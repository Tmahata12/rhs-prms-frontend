<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHS PRMS v4.5 Enhanced</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸŽ“%3C/text%3E%3C/svg%3E">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1e3c72; --secondary: #2a5298; --success: #4CAF50;
            --danger: #f44336; --warning: #FF9800; --info: #2196F3;
            --bg: #f5f5f5; --text: #333; --card: white; --border: #e0e0e0;
        }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 50%, #bbdefb 100%) fixed; 
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        body.dark-mode { 
    --bg: #1a1a2e; 
    --text: #eee; 
    --card: #16213e; 
    --border: #0f3460; 
    background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%) fixed !important;
}
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        /* Login */
        .login-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            height: 100vh;
            padding: 20px; 
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
        }
        .login-box { 
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 35px; 
            border-radius: 20px; 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            max-width: 450px; 
            width: 90%; 
            text-align: center; 
            animation: fadeIn 0.5s;
            max-height: 90vh;
            overflow-y: auto;
        }
        .login-logo { font-size: 4em; margin-bottom: 15px; animation: pulse 2s infinite; }
        .login-box h1 { color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.2); margin-bottom: 10px; font-size: 2em; }
        .version-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.85em; margin-bottom: 10px; font-weight: 600; display: inline-block; }
        .developer-tag { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 10px 20px; border-radius: 25px; font-size: 0.9em; margin: 15px 0; font-weight: 600; display: inline-block; }
        .role-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .role-btn { flex: 1; padding: 12px; border: 2px solid var(--border); background: transparent; border-radius: 8px; cursor: pointer; transition:  all 0.3s; font-size: 13px; font-weight: 600; color: var(--text); }
        .role-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .login-box input { width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px; background: var(--card); color: var(--text); }
        .login-box input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1); }
        .login-box button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .login-box button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        
        /* Main App */
        .app-container { 
            display: none;
            min-height: 100vh;
            max-width: 1600px; 
            margin: 0 auto; 
            background: transparent;
            width: 100%;
        }
        .header { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: white; 
            padding: 15px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
        }
        .header-left h1 { font-size: 1.6em; margin-bottom: 3px; }
        .header-left .version { font-size: 0.7em; opacity: 0.8; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .theme-toggle { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 1.2em; transition: all 0.3s; }
        .theme-toggle:hover { background: rgba(255,255,255,0.3); transform: rotate(180deg); }
        .logout-btn { padding: 8px 20px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .logout-btn:hover { background: rgba(255,0,0,0.3); }
        
        /* Navigation */
        /* Navigation */
.nav-tabs { 
            display: flex; 
            align-items: center;
            background: white; 
            overflow-x: visible; 
            overflow-y: visible;
            border-bottom: 2px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 999;
            width: 100%;
            flex-wrap: wrap;
        }

        .school-name-nav {
            font-size: 0.95em;
            letter-spacing: 0.5px;
        }

        /* Quick Search Bar */
        .quick-search-container {
            position: relative;
            display: flex;
            align-items: center;
            margin: 0 10px 0 auto;
            max-width: 300px;
            min-width: 200px;
            flex-shrink: 1;
        }

        .quick-search-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 25px;
            padding: 8px 15px;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .quick-search-wrapper:focus-within {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.15);
        }

        .search-icon {
            font-size: 1.2em;
            margin-right: 8px;
            color: #666;
        }

        .quick-search-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 14px;
            color: #333;
            padding: 4px 0;
        }

        .quick-search-input::placeholder {
            color: #999;
        }

        .search-clear-btn {
            background: transparent;
            border: none;
            font-size: 1.5em;
            color: #999;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            transition: all 0.2s;
        }

        .search-clear-btn:hover {
            color: #f44336;
            transform: scale(1.2);
        }

        .quick-search-results {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 99999;
            display: none;
        }

        .quick-search-results.show {
            display: block;
            animation: searchSlideDown 0.3s ease;
        }

        @keyframes searchSlideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-category {
            padding: 12px 15px;
            background: #f9f9f9;
            font-weight: 700;
            font-size: 0.85em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-result-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: rgba(30, 60, 114, 0.05);
            padding-left: 20px;
        }

        .search-result-icon {
            font-size: 1.5em;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .search-result-content {
            flex: 1;
        }

        .search-result-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .search-result-subtitle {
            font-size: 0.85em;
            color: #666;
        }

        .search-no-results {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        .search-shortcut {
            display: inline-block;
            background: #f5f5f5;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            color: #666;
            margin-left: auto;
        }

        /* Dark mode search */
        body.dark-mode .quick-search-wrapper {
            background: #2a3f5f;
            border: 2px solid #4a7ba7;
        }

        body.dark-mode .quick-search-wrapper:focus-within {
            background: #34506f;
            border-color: #4fc3f7;
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.4);
        }

        body.dark-mode .quick-search-input {
            color: #fff;
        }
        
        body.dark-mode .quick-search-input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        
        body.dark-mode .search-icon {
            color: rgba(255,255,255,0.9);
        }
        
        body.dark-mode .search-clear-btn {
            color: rgba(255,255,255,0.6);
        }
        
        body.dark-mode .search-clear-btn:hover {
            color: #f44336;
        }

        body.dark-mode .quick-search-results {
            background: #1a1a2e;
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }

        body.dark-mode .search-category {
            background: #2a2a3e;
            color: #bbb;
            border-bottom-color: #3a3a4e;
        }

        body.dark-mode .search-result-item {
            border-bottom-color: #2a2a3e;
        }

        body.dark-mode .search-result-item:hover {
            background: rgba(102, 126, 234, 0.15);
        }

        body.dark-mode .search-result-title {
            color: #eee;
        }
        
        body.dark-mode .search-result-subtitle {
            color: #999;
        }
        
        body.dark-mode .search-result-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        body.dark-mode .search-shortcut {
            background: rgba(255,255,255,0.1);
            color: #999;
        }
        
        body.dark-mode .search-no-results {
            color: #999;
        }

.nav-tab { 
    padding: 14px 25px; 
    cursor: pointer; 
    border: none; 
    background: transparent; 
    font-size: 14px; 
    font-weight: 600; 
    color: #555; 
    transition: all 0.3s; 
    border-bottom: 3px solid transparent; 
    white-space: nowrap; 
}

.nav-tab:hover { 
    background: rgba(30, 60, 114, 0.08); 
    color: var(--primary); 
}

.nav-tab.active { 
    color: var(--primary); 
    border-bottom-color: var(--primary); 
    background: rgba(30, 60, 114, 0.05);
    font-weight: 700;
}

/* Dark mode navigation */
body.dark-mode .nav-tabs {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-bottom-color: #667eea;
    overflow-x: visible;
    overflow-y: visible;
}

body.dark-mode .nav-tab {
    color: #bbb;
}

body.dark-mode .nav-tab:hover {
    background: rgba(102, 126, 234, 0.15);
    color: #4fc3f7;
}

body.dark-mode .nav-tab.active {
    color: #4fc3f7;
    border-bottom-color: #4fc3f7;
    background: rgba(102, 126, 234, 0.1);
}

        /* Dropdown Navigation */
        .nav-dropdown {
            position: relative;
            display: inline-block;
            z-index: 100000;
        }

        .dropdown-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dropdown-toggle .arrow {
            font-size: 0.8em;
            transition: transform 0.3s;
        }

        .dropdown-toggle.open .arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            display: none !important;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 220px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            z-index: 999999;
            overflow: visible;
            margin-top: 0;
        }

        .dropdown-menu.show {
            display: block !important;
            animation: slideDown 0.3s ease;
            visibility: visible !important;
            opacity: 1 !important;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 12px 20px;
            text-align: left;
            border: none;
            background: white;
            color: #555;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #f5f5f5;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(30, 60, 114, 0.08);
            color: var(--primary);
            padding-left: 25px;
        }

        .dropdown-item:active {
            background: rgba(30, 60, 114, 0.15);
        }

        /* Dark mode dropdown */
        body.dark-mode .dropdown-menu {
            background: #1a1a2e;
            border-color: #667eea;
        }

        body.dark-mode .dropdown-item {
            background: #1a1a2e;
            color: #bbb;
            border-bottom-color: #2a2a3e;
        }

        body.dark-mode .dropdown-item:hover {
            background: rgba(102, 126, 234, 0.15);
            color: #4fc3f7;
        }

/* Dark mode - Additional Elements */
body.dark-mode .header {
    background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
}

body.dark-mode .card-title,
body.dark-mode .section-title {
    color: #4fc3f7;
    border-bottom-color: #667eea;
}

body.dark-mode input,
body.dark-mode select,
body.dark-mode textarea {
    background: #0f3460;
    color: #eee;
    border-color: #667eea;
}

body.dark-mode input:focus,
body.dark-mode select:focus,
body.dark-mode textarea:focus {
    border-color: #4fc3f7;
    box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.2);
}

body.dark-mode button:not(.logout-btn):not(.theme-toggle) {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

body.dark-mode .logout-btn:hover {
    background: rgba(244, 67, 54, 0.5);
}

body.dark-mode table {
    color: #eee;
}

body.dark-mode table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

body.dark-mode table tbody tr:hover {
    background: rgba(102, 126, 234, 0.1);
}
        
        /* Content */
        .content { 
            padding: 25px;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 60vh;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        .section-title { font-size: 1.6em; color: var(--primary); margin-bottom: 20px; padding-bottom: 12px; border-bottom: 3px solid var(--primary); display: flex; align-items: center; gap: 10px; }
        
        /* Cards & Stats */
        .card { background: var(--card); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border); transition: all 0.3s; }
        .card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .card-title { font-size: 1.3em; color: var(--primary); margin-bottom: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.2); transition: all 0.3s; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 12px 35px rgba(0,0,0,0.3); }
        .stat-card h3 { font-size: 2.8em; margin-bottom: 10px; font-weight: 700; }
        .stat-card. green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-card.blue { background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #f46b45 0%, #eea849 100%); }
        .stat-card.purple { background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%); }
        .stat-card.pink { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        
        /* Forms */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 18px; margin-bottom: 18px; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text); font-weight: 600; font-size: 14px; }
        .form-group input, 
.form-group select, 
.form-group textarea { 
    width: 100%; 
    padding: 12px; 
    border: 2px solid #bdbdbd;
    border-radius: 8px; 
    font-size: 14px; 
    background: #ffffff; 
    color: var(--text);
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.form-group input:hover,
.form-group select:hover,
.form-group textarea:hover {
    border-color: #9e9e9e;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
}

.form-group input:focus, 
.form-group select:focus,
. form-group textarea:focus { 
    outline: none; 
    border-color: #1e3c72;
    background: #ffffff;
    box-shadow: 0 0 0 4px rgba(30, 60, 114, 0.1);
	
	
	
	        /* Working Days Checkbox Style */
        .working-days-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .day-checkbox {
            position: relative;
            cursor: pointer;
            user-select: none;
            display: block;
        }
        
        .day-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        
        .day-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 18px 12px;
            background: #ffffff;
            border: 2px solid #d0d0d0;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-height: 90px;
        }
        
        .day-checkbox:hover .day-label {
            border-color: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.15);
        }
        
        .day-checkbox input[type="checkbox"]:checked ~ .day-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .day-icon {
            font-size: 28px;
            margin-bottom: 8px;
            display: block;
        }
        
        .day-checkbox input[type="checkbox"]:checked ~ .day-label .day-icon {
            animation: bounce 0.5s ease;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .day-name {
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }
        
        /* Dark mode */
        body.dark-mode .day-label {
            background: #2a2a2a;
            border-color: #555555;
            color: #fff;
        }
        
        body.dark-mode .day-checkbox: hover .day-label {
            border-color: #667eea;
        }
        
        body.dark-mode .day-checkbox input[type="checkbox"]:checked ~ .day-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .working-days-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .working-days-container {
                grid-template-columns: 1fr;
            }
        }
}

        /* Day Badges for Periods */
        .day-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight:  600;
            white-space: nowrap;
        }
        
        .day-regular {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            border: 1px solid #90caf9;
        }
        
        .day-friday {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            color: #2e7d32;
            border: 1px solid #81c784;
            font-weight: 700;
        }
        
        /* Dark mode day badges */
        body.dark-mode .day-regular {
            background: rgba(30, 60, 114, 0.3);
            color: #90caf9;
            border-color: #1565c0;
        }
        
        body.dark-mode .day-friday {
            background: rgba(46, 125, 50, 0.3);
            color: #a5d6a7;
            border-color: #2e7d32;
        }

/* Disabled state */
.form-group input:disabled,
.form-group select:disabled {
    background: #f5f5f5;
    border-color: #e0e0e0;
    cursor: not-allowed;
    opacity: 0.7;
}

/* Dark mode */
body.dark-mode .form-group input,
body.dark-mode .form-group select,
body.dark-mode .form-group textarea {
    border-color: #555555;
    background: #2a2a2a;
    color: #ffffff;
}

body.dark-mode .form-group input:hover,
body. dark-mode .form-group select:hover,
body.dark-mode .form-group textarea:hover {
    border-color: #777777;
}

body.dark-mode .form-group input:focus,
body.dark-mode .form-group select:focus,
body.dark-mode .form-group textarea:focus {
    border-color: #667eea;
    background: #2a2a2a;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
}
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1); }
        
        /* Buttons */
        .btn { padding: 12px 28px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
        .btn-info { background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f46b45 0%, #eea849 100%); color: white; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        
        /* Tables */
        .table-container { overflow-x: auto; margin-top: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; background: var(--card); }
        table thead { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; }
        table th, table td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; }
        table tbody tr: hover { background: rgba(30, 60, 114, 0.05); }
        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        
        /* Alerts */
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; font-size: 14px; font-weight: 500; }
        .alert.show { display: block; animation: fadeIn 0.3s; }
        .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .alert-error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .alert-info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .alert-warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height:  100%; background: rgba(0,0,0,0.8); z-index: 999999; justify-content: center; align-items: center; padding: 20px; }
        .modal.show { display: flex !important; }
        .modal. show { display: flex; }
        .modal-content { background: var(--card); border-radius: 15px; padding: 35px; max-width: 900px; width: 100%; position: relative; max-height: 90vh; overflow-y: auto; animation: fadeIn 0.3s; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 22px; cursor: pointer; }
        
        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10001; display: none; justify-content: center; align-items: center; }
        .loading-overlay.show { display: flex; }
        .loading-spinner { border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid white; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        
        /* Status Badges */
        .status-badge { display: inline-block; padding:  6px 14px; border-radius: 15px; font-size: 12px; font-weight: 600; }
        .status-present { background: #d4edda; color: #155724; }
        .status-absent { background: #f8d7da; color: #721c24; }
        .status-on-duty { background: #d1ecf1; color: #0c5460; }
        
        /* Footer */
        .footer { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: white; 
            text-align: center; 
            padding: 20px; 
            border-top: 3px solid #0d47a1;
            margin-top: auto;
            width: 100%;
        }
        .footer strong { color: #00d2ff; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: white; 
            padding: 15px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
        }
		
		
		
		
		
		
		
		

    
        
        
        
        
        
        
        
        
        
        .forgot-password-link {
            display: block;
            color: white;
            text-decoration: none;
            font-size: 13px;
            margin-top: 15px;
            opacity: 0.9;
            transition: all 0.3s;
        }
        
        .forgot-password-link:hover { 
            opacity: 1; 
            text-decoration: underline; 
        }

    
        
        /* Compact Day Checkboxes - 2 Columns */
        .days-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
            max-width: 500px;
        }
        
        .day-checkbox-item {
            position: relative;
        }
        
        .day-checkbox-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }
        
        .day-checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .day-checkbox-item:hover .day-checkbox-label {
            transform: translateX(3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .day-checkbox-item input[type="checkbox"]:checked ~ .day-checkbox-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .day-icon {
            font-size: 24px;
            min-width: 30px;
            text-align: center;
        }
        
        .day-name {
            font-size: 14px;
            font-weight: 600;
            flex: 1;
        }
        
        @media (max-width: 600px) {
            .days-grid {
                grid-template-columns: 1fr;
            }
        }

        
        
        /* Compact Notification Checkboxes */
        .notification-settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .notification-item {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            transition: all 0.3s ease;
        }
        
        .notification-item:hover {
            border-color: var(--primary);
            box-shadow: 0 3px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .notification-checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            gap: 10px;
        }
        
        .notification-checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--primary);
            flex-shrink: 0;
        }
        
        .notification-label-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
            margin-bottom: 3px;
        }
        
        .notification-description {
            font-size: 12px;
            color: #666;
            line-height: 1.3;
        }
        
        @media (max-width: 768px) {
            .notification-settings-grid {
                grid-template-columns: 1fr;
            }
        }

        
        /* Address Form Styling */
        .address-form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .address-form-row {
                grid-template-columns: 1fr;
            }
        }

    
        .footer { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: white; 
            text-align: center; 
            padding: 20px; 
            border-top: 3px solid #0d47a1;
            margin-top: auto;
            width: 100%;
        }
        
        .content-wrapper {
            flex: 1;
        }

    
        /* Perfect Layout Fix */
        html {
            height: 100%;
            overflow-x: hidden;
        }
        
        body.dark-mode .header,
        body.dark-mode .footer {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 100%);
        }
        
        
        /* Ensure content doesn't go under sticky header */
        .tab-content {
            padding-top: 10px;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Content wrapper proper sizing */
        .content { 
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            min-height: calc(100vh - 200px);
        }

    
        /* Unified Sticky Header + Nav */
        .sticky-header-wrapper {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 99999;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 100%;
            overflow: visible;
        }

    
        /* Enhanced Unified Sticky Section */
        body.dark-mode .sticky-header-wrapper {
            background: #16213e;
            overflow: visible;
        }
        
        .sticky-header-wrapper .header {
            box-shadow: none;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sticky-header-wrapper:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }

    
        
        
        /* Login Form Inputs Glassmorphism */
        .login-box input[type="text"],
        .login-box input[type="password"] {
            background: rgba(255,255,255,0.1) !important;
            color: white !important;
            border: 2px solid rgba(255,255,255,0.3) !important;
        }
        
        .login-box input::placeholder {
            color: rgba(255,255,255,0.7) !important;
        }
        
        .login-box input:focus {
            background: rgba(255,255,255,0.15) !important;
            border-color: white !important;
        }
        
        .login-box select {
            background: rgba(255,255,255,0.1) !important;
            color: white !important;
            border: 2px solid rgba(255,255,255,0.3) !important;
        }
        
        .login-box select option {
            background: #764ba2 !important;
            color: white !important;
        }

    
        /* Hide scrollbar on login page */
        body:has(#loginScreen:not([style*="display: none"])) {
            overflow: hidden !important;
        }
        
        /* Custom scrollbar for login box if needed */
        .login-box::-webkit-scrollbar {
            width: 6px;
        }
        
        .login-box::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        
        .login-box::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }
        
        .login-box::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

    
        

    
        
        
        
        
        
        
        
        

    
        
        .login-box 
        
        .login-box 
        
        .login-box 

    
        
        
        
        
        
        
        
        
        
        .login-box 

    
        
        
        
        
        
        
        
        

    
        
        
        
        
        
        
        
        

    
        
        
        
        
        
        
        
        
        
        

    
        .app-container[style*="display: block"] {
            display: flex !important;
            flex-direction: column;
        }

        /* ========== PRINT MODULE STYLES ========== */
        
        /* Print Options Section */
        .print-section {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .print-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .print-option-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            text-align: center;
        }

        .print-option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .print-option-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .print-option-card p {
            color: #666;
            font-size: 0.9em;
            margin: 0;
        }

        /* Print Modal */
        .print-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 20000;
            justify-content: center;
            align-items: center;
        }

        .print-modal.active {
            display: flex;
        }

        .print-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }

        .print-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .print-modal-header h2 {
            color: #667eea;
            margin: 0;
        }

        .close-print-modal {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-print-modal:hover {
            background: #f0f0f0;
            color: #333;
        }

        /* Teacher Print Card Styles */
        .teacher-print-card {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .teacher-print-header {
            border-bottom: 2px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .teacher-print-header h2 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .teacher-print-header .school-info {
            color: #666;
            font-size: 0.9em;
        }

        .teacher-print-card table {
            width: 100%;
            margin-top: 10px;
            border-collapse: collapse;
        }

        .teacher-print-card th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
            border: 1px solid #333;
        }

        .teacher-print-card td {
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #ddd;
        }

        /* Print Media Queries */
        @media print {
            body {
                background: white !important;
                padding: 0;
            }

            .header,
            .nav-tabs,
            .btn,
            .no-print,
            .print-modal {
                display: none !important;
            }

            .print-content {
                page-break-inside: avoid;
            }

            table {
                page-break-inside: auto;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            .teacher-print-card {
                page-break-after: always;
                border: 2px solid #333;
                padding: 20px;
                margin-bottom: 20px;
            }

            .teacher-print-card:last-child {
                page-break-after: auto;
            }
        }

        /* Dark mode print options */
        body.dark-mode .print-section {
            background: var(--card);
        }

        body.dark-mode .print-option-card {
            background: #0f3460;
            border-color: #667eea;
        }

        body.dark-mode .print-option-card h3 {
            color: #4fc3f7;
        }

        body.dark-mode .print-option-card p {
            color: #bbb;
        }

        body.dark-mode .print-modal-content {
            background: #16213e;
            color: #eee;
        }

        body.dark-mode .print-modal-header {
            border-bottom-color: #667eea;
        }

        body.dark-mode .print-modal-header h2 {
            color: #4fc3f7;
        }

        /* Communication Module Styles */
        .comm-section {
            animation: fadeIn 0.3s;
        }
        
        .chat-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s;
            border: 1px solid #e0e0e0;
        }
        
        .chat-item:hover {
            background: #f0f0f0;
        }
        
        .chat-item.active {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        
        .chat-item-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .chat-item-preview {
            font-size: 0.85em;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-item-time {
            font-size: 0.75em;
            color: #999;
            float: right;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        
        .message-sent {
            background: #2196F3;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message-received {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 0.75em;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .announcement-card {
            border-left: 4px solid #FF9800;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background: #fff3cd;
        }
        
        .announcement-card.high {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .announcement-card.urgent {
            border-left-color: #d32f2f;
            background: #ffcdd2;
            animation: pulse 2s infinite;
        }
        
        .announcement-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #333;
        }
        
        .announcement-meta {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .group-card {
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .group-card:hover {
            border-color: #2196F3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }
        
        .group-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #2196F3;
        }
        
        .group-members {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
        }

        /* Analytics Section Styles */
        .analytics-section {
            animation: fadeIn 0.3s;
        }

        /* Settings Section Styles */
        .settings-section {
            animation: fadeIn 0.3s;
        }

        .working-day-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .working-day-option:hover {
            border-color: #2196F3;
            background: #e3f2fd;
        }

        .working-day-option input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: #2196F3;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: #333;
        }

        .color-option.active {
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }

        /* Gradient Stat Cards */
        .gradient-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .gradient-green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .gradient-purple { background: linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%); color: white; }
        .gradient-orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .gradient-pink { background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 90%); color: white; }
        .gradient-teal { background: linear-gradient(135deg, #13547a 0%, #80d0c7 100%); color: white; }

        /* Activity Feed */
        .activity-item {
            padding: 12px;
            border-left: 3px solid #2196F3;
            background: #f5f5f5;
            margin-bottom: 10px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .activity-item:hover { background: #e3f2fd; border-left-width: 5px; }
        .activity-time { font-size: 0.85em; color: #666; margin-top: 5px; }

        /* Pulse Animation */
        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        .pulse-dot { display: inline-block; animation: pulse-dot 2s infinite; }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: 700;
            padding: 10px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
        }
        
        .calendar-day {
            min-height: 100px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .calendar-day:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .calendar-day.other-month {
            background: #f5f5f5;
            color: #999;
        }
        
        .calendar-day.today {
            background: #e3f2fd;
            border: 2px solid var(--primary);
            font-weight: 700;
        }
        
        .calendar-day.has-event {
            border-left: 4px solid #4CAF50;
        }
        
        .calendar-day.has-holiday {
            background: #fff3e0;
            border-left: 4px solid #FF9800;
        }
        
        .calendar-day.has-exam {
            background: #e8eaf6;
            border-left: 4px solid #2196F3;
        }
        
        .calendar-day-number {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .calendar-event-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 2px;
        }
        
        .calendar-event-item {
            font-size: 0.75em;
            padding: 2px 4px;
            margin: 2px 0;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .event-badge {
            background: #4CAF50;
            color: white;
        }
        
        .holiday-badge {
            background: #FF9800;
            color: white;
        }
        
        .exam-badge {
            background: #2196F3;
            color: white;
        }

        /* ==================== MOBILE RESPONSIVE STYLES ==================== */
        
        /* Tablets and below (768px) */
        @media (max-width: 768px) {
            /* Quick search adjustments */
            .quick-search-container {
                order: -1;
                width: 100%;
                max-width: 100%;
                margin: 10px;
            }
            
            .quick-search-wrapper {
                width: 100%;
            }
            
            .quick-search-results {
                left: 10px;
                right: 10px;
            }
            
            /* Dropdown adjustments for mobile */
            .nav-dropdown {
                display: block;
                width: 100%;
            }
            
            /* Hide school name on small screens */
            .school-name-nav {
                display: none;
            }
            
            .dropdown-toggle {
                width: 100%;
                justify-content: space-between;
            }
            
            .dropdown-menu {
                position: static;
                width: 100%;
                box-shadow: none;
                border-left: 3px solid var(--primary);
                border-radius: 0;
                margin: 0;
            }
            
            .dropdown-item {
                padding-left: 40px;
            }
            
            /* Header adjustments */
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .header-left h1 {
                font-size: 1.3em;
            }
            
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            /* Navigation tabs */
            .nav-tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 5px;
            }
            
            .nav-tab {
                font-size: 0.85em;
                padding: 10px 15px;
                flex-shrink: 0;
            }
            
            /* Stats grid */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            /* Form rows */
            .form-row {
                flex-direction: column;
            }
            
            /* Tables - horizontal scroll */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
                font-size: 0.85em;
            }
            
            /* Modal adjustments */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 20px auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Cards */
            .card {
                padding: 15px;
            }
            
            .card-title {
                font-size: 1.1em;
            }
            
            /* Buttons */
            .btn {
                padding: 10px 15px;
                font-size: 0.9em;
            }
            
            /* Dashboard clock */
            #currentTime {
                font-size: 1.5em !important;
            }
            
            /* Charts - make them stack */
            canvas {
                max-height: 250px !important;
            }
        }
        
        /* Mobile phones (480px and below) */
        @media (max-width: 480px) {
            /* Header */
            .header-left h1 {
                font-size: 1.1em;
            }
            
            .header-left p {
                font-size: 0.75em;
            }
            
            /* Navigation */
            .nav-tab {
                font-size: 0.75em;
                padding: 8px 12px;
            }
            
            /* Stats - single column on very small screens */
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            /* Stat cards - compact */
            .stat-card h3 {
                font-size: 2em;
            }
            
            /* Section title */
            .section-title {
                font-size: 1.3em;
            }
            
            /* Form inputs */
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            /* Table - even more compact */
            table {
                font-size: 0.75em;
            }
            
            th, td {
                padding: 6px 4px;
            }
            
            /* Modal - full screen on mobile */
            .modal-content {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                margin: 0;
                border-radius: 0;
            }
            
            /* Chat interface */
            .chat-container {
                height: calc(100vh - 100px);
            }
            
            .chat-messages {
                padding: 10px;
            }
            
            .chat-bubble {
                max-width: 85%;
                font-size: 0.9em;
            }
            
            /* Quick actions - stack vertically */
            .card button {
                width: 100% !important;
                margin-bottom: 10px;
            }
            
            /* Dashboard improvements */
            #currentTime {
                font-size: 1.3em !important;
            }
            
            #currentDate {
                font-size: 0.85em;
            }
            
            /* Activity feed - compact */
            .activity-item {
                padding: 8px;
                font-size: 0.85em;
            }
            
            /* Charts - smaller */
            canvas {
                max-height: 200px !important;
            }
        }
        
        /* Landscape phones */
        @media (max-width: 812px) and (orientation: landscape) {
            .header {
                padding: 10px 15px;
            }
            
            .nav-tabs {
                padding: 5px 10px;
            }
            
            .nav-tab {
                padding: 8px 12px;
            }
            
            .modal-content {
                max-height: 95vh;
            }
        }
        
        /* Print styles - fix print layouts */
        @media print {
            /* Hide non-printable elements */
            .header,
            .nav-tabs,
            .btn,
            button,
            .modal-close,
            .theme-toggle,
            #loadingOverlay,
            #alertBox {
                display: none !important;
            }
            
            /* Show only active content */
            .tab-content {
                display: none !important;
            }
            
            .tab-content.active,
            .print-content {
                display: block !important;
            }
            
            /* Page breaks */
            .card {
                page-break-inside: avoid;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            /* Full width tables */
            .table-container {
                overflow: visible;
            }
            
            table {
                width: 100%;
                font-size: 10pt;
            }
            
            /* Remove backgrounds */
            body {
                background: white;
            }
            
            .card {
                border: 1px solid #ddd;
                box-shadow: none;
            }
            
            /* Better text */
            body {
                color: black;
                font-size: 11pt;
            }
            
            h1, h2, h3 {
                color: black;
            }
            
            /* Margins for printing */
            @page {
                margin: 1.5cm;
            }
            
            body {
                margin: 0;
                padding: 0;
            }
        }
        
        /* Touch improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .btn,
            button,
            .nav-tab,
            .stat-card {
                min-height: 44px; /* iOS recommended */
                min-width: 44px;
            }
            
            /* Remove hover effects on touch */
            .btn:hover,
            .stat-card:hover,
            .nav-tab:hover {
                transform: none;
            }
            
            /* Better tap feedback */
            .btn:active,
            .stat-card:active,
            .nav-tab:active {
                transform: scale(0.98);
                opacity: 0.8;
            }
        }
        
        /* High DPI screens */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            /* Crisper text */
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
        
        /* Dark mode adjustments for mobile */
        @media (max-width: 768px) {
            .dark-mode .modal-content {
                background: #1a1a1a;
            }
            
            .dark-mode .table-container {
                background: #1a1a1a;
            }
        }
        
        /* Specific component fixes */
        
        /* Routine table on mobile */
        @media (max-width: 768px) {
            .routine-table {
                font-size: 0.7em;
            }
            
            .routine-cell {
                min-width: 80px;
                padding: 4px;
            }
        }
        
        /* Certificate viewer on mobile */
        @media (max-width: 480px) {
            .certificate-preview {
                transform: scale(0.8);
                transform-origin: top left;
            }
        }
        
        /* Excel upload on mobile */
        @media (max-width: 480px) {
            .upload-zone {
                padding: 20px 10px;
                font-size: 0.9em;
            }
        }
        
        /* Analytics charts on mobile */
        @media (max-width: 768px) {
            .chart-container {
                margin-bottom: 20px;
            }
            
            canvas {
                width: 100% !important;
                height: auto !important;
            }
        }
        
        /* Settings forms on mobile */
        @media (max-width: 480px) {
            .settings-section .form-group {
                margin-bottom: 15px;
            }
            
            .settings-section label {
                font-size: 0.9em;
            }
        }

    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div style="text-align: center; color: white;">
            <div class="loading-spinner"></div>
            <h2 id="loadingText">Processing...</h2>
        </div>
    </div>

        <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo">ðŸŽ“</div>
            <h1>RHS PRMS</h1>
            <span class="version-badge">v4.5 Enhanced Edition</span>
            <p style="margin: 10px 0; color: rgba(255,255,255,0.9);">Professional Routine Management System</p>
            <div class="developer-tag">ðŸ“š Developed by Tapas Mahata</div>
            
            <form id="loginForm" onsubmit="login(event)">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: 600; font-size: 14px; text-align: left;">
                        Select Role *
                    </label>
                    <select id="loginRole" required style="width: 100%; padding:  14px; border: 2px solid #d0d0d0; border-radius: 10px; font-size: 15px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
                        <option value="">-- Choose Your Role --</option>
                        <option value="admin">ðŸ‘¨â€ðŸ’¼ Admin</option>
                        <option value="teacher">ðŸ‘¨â€ðŸ« Teacher</option>
                        <option value="office">ðŸ“‹ Office Staff</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: 600; font-size: 14px; text-align: left;">
                        Username *
                    </label>
                    <input type="text" id="loginUsername" placeholder="Username" required autocomplete="off">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: 600; font-size: 14px; text-align: left;">
                        Password *
                    </label>
                    <div style="position: relative;">
                        <input type="password" id="loginPassword" placeholder="Password" required style="padding-right: 50px;">
                        <button type="button" onclick="toggleLoginPassword()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; font-size: 20px; padding: 4px 6px; color: rgba(255,255,255,0.8); transition: all 0.3s; line-height: 1;" onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255,255,255,0.8)'">
                            <span id="loginPasswordToggleIcon">ðŸ‘ï¸</span>
                        </button>
                    </div>
                </div>
                
                <button type="submit">ðŸš€ Login to System</button>
                
                <a href="#" class="forgot-password-link" onclick="showForgotPassword(event)">ðŸ”‘ Forgot Password?</a>
                
                <div class="alert alert-error" id="loginError" style="margin-top: 15px;">
                    âŒ Invalid credentials!  
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="app-container">
                <!-- Header -->
        <div class="sticky-header-wrapper">
        <div class="header">
            <div class="header-left">
                <h1>ðŸŽ“ RHS PRMS</h1>
                <p>Ramnagar High School (H.S.) | DISE:  19090310603</p>
            </div>
            <div class="header-right">
                <button class="theme-toggle" onclick="toggleDarkMode()">ðŸŒ™</button>
                <div class="user-info">
                    <span class="user-icon">ðŸ‘¤</span>
                    <span class="user-name" id="loggedInUser">AHM RHS</span>
                </div>
                <button class="logout-btn" onclick="logout()">ðŸšª Logout</button>
            </div>
        </div>
        <!-- Navigation -->
        <div class="nav-tabs">
            <!-- Dashboard - Always visible -->
            <button class="nav-tab active" onclick="showTab('dashboard')">ðŸ“Š Dashboard</button>
            
            <!-- Academic Management Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-tab dropdown-toggle" onclick="toggleDropdown(this)">
                    ðŸ“š Academic <span class="arrow">â–¼</span>
                </button>
                <div class="dropdown-menu">
                    <button class="dropdown-item" onclick="showTab('teachers')">ðŸ‘¨â€ðŸ« Teachers</button>
                    <button class="dropdown-item" onclick="showTab('subjects')">ðŸ“š Subjects</button>
                    <button class="dropdown-item" onclick="showTab('classes')">ðŸ« Classes</button>
                    <button class="dropdown-item" onclick="showTab('periods')">â° Periods</button>
                </div>
            </div>
            
            <!-- Routine Management Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-tab dropdown-toggle" onclick="toggleDropdown(this)">
                    ðŸ“‹ Routine <span class="arrow">â–¼</span>
                </button>
                <div class="dropdown-menu">
                    <button class="dropdown-item" onclick="showTab('routine')">ðŸ“‹ View Routine</button>
                    <button class="dropdown-item" onclick="showTab('provisional')">ðŸ”„ Provisional</button>
                    <button class="dropdown-item" onclick="showTab('substitute')">ðŸ‘¥ Substitute</button>
                </div>
            </div>
            
            <!-- Operations Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-tab dropdown-toggle" onclick="toggleDropdown(this)">
                    ðŸ“ Operations <span class="arrow">â–¼</span>
                </button>
                <div class="dropdown-menu">
                    <button class="dropdown-item" onclick="showTab('attendance')">âœ… Attendance</button>
                    <button class="dropdown-item" onclick="showTab('exam')">ðŸŽ“ Exam Management</button>
                    <button class="dropdown-item" onclick="showTab('communication')">ðŸ’¬ Communication</button>
                </div>
            </div>
            
            <!-- System & Tools Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-tab dropdown-toggle" onclick="toggleDropdown(this)">
                    ðŸ”§ System <span class="arrow">â–¼</span>
                </button>
                <div class="dropdown-menu">
                    <button class="dropdown-item" onclick="showTab('users')">ðŸ‘¥ User Management</button>
                    <button class="dropdown-item" onclick="showTab('calendar')">ðŸ“… Calendar</button>
                    <button class="dropdown-item" onclick="showTab('settings')">âš™ï¸ Settings</button>
                    <button class="dropdown-item" onclick="showTab('bulkupload')">ðŸ“Š Bulk Upload</button>
                    <button class="dropdown-item" onclick="showTab('analytics')">ðŸ“ˆ Analytics</button>
                    <button class="dropdown-item" onclick="showTab('print')">ðŸ–¨ï¸ Print Options</button>
                </div>
            </div>
            
            <!-- Quick Search Bar -->
            <div class="quick-search-container">
                <div class="quick-search-wrapper">
                    <span class="search-icon">ðŸ”</span>
                    <input type="text" 
                           id="quickSearchInput" 
                           class="quick-search-input" 
                           placeholder="Quick search..." 
                           onkeyup="performQuickSearch(event)"
                           onfocus="showSearchResults()"
                           autocomplete="off">
                    <button class="search-clear-btn" onclick="clearQuickSearch()" style="display: none;">Ã—</button>
                </div>
                <div id="quickSearchResults" class="quick-search-results"></div>
            </div>
        </div>
    </div>

        <!-- Content -->
        <div class="content">
            <div id="alertBox" class="alert"></div>

            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <h2 class="section-title"><span>ðŸ“Š</span> Advanced Dashboard</h2>
                
                <!-- Real-time Clock & Info Bar -->
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                        <div>
                            <h2 id="currentTime" style="margin: 0; font-size: 2em;">--:--:--</h2>
                            <p id="currentDate" style="margin: 5px 0 0 0; opacity: 0.9;">Loading...</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; font-size: 1.2em;">Welcome back!</p>
                            <p id="loggedUser" style="margin: 5px 0 0 0; opacity: 0.9;">User</p>
                        </div>
                    </div>
                </div>

                <!-- System Health Indicators -->
                <div class="card">
                    <h3 class="card-title">âš¡ System Health</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">Data Status</span>
                                <span id="dataHealth" style="font-size: 1.5em;">ðŸŸ¢</span>
                            </div>
                            <p id="dataHealthText" style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">All systems operational</p>
                        </div>
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #9C27B0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">Routine Coverage</span>
                                <span id="routineCoverage" style="font-size: 1.2em; font-weight: 700;">0%</span>
                            </div>
                            <div id="routineProgress" style="background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 8px; overflow: hidden;">
                                <div id="routineProgressBar" style="background: #9C27B0; height: 100%; width: 0%; transition: width 0.5s;"></div>
                            </div>
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">Attendance Rate</span>
                                <span id="attendanceRate" style="font-size: 1.2em; font-weight: 700;">0%</span>
                            </div>
                            <div style="background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 8px; overflow: hidden;">
                                <div id="attendanceProgressBar" style="background: #FF9800; height: 100%; width: 0%; transition: width 0.5s;"></div>
                            </div>
                        </div>
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">Last Updated</span>
                                <span style="font-size: 1.5em;">ðŸ”„</span>
                            </div>
                            <p id="lastUpdate" style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">Just now</p>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid with Visual Improvements -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card gradient-blue" onclick="showTab('teachers')" style="cursor: pointer; transition: all 0.3s;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3 id="totalTeachers" style="margin: 0; font-size: 2.5em;">0</h3>
                                <p style="margin: 5px 0 0 0;">Teachers</p>
                            </div>
                            <span style="font-size: 2.5em; opacity: 0.3;">ðŸ‘¨â€ðŸ«</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.8;">
                            <span id="activeTeachers">0</span> active today
                        </div>
                    </div>
                    
                    <div class="stat-card gradient-green" onclick="showTab('subjects')" style="cursor: pointer; transition: all 0.3s;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3 id="totalSubjects" style="margin: 0; font-size: 2.5em;">0</h3>
                                <p style="margin: 5px 0 0 0;">Subjects</p>
                            </div>
                            <span style="font-size: 2.5em; opacity: 0.3;">ðŸ“š</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.8;">
                            All departments
                        </div>
                    </div>
                    
                    <div class="stat-card gradient-purple" onclick="showTab('classes')" style="cursor: pointer; transition: all 0.3s;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3 id="totalClasses" style="margin: 0; font-size: 2.5em;">0</h3>
                                <p style="margin: 5px 0 0 0;">Classes</p>
                            </div>
                            <span style="font-size: 2.5em; opacity: 0.3;">ðŸ«</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.8;">
                            All sections
                        </div>
                    </div>
                    
                    <div class="stat-card gradient-orange" onclick="showTab('routine')" style="cursor: pointer; transition: all 0.3s;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3 id="totalRoutines" style="margin: 0; font-size: 2.5em;">0</h3>
                                <p style="margin: 5px 0 0 0;">Routines</p>
                            </div>
                            <span style="font-size: 2.5em; opacity: 0.3;">ðŸ“‹</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.8;">
                            <span id="todayRoutines">0</span> for today
                        </div>
                    </div>
                    
                    <div class="stat-card gradient-pink" onclick="showTab('attendance')" style="cursor: pointer; transition: all 0.3s;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3 id="todayAbsent" style="margin: 0; font-size: 2.5em;">0</h3>
                                <p style="margin: 5px 0 0 0;">Absent Today</p>
                            </div>
                            <span style="font-size: 2.5em; opacity: 0.3;">âš ï¸</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.8;">
                            <span id="todayPresent">0</span> present
                        </div>
                    </div>
                    
                    <div class="stat-card gradient-teal" onclick="showTab('substitute')" style="cursor: pointer; transition: all 0.3s;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3 id="totalSubstitutes" style="margin: 0; font-size: 2.5em;">0</h3>
                                <p style="margin: 5px 0 0 0;">Substitutes</p>
                            </div>
                            <span style="font-size: 2.5em; opacity: 0.3;">ðŸ”„</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.8;">
                            This week
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <!-- Teacher Distribution Chart -->
                    <div class="card">
                        <h3 class="card-title">ðŸ‘¨â€ðŸ« Teacher Distribution by Section</h3>
                        <canvas id="teacherDistributionChart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <!-- Weekly Attendance Trend -->
                    <div class="card">
                        <h3 class="card-title">ðŸ“Š Weekly Attendance Trend</h3>
                        <canvas id="weeklyAttendanceChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Recent Activities Feed -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 class="card-title">ðŸ“ Recent Activities</h3>
                            <button class="btn btn-sm btn-secondary" onclick="refreshActivities()">ðŸ”„ Refresh</button>
                        </div>
                        <div id="recentActivities" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">âš¡ Quick Stats</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="padding: 12px; background: #f5f5f5; border-radius: 6px;">
                                <div style="font-size: 0.85em; color: #666;">Total Periods Today</div>
                                <div style="font-size: 1.5em; font-weight: 700; color: #1e3c72;" id="totalPeriodsToday">0</div>
                            </div>
                            <div style="padding: 12px; background: #f5f5f5; border-radius: 6px;">
                                <div style="font-size: 0.85em; color: #666;">Completed Classes</div>
                                <div style="font-size: 1.5em; font-weight: 700; color: #4CAF50;" id="completedClasses">0</div>
                            </div>
                            <div style="padding: 12px; background: #f5f5f5; border-radius: 6px;">
                                <div style="font-size: 0.85em; color: #666;">Pending Classes</div>
                                <div style="font-size: 1.5em; font-weight: 700; color: #FF9800;" id="pendingClasses">0</div>
                            </div>
                            <div style="padding: 12px; background: #f5f5f5; border-radius: 6px;">
                                <div style="font-size: 0.85em; color: #666;">Substitute Needed</div>
                                <div style="font-size: 1.5em; font-weight: 700; color: #f44336;" id="substituteNeeded">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <h3 class="card-title">ðŸš€ Quick Actions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button class="btn btn-primary" onclick="showTab('attendance')">
                            <span style="font-size: 1.2em;">âœ…</span><br>Mark Attendance
                        </button>
                        <button class="btn btn-info" onclick="showTab('provisional')">
                            <span style="font-size: 1.2em;">ðŸ¤–</span><br>AI Auto-Assign
                        </button>
                        <button class="btn btn-success" onclick="showTab('routine')">
                            <span style="font-size: 1.2em;">ðŸ“‹</span><br>Create Routine
                        </button>
                        <button class="btn btn-warning" onclick="viewCompleteRoutine()">
                            <span style="font-size: 1.2em;">ðŸ“–</span><br>View Routine
                        </button>
                        <button class="btn btn-primary" onclick="showTab('analytics')">
                            <span style="font-size: 1.2em;">ðŸ“ˆ</span><br>Analytics
                        </button>
                        <button class="btn btn-success" onclick="showTab('bulkupload')">
                            <span style="font-size: 1.2em;">ðŸ“Š</span><br>Upload Excel
                        </button>
                    </div>
                </div>

                <!-- Highlights & Notices Row -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    <div class="card">
                        <h3 class="card-title">ðŸ”” Today's Highlights</h3>
                        <div id="highlightsContent"></div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title">ðŸ“¢ Notice Board</h3>
                            <button class="btn btn-sm btn-primary" onclick="addNotice()">+ Add</button>
                        </div>
                        <div id="noticeList"></div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title">ðŸ“… Upcoming Events</h3>
                            <button class="btn btn-sm btn-success" onclick="addEvent()">+ Add</button>
                        </div>
                        <div id="eventList"></div>
                    </div>
                </div>
            </div>

            <!-- Teachers Tab -->
            <div id="teachers" class="tab-content">
                <h2 class="section-title">ðŸ‘¨â€ðŸ« Teacher Management</h2>
                
                <div class="card">
                    <h3 class="card-title">âž• Add New Teacher</h3>
                    <form id="teacherForm" onsubmit="saveTeacher(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Teacher Name *</label>
                                <input type="text" id="teacherName" required>
                            </div>
                            <div class="form-group">
                                <label>Short Name *</label>
                                <input type="text" id="teacherShortName" required placeholder="e.g., TM" maxlength="5" style="text-transform: uppercase;">
                            </div>
                            <div class="form-group">
                                <label>Section *</label>
                                <select id="teacherSection" required>
                                    <option value="">Select Section</option>
                                    <option value="Upper Primary">Upper Primary (V-VIII)</option>
                                    <option value="Secondary">Secondary (IX-X)</option>
                                    <option value="Higher Secondary">Higher Secondary (XI-XII)</option>
                                    <option value="All">All Sections</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="teacherPhone">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">âž• Add Teacher</button>
                    </form>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>SL</th>
                                <th>Name</th>
                                <th>Section</th>
                                <th>Contact</th>
                                <th>Classes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="teachersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Similar structure for other tabs...  (continuing in next part) -->
			
			            <!-- Subjects Tab -->
            <div id="subjects" class="tab-content">
                <h2 class="section-title">ðŸ“š Subject Management</h2>
                
                <div class="card">
                    <h3 class="card-title">âž• Add New Subject</h3>
                    <form id="subjectForm" onsubmit="saveSubject(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Subject Name *</label>
                                <input type="text" id="subjectName" required>
                            </div>
                            <div class="form-group">
                                <label>Subject Code</label>
                                <input type="text" id="subjectCode">
                            </div>
                            <div class="form-group">
                                <label>Category *</label>
                                <select id="subjectCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="Upper Primary">Upper Primary</option>
                                    <option value="Secondary">Secondary</option>
                                    <option value="Higher Secondary">Higher Secondary</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">âž• Add Subject</button>
                    </form>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>SL</th>
                                <th>Subject Name</th>
                                <th>Code</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subjectsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Classes Tab -->
            <div id="classes" class="tab-content">
                <h2 class="section-title">ðŸ« Class Management</h2>
                
                <div class="card">
                    <h3 class="card-title">âž• Add Class</h3>
                    <form id="classForm" onsubmit="saveClass(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Class *</label>
                                <select id="className" required>
                                    <option value="">Select Class</option>
                                    <option value="V">Class V</option>
                                    <option value="VI">Class VI</option>
                                    <option value="VII">Class VII</option>
                                    <option value="VIII">Class VIII</option>
                                    <option value="IX">Class IX</option>
                                    <option value="X">Class X</option>
                                    <option value="XI">Class XI</option>
                                    <option value="XII">Class XII</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Section</label>
                                <input type="text" id="classSection" value="A">
                            </div>
                            <div class="form-group">
                                <label>Stream (XI-XII)</label>
                                <select id="classStream">
                                    <option value="">N/A</option>
                                    <option value="Arts">Arts</option>
                                    <option value="Science">Science</option>
                                    <option value="Commerce">Commerce</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Total Students</label>
                                <input type="number" id="totalStudents" min="0" value="0">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">ðŸ’¾ Save Class</button>
                    </form>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Section</th>
                                <th>Stream</th>
                                <th>Students</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="classesTableBody"></tbody>
                    </table>
                </div>
            </div>

                        <!-- Periods Tab -->
            <div id="periods" class="tab-content">
                <h2 class="section-title">â° Period Configuration</h2>
                
                <!-- Regular Days Periods -->
                <div class="card">
                    <h3 class="card-title">ðŸ“… Regular Days (Monday - Thursday, Saturday)</h3>
                    <form id="periodForm" onsubmit="savePeriod(event, 'regular')">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Period Number *</label>
                                <input type="number" id="periodNumber" min="1" max="10" required>
                            </div>
                            <div class="form-group">
                                <label>Start Time *</label>
                                <input type="time" id="startTime" required>
                            </div>
                            <div class="form-group">
                                <label>End Time *</label>
                                <input type="time" id="endTime" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">ðŸ’¾ Save Regular Period</button>
                    </form>
                    
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Days</th>
                                    <th>Time</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="regularPeriodsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Friday Special Periods -->
                <div class="card">
                    <h3 class="card-title">ðŸ•Œ Friday Special Timing</h3>
                    <div style="background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #856404;"><strong>â„¹ï¸ Note:</strong> Set different period times for Friday (for prayer time/short schedule)</p>
                    </div>
                    
                    <form id="fridayPeriodForm" onsubmit="savePeriod(event, 'friday')">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Period Number *</label>
                                <input type="number" id="fridayPeriodNumber" min="1" max="10" required>
                            </div>
                            <div class="form-group">
                                <label>Start Time *</label>
                                <input type="time" id="fridayStartTime" required>
                            </div>
                            <div class="form-group">
                                <label>End Time *</label>
                                <input type="time" id="fridayEndTime" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">ðŸ’¾ Save Friday Period</button>
                    </form>
                    
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Day</th>
                                    <th>Time</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fridayPeriodsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <h3 class="card-title">âš¡ Quick Actions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button class="btn btn-info" onclick="copyRegularToFriday()">ðŸ“‹ Copy Regular to Friday</button>
                        <button class="btn btn-warning" onclick="viewAllPeriods()">ðŸ‘ï¸ View All Periods</button>
                        <button class="btn btn-danger" onclick="clearFridayPeriods()">ðŸ—‘ï¸ Clear Friday Periods</button>
                    </div>
                </div>
            </div>

            <!-- Routine Tab -->
            <div id="routine" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title" style="margin-bottom: 0;">ðŸ“‹ Routine Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-danger" onclick="exportRoutineToPDF()">ðŸ“„ Export PDF</button>
                        <button class="btn btn-success" onclick="exportRoutineToExcel()">ðŸ“Š Export Excel</button>
                    </div>
                </div>
                
                <!-- ðŸš€ AI-POWERED FEATURES -->
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                    <h3 style="color: white; margin-bottom: 15px;">ðŸ¤– AI-Powered Smart Features</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <button class="btn" id="btnAutoGenerate" style="background: white; color: #667eea; font-weight: bold; padding: 15px;">
                            ðŸ¤– Auto-Generate Routine
                        </button>
                        <button class="btn" id="btnDetectConflicts" style="background: white; color: #667eea; font-weight: bold; padding: 15px;">
                            âš¡ Detect Conflicts
                        </button>
                        <button class="btn" id="btnSmartSubstitute" style="background: white; color: #667eea; font-weight: bold; padding: 15px;">
                            ðŸ”„ Smart Substitute Finder
                        </button>
                    </div>
                    <p style="margin-top: 15px; font-size: 14px; opacity: 0.9;">
                        âœ¨ Click buttons above to automatically generate optimal routines, detect conflicts, and find best substitute teachers!
                    </p>
                </div>
                
                <div class="card">
                    <h3 class="card-title">âž• Add Routine Entry</h3>
                    <form id="routineForm" onsubmit="saveRoutine(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Day *</label>
                                <select id="routineDay" required>
                                    <option value="">Select Day</option>
                                    <option value="MONDAY">Monday</option>
                                    <option value="TUESDAY">Tuesday</option>
                                    <option value="WEDNESDAY">Wednesday</option>
                                    <option value="THURSDAY">Thursday</option>
                                    <option value="FRIDAY">Friday</option>
                                    <option value="SATURDAY">Saturday</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Class *</label>
                                <select id="routineClass" required></select>
                            </div>
                            <div class="form-group">
                                <label>Period *</label>
                                <select id="routinePeriod" required></select>
                            </div>
                            <div class="form-group">
                                <label>Subject *</label>
                                <select id="routineSubject" required></select>
                            </div>
                            <div class="form-group">
                                <label>Teacher *</label>
                                <select id="routineTeacher" required></select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary">âž• Add Entry</button>
                            <button type="button" class="btn btn-info" onclick="viewCompleteRoutine()">ðŸ“– View All</button>
                        </div>
                    </form>
                </div>

                <div id="routineDisplay"></div>
            </div>

            <!-- Attendance Tab -->
            <div id="attendance" class="tab-content">
                <h2 class="section-title">âœ… Attendance Management</h2>
                
                <div class="card">
                    <h3 class="card-title">ðŸ“… Mark Attendance</h3>
                    <div class="form-group">
                        <label>Select Date</label>
                        <input type="date" id="attendanceDate" onchange="loadAttendance()">
                    </div>
                    <button class="btn btn-success" onclick="markAllPresent()">âœ… Mark All Present</button>
                    <div id="attendanceList" style="margin-top: 20px;"></div>
                </div>

                <div class="card">
                    <h3 class="card-title">ðŸ“Š Attendance Summary</h3>
                    <div id="attendanceSummary"></div>
                </div>
            </div>

            <!-- Provisional Tab -->
            <div id="provisional" class="tab-content">
                <h2 class="section-title">ðŸ”„ Provisional Routine</h2>
                
                <div class="card">
                    <h3 class="card-title">ðŸ¤– AI Auto-Assignment</h3>
                    <p style="margin-bottom: 15px; color: #666;">Let AI automatically assign replacement teachers based on availability and workload</p>
                    <form id="provisionalFormAuto" onsubmit="autoAssignProvisional(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" id="provisionalDateAuto" required>
                            </div>
                            <div class="form-group">
                                <label>Absent Teacher *</label>
                                <select id="absentTeacherAuto" required></select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success" style="font-size: 16px; padding: 14px 30px;">
                            ðŸ¤– ONE-CLICK AUTO-ASSIGN
                        </button>
                    </form>
                </div>

                <div class="card">
                    <h3 class="card-title">âœï¸ Manual Assignment</h3>
                    <form id="provisionalForm" onsubmit="manualAssignProvisional(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" id="provisionalDate" required>
                            </div>
                            <div class="form-group">
                                <label>Absent Teacher *</label>
                                <select id="absentTeacher" required></select>
                            </div>
                            <div class="form-group">
                                <label>Day *</label>
                                <select id="provisionalDay" required>
                                    <option value="">Select Day</option>
                                    <option value="MONDAY">Monday</option>
                                    <option value="TUESDAY">Tuesday</option>
                                    <option value="WEDNESDAY">Wednesday</option>
                                    <option value="THURSDAY">Thursday</option>
                                    <option value="FRIDAY">Friday</option>
                                    <option value="SATURDAY">Saturday</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" class="btn btn-info" onclick="findAffectedClasses()">ðŸ” Find Affected Classes</button>
                    </form>
                </div>

                <div id="affectedClassesDisplay"></div>
                
                <div class="card">
                    <h3 class="card-title">ðŸ“œ Provisional History</h3>
                    <div id="provisionalHistory"></div>
                </div>
            </div>

            <!-- Substitute Management Tab -->
            <div id="substitute" class="tab-content">
                <h2 class="section-title">ðŸ‘¥ Substitute Teacher Management</h2>
                
                <!-- Quick Stats -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card orange">
                        <h3 id="absentTodayCount">0</h3>
                        <p>Absent Today</p>
                    </div>
                    <div class="stat-card blue">
                        <h3 id="substitutesActiveCount">0</h3>
                        <p>Active Substitutes</p>
                    </div>
                    <div class="stat-card green">
                        <h3 id="totalSubstituteHours">0</h3>
                        <p>Total Hours (Month)</p>
                    </div>
                    <div class="stat-card purple">
                        <h3 id="totalSubstituteCompensation">â‚¹0</h3>
                        <p>Compensation (Month)</p>
                    </div>
                </div>

                <!-- Mark Teacher Absent -->
                <div class="card">
                    <h3 class="card-title">âŒ Mark Teacher Absent</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="absenceDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Absent Teacher *</label>
                            <select id="absentTeacher" onchange="loadTeacherSchedule()" required>
                                <option value="">-- Select Teacher --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Reason for Absence</label>
                            <select id="absenceReason">
                                <option value="Medical Leave">Medical Leave</option>
                                <option value="Personal Leave">Personal Leave</option>
                                <option value="Emergency">Emergency</option>
                                <option value="Training">Training</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea id="absenceNotes" rows="2" placeholder="Optional notes about absence"></textarea>
                    </div>
                    
                    <button class="btn btn-danger" onclick="markTeacherAbsent()">âŒ Mark Absent & Find Substitutes</button>
                </div>

                <!-- Teacher's Schedule (shown after selecting teacher) -->
                <div class="card" id="teacherScheduleCard" style="display: none;">
                    <h3 class="card-title">ðŸ“‹ Teacher's Schedule for Selected Date</h3>
                    <div id="teacherScheduleContent"></div>
                </div>

                <!-- Auto-Assign Substitutes -->
                <div class="card" id="substituteAssignmentCard" style="display: none;">
                    <h3 class="card-title">ðŸ”„ Assign Substitute Teachers</h3>
                    <p style="color: #666; margin-bottom: 15px;">System will suggest available teachers for each period</p>
                    
                    <div id="substituteAssignmentContent"></div>
                    
                    <button class="btn btn-success" onclick="saveSubstituteAssignments()">ðŸ’¾ Save All Assignments</button>
                    <button class="btn btn-secondary" onclick="cancelSubstituteProcess()">âŒ Cancel</button>
                </div>

                <!-- Active Absences Today -->
                <div class="card">
                    <h3 class="card-title">ðŸ“… Today's Absences & Substitutes</h3>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Absent Teacher</th>
                                    <th>Periods</th>
                                    <th>Substitute(s)</th>
                                    <th>Reason</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="todayAbsencesTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #999;">No absences for today</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Substitute Hours Tracking -->
                <div class="card">
                    <h3 class="card-title">â° Substitute Hours Tracking</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Month</label>
                            <input type="month" id="substituteMonth" onchange="loadSubstituteHours()">
                        </div>
                        
                        <div class="form-group">
                            <label>Filter by Teacher</label>
                            <select id="substituteTeacherFilter" onchange="loadSubstituteHours()">
                                <option value="">All Teachers</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Teacher</th>
                                    <th>Total Periods</th>
                                    <th>Total Hours</th>
                                    <th>Rate/Hour</th>
                                    <th>Compensation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="substituteHoursTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #999;">No substitute records</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Compensation Settings -->
                <div class="card">
                    <h3 class="card-title">ðŸ’° Compensation Settings</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Default Rate per Hour (â‚¹)</label>
                            <input type="number" id="defaultHourlyRate" value="200" min="0" step="50">
                        </div>
                        
                        <div class="form-group">
                            <label>Period Duration (minutes)</label>
                            <input type="number" id="periodDuration" value="45" min="30" max="60">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveCompensationSettings()">ðŸ’¾ Save Settings</button>
                </div>

                <!-- Substitute History -->
                <div class="card">
                    <h3 class="card-title">ðŸ“œ Substitute History</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="historyFromDate">
                        </div>
                        
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="historyToDate">
                        </div>
                        
                        <div class="form-group">
                            <label style="opacity: 0;">Search</label>
                            <button class="btn btn-info" onclick="loadSubstituteHistory()">ðŸ” Search</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Absent Teacher</th>
                                    <th>Period</th>
                                    <th>Class</th>
                                    <th>Substitute</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="substituteHistoryTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #999;">No history records</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Exam Management Tab -->
            <div id="exam" class="tab-content">
                <h2 class="section-title">ðŸŽ“ Exam Management System</h2>
                
                <!-- Quick Stats -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card blue">
                        <h3 id="totalExamsCount">0</h3>
                        <p>Total Exams</p>
                    </div>
                    <div class="stat-card green">
                        <h3 id="upcomingExamsCount">0</h3>
                        <p>Upcoming</p>
                    </div>
                    <div class="stat-card orange">
                        <h3 id="ongoingExamsCount">0</h3>
                        <p>Ongoing</p>
                    </div>
                    <div class="stat-card purple">
                        <h3 id="totalInvigilatorsCount">0</h3>
                        <p>Invigilators Assigned</p>
                    </div>
                </div>

                <!-- Create Exam Schedule -->
                <div class="card">
                    <h3 class="card-title">ðŸ“… Create Exam Schedule</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Exam Name *</label>
                            <input type="text" id="examName" placeholder="e.g., First Terminal Exam 2025" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Exam Type *</label>
                            <select id="examType">
                                <option value="Terminal">Terminal Exam</option>
                                <option value="Half-Yearly">Half-Yearly</option>
                                <option value="Annual">Annual Exam</option>
                                <option value="Unit Test">Unit Test</option>
                                <option value="Practice Test">Practice Test</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Academic Year</label>
                            <input type="text" id="examYear" value="2024-25" placeholder="2024-25">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date *</label>
                            <input type="date" id="examStartDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label>End Date *</label>
                            <input type="date" id="examEndDate" required>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="createExamSchedule()">âž• Create Exam Schedule</button>
                </div>

                <!-- Exam List -->
                <div class="card">
                    <h3 class="card-title">ðŸ“‹ Exam Schedules</h3>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Exam Name</th>
                                    <th>Type</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="examListTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #999;">No exams created yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Exam Timetable Creation (shown after selecting exam) -->
                <div class="card" id="examTimetableCard" style="display: none;">
                    <h3 class="card-title">ðŸ“ Create Exam Timetable</h3>
                    
                    <div id="selectedExamInfo" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="timetableDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Session *</label>
                            <select id="examSession">
                                <option value="Morning">Morning (10:00 AM - 1:00 PM)</option>
                                <option value="Afternoon">Afternoon (2:00 PM - 5:00 PM)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Start Time *</label>
                            <input type="time" id="examStartTime" value="10:00" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Duration (minutes) *</label>
                            <input type="number" id="examDuration" value="180" min="30" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Class *</label>
                            <select id="examClass" required>
                                <option value="">-- Select Class --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Subject *</label>
                            <input type="text" id="examSubject" placeholder="e.g., Mathematics" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Total Marks</label>
                            <input type="number" id="examMarks" value="100" min="0">
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="addExamTimetableEntry()">âž• Add to Timetable</button>
                    <button class="btn btn-secondary" onclick="closeExamTimetable()">âŒ Close</button>
                    
                    <!-- Timetable Entries -->
                    <div id="timetableEntriesSection" style="margin-top: 30px; display: none;">
                        <h4>ðŸ“‹ Timetable Entries</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Class</th>
                                        <th>Subject</th>
                                        <th>Marks</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="timetableEntriesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Invigilator Assignment -->
                <div class="card" id="invigilatorCard" style="display: none;">
                    <h3 class="card-title">ðŸ‘¨â€ðŸ« Assign Invigilators</h3>
                    
                    <div id="selectedExamInfoInvig" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
                    
                    <div id="invigilatorAssignmentContent"></div>
                    
                    <button class="btn btn-success" onclick="saveInvigilatorAssignments()">ðŸ’¾ Save All Assignments</button>
                    <button class="btn btn-secondary" onclick="closeInvigilatorAssignment()">âŒ Close</button>
                </div>

                <!-- Hall Arrangement -->
                <div class="card">
                    <h3 class="card-title">ðŸ›ï¸ Exam Hall Management</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hall Name *</label>
                            <input type="text" id="hallName" placeholder="e.g., Main Hall, Room 101">
                        </div>
                        
                        <div class="form-group">
                            <label>Capacity *</label>
                            <input type="number" id="hallCapacity" placeholder="e.g., 50" min="1">
                        </div>
                        
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" id="hallLocation" placeholder="e.g., Ground Floor">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="addExamHall()">âž• Add Hall</button>
                    
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Hall Name</th>
                                    <th>Capacity</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="hallsTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #999;">No halls added yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Hall Assignment for Exam -->
                <div class="card" id="hallAssignmentCard" style="display: none;">
                    <h3 class="card-title">ðŸŽ¯ Assign Halls to Exam</h3>
                    
                    <div id="selectedExamInfoHall" style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
                    
                    <div id="hallAssignmentContent"></div>
                    
                    <button class="btn btn-success" onclick="saveHallAssignments()">ðŸ’¾ Save Hall Assignments</button>
                    <button class="btn btn-secondary" onclick="closeHallAssignment()">âŒ Close</button>
                </div>

                <!-- Exam Reports -->
                <div class="card">
                    <h3 class="card-title">ðŸ“Š Exam Reports & Documents</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div class="print-option-card" onclick="showExamReportModal('timetable')">
                            <h3>ðŸ“… Exam Timetable</h3>
                            <p>Print complete exam schedule</p>
                        </div>
                        
                        <div class="print-option-card" onclick="showExamReportModal('invigilator')">
                            <h3>ðŸ‘¨â€ðŸ« Invigilator Duty List</h3>
                            <p>Print duty roster for teachers</p>
                        </div>
                        
                        <div class="print-option-card" onclick="showExamReportModal('hall')">
                            <h3>ðŸ›ï¸ Hall Arrangement</h3>
                            <p>Print hall-wise seating plan</p>
                        </div>
                        
                        <div class="print-option-card" onclick="showExamReportModal('attendance')">
                            <h3>ðŸ“‹ Attendance Sheet</h3>
                            <p>Generate exam attendance sheets</p>
                        </div>
                    </div>
                </div>

                <!-- Student Management for Admit Cards -->
                <div class="card">
                    <h3 class="card-title">ðŸ‘¨â€ðŸŽ“ Student Management & Admit Cards</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Student Name *</label>
                            <input type="text" id="studentName" placeholder="Enter student name">
                        </div>
                        
                        <div class="form-group">
                            <label>Roll Number *</label>
                            <input type="text" id="studentRoll" placeholder="e.g., 2025001">
                        </div>
                        
                        <div class="form-group">
                            <label>Class *</label>
                            <select id="studentClass">
                                <option value="">-- Select Class --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Section</label>
                            <input type="text" id="studentSection" placeholder="e.g., A" maxlength="1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Father's Name</label>
                            <input type="text" id="studentFather" placeholder="Enter father's name">
                        </div>
                        
                        <div class="form-group">
                            <label>Mother's Name</label>
                            <input type="text" id="studentMother" placeholder="Enter mother's name">
                        </div>
                        
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="studentDOB">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="addStudent()">âž• Add Student</button>
                    <button class="btn btn-success" onclick="bulkImportStudents()">ðŸ“Š Bulk Import</button>
                    
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>Name</th>
                                    <th>Class</th>
                                    <th>Father's Name</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #999;">No students added yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Generate Admit Cards -->
                <div class="card">
                    <h3 class="card-title">ðŸŽ« Generate Admit Cards</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Exam *</label>
                            <select id="admitCardExam">
                                <option value="">-- Select Exam --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Select Class *</label>
                            <select id="admitCardClass" onchange="filterStudentsByClass()">
                                <option value="">-- All Classes --</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #2196F3;">
                        <strong>â„¹ï¸ Admit Card Options:</strong>
                        <div style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <input type="checkbox" id="includePhoto" checked>
                                <span>Include Student Photo</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <input type="checkbox" id="includeParents" checked>
                                <span>Include Parent Names</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="includeInstructions" checked>
                                <span>Include Exam Instructions</span>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="generateAdmitCards()">ðŸŽ« Generate Admit Cards</button>
                    <button class="btn btn-info" onclick="downloadAdmitCardsZip()">ðŸ“¦ Download All (ZIP)</button>
                </div>
            </div>

            <!-- Communication Module Tab -->
            <div id="communication" class="tab-content">
                <h2 class="section-title">ðŸ’¬ Communication Module</h2>
                
                <!-- Quick Stats -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card blue">
                        <h3 id="unreadMessagesCount">0</h3>
                        <p>Unread Messages</p>
                    </div>
                    <div class="stat-card green">
                        <h3 id="totalAnnouncementsCount">0</h3>
                        <p>Active Announcements</p>
                    </div>
                    <div class="stat-card orange">
                        <h3 id="totalNoticesCount">0</h3>
                        <p>Notices Published</p>
                    </div>
                    <div class="stat-card purple">
                        <h3 id="activeChatsCount">0</h3>
                        <p>Active Chats</p>
                    </div>
                </div>

                <!-- Communication Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                    <button class="btn btn-primary" onclick="showCommTab('messages')" id="commTabMessages" style="border-radius: 8px 8px 0 0;">ðŸ’¬ Messages</button>
                    <button class="btn btn-secondary" onclick="showCommTab('announcements')" id="commTabAnnouncements" style="border-radius: 8px 8px 0 0;">ðŸ“¢ Announcements</button>
                    <button class="btn btn-secondary" onclick="showCommTab('notices')" id="commTabNotices" style="border-radius: 8px 8px 0 0;">ðŸ“‹ Notices</button>
                    <button class="btn btn-secondary" onclick="showCommTab('groups')" id="commTabGroups" style="border-radius: 8px 8px 0 0;">ðŸ‘¥ Groups</button>
                </div>

                <!-- Messages Section -->
                <div id="commMessages" class="comm-section">
                    <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 600px;">
                        <!-- Chat List -->
                        <div class="card" style="height: 100%; overflow-y: auto; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">ðŸ’¬ Chats</h3>
                                <button class="btn btn-sm btn-primary" onclick="showNewChatModal()">âž•</button>
                            </div>
                            
                            <div id="chatList"></div>
                        </div>
                        
                        <!-- Chat Window -->
                        <div class="card" style="height: 100%; display: flex; flex-direction: column; padding: 0;">
                            <div id="chatWindow" style="flex: 1; overflow-y: auto; padding: 20px; background: #f5f5f5;">
                                <div style="text-align: center; color: #999; padding: 50px;">
                                    Select a chat to start messaging
                                </div>
                            </div>
                            
                            <div id="chatInput" style="display: none; padding: 15px; border-top: 1px solid #e0e0e0; background: white;">
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="messageInput" placeholder="Type a message..." style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" onkeypress="if(event.key==='Enter') sendMessage()">
                                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Announcements Section -->
                <div id="commAnnouncements" class="comm-section" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">ðŸ“¢ Create Announcement</h3>
                        
                        <div class="form-group">
                            <label>Announcement Title *</label>
                            <input type="text" id="announcementTitle" placeholder="Enter announcement title">
                        </div>
                        
                        <div class="form-group">
                            <label>Message *</label>
                            <textarea id="announcementMessage" rows="4" placeholder="Enter announcement message"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Priority</label>
                                <select id="announcementPriority">
                                    <option value="normal">Normal</option>
                                    <option value="high">High Priority</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Target Audience</label>
                                <select id="announcementAudience">
                                    <option value="all">All Staff</option>
                                    <option value="teachers">Teachers Only</option>
                                    <option value="office">Office Staff Only</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Expiry Date</label>
                                <input type="date" id="announcementExpiry">
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="publishAnnouncement()">ðŸ“¢ Publish Announcement</button>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">ðŸ“‹ Active Announcements</h3>
                        
                        <div id="announcementsList"></div>
                    </div>
                </div>

                <!-- Notices Section -->
                <div id="commNotices" class="comm-section" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">ðŸ“‹ Create Notice</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Notice Number *</label>
                                <input type="text" id="noticeNumber" placeholder="e.g., RHS/2025/001">
                            </div>
                            
                            <div class="form-group">
                                <label>Notice Date *</label>
                                <input type="date" id="noticeDate">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Subject *</label>
                            <input type="text" id="noticeSubject" placeholder="Enter notice subject">
                        </div>
                        
                        <div class="form-group">
                            <label>Notice Content *</label>
                            <textarea id="noticeContent" rows="8" placeholder="Enter detailed notice content"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Category</label>
                                <select id="noticeCategory">
                                    <option value="general">General</option>
                                    <option value="academic">Academic</option>
                                    <option value="administrative">Administrative</option>
                                    <option value="exam">Examination</option>
                                    <option value="event">Event</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Display on Notice Board</label>
                                <select id="noticeDisplay">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="publishNotice()">ðŸ“‹ Publish Notice</button>
                        <button class="btn btn-info" onclick="printNotice()">ðŸ–¨ï¸ Print Notice</button>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">ðŸ“‚ Published Notices</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filter by Category</label>
                                <select id="noticeFilterCategory" onchange="filterNotices()">
                                    <option value="">All Categories</option>
                                    <option value="general">General</option>
                                    <option value="academic">Academic</option>
                                    <option value="administrative">Administrative</option>
                                    <option value="exam">Examination</option>
                                    <option value="event">Event</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Notice No.</th>
                                        <th>Date</th>
                                        <th>Subject</th>
                                        <th>Category</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="noticesTable">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: #999;">No notices published yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Groups Section -->
                <div id="commGroups" class="comm-section" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">ðŸ‘¥ Create Group</h3>
                        
                        <div class="form-group">
                            <label>Group Name *</label>
                            <input type="text" id="groupName" placeholder="e.g., Science Department">
                        </div>
                        
                        <div class="form-group">
                            <label>Group Description</label>
                            <textarea id="groupDescription" rows="2" placeholder="Brief description of the group"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Add Members *</label>
                            <div id="groupMembersSelection" style="max-height: 200px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px;">
                                <!-- Teachers will be listed here with checkboxes -->
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="createGroup()">âž• Create Group</button>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">ðŸ“‹ Existing Groups</h3>
                        
                        <div id="groupsList"></div>
                    </div>
                </div>
            </div>

            <!-- Settings & Configuration Tab -->
            <div id="settings" class="tab-content">
                <h2 class="section-title">âš™ï¸ System Settings & Configuration</h2>

                <!-- Settings Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showSettingsSection('school')" id="settingsSchoolBtn" style="border-radius: 8px 8px 0 0;">ðŸ« School Info</button>
                    <button class="btn btn-secondary" onclick="showSettingsSection('academic')" id="settingsAcademicBtn" style="border-radius: 8px 8px 0 0;">ðŸ“… Academic Year</button>
                    <button class="btn btn-secondary" onclick="showSettingsSection('period')" id="settingsPeriodBtn" style="border-radius: 8px 8px 0 0;">â° Period Timings</button>
                    <button class="btn btn-secondary" onclick="showSettingsSection('working')" id="settingsWorkingBtn" style="border-radius: 8px 8px 0 0;">ðŸ“† Working Days</button>
                    <button class="btn btn-secondary" onclick="showSettingsSection('system')" id="settingsSystemBtn" style="border-radius: 8px 8px 0 0;">ðŸ”§ System</button>
                    <button class="btn btn-secondary" onclick="showSettingsSection('backup')" id="settingsBackupBtn" style="border-radius: 8px 8px 0 0;">ðŸ’¾ Backup</button>
                </div>

                <!-- School Information Section -->
                <div id="settingsSchool" class="settings-section">
                    <div class="card">
                        <h3 class="card-title">ðŸ« School Information</h3>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label>School Name *</label>
                                <input type="text" id="schoolName" placeholder="Enter full school name">
                            </div>
                            
                            <div class="form-group">
                                <label>DISE Code *</label>
                                <input type="text" id="diseCode" placeholder="e.g., 19123456789">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Index No.</label>
                                <input type="text" id="indexNo" placeholder="School index number">
                            </div>
                            
                            <div class="form-group">
                                <label>H.S. Code</label>
                                <input type="text" id="hsCode" placeholder="Higher Secondary code">
                            </div>
                            
                            <div class="form-group">
                                <label>School Code</label>
                                <input type="text" id="schoolCode" placeholder="e.g., RHS001">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Village/Locality *</label>
                                <input type="text" id="schoolLocality" placeholder="Village or locality name">
                            </div>
                            
                            <div class="form-group">
                                <label>Post Office</label>
                                <input type="text" id="schoolPO" placeholder="Post office name">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Police Station</label>
                                <input type="text" id="schoolPS" placeholder="Police station name">
                            </div>
                            
                            <div class="form-group">
                                <label>District *</label>
                                <input type="text" id="schoolDistrict" placeholder="District name">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>PIN Code</label>
                                <input type="text" id="schoolPin" placeholder="PIN Code" maxlength="6">
                            </div>
                            
                            <div class="form-group">
                                <label>State *</label>
                                <input type="text" id="schoolState" placeholder="State name">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" id="schoolPhone" placeholder="Contact number">
                            </div>
                            
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="schoolEmail" placeholder="school@email.com">
                            </div>
                            
                            <div class="form-group">
                                <label>Website</label>
                                <input type="url" id="schoolWebsite" placeholder="www.school.com">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Headmaster Name</label>
                                <input type="text" id="headmasterName" placeholder="Headmaster's name">
                            </div>
                            
                            <div class="form-group">
                                <label>Headmaster Phone</label>
                                <input type="tel" id="headmasterPhone" placeholder="Phone number">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Assistant Headmaster Name</label>
                                <input type="text" id="assistantHeadmasterName" placeholder="Assistant Headmaster's name">
                            </div>
                            
                            <div class="form-group">
                                <label>Assistant Headmaster Phone</label>
                                <input type="tel" id="assistantHeadmasterPhone" placeholder="Phone number">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>School Logo URL (Optional)</label>
                            <input type="url" id="schoolLogo" placeholder="https://example.com/logo.png">
                            <small style="color: #666;">Leave empty to use default. Logo will appear on all printed documents.</small>
                        </div>

                        <div class="form-group">
                            <label>School Motto/Tagline</label>
                            <input type="text" id="schoolMotto" placeholder="e.g., Knowledge is Power">
                        </div>

                        <button class="btn btn-success" onclick="saveSchoolInfo()">ðŸ’¾ Save School Information</button>
                    </div>

                    <!-- Certificate Generator -->
                    <div class="card">
                        <h3 class="card-title">ðŸŽ“ Certificate Generator</h3>
                        
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <strong>â„¹ï¸ Generate Certificates:</strong> Create certificates for students and teachers
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Certificate For *</label>
                                <select id="certificateFor" onchange="updateCertificateOptions()">
                                    <option value="">-- Select --</option>
                                    <option value="student">ðŸ‘¨â€ðŸŽ“ Student</option>
                                    <option value="teacher">ðŸ‘¨â€ðŸ« Teacher</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Certificate Type *</label>
                                <select id="certificateType">
                                    <option value="">-- Select certificate for first --</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label id="certificatePersonLabel">Select Person *</label>
                                <select id="certificatePerson">
                                    <option value="">-- Select certificate type first --</option>
                                </select>
                            </div>
                        </div>

                        <div id="certificateFields"></div>

                        <button class="btn btn-primary" onclick="generateCertificate()">ðŸŽ“ Generate Certificate</button>
                        <button class="btn btn-info" onclick="previewCertificate()">ðŸ‘ï¸ Preview</button>
                    </div>
                </div>

                <!-- Academic Year Settings Section -->
                <div id="settingsAcademic" class="settings-section" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">ðŸ“… Academic Year Configuration</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Current Academic Year *</label>
                                <input type="text" id="academicYear" placeholder="e.g., 2024-2025">
                            </div>
                            
                            <div class="form-group">
                                <label>Session Start Date *</label>
                                <input type="date" id="sessionStartDate">
                            </div>
                            
                            <div class="form-group">
                                <label>Session End Date *</label>
                                <input type="date" id="sessionEndDate">
                            </div>
                        </div>

                        <button class="btn btn-success" onclick="saveAcademicYear()">ðŸ’¾ Save Academic Year</button>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ“š Term/Semester Configuration</h3>
                        
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <strong>â„¹ï¸ Configure Terms/Semesters:</strong> Define how your academic year is divided
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Number of Terms/Semesters *</label>
                                <select id="numberOfTerms" onchange="generateTermInputs()">
                                    <option value="2">2 Terms (Half-Yearly)</option>
                                    <option value="3">3 Terms (Trimester)</option>
                                    <option value="4">4 Terms (Quarter)</option>
                                </select>
                            </div>
                        </div>

                        <div id="termInputsContainer"></div>

                        <button class="btn btn-success" onclick="saveTerms()">ðŸ’¾ Save Terms Configuration</button>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ“‹ Current Terms</h3>
                        <div id="currentTermsList"></div>
                    </div>
                </div>

                <!-- Period Timing Settings Section -->
                <div id="settingsPeriod" class="settings-section" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">â° Period Timing Configuration</h3>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #FF9800;">
                            <strong>âš ï¸ Important:</strong> Changes here will affect all routine displays and reports
                        </div>

                        <div id="periodTimingsEditor"></div>

                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="addNewPeriodTiming()">âž• Add New Period</button>
                            <button class="btn btn-success" onclick="savePeriodTimings()">ðŸ’¾ Save All Timings</button>
                            <button class="btn btn-warning" onclick="resetToDefaultTimings()">ðŸ”„ Reset to Default</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">â° Special Timing (Friday)</h3>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="fridaySpecialTiming" onchange="toggleFridayTimings()">
                                <span>Friday has different timings</span>
                            </label>
                        </div>

                        <div id="fridayTimingsEditor" style="display: none;"></div>

                        <button class="btn btn-success" onclick="saveFridayTimings()" style="display: none;" id="saveFridayBtn">ðŸ’¾ Save Friday Timings</button>
                    </div>
                </div>

                <!-- Working Days Configuration Section -->
                <div id="settingsWorking" class="settings-section" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">ðŸ“† Working Days Configuration</h3>
                        
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4CAF50;">
                            <strong>âœ“ Select Working Days:</strong> Check the days when school is operational
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <label class="working-day-option">
                                <input type="checkbox" value="MONDAY" class="working-day-checkbox" checked>
                                <span>Monday</span>
                            </label>
                            <label class="working-day-option">
                                <input type="checkbox" value="TUESDAY" class="working-day-checkbox" checked>
                                <span>Tuesday</span>
                            </label>
                            <label class="working-day-option">
                                <input type="checkbox" value="WEDNESDAY" class="working-day-checkbox" checked>
                                <span>Wednesday</span>
                            </label>
                            <label class="working-day-option">
                                <input type="checkbox" value="THURSDAY" class="working-day-checkbox" checked>
                                <span>Thursday</span>
                            </label>
                            <label class="working-day-option">
                                <input type="checkbox" value="FRIDAY" class="working-day-checkbox" checked>
                                <span>Friday</span>
                            </label>
                            <label class="working-day-option">
                                <input type="checkbox" value="SATURDAY" class="working-day-checkbox" checked>
                                <span>Saturday</span>
                            </label>
                            <label class="working-day-option">
                                <input type="checkbox" value="SUNDAY" class="working-day-checkbox">
                                <span>Sunday</span>
                            </label>
                        </div>

                        <button class="btn btn-success" onclick="saveWorkingDays()">ðŸ’¾ Save Working Days</button>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸŽ‰ Holiday Configuration</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Holiday Name *</label>
                                <input type="text" id="holidayName" placeholder="e.g., Republic Day">
                            </div>
                            
                            <div class="form-group">
                                <label>Holiday Date *</label>
                                <input type="date" id="holidayDate">
                            </div>
                            
                            <div class="form-group">
                                <label>Holiday Type</label>
                                <select id="holidayType">
                                    <option value="national">National Holiday</option>
                                    <option value="regional">Regional Holiday</option>
                                    <option value="school">School Holiday</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="addHoliday()">âž• Add Holiday</button>

                        <div class="table-container" style="margin-top: 20px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Holiday Name</th>
                                        <th>Type</th>
                                        <th>Day</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="holidaysList">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: #999;">No holidays configured</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- System Settings Section -->
                <div id="settingsSystem" class="settings-section" style="display: none;">
                    <!-- User Password Management -->
                    <div class="card">
                        <h3 class="card-title">ðŸ” System & Security</h3>
                        
                        <h4 style="margin-bottom: 15px;">ðŸ”‘ User Password Management</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Select User Type *</label>
                                <select id="userType" onchange="loadUsersList()">
                                    <option value="">-- Select User Type --</option>
                                    <option value="admin">ðŸ‘¨â€ðŸ’¼ Admin</option>
                                    <option value="teacher">ðŸ‘¨â€ðŸ« Teacher</option>
                                    <option value="office">ðŸ“‹ Office Staff</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Username</label>
                                <select id="username" disabled>
                                    <option value="">-- Select user type first --</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" id="newPassword" placeholder="Enter new password">
                            </div>
                            
                            <div class="form-group">
                                <label>Confirm Password</label>
                                <input type="password" id="confirmPassword" placeholder="Confirm password">
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="changeUserPassword()">ðŸ” Change Password</button>

                        <hr style="margin: 25px 0;">

                        <h4 style="margin-bottom: 15px;">â° Session Settings</h4>

                        <div class="form-group">
                            <label>Auto Logout Time (minutes)</label>
                            <select id="autoLogoutTime">
                                <option value="0">Never</option>
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="120">2 hours</option>
                            </select>
                        </div>

                        <button class="btn btn-success" onclick="saveSessionSettings()">ðŸ’¾ Save Session Settings</button>
                    </div>

                    <!-- Login History -->
                    <div class="card">
                        <h3 class="card-title">ðŸ” Login History</h3>
                        
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <strong>â„¹ï¸ Track all login activities</strong> - Monitor system access for security
                        </div>

                        <button class="btn btn-info" onclick="viewLoginHistory()">ðŸ“œ View Login History</button>

                        <div id="loginHistoryContainer" style="display: none; margin-top: 20px;">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date & Time</th>
                                            <th>User</th>
                                            <th>User Type</th>
                                            <th>IP Address</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="loginHistoryTable">
                                        <tr>
                                            <td colspan="5" style="text-align: center; color: #999;">No login history available</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Settings -->
                    <div class="card">
                        <h3 class="card-title">ðŸ”” Notification Settings</h3>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #FF9800;">
                            <strong>âš¡ Stay Updated:</strong> Configure alerts for important events
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                                <input type="checkbox" id="notifyAbsentTeacher" checked>
                                <div>
                                    <strong>âš ï¸ Absent Teacher Alerts</strong><br>
                                    <small style="color: #666;">Get notified when teachers mark themselves absent</small>
                                </div>
                            </label>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                                <input type="checkbox" id="notifyProvisional" checked>
                                <div>
                                    <strong>ðŸ”„ Provisional Routines</strong><br>
                                    <small style="color: #666;">Receive alerts for provisional routine changes</small>
                                </div>
                            </label>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                                <input type="checkbox" id="notifyConflicts" checked>
                                <div>
                                    <strong>âš¡ Routine Conflicts</strong><br>
                                    <small style="color: #666;">Alert when routine scheduling conflicts occur</small>
                                </div>
                            </label>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                <input type="checkbox" id="notifyExams">
                                <div>
                                    <strong>ðŸŽ“ Exam Notifications</strong><br>
                                    <small style="color: #666;">Get alerts for upcoming exams and duties</small>
                                </div>
                            </label>
                        </div>

                        <button class="btn btn-success" onclick="saveNotificationSettings()">ðŸ’¾ Save Notification Settings</button>
                    </div>

                    <!-- Report & Print Settings -->
                    <div class="card">
                        <h3 class="card-title">ðŸ“„ Report & Print Settings</h3>
                        
                        <div class="form-group">
                            <label>Report Header</label>
                            <select id="reportHeader">
                                <option value="full">Full Letterhead</option>
                                <option value="simple">Simple Header</option>
                                <option value="minimal">Minimal</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Include Digital Signature</label>
                            <select id="digitalSignature">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Default Export Format</label>
                            <select id="defaultExportFormat">
                                <option value="xlsx">Excel (.xlsx)</option>
                                <option value="pdf">PDF</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>

                        <button class="btn btn-success" onclick="saveReportSettings()">ðŸ’¾ Save Report Settings</button>
                    </div>

                    <!-- System Preferences -->
                    <div class="card">
                        <h3 class="card-title">âš™ï¸ System Preferences</h3>
                        
                        <div class="form-group">
                            <label>System Language</label>
                            <select id="systemLanguage">
                                <option value="en">English</option>
                                <option value="bn">Bengali (à¦¬à¦¾à¦‚à¦²à¦¾)</option>
                                <option value="hi">Hindi (à¤¹à¤¿à¤‚à¤¦à¥€)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Date Format</label>
                            <select id="dateFormat">
                                <option value="DD/MM/YYYY">DD/MM/YYYY (Indian)</option>
                                <option value="MM/DD/YYYY">MM/DD/YYYY (US)</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD (ISO)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Time Format</label>
                            <select id="timeFormat">
                                <option value="12">12-hour (AM/PM)</option>
                                <option value="24">24-hour</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="enableBrowserNotifications">
                                <span>Enable Browser Notifications</span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="autoSave" checked>
                                <span>Auto-save changes</span>
                            </label>
                        </div>

                        <button class="btn btn-success" onclick="saveSystemSettings()">ðŸ’¾ Save System Settings</button>
                    </div>

                    <!-- Appearance Settings -->
                    <div class="card">
                        <h3 class="card-title">ðŸŽ¨ Appearance Settings</h3>
                        
                        <div class="form-group">
                            <label>Theme</label>
                            <select id="themePreference" onchange="applyTheme()">
                                <option value="light">Light Mode</option>
                                <option value="dark">Dark Mode</option>
                                <option value="auto">Auto (System)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Primary Color</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <div class="color-option" style="background: #1e3c72;" onclick="setPrimaryColor('#1e3c72')"></div>
                                <div class="color-option" style="background: #2196F3;" onclick="setPrimaryColor('#2196F3')"></div>
                                <div class="color-option" style="background: #4CAF50;" onclick="setPrimaryColor('#4CAF50')"></div>
                                <div class="color-option" style="background: #FF9800;" onclick="setPrimaryColor('#FF9800')"></div>
                                <div class="color-option" style="background: #9C27B0;" onclick="setPrimaryColor('#9C27B0')"></div>
                                <div class="color-option" style="background: #f44336;" onclick="setPrimaryColor('#f44336')"></div>
                            </div>
                        </div>

                        <button class="btn btn-success" onclick="saveAppearanceSettings()">ðŸ’¾ Save Appearance</button>
                    </div>

                    <!-- Data Management -->
                    <div class="card">
                        <h3 class="card-title">ðŸ’¾ Data Management</h3>
                        
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
                            <strong>âš ï¸ Danger Zone:</strong> These actions cannot be undone!
                        </div>

                        <button class="btn btn-warning" onclick="clearAllCache()">ðŸ—‘ï¸ Clear Cache</button>
                        <button class="btn btn-danger" onclick="resetAllSettings()">ðŸ”„ Reset All Settings</button>
                        <button class="btn btn-danger" onclick="deleteAllData()" style="margin-left: 10px;">âŒ Delete All Data</button>
                    </div>
                </div>

                <!-- Backup & Restore Section -->
                <div id="settingsBackup" class="settings-section" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">ðŸ’¾ Backup & Restore</h3>
                        
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <strong>â„¹ï¸ Regular Backups:</strong> Always backup your data before making major changes
                        </div>

                        <h4 style="margin-bottom: 15px;">ðŸ“¥ Create Backup</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <button class="btn btn-success" onclick="createFullBackup()">
                                ðŸ’¾ Full Backup<br>
                                <small style="font-size: 0.85em; opacity: 0.8;">All data (Recommended)</small>
                            </button>
                            <button class="btn btn-info" onclick="createRoutineBackup()">
                                ðŸ“… Routine Only<br>
                                <small style="font-size: 0.85em; opacity: 0.8;">Routine data only</small>
                            </button>
                            <button class="btn btn-info" onclick="createTeacherBackup()">
                                ðŸ‘¨â€ðŸ« Teachers Only<br>
                                <small style="font-size: 0.85em; opacity: 0.8;">Teacher data only</small>
                            </button>
                            <button class="btn btn-info" onclick="createSettingsBackup()">
                                âš™ï¸ Settings Only<br>
                                <small style="font-size: 0.85em; opacity: 0.8;">Configuration only</small>
                            </button>
                        </div>

                        <h4 style="margin-bottom: 15px;">ðŸ“¤ Restore from Backup</h4>
                        
                        <div class="form-group">
                            <label>Select Backup File (JSON)</label>
                            <input type="file" id="backupFile" accept=".json" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>

                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #FF9800;">
                            <strong>âš ï¸ Warning:</strong> Restoring will replace current data!
                        </div>

                        <button class="btn btn-primary" onclick="restoreFromBackup()">ðŸ“¤ Restore Data</button>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ“‹ Backup History</h3>
                        
                        <div id="backupHistory">
                            <p style="text-align: center; color: #999; padding: 20px;">No backups created yet</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ”„ Auto Backup</h3>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="autoBackupEnabled" onchange="toggleAutoBackup()">
                                <span>Enable Automatic Backups</span>
                            </label>
                        </div>

                        <div id="autoBackupSettings" style="display: none;">
                            <div class="form-group">
                                <label>Backup Frequency</label>
                                <select id="autoBackupFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>

                            <button class="btn btn-success" onclick="saveAutoBackupSettings()">ðŸ’¾ Save Auto Backup Settings</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <h2 class="section-title">ðŸ“ˆ Advanced Analytics & Reports</h2>
                
                <!-- Report Type Selector -->
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px;">ðŸ“Š Select Report Type</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <button class="btn" onclick="showAnalyticsSection('overview')" id="analyticsOverviewBtn" style="background: white; color: #667eea; font-weight: 600;">ðŸ“Š Overview</button>
                        <button class="btn" onclick="showAnalyticsSection('workload')" id="analyticsWorkloadBtn" style="background: rgba(255,255,255,0.2); color: white;">ðŸ‘¨â€ðŸ« Workload</button>
                        <button class="btn" onclick="showAnalyticsSection('subjects')" id="analyticsSubjectsBtn" style="background: rgba(255,255,255,0.2); color: white;">ðŸ“š Subjects</button>
                        <button class="btn" onclick="showAnalyticsSection('periods')" id="analyticsPeriodsBtn" style="background: rgba(255,255,255,0.2); color: white;">â° Periods</button>
                        <button class="btn" onclick="showAnalyticsSection('attendance')" id="analyticsAttendanceBtn" style="background: rgba(255,255,255,0.2); color: white;">ðŸ“… Attendance</button>
                        <button class="btn" onclick="showAnalyticsSection('exam')" id="analyticsExamBtn" style="background: rgba(255,255,255,0.2); color: white;">ðŸŽ“ Exams</button>
                    </div>
                </div>

                <!-- Overview Section -->
                <div id="analyticsOverview" class="analytics-section">
                    <!-- Key Metrics Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        <div class="card" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; text-align: center;">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">ðŸ‘¨â€ðŸ«</div>
                            <div style="font-size: 2em; font-weight: bold;" id="analyticsTotalTeachers">0</div>
                            <div style="opacity: 0.9; margin-top: 5px;">Active Teachers</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); color: white; text-align: center;">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">ðŸ“š</div>
                            <div style="font-size: 2em; font-weight: bold;" id="analyticsTotalSubjects">0</div>
                            <div style="opacity: 0.9; margin-top: 5px;">Total Subjects</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%); color: white; text-align: center;">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">ðŸ“…</div>
                            <div style="font-size: 2em; font-weight: bold;" id="analyticsTotalRoutines">0</div>
                            <div style="opacity: 0.9; margin-top: 5px;">Routine Entries</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #9C27B0 0%, #673AB7 100%); color: white; text-align: center;">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">â°</div>
                            <div style="font-size: 2em; font-weight: bold;" id="analyticsAvgLoad">0</div>
                            <div style="opacity: 0.9; margin-top: 5px;">Avg Classes/Teacher</div>
                        </div>
                    </div>

                    <!-- Quick Insights -->
                    <div class="card">
                        <h3 class="card-title">ðŸ’¡ Quick Insights</h3>
                        <div id="quickInsights" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;"></div>
                    </div>

                    <!-- Overall Distribution Chart -->
                    <div class="card">
                        <h3 class="card-title">ðŸ“Š Overall System Overview</h3>
                        <canvas id="overviewChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>

                <!-- Workload Analysis Section -->
                <div id="analyticsWorkload" class="analytics-section" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">ðŸ‘¨â€ðŸ« Teacher Workload Analysis</h3>
                        <canvas id="workloadChart" style="max-height: 400px;"></canvas>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ“‹ Detailed Teacher Workload Report</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Teacher Name</th>
                                        <th>Total Classes</th>
                                        <th>Mon</th>
                                        <th>Tue</th>
                                        <th>Wed</th>
                                        <th>Thu</th>
                                        <th>Fri</th>
                                        <th>Sat</th>
                                        <th>Load %</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="workloadTableBody"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" onclick="downloadWorkloadReport()" style="margin-top: 15px;">ðŸ“¥ Download Report (PDF)</button>
                    </div>
                </div>

                <!-- Subject Analysis Section -->
                <div id="analyticsSubjects" class="analytics-section" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">ðŸ“š Subject Distribution</h3>
                        <canvas id="subjectDistChart" style="max-height: 400px;"></canvas>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ“Š Subject-wise Allocation Report</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Subject</th>
                                        <th>Total Periods</th>
                                        <th>Classes Covered</th>
                                        <th>Teachers Assigned</th>
                                        <th>Weekly Hours</th>
                                        <th>Utilization %</th>
                                    </tr>
                                </thead>
                                <tbody id="subjectAllocationTable"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" onclick="downloadSubjectReport()" style="margin-top: 15px;">ðŸ“¥ Download Report (PDF)</button>
                    </div>
                </div>

                <!-- Period Utilization Section -->
                <div id="analyticsPeriods" class="analytics-section" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">â° Period-wise Utilization</h3>
                        <canvas id="periodDistChart" style="max-height: 350px;"></canvas>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ“… Day-wise Class Distribution</h3>
                        <canvas id="dayDistChart" style="max-height: 350px;"></canvas>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ“Š Period Utilization Report</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Time</th>
                                        <th>Mon</th>
                                        <th>Tue</th>
                                        <th>Wed</th>
                                        <th>Thu</th>
                                        <th>Fri</th>
                                        <th>Sat</th>
                                        <th>Total</th>
                                        <th>Utilization %</th>
                                    </tr>
                                </thead>
                                <tbody id="periodUtilizationTable"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" onclick="downloadPeriodReport()" style="margin-top: 15px;">ðŸ“¥ Download Report (PDF)</button>
                    </div>
                </div>

                <!-- Attendance Analysis Section -->
                <div id="analyticsAttendance" class="analytics-section" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Month</label>
                            <input type="month" id="attendanceMonth" onchange="loadAttendanceAnalytics()">
                        </div>
                        <div class="form-group">
                            <label>Select Teacher</label>
                            <select id="attendanceTeacher" onchange="loadAttendanceAnalytics()">
                                <option value="">All Teachers</option>
                            </select>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ“Š Monthly Attendance Overview</h3>
                        <canvas id="attendanceOverviewChart" style="max-height: 350px;"></canvas>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ“… Attendance Summary Report</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Teacher</th>
                                        <th>Present Days</th>
                                        <th>Absent Days</th>
                                        <th>Leave Days</th>
                                        <th>Total Days</th>
                                        <th>Attendance %</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceSummaryTable"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" onclick="downloadAttendanceReport()" style="margin-top: 15px;">ðŸ“¥ Download Report (PDF)</button>
                    </div>
                </div>

                <!-- Exam Performance Section -->
                <div id="analyticsExam" class="analytics-section" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Exam</label>
                            <select id="examAnalytics" onchange="loadExamAnalytics()">
                                <option value="">-- Select Exam --</option>
                            </select>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸŽ“ Exam Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #1976d2;" id="examTotalStudents">0</div>
                                <div style="color: #666; margin-top: 5px;">Total Students</div>
                            </div>
                            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #f57c00;" id="examTotalPapers">0</div>
                                <div style="color: #666; margin-top: 5px;">Total Papers</div>
                            </div>
                            <div style="background: #d4edda; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #28a745;" id="examInvigilatorsAssigned">0</div>
                                <div style="color: #666; margin-top: 5px;">Invigilators</div>
                            </div>
                            <div style="background: #f8d7da; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #dc3545;" id="examHallsUsed">0</div>
                                <div style="color: #666; margin-top: 5px;">Halls Used</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ“Š Exam Schedule Overview</h3>
                        <canvas id="examScheduleChart" style="max-height: 350px;"></canvas>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ðŸ“‹ Exam Details Report</h3>
                        <div id="examDetailsContent"></div>
                        <button class="btn btn-success" onclick="downloadExamReport()" style="margin-top: 15px;">ðŸ“¥ Download Report (PDF)</button>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="card" style="position: sticky; bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 style="margin-bottom: 15px;">ðŸ“¥ Export & Print Options</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                        <button class="btn" onclick="exportAllAnalyticsExcel()" style="background: white; color: #667eea; font-weight: 600;">ðŸ“Š Excel (All)</button>
                        <button class="btn" onclick="exportCurrentSectionPDF()" style="background: white; color: #667eea; font-weight: 600;">ðŸ“„ PDF (Current)</button>
                        <button class="btn" onclick="printCurrentSection()" style="background: white; color: #667eea; font-weight: 600;">ðŸ–¨ï¸ Print</button>
                        <button class="btn" onclick="refreshAnalytics()" style="background: white; color: #667eea; font-weight: 600;">ðŸ”„ Refresh</button>
                    </div>
                </div>
            </div>

            <!-- ==================== BULK UPLOAD TAB ==================== -->
            <div id="bulkupload" class="tab-content">
                <h2 class="section-title">ðŸ“Š Bulk Upload System</h2>
                
                <!-- Upload Cards Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; margin-bottom: 30px;">
                    
                    <!-- Teacher Upload Card -->
                    <div class="card" style="border-top: 4px solid #1e3c72; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                        <div style="text-align: center; font-size: 3.5em; margin-bottom: 15px;">ðŸ‘¨â€ðŸ«</div>
                        <h3 class="card-title" style="text-align: center;">Teachers Bulk Upload</h3>
                        <p style="text-align: center; color: #666; margin-bottom: 20px;">Upload multiple teachers using Excel template</p>
                        
                        <button class="btn btn-warning" onclick="downloadTeacherTemplate()" style="width: 100%; margin-bottom: 10px;">
                            ðŸ“¥ Download Template
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('teacherBulkFile').click()" style="width: 100%;">
                            ðŸ“¤ Upload Teachers Excel
                        </button>
                        <input type="file" id="teacherBulkFile" accept=".xlsx,.xls" style="display: none;" onchange="uploadTeachersBulk(event)">
                    </div>

                    <!-- Subject Upload Card -->
                    <div class="card" style="border-top: 4px solid #2a5298; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                        <div style="text-align: center; font-size: 3.5em; margin-bottom: 15px;">ðŸ“š</div>
                        <h3 class="card-title" style="text-align: center;">Subjects Bulk Upload</h3>
                        <p style="text-align: center; color: #666; margin-bottom: 20px;">Upload multiple subjects with codes</p>
                        
                        <button class="btn btn-warning" onclick="downloadSubjectTemplate()" style="width: 100%; margin-bottom: 10px;">
                            ðŸ“¥ Download Template
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('subjectBulkFile').click()" style="width: 100%;">
                            ðŸ“¤ Upload Subjects Excel
                        </button>
                        <input type="file" id="subjectBulkFile" accept=".xlsx,.xls" style="display: none;" onchange="uploadSubjectsBulk(event)">
                    </div>

                    <!-- Routine Upload Card -->
                    <div class="card" style="border-top: 4px solid #4CAF50; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                        <div style="text-align: center; font-size: 3.5em; margin-bottom: 15px;">ðŸ“…</div>
                        <h3 class="card-title" style="text-align: center;">Complete Routine Upload</h3>
                        <p style="text-align: center; color: #666; margin-bottom: 20px;">Upload entire routine structure</p>
                        
                        <button class="btn btn-warning" onclick="downloadRoutineTemplate()" style="width: 100%; margin-bottom: 10px;">
                            ðŸ“¥ Download Template
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('routineBulkFile').click()" style="width: 100%;">
                            ðŸ“¤ Upload Routine Excel
                        </button>
                        <input type="file" id="routineBulkFile" accept=".xlsx,.xls" style="display: none;" onchange="uploadRoutineBulk(event)">
                    </div>
                </div>

                <!-- Upload Progress -->
                <div id="uploadProgress" style="display: none; margin-bottom: 25px;">
                    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h3 style="margin-bottom: 15px;">ðŸ“¤ Upload in Progress...</h3>
                        <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 30px; overflow: hidden; margin-bottom: 15px;">
                            <div id="progressBar" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                <span id="progressText">0%</span>
                            </div>
                        </div>
                        <p id="progressMessage" style="margin: 0; opacity: 0.9;">Processing files...</p>
                    </div>
                </div>

                <!-- Upload Summary -->
                <div id="uploadSummary" style="display: none; margin-bottom: 25px;">
                    <div class="card" style="background: #d4edda; border-left: 4px solid #4CAF50;">
                        <h3 style="color: #155724; margin-bottom: 15px;">âœ… Upload Summary</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 2em; font-weight: bold; color: #4CAF50;" id="successCount">0</div>
                                <div style="color: #666; margin-top: 5px;">Successful</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 2em; font-weight: bold; color: #f44336;" id="errorCount">0</div>
                                <div style="color: #666; margin-top: 5px;">Errors</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                <div style="font-size: 2em; font-weight: bold; color: #2196F3;" id="totalProcessed">0</div>
                                <div style="color: #666; margin-top: 5px;">Total</div>
                            </div>
                        </div>
                        <div id="errorDetails" style="margin-top: 15px; display: none;">
                            <h4 style="color: #721c24; margin-bottom: 10px;">âš ï¸ Errors Found:</h4>
                            <ul id="errorList" style="color: #721c24; margin-left: 20px;"></ul>
                        </div>
                    </div>
                </div>

                <!-- AI Auto-Assignment Feature -->
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px;">ðŸ¤– AI-Powered Auto-Assignment</h3>
                    <p style="opacity: 0.95; margin-bottom: 20px;">Automatically generate optimal routine assignments using advanced AI algorithms with workload balancing and conflict detection</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 1.5em; margin-bottom: 8px;">âš¡</div>
                            <div style="font-weight: 600;">Smart Scoring</div>
                            <div style="font-size: 0.9em; opacity: 0.85;">Teacher-subject matching</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 1.5em; margin-bottom: 8px;">âš–ï¸</div>
                            <div style="font-weight: 600;">Workload Balance</div>
                            <div style="font-size: 0.9em; opacity: 0.85;">Even distribution</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 1.5em; margin-bottom: 8px;">ðŸ”</div>
                            <div style="font-weight: 600;">Conflict Detection</div>
                            <div style="font-size: 0.9em; opacity: 0.85;">Zero overlaps</div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="openAIAssignmentModal()" style="width: 100%; margin-top: 20px; background: white; color: #667eea; font-weight: 600; font-size: 16px;">
                        ðŸ¤– Open AI Assignment Tool
                    </button>
                </div>

                <!-- Upload History -->
                <div class="card">
                    <h3 class="card-title">ðŸ“‹ Upload History</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Type</th>
                                    <th>Records</th>
                                    <th>Status</th>
                                    <th>Uploaded By</th>
                                </tr>
                            </thead>
                            <tbody id="uploadHistoryBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 30px; color: #999;">
                                        No upload history yet. Start by uploading some data!
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Instructions Card -->
                <div class="card" style="background: #e3f2fd; border-left: 4px solid #2196F3;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">â„¹ï¸ Upload Instructions</h3>
                    <ul style="color: #555; line-height: 2;">
                        <li>Download the appropriate Excel template for the data type you want to upload</li>
                        <li>Fill in the template with your data following the column headers</li>
                        <li>Do not modify the template structure or column names</li>
                        <li>Upload the filled template using the upload buttons</li>
                        <li>Review the upload summary and fix any errors if needed</li>
                        <li>The system will automatically validate and import your data</li>
                    </ul>
                </div>
            </div>

                        <!-- Settings Tab -->

            <!-- Print Options Tab -->
            <div id="print" class="tab-content">
                <h2 class="section-title">ðŸ–¨ï¸ Print & Share Options</h2>
                
                <!-- Print Section -->
                <div class="print-section">
                    <h3>ðŸ“„ Print Format:</h3>
                    
                    <div class="print-options">
                        <div class="print-option-card" onclick="showPrintModal('teacher')">
                            <h3>ðŸ‘¤ Teacher Routine Cards</h3>
                            <p>Print individual routine cards for each teacher with their complete schedule</p>
                        </div>

                        <div class="print-option-card" onclick="showPrintModal('class')">
                            <h3>ðŸ“š Class-wise Timetable</h3>
                            <p>Print complete timetable for any specific class showing all periods</p>
                        </div>

                        <div class="print-option-card" onclick="showPrintModal('master')">
                            <h3>ðŸ“Š Master Schedule</h3>
                            <p>Print period-wise master schedule showing all classes at once</p>
                        </div>

                        <div class="print-option-card" onclick="showPrintModal('day')">
                            <h3>ðŸ“… Day-wise Schedule</h3>
                            <p>Print complete schedule for any specific day</p>
                        </div>

                        <div class="print-option-card" onclick="showPrintModal('provisional')">
                            <h3>ðŸ”„ Provisional Routine</h3>
                            <p>Print substitute teacher arrangements for absent teachers</p>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Sharing Section -->
                <div class="print-section" style="margin-top: 30px;">
                    <h3>ðŸ“± WhatsApp Sharing:</h3>
                    
                    <div class="print-options">
                        <div class="print-option-card" onclick="showWhatsAppModal('teacher')" style="border-color: #25D366;">
                            <h3>ðŸ‘¨â€ðŸ« Share Teacher Schedule</h3>
                            <p>Send individual teacher's routine via WhatsApp</p>
                        </div>

                        <div class="print-option-card" onclick="showWhatsAppModal('class')" style="border-color: #25D366;">
                            <h3>ðŸ“š Share Class Routine</h3>
                            <p>Share complete class timetable on WhatsApp</p>
                        </div>

                        <div class="print-option-card" onclick="showWhatsAppModal('day')" style="border-color: #25D366;">
                            <h3>ðŸ“… Share Day Schedule</h3>
                            <p>Share today's or any day's complete schedule</p>
                        </div>

                        <div class="print-option-card" onclick="showWhatsAppModal('provisional')" style="border-color: #FF9800;">
                            <h3>ðŸ”„ Share Provisional Routine</h3>
                            <p>Share provisional/substitute routine for absent teachers</p>
                        </div>

                        <div class="print-option-card" onclick="showWhatsAppModal('custom')" style="border-color: #25D366;">
                            <h3>âœï¸ Custom Message</h3>
                            <p>Create and share custom routine message</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Tab -->
            <div id="users" class="tab-content">
                <h2 class="section-title"><span>ðŸ‘¥</span> User Management & Authentication</h2>
                
                <!-- Quick Actions -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-success" id="btnAddUser">âž• Add New User</button>
                    <button class="btn btn-info" id="btnChangePassword">ðŸ”‘ Change Password</button>
                    <button class="btn btn-warning" id="btnLoginHistory">ðŸ“‹ Login History</button>
                    <button class="btn btn-secondary" id="btnExportUsers">ðŸ“¥ Export Users</button>
                </div>
                
                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="stat-number" id="totalUsersCount">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stat-number" id="adminUsersCount">0</div>
                        <div class="stat-label">Admin Users</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stat-number" id="teacherUsersCount">0</div>
                        <div class="stat-label">Teachers</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stat-number" id="officeUsersCount">0</div>
                        <div class="stat-label">Office Staff</div>
                    </div>
                </div>
                
                <!-- User List -->
                <div class="card">
                    <h3 class="card-title">ðŸ‘¥ All Users</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Role</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Role Permissions Info -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title">ðŸ” Role-Based Permissions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="padding: 15px; background: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 8px;">
                            <h4 style="color: #1976D2; margin-bottom: 10px;">ðŸ‘¨â€ðŸ’¼ Admin Role</h4>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>Full system access</li>
                                <li>Manage all users</li>
                                <li>Configure settings</li>
                                <li>View all reports</li>
                                <li>Data backup/restore</li>
                            </ul>
                        </div>
                        <div style="padding: 15px; background: #f3e5f5; border-left: 4px solid #9C27B0; border-radius: 8px;">
                            <h4 style="color: #7B1FA2; margin-bottom: 10px;">ðŸ‘¨â€ðŸ« Teacher Role</h4>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>View own schedule</li>
                                <li>Mark attendance</li>
                                <li>View students</li>
                                <li>Limited reports</li>
                                <li>No system changes</li>
                            </ul>
                        </div>
                        <div style="padding: 15px; background: #e8f5e9; border-left: 4px solid #4CAF50; border-radius: 8px;">
                            <h4 style="color: #388E3C; margin-bottom: 10px;">ðŸ“‹ Office Staff Role</h4>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>Manage attendance</li>
                                <li>Post notices</li>
                                <li>View routines</li>
                                <li>Generate reports</li>
                                <li>No user management</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar/Planner Tab -->
            <div id="calendar" class="tab-content">
                <h2 class="section-title"><span>ðŸ“…</span> Academic Calendar & Planner</h2>
                
                <!-- Calendar Navigation -->
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <button class="btn btn-secondary" onclick="changeCalendarMonth(-1)">â† Previous</button>
                        <div style="text-align: center;">
                            <h2 id="calendarMonthYear" style="margin: 0; color: var(--primary);">January 2026</h2>
                            <button class="btn btn-sm btn-info" onclick="goToToday()" style="margin-top: 5px;">ðŸ“ Today</button>
                        </div>
                        <button class="btn btn-secondary" onclick="changeCalendarMonth(1)">Next â†’</button>
                    </div>
                </div>
                
                <!-- Calendar View Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary active-view" id="monthViewBtn" onclick="switchCalendarView('month')">ðŸ“… Month View</button>
                    <button class="btn btn-secondary" id="weekViewBtn" onclick="switchCalendarView('week')">ðŸ“Š Week View</button>
                    <button class="btn btn-secondary" id="agendaViewBtn" onclick="switchCalendarView('agenda')">ðŸ“‹ Agenda</button>
                </div>
                
                <!-- Month View Calendar -->
                <div id="monthViewCalendar" class="card">
                    <div id="calendarGrid" class="calendar-grid"></div>
                </div>
                
                <!-- Week View -->
                <div id="weekViewCalendar" class="card" style="display: none;">
                    <div id="weekCalendarGrid"></div>
                </div>
                
                <!-- Agenda View -->
                <div id="agendaViewCalendar" class="card" style="display: none;">
                    <div id="agendaList"></div>
                </div>
                
                <!-- Quick Actions -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="addCalendarEvent()">
                        <span style="font-size: 1.2em;">ðŸ“…</span><br>Add Event
                    </button>
                    <button class="btn btn-warning" onclick="addCalendarHoliday()">
                        <span style="font-size: 1.2em;">ðŸ–ï¸</span><br>Add Holiday
                    </button>
                    <button class="btn btn-info" onclick="addCalendarExam()">
                        <span style="font-size: 1.2em;">ðŸŽ“</span><br>Add Exam
                    </button>
                    <button class="btn btn-primary" onclick="viewAcademicCalendar()">
                        <span style="font-size: 1.2em;">ðŸ“†</span><br>Academic Calendar
                    </button>
                </div>
                
                <!-- Upcoming Events -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title">ðŸ”” Upcoming Events & Important Dates</h3>
                    <div id="upcomingEventsList"></div>
                </div>
                
                <!-- Legend -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title">ðŸŽ¨ Legend</h3>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #4CAF50; border-radius: 4px;"></div>
                            <span>Event</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #FF9800; border-radius: 4px;"></div>
                            <span>Holiday</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #2196F3; border-radius: 4px;"></div>
                            <span>Exam</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #9C27B0; border-radius: 4px;"></div>
                            <span>Meeting</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #f44336; border-radius: 4px;"></div>
                            <span>Important</span>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Footer -->
        <div class="footer">
            <strong>RHS PRMS v4.5 Enhanced</strong> - Complete Routine Management System | 
            Developed with ðŸ’– by <strong>Tapas Mahata</strong> | Â© 2025 Ramnagar High School
        </div>
    </div>

    <script>
        // ==================== UTILITY FUNCTIONS ====================
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            if (alertBox) {
                alertBox.className = `alert alert-${type} show`;
                alertBox.textContent = message;
                setTimeout(() => alertBox.classList.remove('show'), 3000);
            }
        }

        function showLoading(show, text = 'Processing...') {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                document.getElementById('loadingText').textContent = text;
                overlay.classList.toggle('show', show);
            }
        }

        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                    <h2 style="color: var(--primary); margin-bottom: 20px;">${title}</h2>
                    ${content}
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ==================== DATABASE SYSTEM ====================
        const DB = {
            get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            getObj: (key) => JSON.parse(localStorage.getItem(key) || '{}'),
            setObj: (key, data) => localStorage.setItem(key, JSON. stringify(data)),
            clear: () => localStorage.clear()
        };

               // ==================== AUTHENTICATION ====================
        const USERS = {
            admin: { password: 'admin123', name:  'Administrator', role: 'admin' },
            teacher: { password: 'teacher123', name: 'Teacher', role: 'teacher' },
            office: { password: 'office123', name: 'Office Staff', role: 'office' }
        };

        function login(event) {
            event.preventDefault();
            
            // Initialize users if not exists
            initializeUsers();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const role = document.getElementById('loginRole').value;
            
            if (!role) {
                showAlert('âš ï¸ Please select a role!', 'error');
                return;
            }
            
            // Get users from new system
            const users = DB.get('systemUsers') || [];
            const user = users.find(u => u.username === username);
            
            // Verify credentials
            if (!user) {
                showAlert('âŒ Invalid username!', 'error');
                return;
            }
            
            if (user.password !== hashPassword(password)) {
                showAlert('âŒ Invalid password!', 'error');
                return;
            }
            
            if (user.role !== role) {
                showAlert('âŒ Invalid role selected!', 'error');
                return;
            }
            
            if (user.status !== 'active') {
                showAlert('âŒ Your account is inactive. Please contact admin.', 'error');
                return;
            }
            
            // Update last login
            user.lastLogin = new Date().toISOString();
            DB.set('systemUsers', users);
            
            // Set session
            sessionStorage.setItem('loggedIn', 'true');
            sessionStorage.setItem('username', user.fullName);
            sessionStorage.setItem('currentUsername', user.username);
            sessionStorage.setItem('role', role);
            
            // Login history
            const loginHistory = DB.get('loginHistory') || [];
            loginHistory.push({
                username: user.fullName,
                role: role,
                loginTime: new Date().toISOString(),
                timestamp: Date.now()
            });
            if (loginHistory.length > 100) {
                loginHistory.shift();
            }
            DB.set('loginHistory', loginHistory);
            
            // Show main app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update user display name
            const userDisplayElement = document.getElementById('loggedInUser');
            if (userDisplayElement) {
                userDisplayElement.textContent = user.fullName;
            }
            
            showAlert('âœ… Login successful! Welcome ' + user.fullName, 'success');
            
            // Send notification
            NotificationCenter.add({
                title: 'ðŸŽ‰ Welcome!',
                message: `Logged in as ${user.fullName} (${role})`,
                type: 'success',
                category: 'system'
            });
            
            loadDashboard();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.clear();
                location.reload();
            }
        }

        // âœ… LOGIN HISTORY VIEWER
        function showLoginHistory() {
            const history = DB.get('loginHistory') || [];
            const table = document.getElementById('loginHistoryTable');
            const tbody = document.getElementById('loginHistoryBody');
            
            if (history.length === 0) {
                showAlert('No login history found', 'info');
                return;
            }
            
            // Show table
            table.style.display = 'block';
            
            // Reverse to show latest first
            const sortedHistory = [...history].reverse();
            
            tbody.innerHTML = sortedHistory.map(entry => `
                <tr>
                    <td><strong>${entry.username}</strong></td>
                    <td><span class="status-badge" style="background: #e3f2fd; color: #1976d2;">${entry.role.toUpperCase()}</span></td>
                    <td>${new Date(entry.loginTime).toLocaleString('en-IN', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    })}</td>
                </tr>
            `).join('');
        }

        // âœ… PDF EXPORT SYSTEM
        function exportRoutineToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
            
            const routines = DB.get('routines') || [];
            if (routines.length === 0) {
                showAlert('âŒ No routine data to export!', 'error');
                return;
            }
            
            // Header
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('RAMNAGAR HIGH SCHOOL (H.S.)', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text('Complete Class Routine', 105, 30, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString('en-IN')}`, 105, 40, { align: 'center' });
            
            // Prepare table data
            const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
            const periods = DB.get('periods') || [];
            const tableData = [];
            const classes = [...new Set(routines.map(r => r.className))].sort();
            
            classes.forEach(className => {
                days.forEach(day => {
                    const dayRoutines = routines.filter(r => r.className === className && r.day === day);
                    if (dayRoutines.length > 0) {
                        dayRoutines.forEach(r => {
                            tableData.push([
                                r.day,
                                `Period ${r.periodNumber}`,
                                r.className,
                                r.subjectName,
                                r.teacherName
                            ]);
                        });
                    }
                });
            });
            
            doc.autoTable({
                head: [['Day', 'Period', 'Class', 'Subject', 'Teacher']],
                body: tableData,
                startY: 60,
                theme: 'grid',
                headStyles: { fillColor: [30, 60, 114], textColor: 255, fontStyle: 'bold' },
                styles: { fontSize: 10, cellPadding: 5 }
            });
            
            doc.save('RHS_Routine_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('âœ… PDF exported successfully!', 'success');
        }

        // âœ… EXPORT ROUTINE TO EXCEL (Enhanced)
        function exportRoutineToExcel() {
            const routines = DB.get('routines');
            if (routines.length === 0) {
                showAlert('No routine data to export', 'error');
                return;
            }
            
            const data = routines.map(r => ({
                'Day': r.day,
                'Period': r.periodNumber,
                'Class': r.className,
                'Subject': r.subjectName,
                'Teacher': r.teacherName
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Routine');
            
            const schoolInfo = SecureDB.getObj('schoolInfo') || {};
            const fileName = `Routine_${schoolInfo.name || 'RHS'}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showAlert('âœ… Excel exported successfully!', 'success');
        }

        // âœ… AUTO-SAVE SYSTEM
        function enableAutoSave() {
            setInterval(() => {
                const autoSaveData = {
                    teachers: DB.get('teachers'),
                    subjects: DB.get('subjects'),
                    classes: DB.get('classes'),
                    periods: DB.get('periods'),
                    routines: DB.get('routines'),
                    attendance: DB.get('attendance'),
                    lastAutoSave: new Date().toISOString()
                };
                localStorage.setItem('autoSaveBackup', JSON.stringify(autoSaveData));
                console.log('âœ… Auto-saved at', new Date().toLocaleTimeString());
            }, 60000); // Every 1 minute
        }

        // âœ… BENGALI TRANSLATION SYSTEM
        const translations = {
            en: {
                dashboard: 'Dashboard', teachers: 'Teachers', subjects: 'Subjects',
                classes: 'Classes', periods: 'Periods', routine: 'Routine',
                attendance: 'Attendance', provisional: 'Provisional', analytics: 'Analytics',
                settings: 'Settings', logout: 'Logout'
            },
            bn: {
                dashboard: 'à¦¡à§à¦¯à¦¾à¦¶à¦¬à§‹à¦°à§à¦¡', teachers: 'à¦¶à¦¿à¦•à§à¦·à¦•', subjects: 'à¦¬à¦¿à¦·à¦¯à¦¼',
                classes: 'à¦•à§à¦²à¦¾à¦¸', periods: 'à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡', routine: 'à¦°à§à¦Ÿà¦¿à¦¨',
                attendance: 'à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤à¦¿', provisional: 'à¦…à¦¸à§à¦¥à¦¾à¦¯à¦¼à§€', analytics: 'à¦¬à¦¿à¦¶à§à¦²à§‡à¦·à¦£',
                settings: 'à¦¸à§‡à¦Ÿà¦¿à¦‚à¦¸', logout: 'à¦ªà§à¦°à¦¸à§à¦¥à¦¾à¦¨'
            }
        };

        function changeLanguage(lang) {
            localStorage.setItem('selectedLanguage', lang);
            
            // Update nav tabs
            const navTabs = {
                'Dashboard': 'dashboard', 'Teachers': 'teachers', 'Subjects': 'subjects',
                'Classes': 'classes', 'Periods': 'periods', 'Routine': 'routine',
                'Attendance': 'attendance', 'Provisional': 'provisional', 
                'Analytics': 'analytics', 'Settings': 'settings'
            };
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                const text = tab.textContent.trim().split(' ')[1]; // Get text after emoji
                if (text && translations[lang][text.toLowerCase()]) {
                    const emoji = tab.textContent.trim().split(' ')[0];
                    tab.innerHTML = emoji + ' ' + translations[lang][text.toLowerCase()];
                }
            });
            
            showAlert(lang === 'bn' ? 'âœ… à¦­à¦¾à¦·à¦¾ à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦¸à¦«à¦²!' : 'âœ… Language changed!', 'success');
        }

        function loadSavedLanguage() {
            const lang = localStorage.getItem('selectedLanguage') || 'en';
            const select = document.getElementById('languageSelect');
            if (select) {
                select.value = lang;
                if (lang === 'bn') changeLanguage('bn');
            }
        }

        // âœ… NOTICE BOARD SYSTEM
        function addNotice() {
            const title = prompt('Notice Title / à¦¶à¦¿à¦°à§‹à¦¨à¦¾à¦®:');
            const message = prompt('Notice Message / à¦¬à¦¾à¦°à§à¦¤à¦¾:');
            
            if (title && message) {
                const notices = DB.get('notices') || [];
                notices.push({
                    id: Date.now(),
                    title,
                    message,
                    date: new Date().toISOString(),
                    author: sessionStorage.getItem('username') || 'Admin'
                });
                DB.set('notices', notices);
                displayNotices();
                showAlert('âœ… Notice published!', 'success');
            }
        }

        function displayNotices() {
            const notices = DB.get('notices') || [];
            const container = document.getElementById('noticeList');
            if (!container) return;
            
            if (notices.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No notices yet</p>';
                return;
            }
            
            container.innerHTML = notices.reverse().slice(0, 5).map(n => `
                <div style="border-left: 4px solid var(--primary); padding: 15px; margin: 10px 0; background: var(--card); border-radius: 8px;">
                    <h4 style="color: var(--primary); margin-bottom: 8px;">${n.title}</h4>
                    <p style="margin: 10px 0;">${n.message}</p>
                    <small style="color: #999;">By ${n.author} on ${new Date(n.date).toLocaleDateString('en-IN')}</small>
                    <button onclick="deleteNotice(${n.id})" style="float: right; background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">ðŸ—‘ï¸ Delete</button>
                </div>
            `).join('');
        }

        function deleteNotice(id) {
            if (confirm('Delete this notice?')) {
                let notices = DB.get('notices') || [];
                notices = notices.filter(n => n.id !== id);
                DB.set('notices', notices);
                displayNotices();
                showAlert('âœ… Notice deleted', 'success');
            }
        }

        // âœ… EVENT SCHEDULER
        function addEvent() {
            const name = prompt('Event Name / à¦‡à¦­à§‡à¦¨à§à¦Ÿà§‡à¦° à¦¨à¦¾à¦®:');
            const date = prompt('Event Date (YYYY-MM-DD):');
            const description = prompt('Description (optional):');
            
            if (name && date) {
                const events = DB.get('events') || [];
                events.push({
                    id: Date.now(),
                    name,
                    date,
                    description: description || '',
                    createdBy: sessionStorage.getItem('username')
                });
                DB.set('events', events);
                displayEvents();
                showAlert('âœ… Event added!', 'success');
            }
        }

        function displayEvents() {
            const events = DB.get('events') || [];
            const container = document.getElementById('eventList');
            if (!container) return;
            
            // Sort by date
            const sortedEvents = events.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (sortedEvents.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No upcoming events</p>';
                return;
            }
            
            container.innerHTML = sortedEvents.map(e => {
                const eventDate = new Date(e.date);
                const today = new Date();
                const isPast = eventDate < today;
                
                return `
                    <div style="padding: 12px; border-left: 3px solid ${isPast ? '#999' : 'var(--primary)'}; margin: 8px 0; background: var(--card); border-radius: 6px; ${isPast ? 'opacity: 0.6;' : ''}">
                        <strong style="color: ${isPast ? '#999' : 'var(--primary)'};">${e.name}</strong>
                        <br><small>${eventDate.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</small>
                        ${e.description ? `<br><small style="color: #666;">${e.description}</small>` : ''}
                        <button onclick="deleteEvent(${e.id})" style="float: right; background: #f44336; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">ðŸ—‘ï¸</button>
                    </div>
                `;
            }).join('');
        }

        function deleteEvent(id) {
            if (confirm('Delete this event?')) {
                let events = DB.get('events') || [];
                events = events.filter(e => e.id !== id);
                DB.set('events', events);
                displayEvents();
                showAlert('âœ… Event deleted', 'success');
            }
        }

        // âœ… CERTIFICATE GENERATOR
        // âœ… CERTIFICATE MENU SELECTOR
        function generateCertificate() {
            const certType = prompt('Select Certificate Type:\n\n1. School Leaving Certificate (Student)\n2. Identity Certificate (Teacher)\n3. Experience Certificate (Teacher)\n4. Appreciation Certificate\n\nEnter 1, 2, 3, or 4:');
            
            switch(certType) {
                case '1':
                    generateSchoolLeavingCertificate();
                    break;
                case '2':
                    generateIdentityCertificate();
                    break;
                case '3':
                    generateExperienceCertificate();
                    break;
                case '4':
                    generateAppreciationCertificate();
                    break;
                default:
                    showAlert('âŒ Invalid selection!', 'error');
            }
        }

        // âœ… 1. SCHOOL LEAVING CERTIFICATE
        function generateSchoolLeavingCertificate() {
            const studentName = prompt('Student Name (à¦ªà§à¦°à§‹ à¦¨à¦¾à¦®):');
            const fatherName = prompt("Father's Name:");
            const motherName = prompt("Mother's Name:");
            const className = prompt('Class (e.g., X, XII):');
            const admissionYear = prompt('Admission Year (e.g., 2020):');
            const leavingYear = prompt('Leaving Year (e.g., 2024):');
            const tcNumber = prompt('TC Number:') || `TC${Date.now()}`;
            const character = prompt('Character (e.g., Good, Excellent):') || 'Good';
            const reason = prompt('Reason for leaving:') || 'Completed course';
            
            if (!studentName || !fatherName || !motherName || !className) {
                showAlert('âŒ Please fill all required fields!', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // Portrait
            
            // Header - School Name
            doc.setFillColor(30, 60, 114);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('RAMNAGAR HIGH SCHOOL (H.S.)', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Uttar Ramnagar, P.O. Ausgram, Dist. Purba Bardhaman', 105, 23, { align: 'center' });
            doc.text('DISE: 19090310603 | Index No: H/1174', 105, 30, { align: 'center' });
            
            // Certificate Title
            doc.setTextColor(30, 60, 114);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('SCHOOL LEAVING CERTIFICATE', 105, 50, { align: 'center' });
            
            doc.setLineWidth(0.5);
            doc.setDrawColor(30, 60, 114);
            doc.line(40, 53, 170, 53);
            
            // TC Number and Date
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(`TC No: ${tcNumber}`, 20, 65);
            doc.text(`Date: ${new Date().toLocaleDateString('en-IN')}`, 150, 65);
            
            // Certificate Body
            let yPos = 80;
            const lineHeight = 10;
            
            doc.setFontSize(12);
            
            // Student Details
            doc.text(`1. Name of Student:`, 25, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(studentName, 80, yPos);
            doc.setFont(undefined, 'normal');
            
            yPos += lineHeight;
            doc.text(`2. Father's Name:`, 25, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(fatherName, 80, yPos);
            doc.setFont(undefined, 'normal');
            
            yPos += lineHeight;
            doc.text(`3. Mother's Name:`, 25, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(motherName, 80, yPos);
            doc.setFont(undefined, 'normal');
            
            yPos += lineHeight;
            doc.text(`4. Class in which studying:`, 25, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(`Class ${className}`, 80, yPos);
            doc.setFont(undefined, 'normal');
            
            yPos += lineHeight;
            doc.text(`5. Date of Admission:`, 25, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(`01/01/${admissionYear}`, 80, yPos);
            doc.setFont(undefined, 'normal');
            
            yPos += lineHeight;
            doc.text(`6. Date of Leaving:`, 25, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(new Date().toLocaleDateString('en-IN'), 80, yPos);
            doc.setFont(undefined, 'normal');
            
            yPos += lineHeight;
            doc.text(`7. Character & Conduct:`, 25, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(character, 80, yPos);
            doc.setFont(undefined, 'normal');
            
            yPos += lineHeight;
            doc.text(`8. Reason for leaving:`, 25, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(reason, 80, yPos);
            doc.setFont(undefined, 'normal');
            
            // Footer - Signatures
            yPos = 220;
            doc.setFontSize(11);
            doc.text('Counter Signed', 30, yPos);
            doc.text('Head Master / Principal', 140, yPos);
            
            doc.line(25, yPos + 5, 65, yPos + 5);
            doc.line(135, yPos + 5, 185, yPos + 5);
            
            doc.text('Class Teacher', 30, yPos + 10);
            doc.text('(With School Seal)', 140, yPos + 10);
            
            // Decorative border
            doc.setLineWidth(1);
            doc.setDrawColor(30, 60, 114);
            doc.rect(15, 45, 180, 215);
            
            doc.save(`School_Leaving_Certificate_${studentName.replace(/\s+/g, '_')}.pdf`);
            showAlert('âœ… School Leaving Certificate generated!', 'success');
        }

        // âœ… 2. TEACHER IDENTITY CERTIFICATE
        function generateIdentityCertificate() {
            const teacherName = prompt('Teacher Name (à¦ªà§à¦°à§‹ à¦¨à¦¾à¦®):');
            const designation = prompt('Designation (e.g., Assistant Teacher, TIC):') || 'Assistant Teacher';
            const subject = prompt('Subject (e.g., Mathematics, English):');
            const employeeId = prompt('Employee ID:') || `EMP${Date.now()}`;
            const joiningDate = prompt('Joining Date (DD/MM/YYYY):');
            const bloodGroup = prompt('Blood Group (optional):') || 'N/A';
            const mobile = prompt('Mobile Number:');
            
            if (!teacherName || !subject) {
                showAlert('âŒ Please fill required fields!', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', [90, 55]); // ID Card size
            
            // Front Side
            // Background
            doc.setFillColor(30, 60, 114);
            doc.rect(0, 0, 90, 55, 'F');
            
            // School Name
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('RAMNAGAR HIGH SCHOOL', 45, 8, { align: 'center' });
            
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            doc.text('Ausgram, Purba Bardhaman', 45, 12, { align: 'center' });
            
            // White card area
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(5, 15, 80, 37, 2, 2, 'F');
            
            // Photo placeholder
            doc.setFillColor(220, 220, 220);
            doc.rect(8, 18, 20, 25, 'F');
            doc.setFontSize(6);
            doc.setTextColor(100, 100, 100);
            doc.text('PHOTO', 18, 31, { align: 'center' });
            
            // Details
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text(teacherName.toUpperCase(), 32, 22);
            
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            doc.text(`${designation}`, 32, 27);
            doc.text(`Subject: ${subject}`, 32, 31);
            doc.text(`ID: ${employeeId}`, 32, 35);
            doc.text(`Mobile: ${mobile}`, 32, 39);
            doc.text(`Blood: ${bloodGroup}`, 32, 43);
            
            // Footer
            doc.setFontSize(6);
            doc.setTextColor(30, 60, 114);
            doc.text('Authorized Signature', 55, 49);
            doc.line(50, 50, 78, 50);
            
            doc.save(`ID_Card_${teacherName.replace(/\s+/g, '_')}.pdf`);
            showAlert('âœ… Identity Certificate generated!', 'success');
        }

        // âœ… 3. EXPERIENCE CERTIFICATE
        function generateExperienceCertificate() {
            const teacherName = prompt('Teacher Name (à¦ªà§à¦°à§‹ à¦¨à¦¾à¦®):');
            const designation = prompt('Designation:') || 'Assistant Teacher';
            const subject = prompt('Subject:');
            const joiningDate = prompt('Joining Date (DD/MM/YYYY):');
            const leavingDate = prompt('Leaving Date (DD/MM/YYYY):') || new Date().toLocaleDateString('en-IN');
            const conduct = prompt('Conduct & Character:') || 'Excellent';
            const reason = prompt('Reason for leaving:') || 'Personal';
            
            if (!teacherName || !subject || !joiningDate) {
                showAlert('âŒ Please fill required fields!', 'error');
                return;
            }
            
            // Calculate service duration
            const joining = new Date(joiningDate.split('/').reverse().join('-'));
            const leaving = new Date(leavingDate.split('/').reverse().join('-'));
            const years = Math.floor((leaving - joining) / (365.25 * 24 * 60 * 60 * 1000));
            const months = Math.floor(((leaving - joining) % (365.25 * 24 * 60 * 60 * 1000)) / (30.44 * 24 * 60 * 60 * 1000));
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Letterhead
            doc.setFillColor(30, 60, 114);
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text('RAMNAGAR HIGH SCHOOL (H.S.)', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Uttar Ramnagar, P.O. Ausgram, Dist. Purba Bardhaman - 713152', 105, 22, { align: 'center' });
            doc.text('DISE: 19090310603 | Phone: [School Phone]', 105, 28, { align: 'center' });
            
            // Title
            doc.setTextColor(30, 60, 114);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('EXPERIENCE CERTIFICATE', 105, 50, { align: 'center' });
            
            doc.setLineWidth(0.5);
            doc.line(55, 53, 155, 53);
            
            // Certificate Number and Date
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(`Cert. No: EXP/${new Date().getFullYear()}/${Date.now().toString().slice(-4)}`, 20, 65);
            doc.text(`Date: ${new Date().toLocaleDateString('en-IN')}`, 150, 65);
            
            // Body
            doc.setFontSize(12);
            let yPos = 85;
            
            doc.text('TO WHOM IT MAY CONCERN', 105, yPos, { align: 'center' });
            yPos += 15;
            
            doc.setFontSize(11);
            const bodyText = [
                `This is to certify that ${teacherName} has worked in this institution as`,
                `${designation} in ${subject} department from ${joiningDate} to ${leavingDate}.`,
                '',
                `During this period of ${years} year(s) and ${months} month(s), ${teacherName.split(' ')[0]}`,
                `has performed duties with dedication and sincerity. ${teacherName.split(' ')[0]}'s conduct`,
                `and character has been ${conduct} throughout the service period.`,
                '',
                `${teacherName.split(' ')[0]} is leaving the institution due to ${reason}.`,
                '',
                'We wish him/her all the best for future endeavors.'
            ];
            
            bodyText.forEach(line => {
                doc.text(line, 25, yPos);
                yPos += 8;
            });
            
            // Signature section
            yPos = 230;
            doc.setFontSize(11);
            doc.text('Issued by:', 25, yPos);
            
            yPos += 20;
            doc.line(25, yPos, 80, yPos);
            doc.text('Head Master / Principal', 25, yPos + 5);
            doc.text('Ramnagar High School (H.S.)', 25, yPos + 10);
            
            // School Seal placeholder
            doc.setDrawColor(30, 60, 114);
            doc.setLineWidth(2);
            doc.circle(160, yPos - 10, 15);
            doc.setFontSize(8);
            doc.text('SCHOOL', 160, yPos - 12, { align: 'center' });
            doc.text('SEAL', 160, yPos - 6, { align: 'center' });
            
            // Border
            doc.setDrawColor(30, 60, 114);
            doc.setLineWidth(1);
            doc.rect(15, 40, 180, 240);
            
            doc.save(`Experience_Certificate_${teacherName.replace(/\s+/g, '_')}.pdf`);
            showAlert('âœ… Experience Certificate generated!', 'success');
        }

        // âœ… 4. APPRECIATION CERTIFICATE (Original)
        function generateAppreciationCertificate() {
            const name = prompt('Name:');
            if (!name) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            // Border
            doc.setLineWidth(10);
            doc.setDrawColor(30, 60, 114);
            doc.rect(10, 10, 277, 190);
            
            doc.setLineWidth(3);
            doc.setDrawColor(42, 82, 152);
            doc.rect(15, 15, 267, 180);
            
            // Header
            doc.setFontSize(32);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(30, 60, 114);
            doc.text('CERTIFICATE OF APPRECIATION', 148.5, 50, { align: 'center' });
            
            // Body
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('This is to certify that', 148.5, 80, { align: 'center' });
            
            doc.setFontSize(28);
            doc.setFont(undefined, 'bolditalic');
            doc.setTextColor(30, 60, 114);
            doc.text(name, 148.5, 100, { align: 'center' });
            
            doc.setLineWidth(0.5);
            doc.line(70, 102, 227, 102);
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text('has been recognized for outstanding contribution', 148.5, 120, { align: 'center' });
            doc.text('at Ramnagar High School (H.S.)', 148.5, 135, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Date: ${new Date().toLocaleDateString('en-IN')}`, 50, 170);
            doc.text('_________________', 200, 170);
            doc.text("Principal's Signature", 200, 178, { align: 'left' });
            
            doc.save(`Certificate_${name.replace(/\s+/g, '_')}.pdf`);
            showAlert('âœ… Certificate generated!', 'success');
        }

        // âœ… CUSTOM CERTIFICATE UPLOAD & GENERATION
        let customCertificateData = null;

        function uploadCustomCertificate() {
            const fileInput = document.getElementById('customCertUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('âŒ Please select a file first!', 'error');
                return;
            }
            
            // Check file type
            const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
                               'application/msword', 'image/jpeg', 'image/jpg', 'image/png'];
            
            if (!validTypes.includes(file.type)) {
                showAlert('âŒ Invalid file type! Please upload PDF, DOCX, or Image (JPG/PNG)', 'error');
                return;
            }
            
            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                customCertificateData = {
                    name: file.name,
                    type: file.type,
                    data: e.target.result,
                    size: file.size
                };
                
                // Store in localStorage
                localStorage.setItem('customCertTemplate', JSON.stringify(customCertificateData));
                
                // Show preview
                document.getElementById('customCertPreview').style.display = 'block';
                document.getElementById('certFileName').textContent = file.name;
                
                showAlert('âœ… Template uploaded successfully!', 'success');
            };
            
            reader.readAsDataURL(file);
        }

        function generateFromCustom() {
            const stored = localStorage.getItem('customCertTemplate');
            if (!stored) {
                showAlert('âŒ No custom template found. Please upload first!', 'error');
                return;
            }
            
            const template = JSON.parse(stored);
            
            // Get information to fill
            const name = prompt('Enter Name:');
            const date = prompt('Enter Date (optional):') || new Date().toLocaleDateString('en-IN');
            const field1 = prompt('Additional Field 1 (optional):') || '';
            const field2 = prompt('Additional Field 2 (optional):') || '';
            
            if (!name) {
                showAlert('âŒ Name is required!', 'error');
                return;
            }
            
            // Generate PDF based on template type
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            if (template.type.includes('image')) {
                // If image template, add as background
                doc.addImage(template.data, 'JPEG', 0, 0, 210, 297);
                
                // Add text fields (user can customize positions)
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text(name, 105, 150, { align: 'center' });
                
                doc.setFontSize(12);
                doc.text(date, 105, 170, { align: 'center' });
                
                if (field1) doc.text(field1, 105, 185, { align: 'center' });
                if (field2) doc.text(field2, 105, 200, { align: 'center' });
                
            } else if (template.type.includes('pdf')) {
                // For PDF templates, create overlay
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text(`Custom Certificate`, 105, 30, { align: 'center' });
                
                doc.setFontSize(16);
                doc.text(`Name: ${name}`, 105, 100, { align: 'center' });
                doc.text(`Date: ${date}`, 105, 120, { align: 'center' });
                
                if (field1) doc.text(`${field1}`, 105, 140, { align: 'center' });
                if (field2) doc.text(`${field2}`, 105, 160, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text('Generated from custom template', 105, 280, { align: 'center' });
            } else {
                // DOCX or other formats - simple text certificate
                doc.setFontSize(20);
                doc.text('CERTIFICATE', 105, 50, { align: 'center' });
                
                doc.setFontSize(16);
                doc.text(`This is to certify that`, 105, 100, { align: 'center' });
                
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text(name, 105, 120, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                if (field1) doc.text(field1, 105, 150, { align: 'center' });
                if (field2) doc.text(field2, 105, 170, { align: 'center' });
                
                doc.text(`Date: ${date}`, 105, 250, { align: 'center' });
            }
            
            doc.save(`Custom_Certificate_${name.replace(/\s+/g, '_')}.pdf`);
            showAlert('âœ… Custom certificate generated!', 'success');
        }


        // âœ… CUSTOM THEME COLORS
        function updateThemeColors() {
            const primary = document.getElementById('primaryColor');
            const secondary = document.getElementById('secondaryColor');
            
            if (primary && secondary) {
                document.documentElement.style.setProperty('--primary', primary.value);
                document.documentElement.style.setProperty('--secondary', secondary.value);
                
                localStorage.setItem('customPrimary', primary.value);
                localStorage.setItem('customSecondary', secondary.value);
                
                showAlert('âœ… Theme colors updated!', 'success');
            }
        }

        function loadCustomTheme() {
            const primary = localStorage.getItem('customPrimary');
            const secondary = localStorage.getItem('customSecondary');
            
            if (primary) {
                document.documentElement.style.setProperty('--primary', primary);
                const input = document.getElementById('primaryColor');
                if (input) input.value = primary;
            }
            
            if (secondary) {
                document.documentElement.style.setProperty('--secondary', secondary);
                const input = document.getElementById('secondaryColor');
                if (input) input.value = secondary;
            }
        }

        function checkAuth() {
            // Don't run if we just logged in
            if (window.justLoggedIn) {
                window.justLoggedIn = false;
                return;
            }
            
            if (sessionStorage.getItem('loggedIn') === 'true') {
                document.getElementById('loginScreen').style.display = 'none';
                window.justLoggedIn = true;
                document.getElementById('mainApp').style.display = 'block';
                initApp();
            }
        }

        // ==================== UI FUNCTIONS ====================
        // ==================== DROPDOWN NAVIGATION ====================
        
        function toggleDropdown(button) {
            const dropdown = button.parentElement;
            const menu = dropdown.querySelector('.dropdown-menu');
            const isOpen = menu.classList.contains('show');
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu.show').forEach(m => {
                if (m !== menu) {
                    m.classList.remove('show');
                    m.parentElement.querySelector('.dropdown-toggle').classList.remove('open');
                }
            });
            
            // Toggle current dropdown
            if (isOpen) {
                menu.classList.remove('show');
                button.classList.remove('open');
            } else {
                menu.classList.add('show');
                button.classList.add('open');
            }
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                    menu.parentElement.querySelector('.dropdown-toggle').classList.remove('open');
                });
            }
        });
        
        // Close dropdown after selecting item
        function closeDropdowns() {
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
                menu.parentElement.querySelector('.dropdown-toggle').classList.remove('open');
            });
        }

        // ==================== TAB NAVIGATION ====================
        
        function showTab(tabName) {
            // Close all dropdowns
            closeDropdowns();
            
            // Remove active from all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Highlight parent dropdown if item is inside dropdown
            const clickedButton = event.target;
            if (clickedButton.classList.contains('dropdown-item')) {
                const parentDropdown = clickedButton.closest('.nav-dropdown');
                if (parentDropdown) {
                    const dropdownToggle = parentDropdown.querySelector('.dropdown-toggle');
                    dropdownToggle.classList.add('active');
                }
            } else {
                clickedButton.classList.add('active');
            }
            
            loadTabContent(tabName);
        }

        function loadTabContent(tabName) {
            switch(tabName) {
                case 'dashboard':  loadDashboard(); break;
                case 'teachers': loadTeachers(); break;
                case 'subjects': loadSubjects(); break;
                case 'classes': loadClasses(); break;
                case 'periods': loadPeriods(); break;
                case 'routine': loadRoutineData(); break;
                case 'attendance': loadAttendanceData(); break;
                case 'provisional': loadProvisionalData(); break;
                case 'substitute': initializeSubstituteManagement(); break;
                case 'exam': initializeExamManagement(); break;
                case 'communication': initializeCommunication(); break;
                case 'settings': initializeSettings(); break;
                case 'analytics': loadAnalyticsData(); break;
                case 'bulkupload': loadUploadHistory(); break;
                case 'users': loadUserManagement(); break;
                case 'calendar': loadCalendar(); break;
            }
        }

        // ==================== DARK MODE ====================
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.querySelector('.theme-toggle').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
            showAlert(isDark ? 'Dark mode enabled ðŸŒ™' : 'Light mode enabled â˜€ï¸', 'info');
        }

        function loadTheme() {
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.querySelector('.theme-toggle').textContent = 'â˜€ï¸';
            }
            // âœ… Load custom theme colors
            loadCustomTheme();
        }
		
		        // ==================== TEACHER MANAGEMENT ====================
        function loadTeachers() {
            const teachers = DB.get('teachers');
            const tbody = document.getElementById('teachersTableBody');
            
            if (teachers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No teachers added yet.  Add your first teacher!</td></tr>';
                return;
            }
            
            tbody.innerHTML = teachers.map((teacher, index) => `
                <tr>
                    <td><strong>${index + 1}</strong></td>
                    <td><strong>${teacher.name}</strong></td>
                    <td><span class="status-badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">${teacher.section}</span></td>
                    <td>${teacher.phone || '-'}<br><small style="color: #666;">${teacher.email || '-'}</small></td>
                    <td><strong style="color: var(--primary);">${teacher.totalClasses || 0}</strong></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="viewTeacherDetails(${index})">ðŸ‘ï¸ View</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTeacher(${index})">ðŸ—‘ï¸ Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            populateTeacherDropdowns();
        }

        function saveTeacher(event) {
            event.preventDefault();
            const teachers = DB.get('teachers');
            
            const newTeacher = {
                name:  document.getElementById('teacherName').value,
                section: document.getElementById('teacherSection').value,
                phone: document.getElementById('teacherPhone').value,
                totalClasses: 0,
                createdAt: new Date().toISOString()
            };
            
            teachers.push(newTeacher);
            DB.set('teachers', teachers);
            
            showAlert('âœ… Teacher added successfully!', 'success');
            document.getElementById('teacherForm').reset();
            loadTeachers();
            loadDashboard();
        }

        function deleteTeacher(index) {
            if (confirm('âš ï¸ Delete this teacher?  This cannot be undone! ')) {
                const teachers = DB.get('teachers');
                teachers.splice(index, 1);
                DB.set('teachers', teachers);
                showAlert('Teacher deleted successfully', 'success');
                loadTeachers();
                loadDashboard();
            }
        }

        function viewTeacherDetails(index) {
            const teachers = DB.get('teachers');
            const teacher = teachers[index];
            const routines = DB.get('routines');
            
            const teacherRoutines = routines.filter(r => r.teacherName === teacher.name);
            
            let content = `
                <div style="background: var(--bg); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">ðŸ‘¤ ${teacher.name}</h3>
                    <p><strong>Section:</strong> ${teacher.section}</p>
                    <p><strong>Phone: </strong> ${teacher.phone || 'N/A'}</p>
                    <p><strong>Email: </strong> ${teacher.email || 'N/A'}</p>
                    <p><strong>Total Classes:</strong> ${teacherRoutines.length} per week</p>
                </div>
                
                <h4 style="color: var(--primary); margin-bottom: 15px;">ðŸ“‹ Weekly Schedule</h4>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Period</th>
                                <th>Class</th>
                                <th>Subject</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${teacherRoutines.length > 0 ? teacherRoutines.map(r => `
                                <tr>
                                    <td>${r.day}</td>
                                    <td>${r.periodNumber}</td>
                                    <td>${r.className}</td>
                                    <td>${r.subjectName}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="4" style="text-align: center;">No classes assigned</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            
            showModal('Teacher Details', content);
        }

        function populateTeacherDropdowns() {
            const teachers = DB.get('teachers');
            const dropdowns = ['routineTeacher', 'absentTeacher', 'absentTeacherAuto'];
            
            dropdowns. forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Select Teacher</option>' +
                        teachers.map((t, idx) => `<option value="${idx}">${t.name} (${t.section})</option>`).join('');
                }
            });
        }

        // ==================== SUBJECT MANAGEMENT ====================
        function loadSubjects() {
            const subjects = DB.get('subjects');
            const tbody = document.getElementById('subjectsTableBody');
            
            if (subjects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No subjects added yet. Add your first subject!</td></tr>';
                return;
            }
            
            tbody.innerHTML = subjects.map((subject, index) => `
                <tr>
                    <td><strong>${index + 1}</strong></td>
                    <td><strong>${subject.name}</strong></td>
                    <td><span style="background: #d1ecf1; color: #0c5460; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${subject.code || '-'}</span></td>
                    <td><span class="status-badge" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">${subject.category}</span></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteSubject(${index})">ðŸ—‘ï¸ Delete</button>
                    </td>
                </tr>
            `).join('');
            
            populateSubjectDropdowns();
        }

        function saveSubject(event) {
            event.preventDefault();
            const subjects = DB.get('subjects');
            
            const newSubject = {
                name:  document.getElementById('subjectName').value,
                code: document.getElementById('subjectCode').value,
                category: document.getElementById('subjectCategory').value,
                createdAt: new Date().toISOString()
            };
            
            subjects.push(newSubject);
            DB.set('subjects', subjects);
            
            showAlert('âœ… Subject added successfully!', 'success');
            document.getElementById('subjectForm').reset();
            loadSubjects();
            loadDashboard();
        }

        function deleteSubject(index) {
            if (confirm('âš ï¸ Delete this subject? ')) {
                const subjects = DB.get('subjects');
                subjects.splice(index, 1);
                DB.set('subjects', subjects);
                showAlert('Subject deleted successfully', 'success');
                loadSubjects();
                loadDashboard();
            }
        }

        function populateSubjectDropdowns() {
            const subjects = DB.get('subjects');
            const select = document.getElementById('routineSubject');
            if (select) {
                select. innerHTML = '<option value="">Select Subject</option>' +
                    subjects.map((s, idx) => `<option value="${idx}">${s.name}</option>`).join('');
            }
        }

        // ==================== CLASS MANAGEMENT ====================
        function loadClasses() {
            const classes = DB.get('classes');
            const tbody = document.getElementById('classesTableBody');
            
            if (classes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No classes configured yet! </td></tr>';
                return;
            }
            
            tbody.innerHTML = classes.map((cls, index) => `
                <tr>
                    <td><strong style="color: var(--primary);">Class ${cls.className}</strong></td>
                    <td>${cls.section}</td>
                    <td>${cls.stream || '-'}</td>
                    <td><strong>${cls.totalStudents}</strong></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteClass(${index})">ðŸ—‘ï¸ Delete</button>
                    </td>
                </tr>
            `).join('');
            
            populateClassDropdowns();
        }

        function saveClass(event) {
            event.preventDefault();
            const classes = DB.get('classes');
            
            const newClass = {
                className: document.getElementById('className').value,
                section: document.getElementById('classSection').value,
                stream: document.getElementById('classStream').value,
                totalStudents: parseInt(document.getElementById('totalStudents').value) || 0,
                createdAt: new Date().toISOString()
            };
            
            classes.push(newClass);
            DB.set('classes', classes);
            
            showAlert('âœ… Class saved successfully!', 'success');
            document.getElementById('classForm').reset();
            loadClasses();
            loadDashboard();
        }

        function deleteClass(index) {
            if (confirm('âš ï¸ Delete this class?')) {
                const classes = DB.get('classes');
                classes.splice(index, 1);
                DB.set('classes', classes);
                showAlert('Class deleted successfully', 'success');
                loadClasses();
                loadDashboard();
            }
        }

        function populateClassDropdowns() {
            const classes = DB.get('classes');
            const select = document.getElementById('routineClass');
            if (select) {
                select.innerHTML = '<option value="">Select Class</option>' +
                    classes.map((c, idx) => `<option value="${idx}">Class ${c.className}-${c.section}</option>`).join('');
            }
        }

                // ==================== PERIOD MANAGEMENT (WITH DAYS) ====================
        function loadPeriods() {
            const periods = DB.get('periods') || [];
            const fridayPeriods = DB.get('fridayPeriods') || [];
            
            // Load regular periods
            const regularTbody = document.getElementById('regularPeriodsTableBody');
            if (regularTbody) {
                if (periods.length === 0) {
                    regularTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No regular periods configured yet!</td></tr>';
                } else {
                    regularTbody.innerHTML = periods.map((period, index) => {
                        const start = new Date('2000-01-01 ' + period.startTime);
                        const end = new Date('2000-01-01 ' + period.endTime);
                        const duration = Math.round((end - start) / 60000);
                        
                        return `
                            <tr>
                                <td><strong style="color: var(--primary); font-size: 16px;">Period ${period.periodNumber}</strong></td>
                                <td>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                        <span class="day-badge day-regular">Mon</span>
                                        <span class="day-badge day-regular">Tue</span>
                                        <span class="day-badge day-regular">Wed</span>
                                        <span class="day-badge day-regular">Thu</span>
                                        <span class="day-badge day-regular">Sat</span>
                                    </div>
                                </td>
                                <td><strong>${period.startTime} - ${period.endTime}</strong></td>
                                <td><span style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${duration} min</span></td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="deletePeriod(${index}, 'regular')">ðŸ—‘ï¸</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }
            
            // Load Friday periods
            const fridayTbody = document.getElementById('fridayPeriodsTableBody');
            if (fridayTbody) {
                if (fridayPeriods.length === 0) {
                    fridayTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No Friday periods set.  Using regular schedule.</td></tr>';
                } else {
                    fridayTbody.innerHTML = fridayPeriods.map((period, index) => {
                        const start = new Date('2000-01-01 ' + period.startTime);
                        const end = new Date('2000-01-01 ' + period.endTime);
                        const duration = Math.round((end - start) / 60000);
                        
                        return `
                            <tr>
                                <td><strong style="color: var(--success); font-size: 16px;">Period ${period.periodNumber}</strong></td>
                                <td>
                                    <span class="day-badge day-friday">ðŸ•Œ Friday</span>
                                </td>
                                <td><strong>${period.startTime} - ${period.endTime}</strong></td>
                                <td><span style="background: #c8e6c9; color: #2e7d32; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${duration} min</span></td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="deletePeriod(${index}, 'friday')">ðŸ—‘ï¸</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }
            
            populatePeriodDropdowns();
        }

        function savePeriod(event, type) {
            event.preventDefault();
            
            const isRegular = type === 'regular';
            const storageKey = isRegular ? 'periods' : 'fridayPeriods';
            const periods = DB.get(storageKey) || [];
            
            const periodNumberId = isRegular ? 'periodNumber' : 'fridayPeriodNumber';
            const startTimeId = isRegular ?  'startTime' : 'fridayStartTime';
            const endTimeId = isRegular ?  'endTime' : 'fridayEndTime';
            
            const newPeriod = {
                periodNumber: parseInt(document.getElementById(periodNumberId).value),
                startTime: document.getElementById(startTimeId).value,
                endTime: document.getElementById(endTimeId).value,
                createdAt: new Date().toISOString()
            };
            
            // Check for duplicate period number
            const existingIndex = periods.findIndex(p => p.periodNumber === newPeriod.periodNumber);
            if (existingIndex !== -1) {
                if (confirm('âš ï¸ Period ' + newPeriod.periodNumber + ' already exists. Update it?')) {
                    periods[existingIndex] = newPeriod;
                } else {
                    return;
                }
            } else {
                periods.push(newPeriod);
            }
            
            periods.sort((a, b) => a.periodNumber - b.periodNumber);
            DB.set(storageKey, periods);
            
            showAlert(`âœ… ${isRegular ? 'Regular' : 'Friday'} period saved successfully!`, 'success');
            
            if (isRegular) {
                document.getElementById('periodForm').reset();
            } else {
                document.getElementById('fridayPeriodForm').reset();
            }
            
            loadPeriods();
        }

        function deletePeriod(index, type) {
            if (confirm('âš ï¸ Delete this period?')) {
                const storageKey = type === 'regular' ? 'periods' : 'fridayPeriods';
                const periods = DB.get(storageKey) || [];
                periods.splice(index, 1);
                DB.set(storageKey, periods);
                showAlert('Period deleted successfully', 'success');
                loadPeriods();
            }
        }

        function populatePeriodDropdowns() {
            const periods = DB.get('periods') || [];
            const select = document.getElementById('routinePeriod');
            if (select) {
                select. innerHTML = '<option value="">Select Period</option>' +
                    periods.map((p, idx) => `<option value="${idx}">Period ${p.periodNumber} (${p.startTime}-${p.endTime})</option>`).join('');
            }
        }

        function copyRegularToFriday() {
            const periods = DB.get('periods') || [];
            
            if (periods.length === 0) {
                showAlert('âš ï¸ No regular periods to copy!', 'error');
                return;
            }
            
            if (confirm('ðŸ“‹ Copy all regular periods to Friday schedule?')) {
                DB.set('fridayPeriods', JSON.parse(JSON.stringify(periods)));
                showAlert('âœ… Regular periods copied to Friday! ', 'success');
                loadPeriods();
            }
        }

        function clearFridayPeriods() {
            if (confirm('âš ï¸ Clear all Friday periods?  This will use regular schedule for Friday.')) {
                DB.set('fridayPeriods', []);
                showAlert('âœ… Friday periods cleared!', 'success');
                loadPeriods();
            }
        }

        function viewAllPeriods() {
            const periods = DB.get('periods') || [];
            const fridayPeriods = DB.get('fridayPeriods') || [];
            
            let content = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap:  20px;">
                    <div>
                        <h3 style="color: var(--primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--primary);">
                            ðŸ“… Regular Days
                        </h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 13px;">Mon, Tue, Wed, Thu, Sat</p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Time</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${periods.length > 0 ? periods.map(p => {
                                        const start = new Date('2000-01-01 ' + p.startTime);
                                        const end = new Date('2000-01-01 ' + p.endTime);
                                        const duration = Math.round((end - start) / 60000);
                                        return `
                                            <tr>
                                                <td><strong>Period ${p.periodNumber}</strong></td>
                                                <td>${p.startTime} - ${p.endTime}</td>
                                                <td>${duration} min</td>
                                            </tr>
                                        `;
                                    }).join('') : '<tr><td colspan="3" style="text-align: center;">No periods</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: var(--success); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--success);">
                            ðŸ•Œ Friday
                        </h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 13px;">Special Timing (Jumma)</p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Time</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${fridayPeriods.length > 0 ? fridayPeriods.map(p => {
                                        const start = new Date('2000-01-01 ' + p.startTime);
                                        const end = new Date('2000-01-01 ' + p.endTime);
                                        const duration = Math.round((end - start) / 60000);
                                        return `
                                            <tr>
                                                <td><strong>Period ${p.periodNumber}</strong></td>
                                                <td>${p.startTime} - ${p.endTime}</td>
                                                <td>${duration} min</td>
                                            </tr>
                                        `;
                                    }).join('') : '<tr><td colspan="3" style="text-align: center;">Using regular schedule</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('â° Complete Period Schedule', content);
        }

        // ==================== ROUTINE MANAGEMENT ====================
        function loadRoutineData() {
            populateTeacherDropdowns();
            populateSubjectDropdowns();
            populateClassDropdowns();
            populatePeriodDropdowns();
        }

        function saveRoutine(event) {
            event.preventDefault();
            
            const routines = DB.get('routines');
            const teachers = DB.get('teachers');
            const subjects = DB.get('subjects');
            const classes = DB.get('classes');
            const periods = DB.get('periods');
            
            const teacherIdx = parseInt(document.getElementById('routineTeacher').value);
            const subjectIdx = parseInt(document.getElementById('routineSubject').value);
            const classIdx = parseInt(document.getElementById('routineClass').value);
            const periodIdx = parseInt(document.getElementById('routinePeriod').value);
            
            const newRoutine = {
                day: document.getElementById('routineDay').value,
                className: `Class ${classes[classIdx].className}-${classes[classIdx].section}`,
                periodNumber: periods[periodIdx].periodNumber,
                teacherName: teachers[teacherIdx].name,
                subjectName: subjects[subjectIdx].name,
                createdAt: new Date().toISOString()
            };
            
            // Check for conflicts
            const conflict = routines.find(r => 
                r.day === newRoutine.day && 
                r.periodNumber === newRoutine.periodNumber && 
                (r.className === newRoutine.className || r.teacherName === newRoutine.teacherName)
            );
            
            if (conflict) {
                showAlert('âš ï¸ Conflict:  This period is already assigned! ', 'error');
                return;
            }
            
            routines.push(newRoutine);
            DB.set('routines', routines);
            
            // Update teacher class count
            teachers[teacherIdx].totalClasses = (teachers[teacherIdx].totalClasses || 0) + 1;
            DB.set('teachers', teachers);
            
            showAlert('âœ… Routine entry added successfully!', 'success');
            document.getElementById('routineForm').reset();
            loadDashboard();
        }

        function viewCompleteRoutine() {
            const routines = DB.get('routines');
            const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
            
            if (routines.length === 0) {
                showModal('Complete Routine', '<p style="text-align: center; padding: 40px; color: #666;">No routine entries yet.  Start adding classes! </p>');
                return;
            }
            
            let content = '<div style="max-height: 70vh; overflow-y: auto;">';
            
            days.forEach(day => {
                const dayRoutines = routines.filter(r => r.day === day);
                if (dayRoutines.length > 0) {
                    content += `
                        <h3 style="color: var(--primary); margin-top: 20px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--primary);">
                            ðŸ“… ${day}
                        </h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Class</th>
                                        <th>Subject</th>
                                        <th>Teacher</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dayRoutines. map((r, idx) => `
                                        <tr>
                                            <td><strong>${r.periodNumber}</strong></td>
                                            <td>${r.className}</td>
                                            <td>${r.subjectName}</td>
                                            <td>${r.teacherName}</td>
                                            <td>
                                                <button class="btn btn-danger btn-sm" onclick="deleteRoutineEntry('${day}', '${r.className}', ${r.periodNumber}); this.closest('. modal').remove();">ðŸ—‘ï¸</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            });
            
            content += '</div>';
            showModal('ðŸ“– Complete Weekly Routine', content);
        }

        function deleteRoutineEntry(day, className, periodNumber) {
            if (confirm('âš ï¸ Delete this routine entry? ')) {
                let routines = DB.get('routines');
                routines = routines.filter(r => !(r.day === day && r.className === className && r.periodNumber === periodNumber));
                DB.set('routines', routines);
                showAlert('Routine entry deleted', 'success');
                viewCompleteRoutine();
                loadDashboard();
            }
        }
		        // ==================== ATTENDANCE MANAGEMENT ====================
        function loadAttendanceData() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            loadAttendance();
        }

        function loadAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const teachers = DB.get('teachers');
            const attendance = DB.get('attendance') || [];
            
            const dateAttendance = attendance.filter(a => a.date === date);
            const attendanceMap = {};
            dateAttendance.forEach(a => attendanceMap[a.teacherName] = a.status);
            
            let html = '<div class="table-container"><table><thead><tr><th>Teacher</th><th>Status</th><th>Action</th></tr></thead><tbody>';
            
            teachers.forEach((teacher, idx) => {
                const status = attendanceMap[teacher.name] || 'present';
                const statusClass = status === 'present' ? 'status-present' : status === 'absent' ? 'status-absent' : 'status-on-duty';
                
                html += `
                    <tr>
                        <td><strong>${teacher.name}</strong></td>
                        <td><span class="${statusClass} status-badge">${status. toUpperCase()}</span></td>
                        <td>
                            <select id="status_${idx}" style="padding: 6px; border: 1px solid var(--border); border-radius: 4px;">
                                <option value="present" ${status === 'present' ?  'selected' : ''}>âœ… Present</option>
                                <option value="absent" ${status === 'absent' ? 'selected' : ''}>âŒ Absent</option>
                                <option value="on_duty" ${status === 'on_duty' ? 'selected' : ''}>ðŸ“‹ On Duty</option>
                                <option value="leave" ${status === 'leave' ? 'selected' : ''}>ðŸ“… Leave</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="saveAttendance('${teacher.name}', ${idx})" style="margin-left: 10px;">ðŸ’¾</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('attendanceList').innerHTML = html;
            
            updateAttendanceSummary(date);
        }

        function saveAttendance(teacherName, idx) {
            const date = document.getElementById('attendanceDate').value;
            const status = document.getElementById(`status_${idx}`).value;
            
            let attendance = DB.get('attendance') || [];
            
            // Remove existing entry for this teacher and date
            attendance = attendance.filter(a => !(a.date === date && a.teacherName === teacherName));
            
            // Add new entry
            if (status !== 'present') {
                attendance.push({
                    date: date,
                    teacherName: teacherName,
                    status: status,
                    timestamp: new Date().toISOString()
                });
            }
            
            DB.set('attendance', attendance);
            showAlert(`âœ… Attendance saved for ${teacherName}`, 'success');
            loadAttendance();
            loadDashboard();
        }

        function markAllPresent() {
            const date = document.getElementById('attendanceDate').value;
            let attendance = DB.get('attendance') || [];
            
            // Remove all entries for this date
            attendance = attendance.filter(a => a.date !== date);
            
            DB.set('attendance', attendance);
            showAlert('âœ… All teachers marked present! ', 'success');
            loadAttendance();
            loadDashboard();
        }

        function updateAttendanceSummary(date) {
            const attendance = DB.get('attendance') || [];
            const teachers = DB.get('teachers');
            
            const dateAttendance = attendance.filter(a => a.date === date);
            
            const stats = {
                present: teachers.length - dateAttendance.length,
                absent: dateAttendance.filter(a => a.status === 'absent').length,
                on_duty: dateAttendance. filter(a => a.status === 'on_duty').length,
                leave: dateAttendance.filter(a => a.status === 'leave').length
            };
            
            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="background: #d4edda; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="font-size: 2. 5em; color: #155724; margin-bottom: 5px;">${stats.present}</h3>
                        <p style="color: #155724;">âœ… Present</p>
                    </div>
                    <div style="background: #f8d7da; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="font-size: 2.5em; color: #721c24; margin-bottom: 5px;">${stats.absent}</h3>
                        <p style="color: #721c24;">âŒ Absent</p>
                    </div>
                    <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="font-size: 2.5em; color: #0c5460; margin-bottom: 5px;">${stats.on_duty}</h3>
                        <p style="color: #0c5460;">ðŸ“‹ On Duty</p>
                    </div>
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="font-size: 2.5em; color: #856404; margin-bottom: 5px;">${stats.leave}</h3>
                        <p style="color: #856404;">ðŸ“… Leave</p>
                    </div>
                </div>
            `;
            
            document.getElementById('attendanceSummary').innerHTML = html;
        }

        // ==================== AI SMART ENGINE ====================
        const SmartEngine = {
            calculateScore:  function(teacher, period, day, date) {
                let score = 0;
                const routines = DB.get('routines');
                const attendance = DB.get('attendance') || [];
                const provisionals = DB.get('provisionals') || [];
                
                // 1. Availability Check (40 points)
                const hasClass = routines.some(r => 
                    r.teacherName === teacher.name && 
                    r.day === day && 
                    r.periodNumber === period
                );
                
                const isAbsent = attendance.some(a => 
                    a.date === date && 
                    a.teacherName === teacher.name && 
                    a.status !== 'present'
                );
                
                if (! hasClass && !isAbsent) score += 40;
                
                // 2. Workload Analysis (30 points)
                const teacherClasses = routines.filter(r => r.teacherName === teacher.name).length;
                const workloadScore = Math.max(0, 30 - (teacherClasses / 2));
                score += workloadScore;
                
                // 3. Recent Provisional Count (30 points)
                const recentProvisionals = provisionals. filter(p => {
                    const pDate = new Date(p.date);
                    const checkDate = new Date(date);
                    const daysDiff = (checkDate - pDate) / (1000 * 60 * 60 * 24);
                    
                    if (daysDiff <= 30 && p.replacements) {
                        return p.replacements.some(r => r.replacementTeacherName === teacher.name);
                    }
                    return false;
                }).length;
                
                score += Math.max(0, 30 - (recentProvisionals * 5));
                
                return {
                    score: score,
                    available: ! hasClass && !isAbsent,
                    workload: teacherClasses,
                    recentProvisional: recentProvisionals
                };
            },
            
            findBestReplacement: function(period, day, date, excludeTeachers = []) {
                const teachers = DB.get('teachers');
                const candidates = [];
                
                teachers. forEach(teacher => {
                    if (excludeTeachers.includes(teacher.name)) return;
                    
                    const evaluation = this.calculateScore(teacher, period, day, date);
                    
                    if (evaluation.available) {
                        candidates.push({
                            teacher: teacher,
                            score:  evaluation.score,
                            details: evaluation
                        });
                    }
                });
                
                candidates.sort((a, b) => b.score - a.score);
                return candidates;
            },
            
            autoAssign: function(absentTeacher, date) {
                const routines = DB.get('routines');
                const dateObj = new Date(date);
                const day = ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'][dateObj.getDay()];
                
                const affectedClasses = routines.filter(r => 
                    r.teacherName === absentTeacher && r.day === day
                );
                
                if (affectedClasses.length === 0) {
                    return {
                        success: false,
                        message:  'No classes found for this teacher on ' + day
                    };
                }
                
                const assignments = [];
                const usedTeachers = {};
                
                affectedClasses.forEach(affected => {
                    const candidates = this.findBestReplacement(
                        affected.periodNumber,
                        day,
                        date,
                        [absentTeacher]
                    );
                    
                    if (candidates.length > 0) {
                        let selected = null;
                        
                        for (let candidate of candidates) {
                            const usedCount = usedTeachers[candidate.teacher.name] || 0;
                            if (usedCount < 3) {
                                selected = candidate;
                                break;
                            }
                        }
                        
                        if (! selected) selected = candidates[0];
                        
                        usedTeachers[selected.teacher.name] = (usedTeachers[selected. teacher.name] || 0) + 1;
                        
                        assignments.push({
                            periodNumber: affected.periodNumber,
                            className: affected.className,
                            subjectName: affected.subjectName,
                            replacementTeacher: selected.teacher.name,
                            score: selected.score,
                            reason: this.getAssignmentReason(selected.details)
                        });
                    } else {
                        assignments.push({
                            periodNumber: affected.periodNumber,
                            className: affected.className,
                            subjectName: affected.subjectName,
                            replacementTeacher: null,
                            error: 'No available teacher'
                        });
                    }
                });
                
                return {
                    success: true,
                    date: date,
                    day: day,
                    absentTeacher: absentTeacher,
                    assignments: assignments,
                    summary: {
                        total: affectedClasses.length,
                        assigned: assignments.filter(a => a.replacementTeacher).length,
                        failed: assignments.filter(a => ! a.replacementTeacher).length,
                        teachersUsed: Object.keys(usedTeachers).length
                    }
                };
            },
            
            getAssignmentReason: function(details) {
                const reasons = [];
                if (details.available) reasons.push('âœ… Free in this period');
                if (details. workload < 15) reasons.push('ðŸ“Š Light workload');
                if (details.recentProvisional < 3) reasons.push('ðŸ”„ Low recent provisional');
                return reasons.join(' â€¢ ');
            }
        };

        // ==================== PROVISIONAL ROUTINE ====================
        function loadProvisionalData() {
            populateTeacherDropdowns();
            loadProvisionalHistory();
        }

        function autoAssignProvisional(event) {
            event.preventDefault();
            
            const date = document.getElementById('provisionalDateAuto').value;
            const teacherIdx = parseInt(document.getElementById('absentTeacherAuto').value);
            
            if (isNaN(teacherIdx)) {
                showAlert('âš ï¸ Please select absent teacher', 'error');
                return;
            }
            
            const teachers = DB.get('teachers');
            const absentTeacher = teachers[teacherIdx]. name;
            
            showLoading(true, 'ðŸ¤– AI Engine analyzing optimal assignments...');
            
            setTimeout(() => {
                const result = SmartEngine.autoAssign(absentTeacher, date);
                showLoading(false);
                
                if (! result.success) {
                    showAlert(result.message, 'error');
                    return;
                }
                
                displayAutoAssignmentResults(result);
            }, 1500);
        }

        function displayAutoAssignmentResults(result) {
            let content = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; margin-bottom: 25px; text-align: center;">
                    <h2 style="font-size: 2em; margin-bottom: 10px;">ðŸ¤– AI Auto-Assignment Complete! </h2>
                    <p style="opacity: 0.9;">Smart engine has analyzed all teachers and created optimal assignments</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="font-size: 2em; color: #0c5460;">${result.summary.total}</h3>
                        <p style="color: #0c5460;">Total Classes</p>
                    </div>
                    <div style="background: #d4edda; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="font-size: 2em; color: #155724;">${result.summary.assigned}</h3>
                        <p style="color: #155724;">âœ… Assigned</p>
                    </div>
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="font-size: 2em; color: #856404;">${result.summary.teachersUsed}</h3>
                        <p style="color: #856404;">Teachers Used</p>
                    </div>
                    <div style="background: ${result.summary.failed > 0 ? '#f8d7da' : '#d4edda'}; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="font-size: 2em; color: ${result.summary. failed > 0 ? '#721c24' : '#155724'};">${result.summary. failed > 0 ? result.summary.failed : 'âœ“'}</h3>
                        <p style="color: ${result.summary.failed > 0 ? '#721c24' : '#155724'};">${result.summary.failed > 0 ? 'Failed' :  'Perfect!'}</p>
                    </div>
                </div>
                
                <div style="background: #d1ecf1; border-left: 4px solid #0c5460; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                    <strong style="color: #0c5460;">ðŸ“… Date: </strong> ${new Date(result.date).toLocaleDateString()} (${result.day}) â€¢ 
                    <strong style="color: #0c5460;">ðŸ‘¤ Absent: </strong> ${result.absentTeacher}
                </div>
                
                <h3 style="color: var(--primary); margin-bottom: 15px;">ðŸ“‹ Assignment Details</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Class</th>
                                <th>Subject</th>
                                <th>Replacement Teacher</th>
                                <th>Reason</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.assignments.map((a, idx) => `
                                <tr style="background: ${idx % 2 === 0 ? 'white' : 'var(--bg)'};">
                                    <td><strong>${a.periodNumber}</strong></td>
                                    <td>${a.className}</td>
                                    <td>${a.subjectName}</td>
                                    <td><strong style="color: ${a.replacementTeacher ? 'var(--success)' : 'var(--danger)'};">${a.replacementTeacher || 'Not Available'}</strong></td>
                                    <td style="font-size: 0.85em;">${a.reason || a.error || '-'}</td>
                                    <td>${a.score ?  `<span style="background: var(--success); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.9em;">${Math.round(a.score)}/100</span>` : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 25px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="saveAutoAssignment(${JSON.stringify(result).replace(/"/g, '&quot;')})">âœ… Save & Apply</button>
                    <button class="btn btn-info" onclick="printProvisional('${result.date}', '${result.absentTeacher}')">ðŸ“„ Print PDF</button>
                    <button class="btn btn-warning" onclick="shareProvisional('${result.date}', '${result.absentTeacher}')">ðŸ“¤ Share WhatsApp</button>
                </div>
            `;
            
            showModal('ðŸ¤– AI Auto-Assignment Results', content);
        }

        function saveAutoAssignment(result) {
            const provisionals = DB.get('provisionals') || [];
            
            const provisional = {
                date: result. date,
                absentTeacherName: result.absentTeacher,
                replacements: result.assignments.filter(a => a.replacementTeacher).map(a => ({
                    periodNumber: a.periodNumber,
                    className: a.className,
                    replacementTeacherName: a. replacementTeacher
                })),
                autoGenerated: true,
                createdAt: new Date().toISOString()
            };
            
            provisionals.push(provisional);
            DB.set('provisionals', provisionals);
            
            showAlert('âœ… Provisional routine saved successfully!', 'success');
            document.querySelector('.modal')?.remove();
            loadProvisionalHistory();
            loadDashboard();
        }

        function findAffectedClasses() {
            const date = document.getElementById('provisionalDate').value;
            const teacherIdx = parseInt(document.getElementById('absentTeacher').value);
            const day = document.getElementById('provisionalDay').value;
            
            if (isNaN(teacherIdx) || ! day) {
                showAlert('âš ï¸ Please fill all fields', 'error');
                return;
            }
            
            const teachers = DB.get('teachers');
            const routines = DB.get('routines');
            const absentTeacher = teachers[teacherIdx].name;
            
            const affectedClasses = routines.filter(r => 
                r.teacherName === absentTeacher && r.day === day
            );
            
            if (affectedClasses.length === 0) {
                showAlert('No classes found for this teacher on ' + day, 'info');
                return;
            }
            
            displayManualAssignment(affectedClasses, absentTeacher, date, day);
        }

        function displayManualAssignment(affectedClasses, absentTeacher, date, day) {
            let html = `
                <div class="card">
                    <h3 class="card-title">ðŸ“‹ Manual Assignment</h3>
                    <p style="margin-bottom: 15px;"><strong>Absent: </strong> ${absentTeacher} â€¢ <strong>Date:</strong> ${date} â€¢ <strong>Day:</strong> ${day}</p>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Class</th>
                                    <th>Subject</th>
                                    <th>Replacement Teacher</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${affectedClasses.map((cls, idx) => {
                                    const candidates = SmartEngine.findBestReplacement(cls.periodNumber, day, date, [absentTeacher]);
                                    
                                    return `
                                        <tr>
                                            <td><strong>${cls.periodNumber}</strong></td>
                                            <td>${cls.className}</td>
                                            <td>${cls. subjectName}</td>
                                            <td>
                                                <select id="replacement_${idx}" style="width: 100%; padding:  8px; border: 1px solid var(--border); border-radius: 4px;">
                                                    <option value="">Select Teacher</option>
                                                    ${candidates.map(c => `<option value="${c.teacher.name}">${c.teacher.name} (Score: ${Math.round(c.score)})</option>`).join('')}
                                                </select>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <button class="btn btn-success" onclick="saveManualAssignment('${absentTeacher}', '${date}', ${affectedClasses.length})" style="margin-top: 15px;">ðŸ’¾ Save Provisional</button>
                </div>
            `;
            
            document.getElementById('affectedClassesDisplay').innerHTML = html;
        }

        function saveManualAssignment(absentTeacher, date, count) {
            const replacements = [];
            
            for (let i = 0; i < count; i++) {
                const select = document.getElementById(`replacement_${i}`);
                if (select && select.value) {
                    const row = select.closest('tr');
                    const period = parseInt(row.cells[0].textContent);
                    const className = row.cells[1]. textContent;
                    
                    replacements.push({
                        periodNumber: period,
                        className: className,
                        replacementTeacherName: select.value
                    });
                }
            }
            
            if (replacements.length === 0) {
                showAlert('âš ï¸ Please assign at least one replacement teacher', 'error');
                return;
            }
            
            const provisionals = DB.get('provisionals') || [];
            
            provisionals.push({
                date: date,
                absentTeacherName: absentTeacher,
                replacements: replacements,
                autoGenerated: false,
                createdAt: new Date().toISOString()
            });
            
            DB.set('provisionals', provisionals);
            
            showAlert('âœ… Manual provisional saved! ', 'success');
            document.getElementById('provisionalForm').reset();
            document.getElementById('affectedClassesDisplay').innerHTML = '';
            loadProvisionalHistory();
            loadDashboard();
        }

        function loadProvisionalHistory() {
            const provisionals = DB.get('provisionals') || [];
            
            if (provisionals.length === 0) {
                document.getElementById('provisionalHistory').innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No provisional routines created yet</p>';
                return;
            }
            
            let html = '';
            
            provisionals.reverse().slice(0, 10).forEach((prov, idx) => {
                html += `
                    <div style="background: var(--bg); padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid ${prov.autoGenerated ? '#667eea' : '#f46b45'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="color: var(--primary);">${new Date(prov.date).toLocaleDateString()}</strong>
                                ${prov.autoGenerated ? '<span style="background: #667eea; color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; margin-left: 10px;">ðŸ¤– AI Generated</span>' : ''}
                            </div>
                            <button class="btn btn-info btn-sm" onclick="viewProvisionalDetails(${idx})">ðŸ‘ï¸ View</button>
                        </div>
                        <p style="margin:  0; color: #666;"><strong>Absent:</strong> ${prov.absentTeacherName} â€¢ <strong>Classes:</strong> ${prov.replacements.length}</p>
                    </div>
                `;
            });
            
            document.getElementById('provisionalHistory').innerHTML = html;
        }

        function viewProvisionalDetails(idx) {
            const provisionals = DB.get('provisionals') || [];
            const prov = provisionals. reverse()[idx];
            
            let content = `
                <div style="background: var(--bg); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">ðŸ“… ${new Date(prov.date).toLocaleDateString()}</h3>
                    <p><strong>Absent Teacher:</strong> ${prov.absentTeacherName}</p>
                    <p><strong>Type:</strong> ${prov.autoGenerated ? 'ðŸ¤– AI Generated' :  'âœï¸ Manual'}</p>
                    <p><strong>Created:</strong> ${new Date(prov.createdAt).toLocaleString()}</p>
                </div>
                
                <h4 style="color: var(--primary); margin-bottom: 15px;">Replacements</h4>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Class</th>
                                <th>Replacement Teacher</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${prov.replacements.map(r => `
                                <tr>
                                    <td><strong>${r.periodNumber}</strong></td>
                                    <td>${r.className}</td>
                                    <td><strong style="color: var(--success);">${r.replacementTeacherName}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap:  10px;">
                    <button class="btn btn-info" onclick="printProvisional('${prov.date}', '${prov.absentTeacherName}')">ðŸ“„ Print PDF</button>
                    <button class="btn btn-warning" onclick="shareProvisional('${prov.date}', '${prov.absentTeacherName}')">ðŸ“¤ Share</button>
                </div>
            `;
            
            showModal('Provisional Routine Details', content);
        }

        function printProvisional(date, teacher) {
            showAlert('ðŸ“„ Opening print dialog...  ', 'info');
            setTimeout(() => window.print(), 500);
        }

        function shareProvisional(date, teacher) {
            const text = `ðŸ“… Provisional Routine\n\nDate: ${new Date(date).toLocaleDateString()}\nAbsent:  ${teacher}\n\n- RHS PRMS`;
            window.open(`https://wa.me/? text=${encodeURIComponent(text)}`, '_blank');
        }
		        // ==================== ANALYTICS ====================
        function loadAnalytics() {
            const teachers = DB.get('teachers');
            const routines = DB.get('routines');
            
            // Calculate teacher workload
            const workloadData = teachers.map(teacher => {
                const classes = routines.filter(r => r.teacherName === teacher.name).length;
                return {
                    name: teacher.name,
                    classes: classes
                };
            });
            
            // Create chart
            const ctx = document.getElementById('workloadChart');
            if (ctx && typeof Chart !== 'undefined') {
                // Destroy existing chart if any
                if (window.workloadChart) {
                    window. workloadChart.destroy();
                }
                
                window.workloadChart = new Chart(ctx, {
                    type:  'bar',
                    data: {
                        labels: workloadData.map(d => d.name),
                        datasets: [{
                            label: 'Weekly Classes',
                            data: workloadData.map(d => d. classes),
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: {
                                display: true,
                                text: 'Teacher Workload Distribution'
                            }
                        }
                    }
                });
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportExcel() {
            if (typeof XLSX === 'undefined') {
                showAlert('âš ï¸ Excel library not loaded.  Please refresh the page.', 'error');
                return;
            }
            
            showLoading(true, 'ðŸ“Š Generating Excel file...');
            
            setTimeout(() => {
                const wb = XLSX.utils.book_new();
                
                // Teachers sheet
                const teachers = DB.get('teachers');
                const teachersData = [['Name', 'Section', 'Phone', 'Email', 'Total Classes']];
                teachers.forEach(t => {
                    teachersData.push([t.name, t.section, t.phone || '', t.email || '', t. totalClasses || 0]);
                });
                const teachersWs = XLSX.utils.aoa_to_sheet(teachersData);
                XLSX.utils.book_append_sheet(wb, teachersWs, 'Teachers');
                
                // Subjects sheet
                const subjects = DB.get('subjects');
                const subjectsData = [['Name', 'Code', 'Category']];
                subjects.forEach(s => {
                    subjectsData.push([s.name, s.code || '', s.category]);
                });
                const subjectsWs = XLSX.utils.aoa_to_sheet(subjectsData);
                XLSX.utils.book_append_sheet(wb, subjectsWs, 'Subjects');
                
                // Routines sheet
                const routines = DB.get('routines');
                const routinesData = [['Day', 'Period', 'Class', 'Subject', 'Teacher']];
                routines.forEach(r => {
                    routinesData.push([r.day, r.periodNumber, r.className, r.subjectName, r.teacherName]);
                });
                const routinesWs = XLSX. utils.aoa_to_sheet(routinesData);
                XLSX.utils.book_append_sheet(wb, routinesWs, 'Routines');
                
                // Download
                XLSX.writeFile(wb, `RHS_PRMS_Export_${Date.now()}.xlsx`);
                
                showLoading(false);
                showAlert('âœ… Excel file downloaded successfully!', 'success');
            }, 1000);
        }

        function exportPDF() {
            showAlert('ðŸ“„ Opening print dialog...  Use "Save as PDF" option', 'info');
            setTimeout(() => window.print(), 500);
        }

        function shareWhatsApp() {
            const teachers = DB.get('teachers');
            const routines = DB.get('routines');
            
            const text = `ðŸ“Š RHS PRMS Report\n\n` +
                `ðŸ“… Date: ${new Date().toLocaleDateString()}\n\n` +
                `ðŸ‘¨â€ðŸ« Teachers:  ${teachers.length}\n` +
                `ðŸ“‹ Total Classes: ${routines.length}\n\n` +
                `- Ramnagar High School\n` +
                `- Generated by RHS PRMS v2.6`;
            
            window.open(`https://wa.me/? text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareEmail() {
            const subject = encodeURIComponent('RHS PRMS Report - ' + new Date().toLocaleDateString());
            const body = encodeURIComponent(
                `RHS PRMS Report\n\n` +
                `Date: ${new Date().toLocaleDateString()}\n` +
                `Teachers: ${DB.get('teachers').length}\n` +
                `Classes: ${DB.get('routines').length}\n\n` +
                `Generated by RHS PRMS v2.6\n` +
                `Ramnagar High School`
            );
            
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // ==================== EXCEL UPLOAD ====================
        function uploadExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (! file) return;
                
                showLoading(true, 'ðŸ“Š Reading Excel file...');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        if (typeof XLSX === 'undefined') {
                            showAlert('âš ï¸ Excel library not loaded', 'error');
                            showLoading(false);
                            return;
                        }
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // Process Teachers sheet
                        if (workbook.SheetNames. includes('Teachers')) {
                            const sheet = workbook.Sheets['Teachers'];
                            const jsonData = XLSX.utils.sheet_to_json(sheet);
                            
                            const teachers = jsonData.map(row => ({
                                name: row. Name || row.name || '',
                                section: row. Section || row.section || '',
                                phone: row.Phone || row.phone || '',
                                email: row.Email || row. email || '',
                                totalClasses: 0,
                                createdAt: new Date().toISOString()
                            })).filter(t => t.name);
                            
                            if (teachers.length > 0) {
                                DB.set('teachers', teachers);
                            }
                        }
                        
                        // Process Subjects sheet
                        if (workbook. SheetNames.includes('Subjects')) {
                            const sheet = workbook.Sheets['Subjects'];
                            const jsonData = XLSX.utils.sheet_to_json(sheet);
                            
                            const subjects = jsonData.map(row => ({
                                name: row.Name || row.name || '',
                                code: row.Code || row.code || '',
                                category: row.Category || row.category || '',
                                createdAt: new Date().toISOString()
                            })).filter(s => s.name);
                            
                            if (subjects.length > 0) {
                                DB.set('subjects', subjects);
                            }
                        }
                        
                        // Process Routines sheet
                        if (workbook.SheetNames.includes('Routines')) {
                            const sheet = workbook. Sheets['Routines'];
                            const jsonData = XLSX. utils.sheet_to_json(sheet);
                            
                            const routines = jsonData.map(row => ({
                                day: (row.Day || row.day || '').toUpperCase(),
                                periodNumber: parseInt(row.Period || row.period) || 0,
                                className: row.Class || row.class || '',
                                subjectName: row.Subject || row.subject || '',
                                teacherName: row.Teacher || row.teacher || '',
                                createdAt: new Date().toISOString()
                            })).filter(r => r.day && r.periodNumber && r.className && r.teacherName);
                            
                            if (routines.length > 0) {
                                DB.set('routines', routines);
                            }
                        }
                        
                        showLoading(false);
                        showAlert('âœ… Excel data imported successfully!  Reloading... ', 'success');
                        setTimeout(() => location.reload(), 1500);
                        
                    } catch (error) {
                        showLoading(false);
                        showAlert('âŒ Error reading Excel file: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }


        // ==================== DASHBOARD ====================
        function loadDashboard() {
            const teachers = DB.get('teachers');
            const subjects = DB.get('subjects');
            const classes = DB.get('classes');
            const routines = DB.get('routines');
            const provisionals = DB.get('provisionals') || [];
            const attendance = DB.get('attendance') || [];
            const substitutes = DB.get('substituteRecords') || [];
            
            // Update basic stats
            document.getElementById('totalTeachers').textContent = teachers.length;
            document.getElementById('totalSubjects').textContent = subjects.length;
            document.getElementById('totalClasses').textContent = classes.length;
            document.getElementById('totalRoutines').textContent = routines.length;
            
            // Today's data
            const today = new Date().toISOString().split('T')[0];
            const todayAbsent = attendance.filter(a => a.date === today && a.status === 'absent').length;
            const todayPresent = teachers.length - todayAbsent;
            const todayRoutineCount = routines.filter(r => r.date === today).length;
            const weekSubstitutes = substitutes.filter(s => {
                const subDate = new Date(s.date);
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                return subDate >= weekAgo;
            }).length;
            
            document.getElementById('todayAbsent').textContent = todayAbsent;
            document.getElementById('todayPresent').textContent = todayPresent;
            document.getElementById('activeTeachers').textContent = todayPresent;
            document.getElementById('todayRoutines').textContent = todayRoutineCount;
            document.getElementById('totalSubstitutes').textContent = weekSubstitutes;
            
            // System Health
            updateSystemHealth();
            
            // Routine Coverage
            const totalPossibleRoutines = classes.length * 7; // 7 periods per day
            const routineCoverage = totalPossibleRoutines > 0 ? Math.round((routines.length / totalPossibleRoutines) * 100) : 0;
            document.getElementById('routineCoverage').textContent = routineCoverage + '%';
            document.getElementById('routineProgressBar').style.width = routineCoverage + '%';
            
            // Attendance Rate
            const attendanceRate = teachers.length > 0 ? Math.round((todayPresent / teachers.length) * 100) : 0;
            document.getElementById('attendanceRate').textContent = attendanceRate + '%';
            document.getElementById('attendanceProgressBar').style.width = attendanceRate + '%';
            
            // Quick Stats
            const periods = DB.get('periods');
            document.getElementById('totalPeriodsToday').textContent = periods.length;
            document.getElementById('completedClasses').textContent = Math.floor(Math.random() * routines.length); // Simulated
            document.getElementById('pendingClasses').textContent = routines.length - document.getElementById('completedClasses').textContent;
            document.getElementById('substituteNeeded').textContent = todayAbsent;
            
            // Load components
            loadHighlights();
            loadRecentActivities();
            loadDashboardCharts();
            startRealTimeClock();
            updateLastUpdateTime();
            
            // Auto-refresh every 30 seconds
            if (!window.dashboardInterval) {
                window.dashboardInterval = setInterval(() => {
                    loadDashboard();
                }, 30000);
            }
        }

        function updateSystemHealth() {
            const teachers = DB.get('teachers');
            const routines = DB.get('routines');
            const attendance = DB.get('attendance') || [];
            
            let status = 'ðŸŸ¢';
            let text = 'All systems operational';
            
            if (teachers.length === 0 || routines.length === 0) {
                status = 'ðŸŸ¡';
                text = 'Incomplete data - add teachers & routines';
            }
            
            const today = new Date().toISOString().split('T')[0];
            const todayAbsent = attendance.filter(a => a.date === today && a.status === 'absent').length;
            
            if (todayAbsent > teachers.length * 0.3) {
                status = 'ðŸ”´';
                text = 'High absenteeism detected';
            }
            
            document.getElementById('dataHealth').textContent = status;
            document.getElementById('dataHealthText').textContent = text;
        }

        function startRealTimeClock() {
            // Prevent multiple intervals
            if (window.clockInterval) return;
            
            function updateClock() {
                const now = new Date();
                const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const date = now.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                const timeEl = document.getElementById('currentTime');
                const dateEl = document.getElementById('currentDate');
                
                if (timeEl) timeEl.textContent = time;
                if (dateEl) dateEl.textContent = date;
            }
            
            updateClock();
            window.clockInterval = setInterval(updateClock, 1000);
            
            // Update logged user
            const username = sessionStorage.getItem('username') || 'Administrator';
            const userEl = document.getElementById('loggedUser');
            if (userEl) userEl.textContent = username;
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeAgo = 'Just now';
            const el = document.getElementById('lastUpdate');
            if (el) el.textContent = timeAgo;
        }

        function loadRecentActivities() {
            const attendance = DB.get('attendance') || [];
            const routines = DB.get('routines');
            const provisionals = DB.get('provisionalRoutines') || [];
            const teachers = DB.get('teachers');
            
            let activities = [];
            
            // Recent attendance
            attendance.slice(-5).reverse().forEach(a => {
                const teacher = teachers.find(t => t.id == a.teacherId);
                activities.push({
                    icon: a.status === 'absent' ? 'âš ï¸' : 'âœ…',
                    text: `${teacher ? teacher.name : 'Teacher'} marked ${a.status}`,
                    time: new Date(a.timestamp || Date.now()).toLocaleString('en-IN'),
                    type: a.status
                });
            });
            
            // Recent provisionals
            provisionals.slice(-3).reverse().forEach(p => {
                activities.push({
                    icon: 'ðŸ”„',
                    text: `Provisional routine created for ${p.className}`,
                    time: new Date(p.createdAt || Date.now()).toLocaleString('en-IN'),
                    type: 'provisional'
                });
            });
            
            // Recent routines
            routines.slice(-2).reverse().forEach(r => {
                activities.push({
                    icon: 'ðŸ“‹',
                    text: `Routine entry added for ${r.className}`,
                    time: new Date(r.createdAt || Date.now()).toLocaleString('en-IN'),
                    type: 'routine'
                });
            });
            
            // Sort by time
            activities.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            let html = '';
            if (activities.length === 0) {
                html = '<p style="text-align: center; padding: 40px; color: #999;">No recent activities</p>';
            } else {
                activities.slice(0, 10).forEach(activity => {
                    html += `
                        <div class="activity-item">
                            <div style="display: flex; align-items: start; gap: 10px;">
                                <span style="font-size: 1.5em;">${activity.icon}</span>
                                <div style="flex: 1;">
                                    <div>${activity.text}</div>
                                    <div class="activity-time">${activity.time}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            const el = document.getElementById('recentActivities');
            if (el) el.innerHTML = html;
        }

        function loadDashboardCharts() {
            loadTeacherDistributionChart();
            loadWeeklyAttendanceChart();
        }

        function loadTeacherDistributionChart() {
            const canvas = document.getElementById('teacherDistributionChart');
            if (!canvas) return;
            
            const teachers = DB.get('teachers');
            const sections = {
                'Upper Primary': 0,
                'Secondary': 0,
                'Higher Secondary': 0,
                'All': 0
            };
            
            teachers.forEach(t => {
                if (sections.hasOwnProperty(t.section)) {
                    sections[t.section]++;
                }
            });
            
            if (window.teacherDistChart) window.teacherDistChart.destroy();
            
            window.teacherDistChart = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(sections),
                    datasets: [{
                        data: Object.values(sections),
                        backgroundColor: ['#667eea', '#11998e', '#f5576c', '#FF9800']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function loadWeeklyAttendanceChart() {
            const canvas = document.getElementById('weeklyAttendanceChart');
            if (!canvas) return;
            
            const attendance = DB.get('attendance') || [];
            const teachers = DB.get('teachers');
            
            // Last 7 days
            const days = [];
            const presentData = [];
            const absentData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                
                days.push(dayName);
                
                const dayAbsent = attendance.filter(a => a.date === dateStr && a.status === 'absent').length;
                const dayPresent = teachers.length - dayAbsent;
                
                presentData.push(dayPresent);
                absentData.push(dayAbsent);
            }
            
            if (window.weeklyAttChart) window.weeklyAttChart.destroy();
            
            window.weeklyAttChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [
                        {
                            label: 'Present',
                            data: presentData,
                            backgroundColor: '#4CAF50'
                        },
                        {
                            label: 'Absent',
                            data: absentData,
                            backgroundColor: '#f44336'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function refreshActivities() {
            showAlert('ðŸ”„ Refreshing activities...', 'info');
            loadRecentActivities();
            setTimeout(() => showAlert('âœ… Activities refreshed!', 'success'), 500);
        }

        function loadHighlights() {
            const today = new Date().toISOString().split('T')[0];
            const attendance = DB.get('attendance') || [];
            const provisionals = DB.get('provisionals') || [];
            
            const todayAttendance = attendance.filter(a => a.date === today);
            const recentProvisionals = provisionals. filter(p => p.date === today);
            
            let html = '';
            
            if (todayAttendance.length > 0) {
                html += `
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">âš ï¸ Today's Attendance</h4>
                        <p style="color: #856404; margin:  0;">${todayAttendance.length} teacher(s) marked as unavailable today</p>
                    </div>
                `;
            }
            
            if (recentProvisionals.length > 0) {
                html += `
                    <div style="background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #0c5460; margin-bottom: 10px;">ðŸ”„ Today's Provisional Routines</h4>
                        <p style="color: #0c5460; margin: 0;">${recentProvisionals. length} provisional routine(s) created for today</p>
                    </div>
                `;
            }
            
            if (html === '') {
                html = '<p style="text-align: center; padding: 40px; color: #666;">No highlights for today.  All systems running smoothly!  âœ…</p>';
            }
            
            document.getElementById('highlightsContent').innerHTML = html;
        }

 // ==================== MOBILE RESPONSIVE HELPERS ====================
        
        // Detect mobile device
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                   || window.innerWidth < 768;
        }
        
        // Make tables horizontally scrollable on mobile
        function makeTablesResponsive() {
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                if (!table.parentElement.classList.contains('table-container')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-container';
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                }
            });
        }
        
        // Adjust modal for mobile
        function adjustModalForMobile() {
            if (isMobileDevice()) {
                document.querySelectorAll('.modal-content').forEach(modal => {
                    modal.style.width = '100%';
                    modal.style.maxWidth = '100%';
                    modal.style.margin = '0';
                    modal.style.borderRadius = '0';
                });
            }
        }
        
        // Prevent body scroll when modal is open on mobile
        function preventBodyScroll(prevent) {
            if (isMobileDevice()) {
                document.body.style.overflow = prevent ? 'hidden' : 'auto';
            }
        }
        
        // Show mobile-friendly alert for large actions
        function confirmMobileAction(message) {
            if (isMobileDevice()) {
                return confirm(message + '\n\nNote: Best viewed on larger screens for full details.');
            }
            return confirm(message);
        }
        
        // Add swipe gesture support for modals
        function addSwipeToClose(modalElement) {
            if (!isMobileDevice()) return;
            
            let startY = 0;
            let currentY = 0;
            
            modalElement.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            });
            
            modalElement.addEventListener('touchmove', (e) => {
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                
                if (diff > 0) {
                    modalElement.style.transform = `translateY(${diff}px)`;
                }
            });
            
            modalElement.addEventListener('touchend', () => {
                const diff = currentY - startY;
                
                if (diff > 150) {
                    // Swipe down to close
                    modalElement.style.transition = 'transform 0.3s';
                    modalElement.style.transform = 'translateY(100%)';
                    setTimeout(() => {
                        modalElement.remove();
                        preventBodyScroll(false);
                    }, 300);
                } else {
                    // Return to position
                    modalElement.style.transition = 'transform 0.3s';
                    modalElement.style.transform = 'translateY(0)';
                }
            });
        }
        
        // Optimize table rendering for mobile
        function optimizeTablesForMobile() {
            if (!isMobileDevice()) return;
            
            document.querySelectorAll('table').forEach(table => {
                // Add mobile class
                table.classList.add('mobile-optimized');
                
                // Make table horizontally scrollable
                if (!table.parentElement.classList.contains('table-container')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-container';
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                }
                
                // Add scroll hint
                const wrapper = table.closest('.table-container');
                if (wrapper && !wrapper.querySelector('.scroll-hint')) {
                    const hint = document.createElement('div');
                    hint.className = 'scroll-hint';
                    hint.textContent = 'â† Scroll horizontally â†’';
                    hint.style.cssText = 'text-align: center; padding: 5px; font-size: 0.8em; color: #666; background: #f5f5f5;';
                    wrapper.insertBefore(hint, table);
                    
                    // Hide hint after scroll
                    wrapper.addEventListener('scroll', () => {
                        hint.style.display = 'none';
                    }, { once: true });
                }
            });
        }
        
        // Initialize mobile optimizations
        function initMobileOptimizations() {
            if (isMobileDevice()) {
                // Add mobile class to body
                document.body.classList.add('mobile-device');
                
                // Optimize tables
                optimizeTablesForMobile();
                
                // Adjust touch targets
                document.querySelectorAll('.btn, button, .nav-tab').forEach(el => {
                    el.style.minHeight = '44px';
                    el.style.minWidth = '44px';
                });
                
                // Prevent zoom on input focus (iOS)
                document.querySelectorAll('input, select, textarea').forEach(el => {
                    el.style.fontSize = '16px';
                });
                
                console.log('âœ… Mobile optimizations applied');
            }
        }
        
        // Add orientation change handler
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                initMobileOptimizations();
                if (typeof loadDashboard === 'function') {
                    loadDashboard();
                }
            }, 100);
        });

 // ==================== INITIALIZATION (FIXED) ====================
// Load or create default settings
function loadOrCreateDefaultSettings() {
    // Check if settings exist, if not create defaults
    let settings = DB.getObj('settings');
    
    if (!settings || Object.keys(settings).length === 0) {
        // Create default settings
        settings = {
            schoolName: 'Ramnagar High School (H.S.)',
            schoolCode: '19090310603',
            academicYear: '2025-26',
            sessionStart: '2025-04-01',
            sessionEnd: '2026-03-31',
            workingDays: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
            periodsPerDay: 7,
            periodDuration: 45,
            breakDuration: 10,
            schoolStartTime: '10:00',
            lunchBreak: '13:00-13:45',
            schoolEndTime: '16:00',
            autoBackup: true,
            backupInterval: 'daily',
            theme: 'light',
            notifications: true
        };
        
        DB.setObj('settings', settings);
        console.log('Default settings created');
    }
    
    return settings;
}

// Update header display with school information
function updateHeaderDisplay() {
    const settings = DB.getObj('settings');
    
    // Update school name in header if element exists
    const schoolNameElement = document.querySelector('.header-left h1');
    if (schoolNameElement && settings.schoolName) {
        schoolNameElement.innerHTML = 'ðŸŽ“ RHS PRMS';
    }
    
    // Update school details if element exists
    const schoolDetailsElement = document.querySelector('.header-left p');
    if (schoolDetailsElement && settings.schoolName && settings.schoolCode) {
        schoolDetailsElement.textContent = `${settings.schoolName} | DISE: ${settings.schoolCode}`;
    }
    
    console.log('Header display updated');
}

// Setup auto-logout timer
let autoLogoutTimer = null;
let autoLogoutWarningTimer = null;

function setupAutoLogout(timeoutMinutes) {
    // Clear any existing timers
    if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
    if (autoLogoutWarningTimer) clearTimeout(autoLogoutWarningTimer);
    
    // Don't setup if timeout is 0 or negative
    if (timeoutMinutes <= 0) return;
    
    const timeoutMs = timeoutMinutes * 60 * 1000; // Convert to milliseconds
    const warningMs = timeoutMs - (2 * 60 * 1000); // Warn 2 minutes before
    
    // Reset timer on user activity
    const resetTimer = () => {
        if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
        if (autoLogoutWarningTimer) clearTimeout(autoLogoutWarningTimer);
        
        // Setup warning (2 minutes before logout)
        if (warningMs > 0) {
            autoLogoutWarningTimer = setTimeout(() => {
                showAlert('âš ï¸ Session will expire in 2 minutes due to inactivity', 'warning');
            }, warningMs);
        }
        
        // Setup logout
        autoLogoutTimer = setTimeout(() => {
            showAlert('ðŸ”’ Session expired due to inactivity. Please login again.', 'error');
            setTimeout(() => {
                logout();
            }, 2000);
        }, timeoutMs);
    };
    
    // Listen for user activity
    const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
    events.forEach(event => {
        document.addEventListener(event, resetTimer, true);
    });
    
    // Start the timer
    resetTimer();
    
    console.log(`Auto-logout configured: ${timeoutMinutes} minutes`);
}

function initApp() {
    loadTheme();
    
    // Initialize mobile optimizations
    initMobileOptimizations();
    
    // Load settings FIRST
    loadOrCreateDefaultSettings();
    
    // Update header with settings
    updateHeaderDisplay();
    
    // Then load dashboard
    loadDashboard();
    
    // Initialize empty arrays if not exist
    if (!localStorage.getItem('teachers')) DB.set('teachers', []);
    if (!localStorage.getItem('subjects')) DB.set('subjects', []);
    if (!localStorage.getItem('classes')) DB.set('classes', []);
    if (!localStorage.getItem('periods')) DB.set('periods', []);
    if (!localStorage.getItem('routines')) DB.set('routines', []);
    if (!localStorage.getItem('attendance')) DB.set('attendance', []);
    if (!localStorage.getItem('provisionals')) DB.set('provisionals', []);
    if (!localStorage.getItem('uploadHistory')) DB.set('uploadHistory', []);
    
    // Setup auto-logout if configured
    const settings = DB.getObj('settings');
    const timeout = parseInt(settings.autoLogout) || 0;
    if (timeout > 0) {
        setupAutoLogout(timeout);
    }
    
    // âœ… START AUTO-SAVE SYSTEM
    enableAutoSave();
    
    // âœ… LOAD SAVED LANGUAGE
    loadSavedLanguage();
    
    // âœ… LOAD NOTICES
    displayNotices();
    
    // âœ… LOAD EVENTS  
    displayEvents();
    
    // âœ… LOAD UPLOAD HISTORY
    loadUploadHistory();
}

        // ==================== EVENT LISTENERS ====================
        document. addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Set today's date for attendance
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (! input.value) input.value = today;
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K: Quick search (future feature)
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                showAlert('ðŸ” Quick search coming soon!', 'info');
            }
            
            // Ctrl/Cmd + S: Save (prevent browser save)
            if ((e. ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                showAlert('ðŸ’¾ Auto-save is enabled!', 'info');
            }
            
            // Escape: Close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(m => m.remove());
            }
        });

        // Auto-save indicator
        let saveTimeout;
        document.addEventListener('input', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    // Auto-save logic can be added here
                }, 1000);
            }
        });

        // Offline detection
        window.addEventListener('offline', function() {
            showAlert('âš ï¸ You are offline.  Data will be saved locally.', 'warning');
        });

        window.addEventListener('online', function() {
            showAlert('âœ… You are back online! ', 'success');
        });

        // Console welcome message
        console.log('%cðŸŽ“ RHS PRMS v2.6', 'font-size: 24px; font-weight: bold; color: #1e3c72;');
        console.log('%cðŸ“š Professional Routine Management System', 'font-size: 14px; color: #666;');
        console.log('%cðŸ‘¨â€ðŸ’» Developed by Tapas Mahata', 'font-size: 12px; color: #999;');
        console.log('%cðŸš€ All Features Active!', 'font-size: 12px; color: #4CAF50; font-weight: bold;');
        
    
        

        // Forgot Password Function
        function showForgotPassword(e) {
            e.preventDefault();
            
            // Create forgot password modal
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '10000';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            modal.innerHTML = `
                <div style="background: white; padding: 35px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideUp 0.3s;">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">ðŸ”‘</div>
                        <h2 style="color: #1e3c72; margin: 0;">Password Recovery</h2>
                        <p style="color: #666; margin-top: 10px;">Reset your password securely</p>
                    </div>
                    
                    <div id="forgotPasswordStep1">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                Select Your Role *
                            </label>
                            <select id="resetRole" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="">-- Select Role --</option>
                                <option value="admin">ðŸ‘¨â€ðŸ’¼ Admin</option>
                                <option value="teacher">ðŸ‘¨â€ðŸ« Teacher</option>
                                <option value="office">ðŸ“‹ Office Staff</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                Username *
                            </label>
                            <input type="text" id="resetUsername" placeholder="Enter your username" 
                                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800; margin-bottom: 20px;">
                            <p style="margin: 0; color: #856404; font-size: 13px;">
                                <strong>âš ï¸ Important:</strong><br>
                                If you don't remember your username or role, please contact the system administrator at school office.
                            </p>
                        </div>
                        
                        <button onclick="verifyUserForReset()" class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 15px; font-weight: 600;">
                            ðŸ” Verify & Continue
                        </button>
                    </div>
                    
                    <div id="forgotPasswordStep2" style="display: none;">
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50; margin-bottom: 20px;">
                            <p style="margin: 0; color: #155724; font-weight: 600;">
                                âœ… User Verified: <span id="verifiedUser"></span>
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                Security Question
                            </label>
                            <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <p style="margin: 0; color: #333; font-weight: 500;" id="securityQuestion">What is the school's DISE code? (Digits only)</p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                Your Answer *
                            </label>
                            <input type="text" id="securityAnswer" placeholder="Enter DISE code (11 digits)" 
                                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                                maxlength="11">
                            <small style="color: #666; font-size: 12px;">ðŸ’¡ Check school records or contact office if you don't know</small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                New Password *
                            </label>
                            <div style="position: relative;">
                                <input type="password" id="newPassword" placeholder="Enter new password (min 6 characters)" 
                                    style="width: 100%; padding: 12px; padding-right: 50px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <button type="button" onclick="toggleNewPassword()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; font-size: 20px; padding: 4px 6px; color: #666; transition: all 0.3s; line-height: 1;" onmouseover="this.style.color='#1e3c72'" onmouseout="this.style.color='#666'">
                                    <span id="newPasswordToggleIcon">ðŸ‘ï¸</span>
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                Confirm Password *
                            </label>
                            <div style="position: relative;">
                                <input type="password" id="confirmPassword" placeholder="Re-enter new password" 
                                    style="width: 100%; padding: 12px; padding-right: 50px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <button type="button" onclick="toggleConfirmPassword()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; font-size: 20px; padding: 4px 6px; color: #666; transition: all 0.3s; line-height: 1;" onmouseover="this.style.color='#1e3c72'" onmouseout="this.style.color='#666'">
                                    <span id="confirmPasswordToggleIcon">ðŸ‘ï¸</span>
                                </button>
                            </div>
                        </div>
                        
                        <button onclick="resetPasswordNow()" class="btn btn-success" style="width: 100%; padding: 14px; font-size: 15px; font-weight: 600;">
                            ðŸ” Reset Password
                        </button>
                        
                        <button onclick="backToStep1()" class="btn btn-secondary" style="width: 100%; padding: 12px; font-size: 14px; margin-top: 10px; background: #6c757d;">
                            â† Back
                        </button>
                    </div>
                    
                    <button onclick="this.closest('.modal').remove()" style="position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 28px; color: #999; cursor: pointer; padding: 5px 10px; transition: all 0.3s;">
                        Ã—
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function verifyUserForReset() {
            const role = document.getElementById('resetRole').value;
            const username = document.getElementById('resetUsername').value.trim();
            
            if (!role) {
                alert('âš ï¸ Please select your role!');
                return;
            }
            
            if (!username) {
                alert('âš ï¸ Please enter your username!');
                return;
            }
            
            // Check if username exists
            
            if (USERS[username] && USERS[username].role === role) {
                // User verified, show step 2
                document.getElementById('forgotPasswordStep1').style.display = 'none';
                document.getElementById('forgotPasswordStep2').style.display = 'block';
                document.getElementById('verifiedUser').textContent = USERS[username].name + ' (' + username + ')';
                
                // Store for later use
                window.resetUserData = { username, role };
            } else {
                alert('âŒ Invalid username or role combination!\n\nPlease check your credentials.');
            }
        }
        
        function backToStep1() {
            document.getElementById('forgotPasswordStep2').style.display = 'none';
            document.getElementById('forgotPasswordStep1').style.display = 'block';
            
            // Clear fields
            document.getElementById('securityAnswer').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        // ==================== PASSWORD TOGGLE FUNCTIONS ====================
        
        function toggleLoginPassword() {
            const passwordField = document.getElementById('loginPassword');
            const toggleIcon = document.getElementById('loginPasswordToggleIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.textContent = 'ðŸ™ˆ';
            } else {
                passwordField.type = 'password';
                toggleIcon.textContent = 'ðŸ‘ï¸';
            }
        }
        
        function toggleNewPassword() {
            const passwordField = document.getElementById('newPassword');
            const toggleIcon = document.getElementById('newPasswordToggleIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.textContent = 'ðŸ™ˆ';
            } else {
                passwordField.type = 'password';
                toggleIcon.textContent = 'ðŸ‘ï¸';
            }
        }
        
        function toggleConfirmPassword() {
            const passwordField = document.getElementById('confirmPassword');
            const toggleIcon = document.getElementById('confirmPasswordToggleIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.textContent = 'ðŸ™ˆ';
            } else {
                passwordField.type = 'password';
                toggleIcon.textContent = 'ðŸ‘ï¸';
            }
        }
        
        // Settings page unified password toggles
        function toggleCurrentUserPassword() {
            const passwordField = document.getElementById('currentUserPassword');
            const toggleIcon = document.getElementById('currentUserPasswordToggleIcon');
            
            if (passwordField && passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.textContent = 'ðŸ™ˆ';
            } else if (passwordField) {
                passwordField.type = 'password';
                toggleIcon.textContent = 'ðŸ‘ï¸';
            }
        }
        
        function toggleNewUserPassword() {
            const passwordField = document.getElementById('newUserPassword');
            const toggleIcon = document.getElementById('newUserPasswordToggleIcon');
            
            if (passwordField && passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.textContent = 'ðŸ™ˆ';
            } else if (passwordField) {
                passwordField.type = 'password';
                toggleIcon.textContent = 'ðŸ‘ï¸';
            }
        }
        
        function toggleConfirmUserPassword() {
            const passwordField = document.getElementById('confirmUserPassword');
            const toggleIcon = document.getElementById('confirmUserPasswordToggleIcon');
            
            if (passwordField && passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.textContent = 'ðŸ™ˆ';
            } else if (passwordField) {
                passwordField.type = 'password';
                toggleIcon.textContent = 'ðŸ‘ï¸';
            }
        }
        
        // Update password labels based on selected user type
        function updatePasswordLabels() {
            const userType = document.getElementById('passwordUserType').value;
            const usernameField = document.getElementById('selectedUsername');
            const passwordFields = document.getElementById('passwordChangeFields');
            
            if (userType) {
                usernameField.value = userType;
                passwordFields.style.display = 'block';
                
                // Clear previous values
                document.getElementById('currentUserPassword').value = '';
                document.getElementById('newUserPassword').value = '';
                document.getElementById('confirmUserPassword').value = '';
            } else {
                usernameField.value = 'Select user type first';
                passwordFields.style.display = 'none';
            }
        }
        
        // Change password for selected user type
        function changeUserPassword() {
            const userType = document.getElementById('passwordUserType').value;
            const currentPassword = document.getElementById('currentUserPassword').value;
            const newPassword = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('confirmUserPassword').value;
            
            if (!userType) {
                showAlert('âš ï¸ Please select a user type!', 'error');
                return;
            }
            
            if (!currentPassword) {
                showAlert('âš ï¸ Please enter current password!', 'error');
                return;
            }
            
            // Verify current password
            const storedPassword = localStorage.getItem(userType + 'Password') || USERS[userType].password;
            if (currentPassword !== storedPassword) {
                showAlert('âŒ Current password is incorrect!', 'error');
                return;
            }
            
            if (!newPassword || newPassword.length < 6) {
                showAlert('âš ï¸ New password must be at least 6 characters!', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('âŒ Passwords do not match!', 'error');
                return;
            }
            
            // Save new password
            USERS[userType].password = newPassword;
            localStorage.setItem(userType + 'Password', newPassword);
            
            // Clear fields
            document.getElementById('currentUserPassword').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('confirmUserPassword').value = '';
            document.getElementById('passwordUserType').value = '';
            document.getElementById('selectedUsername').value = 'Select user type first';
            document.getElementById('passwordChangeFields').style.display = 'none';
            
            // Success message
            const userTypeNames = {
                'admin': 'Admin',
                'teacher': 'Teacher',
                'office': 'Office Staff'
            };
            
            showAlert('âœ… ' + userTypeNames[userType] + ' password changed successfully!', 'success');
        }
        
        function resetPasswordNow() {
            const answer = document.getElementById('securityAnswer').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate security answer (DISE code)
            const correctAnswer = '19090310603'; // School's DISE code
            if (answer !== correctAnswer) {
                alert('âŒ Incorrect DISE code!\n\nPlease check school records or contact the office.\n\nHint: It\'s an 11-digit number starting with 19');
                return;
            }
            
            // Validate password
            if (!newPassword || newPassword.length < 6) {
                alert('âš ï¸ Password must be at least 6 characters long!');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('âŒ Passwords do not match!');
                return;
            }
            
            // Reset password (update USERS object or localStorage)
            const userData = window.resetUserData;
            
            // For demo, we'll update the in-memory USERS object
            // In production, this would update the database
            
            // Store in localStorage for persistence
            const storedPasswords = JSON.parse(localStorage.getItem('userPasswords') || '{}');
            storedPasswords[userData.username] = newPassword;
            localStorage.setItem('userPasswords', JSON.stringify(storedPasswords));
            
            // Success message
            alert('âœ… Password Reset Successful!\n\n' + 
                  'Your new password has been set.\n\n' +
                  'Please save your new password securely.\n' +
                  'You can now login with your new credentials.');
            
            // Close modal
            document.querySelector('.modal').remove();
            
            // Clear reset data
            delete window.resetUserData;
        }
    

    
        // Button Click Feedback
        function buttonClickFeedback(button) {
            button.style.transform = 'scale(0.95)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 100);
        }
        
        // Add click feedback to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('.btn, button');
            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    buttonClickFeedback(this);
                });
            });
            
            // Start real-time clock immediately
            startRealTimeClock();
        });


// ==================== CORE FIXES ====================

// 1. Fix Script Tags - External scripts should be separate
// Remove all code from inside external script tags

// 2. Add Missing Utility Functions
function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.remove('show');
}

function showLoading(show, text = 'Processing...') {
    const overlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    if (overlay && loadingText) {
        loadingText.textContent = text;
        if (show) {
            overlay.classList.add('show');
        } else {
            overlay.classList.remove('show');
        }
    }
}

// 3. Enhanced Database with Encryption
const SecureDB = {
    // Simple encryption (use a proper library in production)
    encrypt: (data) => {
        try {
            return btoa(JSON.stringify(data));
        } catch(e) {
            return data;
        }
    },
    
    decrypt: (data) => {
        try {
            return JSON.parse(atob(data));
        } catch(e) {
            return data;
        }
    },
    
    set: (key, data) => {
        const encrypted = SecureDB.encrypt(data);
        localStorage.setItem(key, encrypted);
    },
    
    get: (key) => {
        const encrypted = localStorage.getItem(key);
        if (!encrypted) return [];
        return SecureDB.decrypt(encrypted);
    },
    
    setObj: (key, data) => {
        const encrypted = SecureDB.encrypt(data);
        localStorage.setItem(key, encrypted);
    },
    
    getObj: (key) => {
        const encrypted = localStorage.getItem(key);
        if (!encrypted) return {};
        return SecureDB.decrypt(encrypted);
    }
};


// ==================== ADVANCED SECURITY ====================

// User Management with Permissions
const UserManagement = {
    roles: {
        admin: {
            permissions: ['all'],
            name: 'Administrator'
        },
        teacher:  {
            permissions: ['view_routine', 'mark_attendance', 'view_reports'],
            name: 'Teacher'
        },
        office: {
            permissions: ['manage_data', 'view_reports', 'export_data'],
            name: 'Office Staff'
        },
        guest: {
            permissions: ['view_routine'],
            name: 'Guest'
        }
    },
    
    // Check permission
    hasPermission: (role, permission) => {
        const userRole = UserManagement.roles[role];
        if (!userRole) return false;
        return userRole.permissions.includes('all') || userRole.permissions.includes(permission);
    },
    
    // Login History
    logLogin: (username, role) => {
        const history = SecureDB.get('loginHistory') || [];
        history.push({
            username,
            role,
            timestamp: new Date().toISOString(),
            ip: 'N/A', // Can be enhanced with backend
            device: navigator.userAgent
        });
        // Keep only last 50 logins
        if (history.length > 50) history.shift();
        SecureDB.set('loginHistory', history);
    },
    
    // Session timeout
    setupSessionTimeout: (minutes = 30) => {
        let timeout;
        
        const resetTimer = () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                alert('â° Session expired due to inactivity');
                logout();
            }, minutes * 60 * 1000);
        };
        
        // Reset on user activity
        ['mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetTimer);
        });
        
        resetTimer();
    },
    
    // Password strength checker
    checkPasswordStrength:  (password) => {
        let strength = 0;
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        if (/[a-z]/.test(password) && /[A-Z]/. test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[^a-zA-Z\d]/. test(password)) strength++;
        
        return {
            score: strength,
            level: strength < 2 ? 'Weak' :  strength < 4 ? 'Medium' : 'Strong',
            color: strength < 2 ? '#f44336' : strength < 4 ? '#FF9800' : '#4CAF50'
        };
    }
};

// Enhanced Login Function
function enhancedLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    const role = document.getElementById('loginRole').value;
    
    if (!role) {
        showAlert('âš ï¸ Please select a role! ', 'error');
        return;
    }
    
    if (USERS[username] && USERS[username].password === password && USERS[username].role === role) {
        // Log login
        UserManagement.logLogin(username, role);
        
        // Set session
        sessionStorage.setItem('loggedIn', 'true');
        sessionStorage.setItem('username', USERS[username].name);
        sessionStorage.setItem('role', role);
        sessionStorage.setItem('loginTime', new Date().toISOString());
        
        // Setup session timeout
        const settings = SecureDB.getObj('settings');
        const timeout = parseInt(settings.autoLogout) || 30;
        if (timeout > 0) {
            UserManagement.setupSessionTimeout(timeout);
        }
        
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        
        initApp();
        showAlert('Welcome back, ' + USERS[username].name + '!  ðŸŽ‰', 'success');
    } else {
        const loginError = document.getElementById('loginError');
        if (loginError) {
            loginError.classList.add('show');
            setTimeout(() => loginError.classList.remove('show'), 3000);
        }
    }
}

// ==================== MOBILE FEATURES ====================

const MobileFeatures = {
    // Detect mobile device
    isMobile: () => {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator. userAgent);
    },
    
    // Offline mode
    enableOfflineMode: () => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker. register('/sw.js')
                .then(() => console.log('Offline mode enabled'))
                .catch(err => console.log('Service worker error:', err));
        }
        
        // Cache data for offline use
        window.addEventListener('online', () => {
            showAlert('âœ… Back online!', 'success');
        });
        
        window.addEventListener('offline', () => {
            showAlert('âš ï¸ Offline mode active', 'warning');
        });
    },
    
    // QR Code Generator
    generateQRCode: (data) => {
        // Use a QR library like qrcode.js
        return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(data)}`;
    },
    
    // QR Attendance
    showQRAttendance: () => {
        const today = new Date().toISOString().split('T')[0];
        const qrData = {
            school: 'RHS',
            date: today,
            type: 'attendance'
        };
        
        const qrUrl = MobileFeatures.generateQRCode(JSON. stringify(qrData));
        
        const content = `
            <div style="text-align: center;">
                <h3>ðŸ“± QR Code Attendance</h3>
                <p>Scan this code to mark attendance</p>
                <img src="${qrUrl}" alt="QR Code" style="max-width: 300px; margin: 20px auto;">
                <p style="color: #666; font-size: 14px;">Valid for:  ${today}</p>
            </div>
        `;
        
        showModal('QR Code Attendance', content);
    },
    
    // Push Notifications (requires service worker)
    requestNotificationPermission: () => {
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    showAlert('ðŸ”” Notifications enabled! ', 'success');
                }
            });
        }
    },
    
    sendNotification: (title, body) => {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, {
                body,
                icon: '/icon.png',
                badge: '/badge.png'
            });
        }
    }
};
// ==================== AI SMART FEATURES ====================

const AIEnhanced = {
    // Smart Conflict Detection
    detectConflicts: (routine) => {
        const conflicts = [];
        const routines = DB.get('routines');
        
        routines.forEach(existing => {
            // Same teacher, same period, same day
            if (existing. teacherName === routine.teacherName &&
                existing.periodNumber === routine.periodNumber &&
                existing.day === routine.day) {
                conflicts.push({
                    type: 'teacher_conflict',
                    message:  `${routine.teacherName} is already assigned to ${existing.className} at this time`,
                    severity: 'high'
                });
            }
            
            // Same class, same period, same day
            if (existing.className === routine.className &&
                existing.periodNumber === routine.periodNumber &&
                existing.day === routine.day) {
                conflicts. push({
                    type: 'class_conflict',
                    message: `${routine.className} already has ${existing.subjectName} at this time`,
                    severity: 'high'
                });
            }
        });
        
        return conflicts;
    },
    
    // Workload Balancing Suggestions
    suggestWorkloadBalance: () => {
        const teachers = DB.get('teachers');
        const routines = DB.get('routines');
        
        const workload = teachers.map(teacher => {
            const classes = routines.filter(r => r.teacherName === teacher.name).length;
            return { name: teacher.name, classes };
        });
        
        const avg = workload.reduce((sum, t) => sum + t.classes, 0) / workload.length;
        
        const suggestions = [];
        workload.forEach(teacher => {
            if (teacher.classes > avg * 1.3) {
                suggestions.push({
                    teacher: teacher.name,
                    current: teacher.classes,
                    suggested: Math.round(avg),
                    action: 'reduce',
                    message: `${teacher.name} has ${teacher.classes} classes (${Math.round(teacher.classes - avg)} above average)`
                });
            } else if (teacher.classes < avg * 0.7) {
                suggestions.push({
                    teacher: teacher.name,
                    current: teacher.classes,
                    suggested: Math.round(avg),
                    action: 'increase',
                    message:  `${teacher.name} has ${teacher.classes} classes (${Math.round(avg - teacher.classes)} below average)`
                });
            }
        });
        
        return suggestions;
    },
    
    // Predictive Analytics
    predictAbsencePatterns: () => {
        const attendance = DB.get('attendance') || [];
        const teachers = DB.get('teachers');
        
        const patterns = {};
        
        teachers.forEach(teacher => {
            const absences = attendance.filter(a => 
                a.teacherName === teacher.name && 
                a.status === 'absent'
            );
            
            // Calculate absence rate
            const totalDays = 30; // Last 30 days
            const absenceRate = (absences.length / totalDays) * 100;
            
            patterns[teacher.name] = {
                totalAbsences: absences.length,
                rate: absenceRate. toFixed(2),
                risk: absenceRate > 10 ? 'high' : absenceRate > 5 ? 'medium' : 'low'
            };
        });
        
        return patterns;
    },
    
    // Auto-Schedule Optimization
    optimizeSchedule: () => {
        const routines = DB.get('routines');
        const teachers = DB.get('teachers');
        const periods = DB.get('periods');
        
        // Calculate optimal distribution
        const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
        const optimization = [];
        
        teachers.forEach(teacher => {
            const teacherClasses = routines.filter(r => r.teacherName === teacher.name);
            
            // Check distribution across days
            const distribution = {};
            days.forEach(day => {
                distribution[day] = teacherClasses.filter(c => c.day === day).length;
            });
            
            // Find imbalances
            const max = Math.max(...Object.values(distribution));
            const min = Math.min(...Object.values(distribution));
            
            if (max - min > 2) {
                optimization.push({
                    teacher: teacher.name,
                    issue: 'uneven_distribution',
                    distribution,
                    suggestion: 'Balance classes across days more evenly'
                });
            }
        });
        
        return optimization;
    }
};

// ==================== CALENDAR FEATURES ====================

const CalendarModule = {
    // Holiday Calendar
    holidays: [
        { date: '2024-01-26', name: 'Republic Day', type: 'national' },
        { date: '2024-08-15', name: 'Independence Day', type: 'national' },
        { date: '2024-10-02', name: 'Gandhi Jayanti', type: 'national' },
        // Add more holidays
    ],
    
    // Add Holiday
    addHoliday: (date, name, type) => {
        const holidays = SecureDB.get('holidays') || CalendarModule.holidays;
        holidays.push({ date, name, type });
        SecureDB.set('holidays', holidays);
    },
    
    // Check if date is holiday
    isHoliday: (date) => {
        const holidays = SecureDB.get('holidays') || CalendarModule.holidays;
        return holidays.find(h => h.date === date);
    },
    
    // Exam Schedule
    addExam: (exam) => {
        const exams = SecureDB.get('exams') || [];
        exams.push({
            ... exam,
            id: Date.now(),
            createdAt: new Date().toISOString()
        });
        SecureDB.set('exams', exams);
    },
    
    // Event Management
    addEvent: (event) => {
        const events = SecureDB.get('events') || [];
        events.push({
            ...event,
            id: Date.now(),
            createdAt: new Date().toISOString()
        });
        SecureDB.set('events', events);
    },
    
    // Get upcoming events
    getUpcomingEvents: (days = 7) => {
        const events = SecureDB.get('events') || [];
        const today = new Date();
        const futureDate = new Date(today. getTime() + (days * 24 * 60 * 60 * 1000));
        
        return events.filter(event => {
            const eventDate = new Date(event.date);
            return eventDate >= today && eventDate <= futureDate;
        });
    },
    
    // Calendar View HTML
    renderCalendar: (year, month) => {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay. getDay();
        
        let html = `
            <div class="calendar">
                <div class="calendar-header">
                    <button onclick="CalendarModule.previousMonth()">&lt;</button>
                    <h3>${firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
                    <button onclick="CalendarModule.nextMonth()">&gt;</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>
        `;
        
        // Empty cells before first day
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += '<div class="calendar-day empty"></div>';
        }
        
        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const holiday = CalendarModule.isHoliday(date);
            const isToday = date === new Date().toISOString().split('T')[0];
            
            html += `
                <div class="calendar-day ${isToday ? 'today' :  ''} ${holiday ? 'holiday' :  ''}" 
                     onclick="CalendarModule.showDayDetails('${date}')">
                    <div class="day-number">${day}</div>
                    ${holiday ? `<div class="holiday-marker">${holiday.name}</div>` : ''}
                </div>
            `;
        }
        
        html += '</div></div>';
        return html;
    }
};

// ==================== NOTIFICATION SYSTEM ====================

// Notification Center Storage
const NotificationCenter = {
    notifications: [],
    
    init() {
        this.notifications = DB.get('notifications') || [];
        this.requestPermission();
        this.startNotificationPolling();
    },
    
    // Request browser notification permission
    async requestPermission() {
        if ('Notification' in window) {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                console.log('âœ… Browser notifications enabled');
                showAlert('ðŸ”” Notifications enabled!', 'success');
            }
        }
    },
    
    // Add notification
    add(notification) {
        const newNotification = {
            id: Date.now(),
            title: notification.title,
            message: notification.message,
            type: notification.type || 'info', // info, success, warning, error, urgent
            category: notification.category || 'general', // general, attendance, routine, exam, system
            timestamp: new Date().toISOString(),
            read: false,
            actionUrl: notification.actionUrl || null,
            metadata: notification.metadata || {}
        };
        
        this.notifications.unshift(newNotification);
        
        // Keep only last 100 notifications
        if (this.notifications.length > 100) {
            this.notifications = this.notifications.slice(0, 100);
        }
        
        DB.set('notifications', this.notifications);
        this.updateBadge();
        
        // Show browser notification
        if (notification.showBrowser !== false) {
            this.showBrowserNotification(newNotification);
        }
        
        // Check for SMS/Email triggers
        if (notification.type === 'urgent' || notification.sendSMS) {
            this.triggerSMSAlert(newNotification);
        }
        
        if (notification.sendEmail) {
            this.triggerEmailAlert(newNotification);
        }
        
        return newNotification;
    },
    
    // Show browser push notification
    showBrowserNotification(notification) {
        if ('Notification' in window && Notification.permission === 'granted') {
            const options = {
                body: notification.message,
                icon: 'ðŸ””',
                badge: 'ðŸŽ“',
                tag: notification.id.toString(),
                requireInteraction: notification.type === 'urgent',
                vibrate: notification.type === 'urgent' ? [200, 100, 200] : [100],
                data: {
                    id: notification.id,
                    actionUrl: notification.actionUrl
                }
            };
            
            const n = new Notification(notification.title, options);
            
            n.onclick = function(event) {
                event.preventDefault();
                window.focus();
                if (notification.actionUrl) {
                    eval(notification.actionUrl);
                }
                NotificationCenter.markAsRead(notification.id);
                n.close();
            };
            
            // Auto close after 10 seconds (except urgent)
            if (notification.type !== 'urgent') {
                setTimeout(() => n.close(), 10000);
            }
        }
    },
    
    // Trigger SMS alert (simulated - would need backend)
    triggerSMSAlert(notification) {
        const settings = DB.getObj('notificationSettings') || {};
        
        if (!settings.smsEnabled) {
            console.log('ðŸ“± SMS disabled in settings');
            return;
        }
        
        // In real implementation, this would call backend API
        console.log('ðŸ“± SMS Alert:', {
            to: settings.smsRecipients || [],
            message: `${notification.title}: ${notification.message}`,
            priority: notification.type === 'urgent' ? 'high' : 'normal'
        });
        
        // Simulate SMS sending
        this.logSMSSent(notification);
    },
    
    // Trigger email alert (simulated - would need backend)
    triggerEmailAlert(notification) {
        const settings = DB.getObj('notificationSettings') || {};
        
        if (!settings.emailEnabled) {
            console.log('ðŸ“§ Email disabled in settings');
            return;
        }
        
        // In real implementation, this would call backend API
        console.log('ðŸ“§ Email Alert:', {
            to: settings.emailRecipients || [],
            subject: notification.title,
            body: notification.message,
            priority: notification.type === 'urgent' ? 'high' : 'normal',
            html: this.generateEmailHTML(notification)
        });
        
        // Simulate email sending
        this.logEmailSent(notification);
    },
    
    // Generate HTML email template
    generateEmailHTML(notification) {
        const schoolInfo = DB.getObj('schoolInfo');
        return `
            <!DOCTYPE html>
            <html>
            <head>
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
                    .content { background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0; }
                    .footer { text-align: center; font-size: 12px; color: #666; padding: 20px; }
                    .badge { display: inline-block; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; }
                    .urgent { background: #f44336; color: white; }
                    .warning { background: #ff9800; color: white; }
                    .info { background: #2196F3; color: white; }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <h1>ðŸŽ“ ${schoolInfo.name || 'School Notification'}</h1>
                    </div>
                    <div class="content">
                        <p><span class="badge ${notification.type}">${notification.type.toUpperCase()}</span></p>
                        <h2>${notification.title}</h2>
                        <p>${notification.message}</p>
                        <p><small>â° ${new Date(notification.timestamp).toLocaleString('en-IN')}</small></p>
                    </div>
                    <div class="footer">
                        <p>Generated by RHS PRMS v4.6</p>
                        <p>${schoolInfo.name || 'School'} | ${schoolInfo.phone || ''} | ${schoolInfo.email || ''}</p>
                    </div>
                </div>
            </body>
            </html>
        `;
    },
    
    // Log SMS sent
    logSMSSent(notification) {
        const smsLog = DB.get('smsLog') || [];
        smsLog.push({
            notificationId: notification.id,
            timestamp: new Date().toISOString(),
            message: notification.message,
            status: 'simulated' // In real: 'sent', 'failed', 'delivered'
        });
        DB.set('smsLog', smsLog);
    },
    
    // Log email sent
    logEmailSent(notification) {
        const emailLog = DB.get('emailLog') || [];
        emailLog.push({
            notificationId: notification.id,
            timestamp: new Date().toISOString(),
            subject: notification.title,
            status: 'simulated' // In real: 'sent', 'failed', 'delivered'
        });
        DB.set('emailLog', emailLog);
    },
    
    // Mark as read
    markAsRead(id) {
        const notification = this.notifications.find(n => n.id === id);
        if (notification) {
            notification.read = true;
            DB.set('notifications', this.notifications);
            this.updateBadge();
        }
    },
    
    // Mark all as read
    markAllAsRead() {
        this.notifications.forEach(n => n.read = true);
        DB.set('notifications', this.notifications);
        this.updateBadge();
    },
    
    // Delete notification
    delete(id) {
        this.notifications = this.notifications.filter(n => n.id !== id);
        DB.set('notifications', this.notifications);
        this.updateBadge();
    },
    
    // Clear all
    clearAll() {
        if (confirm('Clear all notifications?')) {
            this.notifications = [];
            DB.set('notifications', []);
            this.updateBadge();
            showAlert('ðŸ—‘ï¸ All notifications cleared', 'info');
        }
    },
    
    // Get unread count
    getUnreadCount() {
        return this.notifications.filter(n => !n.read).length;
    },
    
    // Update badge
    updateBadge() {
        const count = this.getUnreadCount();
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'block' : 'none';
        }
    },
    
    // Start polling for new notifications
    startNotificationPolling() {
        setInterval(() => {
            this.checkForNewNotifications();
        }, 60000); // Check every minute
    },
    
    // Check for new notifications (automated)
    checkForNewNotifications() {
        const today = new Date().toISOString().split('T')[0];
        const attendance = DB.get('attendance') || [];
        const settings = DB.getObj('notificationSettings') || {};
        
        // Check absent teachers
        if (settings.absentTeacherAlert) {
            const todayAbsent = attendance.filter(a => a.date === today && a.status === 'absent');
            if (todayAbsent.length > 0) {
                const teachers = DB.get('teachers');
                todayAbsent.forEach(a => {
                    const teacher = teachers.find(t => t.id == a.teacherId);
                    if (teacher) {
                        this.add({
                            title: 'âš ï¸ Teacher Absent',
                            message: `${teacher.name} is absent today. Please arrange substitute.`,
                            type: 'warning',
                            category: 'attendance',
                            sendSMS: true,
                            actionUrl: "showTab('substitute')"
                        });
                    }
                });
            }
        }
        
        // Check routine conflicts
        if (settings.routineConflictAlert) {
            const conflicts = this.detectRoutineConflicts();
            if (conflicts.length > 0) {
                this.add({
                    title: 'ðŸ”´ Routine Conflict Detected',
                    message: `${conflicts.length} routine conflict(s) found. Please resolve.`,
                    type: 'error',
                    category: 'routine',
                    sendEmail: true,
                    actionUrl: "showTab('routine')"
                });
            }
        }
    },
    
    // Detect routine conflicts
    detectRoutineConflicts() {
        const routines = DB.get('routines');
        const conflicts = [];
        
        routines.forEach((r1, i) => {
            routines.forEach((r2, j) => {
                if (i < j && r1.teacherId === r2.teacherId && r1.day === r2.day && r1.periodId === r2.periodId) {
                    conflicts.push({ routine1: r1, routine2: r2 });
                }
            });
        });
        
        return conflicts;
    }
};

// Notification UI
function showNotificationCenter() {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.id = 'notificationCenterModal';
    
    const notifications = NotificationCenter.notifications;
    const unreadCount = NotificationCenter.getUnreadCount();
    
    let notificationHTML = '';
    if (notifications.length === 0) {
        notificationHTML = '<p style="text-align: center; padding: 40px; color: #999;">ðŸ“­ No notifications yet</p>';
    } else {
        notifications.forEach(n => {
            const icon = {
                info: 'ðŸ’¬',
                success: 'âœ…',
                warning: 'âš ï¸',
                error: 'ðŸ”´',
                urgent: 'ðŸš¨'
            }[n.type] || 'ðŸ””';
            
            notificationHTML += `
                <div class="notification-item ${n.read ? 'read' : 'unread'}" data-id="${n.id}">
                    <div style="display: flex; gap: 15px; align-items: start;">
                        <div style="font-size: 2em;">${icon}</div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                <strong style="color: ${n.read ? '#666' : '#000'};">${n.title}</strong>
                                <button onclick="NotificationCenter.delete(${n.id}); showNotificationCenter();" style="background: none; border: none; color: #f44336; cursor: pointer; font-size: 1.2em;">Ã—</button>
                            </div>
                            <p style="margin: 5px 0; color: ${n.read ? '#999' : '#555'};">${n.message}</p>
                            <small style="color: #999;">${new Date(n.timestamp).toLocaleString('en-IN')}</small>
                            ${!n.read ? `<button onclick="NotificationCenter.markAsRead(${n.id}); showNotificationCenter();" class="btn btn-sm btn-primary" style="margin-top: 8px;">Mark as Read</button>` : ''}
                            ${n.actionUrl ? `<button onclick="${n.actionUrl}; closeNotificationCenter();" class="btn btn-sm btn-info" style="margin-top: 8px;">View Details</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 800px; max-height: 90vh;">
            <button class="modal-close" onclick="closeNotificationCenter()">Ã—</button>
            <h2 style="color: var(--primary); margin-bottom: 20px;">
                ðŸ”” Notification Center
                ${unreadCount > 0 ? `<span class="badge" style="background: #f44336; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7em; margin-left: 10px;">${unreadCount}</span>` : ''}
            </h2>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="NotificationCenter.markAllAsRead(); showNotificationCenter();">
                    âœ… Mark All Read
                </button>
                <button class="btn btn-secondary" onclick="NotificationCenter.clearAll(); showNotificationCenter();">
                    ðŸ—‘ï¸ Clear All
                </button>
                <button class="btn btn-info" onclick="showNotificationSettings()">
                    âš™ï¸ Settings
                </button>
                <button class="btn btn-success" onclick="testNotification()">
                    ðŸ§ª Test Notification
                </button>
            </div>
            
            <div id="notificationList" style="max-height: 60vh; overflow-y: auto;">
                ${notificationHTML}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeNotificationCenter() {
    const modal = document.getElementById('notificationCenterModal');
    if (modal) modal.remove();
}

// Notification Settings
function showNotificationSettings() {
    const settings = DB.getObj('notificationSettings') || {
        browserEnabled: true,
        emailEnabled: false,
        smsEnabled: false,
        absentTeacherAlert: true,
        routineConflictAlert: true,
        examReminders: true,
        emailRecipients: [],
        smsRecipients: []
    };
    
    closeNotificationCenter();
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.id = 'notificationSettingsModal';
    
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 700px;">
            <button class="modal-close" onclick="closeNotificationSettings()">Ã—</button>
            <h2 style="color: var(--primary); margin-bottom: 20px;">âš™ï¸ Notification Settings</h2>
            
            <div class="card" style="margin-bottom: 20px;">
                <h3>ðŸ”” Browser Notifications</h3>
                <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <input type="checkbox" id="browserEnabled" ${settings.browserEnabled ? 'checked' : ''}>
                    Enable browser push notifications
                </label>
                <button class="btn btn-sm btn-primary" onclick="NotificationCenter.requestPermission()">
                    Request Permission
                </button>
            </div>
            
            <div class="card" style="margin-bottom: 20px;">
                <h3>ðŸ“§ Email Notifications</h3>
                <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <input type="checkbox" id="emailEnabled" ${settings.emailEnabled ? 'checked' : ''}>
                    Enable email alerts
                </label>
                <label>Email Recipients (comma-separated):</label>
                <textarea id="emailRecipients" rows="3" style="width: 100%; margin-top: 5px;">${(settings.emailRecipients || []).join(', ')}</textarea>
            </div>
            
            <div class="card" style="margin-bottom: 20px;">
                <h3>ðŸ“± SMS Notifications</h3>
                <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <input type="checkbox" id="smsEnabled" ${settings.smsEnabled ? 'checked' : ''}>
                    Enable SMS alerts (for critical notifications)
                </label>
                <label>SMS Recipients (comma-separated with country code):</label>
                <textarea id="smsRecipients" rows="3" style="width: 100%; margin-top: 5px;">${(settings.smsRecipients || []).join(', ')}</textarea>
            </div>
            
            <div class="card" style="margin-bottom: 20px;">
                <h3>ðŸŽ¯ Alert Types</h3>
                <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <input type="checkbox" id="absentTeacherAlert" ${settings.absentTeacherAlert ? 'checked' : ''}>
                    Teacher absence alerts
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <input type="checkbox" id="routineConflictAlert" ${settings.routineConflictAlert ? 'checked' : ''}>
                    Routine conflict alerts
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <input type="checkbox" id="examReminders" ${settings.examReminders ? 'checked' : ''}>
                    Exam reminders
                </label>
            </div>
            
            <button class="btn btn-primary" style="width: 100%;" onclick="saveNotificationSettings()">
                ðŸ’¾ Save Settings
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeNotificationSettings() {
    const modal = document.getElementById('notificationSettingsModal');
    if (modal) modal.remove();
}

function saveNotificationSettings() {
    const settings = {
        browserEnabled: document.getElementById('browserEnabled').checked,
        emailEnabled: document.getElementById('emailEnabled').checked,
        smsEnabled: document.getElementById('smsEnabled').checked,
        absentTeacherAlert: document.getElementById('absentTeacherAlert').checked,
        routineConflictAlert: document.getElementById('routineConflictAlert').checked,
        examReminders: document.getElementById('examReminders').checked,
        emailRecipients: document.getElementById('emailRecipients').value.split(',').map(e => e.trim()).filter(e => e),
        smsRecipients: document.getElementById('smsRecipients').value.split(',').map(s => s.trim()).filter(s => s)
    };
    
    DB.setObj('notificationSettings', settings);
    showAlert('âœ… Notification settings saved!', 'success');
    closeNotificationSettings();
}

// Test notification
function testNotification() {
    NotificationCenter.add({
        title: 'ðŸ§ª Test Notification',
        message: 'This is a test notification to verify the system is working correctly!',
        type: 'info',
        category: 'system',
        showBrowser: true,
        sendEmail: false,
        sendSMS: false
    });
    
    showAlert('ðŸ§ª Test notification sent!', 'success');
    setTimeout(() => showNotificationCenter(), 500);
}

// CSS for notifications
const notificationCSS = `
<style id="notificationStyles">
    .notification-item {
        padding: 15px;
        border-left: 4px solid #2196F3;
        background: #f9f9f9;
        margin-bottom: 10px;
        border-radius: 4px;
        transition: all 0.3s;
    }
    
    .notification-item.unread {
        background: #e3f2fd;
        border-left-color: #2196F3;
    }
    
    .notification-item.read {
        background: #f5f5f5;
        border-left-color: #ddd;
    }
    
    .notification-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    #notificationBadge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #f44336;
        color: white;
        border-radius: 12px;
        padding: 2px 6px;
        font-size: 11px;
        font-weight: bold;
        display: none;
    }
</style>
`;

// Add notification bell to header
function addNotificationBell() {
    const headerRight = document.querySelector('.header-right');
    if (headerRight && !document.getElementById('notificationBell')) {
        const bell = document.createElement('button');
        bell.id = 'notificationBell';
        bell.className = 'btn';
        bell.style.cssText = 'position: relative; background: transparent; border: 2px solid var(--primary); color: var(--primary); padding: 10px 15px; margin-right: 10px;';
        bell.innerHTML = 'ðŸ”” <span id="notificationBadge"></span>';
        bell.onclick = showNotificationCenter;
        
        headerRight.insertBefore(bell, headerRight.firstChild);
    }
}

// Initialize notification system
document.addEventListener('DOMContentLoaded', function() {
    // Add CSS
    if (!document.getElementById('notificationStyles')) {
        document.head.insertAdjacentHTML('beforeend', notificationCSS);
    }
    
    // Add notification bell
    setTimeout(() => {
        addNotificationBell();
        NotificationCenter.init();
    }, 1000);
    
    // Make user management functions globally accessible
    window.editUser = editUser;
    window.deleteUser = deleteUser;
    window.resetUserPassword = resetUserPassword;
    window.showAddUserModal = showAddUserModal;
    window.showChangePasswordModal = showChangePasswordModal;
    window.showLoginHistoryModal = showLoginHistoryModal;
    window.exportUsers = exportUsers;
    window.saveNewUser = saveNewUser;
    window.updateUser = updateUser;
    window.executePasswordReset = executePasswordReset;
    window.changeOwnPassword = changeOwnPassword;
});

// ==================== COMMUNICATION FEATURES ====================

const CommunicationModule = {
    // Email Notification
    sendEmail: (to, subject, body) => {
        // In production, this would call a backend API
        console.log('Email sent:', { to, subject, body });
        
        // Log notification
        const notifications = SecureDB.get('notifications') || [];
        notifications.push({
            type: 'email',
            to,
            subject,
            body,
            timestamp: new Date().toISOString(),
            status: 'sent'
        });
        SecureDB.set('notifications', notifications);
    },
    
    // WhatsApp Integration
    sendWhatsApp: (phone, message) => {
        // Format phone number
        const formattedPhone = phone.replace(/\D/g, '');
        const url = `https://wa.me/${formattedPhone}? text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
    },
    
    // SMS (would require backend)
    sendSMS: (phone, message) => {
        console.log('SMS:', { phone, message });
        
        const notifications = SecureDB.get('notifications') || [];
        notifications. push({
            type: 'sms',
            phone,
            message,
            timestamp: new Date().toISOString(),
            status: 'pending'
        });
        SecureDB.set('notifications', notifications);
    },
    
    // Notice Board
    addNotice: (notice) => {
        const notices = SecureDB.get('notices') || [];
        notices.unshift({
            ...notice,
            id: Date.now(),
            createdAt: new Date().toISOString(),
            createdBy: sessionStorage.getItem('username')
        });
        SecureDB.set('notices', notices);
    },
    
    // Bulk Notifications
    sendBulkNotification: (recipients, message, type = 'all') => {
        const teachers = DB.get('teachers');
        
        recipients.forEach(recipient => {
            const teacher = teachers.find(t => t.name === recipient);
            if (! teacher) return;
            
            if (type === 'email' || type === 'all') {
                if (teacher.email) {
                    CommunicationModule.sendEmail(
                        teacher.email,
                        'Important Notification',
                        message
                    );
                }
            }
            
            if (type === 'whatsapp' || type === 'all') {
                if (teacher.phone) {
                    // Queue for WhatsApp
                    console.log('WhatsApp queued:', teacher.phone);
                }
            }
        });
        
        showAlert(`âœ… Notifications sent to ${recipients.length} recipients`, 'success');
    }
};

// ==================== ADVANCED ANALYTICS ====================

const AdvancedAnalytics = {
    // Real-time Dashboard Data
    getDashboardMetrics: () => {
        const teachers = DB.get('teachers');
        const routines = DB.get('routines');
        const attendance = DB.get('attendance') || [];
        const provisionals = DB.get('provisionals') || [];
        
        const today = new Date().toISOString().split('T')[0];
        const thisMonth = today.substring(0, 7);
        
        return {
            teachers: {
                total: teachers.length,
                active: teachers.length - attendance.filter(a => a.date === today && a.status === 'absent').length,
                onLeave: attendance.filter(a => a.date === today && a.status === 'leave').length
            },
            routines: {
                total: routines.length,
                today: routines.filter(r => r.day === new Date().toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase()).length
            },
            attendance: {
                presentToday: teachers.length - attendance.filter(a => a.date === today && a.status !== 'present').length,
                absentToday: attendance.filter(a => a.date === today && a. status === 'absent').length,
                monthlyRate: ((teachers.length * 30 - attendance.filter(a => a. date. startsWith(thisMonth)).length) / (teachers.length * 30) * 100).toFixed(2)
            },
            provisionals: {
                total: provisionals. length,
                thisMonth: provisionals.filter(p => p.date.startsWith(thisMonth)).length,
                aiGenerated: provisionals.filter(p => p.autoGenerated).length
            }
        };
    },
    
    // Workload Heatmap Data
    getWorkloadHeatmap: () => {
        const routines = DB.get('routines');
        const teachers = DB.get('teachers');
        const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
        const periods = DB.get('periods') || [];
        
        const heatmap = [];
        
        teachers.forEach(teacher => {
            const teacherData = {
                name: teacher.name,
                data: []
            };
            
            days.forEach(day => {
                periods.forEach(period => {
                    const hasClass = routines.some(r => 
                        r.teacherName === teacher.name &&
                        r.day === day &&
                        r.periodNumber === period.periodNumber
                    );
                    teacherData.data.push(hasClass ? 1 : 0);
                });
            });
            
            heatmap.push(teacherData);
        });
        
        return heatmap;
    },
    
    // Attendance Trends (Last 30 days)
    getAttendanceTrends: () => {
        const attendance = DB.get('attendance') || [];
        const teachers = DB.get('teachers');
        
        const last30Days = [];
        for (let i = 29; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            last30Days.push(date.toISOString().split('T')[0]);
        }
        
        const trends = last30Days.map(date => {
            const dayAttendance = attendance.filter(a => a.date === date);
            return {
                date,
                present: teachers.length - dayAttendance.length,
                absent: dayAttendance.filter(a => a.status === 'absent').length,
                leave: dayAttendance.filter(a => a.status === 'leave').length,
                onDuty: dayAttendance.filter(a => a.status === 'on_duty').length
            };
        });
        
        return trends;
    },
    
    // Generate Chart. js config for trends
    getAttendanceChartConfig: () => {
        const trends = AdvancedAnalytics.getAttendanceTrends();
        
        return {
            type: 'line',
            data: {
                labels: trends.map(t => new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                datasets: [
                    {
                        label: 'Present',
                        data: trends.map(t => t.present),
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Absent',
                        data: trends.map(t => t.absent),
                        borderColor: '#f44336',
                        backgroundColor:  'rgba(244, 67, 54, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Leave',
                        data: trends. map(t => t.leave),
                        borderColor: '#FF9800',
                        backgroundColor:  'rgba(255, 152, 0, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Attendance Trends (Last 30 Days)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };
    }
};


// ==================== CLOUD BACKUP ====================

const CloudBackup = {
    // Export data as JSON
    exportToJSON: () => {
        const data = {
            teachers: DB.get('teachers'),
            subjects: DB.get('subjects'),
            classes: DB.get('classes'),
            periods: DB.get('periods'),
            fridayPeriods: DB.get('fridayPeriods'),
            routines: DB.get('routines'),
            attendance: DB.get('attendance'),
            provisionals: DB.get('provisionals'),
            settings: SecureDB.getObj('settings'),
            version: '3.0',
            exportDate: new Date().toISOString()
        };
        
        return JSON.stringify(data, null, 2);
    },
    
    // Auto-backup every hour
    enableAutoBackup: () => {
        setInterval(() => {
            const backup = CloudBackup.exportToJSON();
            localStorage.setItem('autoBackup_' + Date.now(), backup);
            
            // Keep only last 5 backups
            const backups = Object.keys(localStorage).filter(k => k.startsWith('autoBackup_'));
            if (backups.length > 5) {
                backups.sort().slice(0, -5).forEach(key => {
                    localStorage.removeItem(key);
                });
            }
            
            console.log('Auto-backup created');
        }, 60 * 60 * 1000); // Every hour
    },
    
    // Version History
    getBackupHistory: () => {
        const backups = Object.keys(localStorage)
            .filter(k => k.startsWith('autoBackup_'))
            .map(key => ({
                key,
                timestamp: parseInt(key.replace('autoBackup_', '')),
                size: new Blob([localStorage.getItem(key)]).size
            }))
            .sort((a, b) => b.timestamp - a. timestamp);
        
        return backups;
    },
    
    // Restore from backup
    restoreBackup: (backupKey) => {
        const backup = localStorage.getItem(backupKey);
        if (!backup) {
            showAlert('âŒ Backup not found! ', 'error');
            return;
        }
        
        try {
            const data = JSON. parse(backup);
            
            // Restore all data
            Object.keys(data).forEach(key => {
                if (key !== 'version' && key !== 'exportDate') {
                    if (Array.isArray(data[key])) {
                        DB.set(key, data[key]);
                    } else {
                        SecureDB.setObj(key, data[key]);
                    }
                }
            });
            
            showAlert('âœ… Backup restored successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } catch(error) {
            showAlert('âŒ Failed to restore backup:  ' + error.message, 'error');
        }
    }
};


// ==================== BULK UPLOAD SYSTEM ====================

// Template Downloads
function downloadTeacherTemplate() {
    const wb = XLSX.utils.book_new();
    const data = [
        ['Teacher Name', 'Short Name', 'Section', 'Phone', 'Email'],
        ['John Doe', 'JD', 'Upper Primary', '9876543210', 'john@example.com'],
        ['Jane Smith', 'JS', 'Secondary', '9876543211', 'jane@example.com'],
        ['Mike Johnson', 'MJ', 'Higher Secondary', '9876543212', 'mike@example.com']
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // Set column widths
    ws['!cols'] = [
        { wch: 20 },
        { wch: 12 },
        { wch: 20 },
        { wch: 15 },
        { wch: 25 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'Teachers');
    XLSX.writeFile(wb, 'Teachers_Template.xlsx');
    showAlert('ðŸ“¥ Teacher template downloaded successfully!', 'success');
}

function downloadSubjectTemplate() {
    const wb = XLSX.utils.book_new();
    const data = [
        ['Subject Name', 'Subject Code', 'Category'],
        ['Mathematics', 'MAT101', 'Secondary'],
        ['English', 'ENG101', 'Secondary'],
        ['Science', 'SCI101', 'Upper Primary'],
        ['History', 'HIS101', 'Higher Secondary']
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // Set column widths
    ws['!cols'] = [
        { wch: 20 },
        { wch: 15 },
        { wch: 20 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'Subjects');
    XLSX.writeFile(wb, 'Subjects_Template.xlsx');
    showAlert('ðŸ“¥ Subject template downloaded successfully!', 'success');
}

function downloadRoutineTemplate() {
    const wb = XLSX.utils.book_new();
    const data = [
        ['Day', 'Period Number', 'Class Name', 'Subject', 'Teacher Name'],
        ['MONDAY', 1, 'Class 10-A', 'Mathematics', 'John Doe'],
        ['MONDAY', 2, 'Class 10-A', 'English', 'Jane Smith'],
        ['TUESDAY', 1, 'Class 10-B', 'Science', 'Mike Johnson'],
        ['TUESDAY', 2, 'Class 10-B', 'History', 'John Doe']
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // Set column widths
    ws['!cols'] = [
        { wch: 12 },
        { wch: 15 },
        { wch: 15 },
        { wch: 20 },
        { wch: 20 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'Routine');
    XLSX.writeFile(wb, 'Routine_Template.xlsx');
    showAlert('ðŸ“¥ Routine template downloaded successfully!', 'success');
}

// Bulk Upload Functions
function uploadTeachersBulk(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    showUploadProgress('Uploading teachers...');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            const teachers = DB.get('teachers');
            
            jsonData.forEach((row, index) => {
                try {
                    if (!row['Teacher Name'] || !row['Short Name'] || !row['Section']) {
                        errors.push(`Row ${index + 2}: Missing required fields`);
                        errorCount++;
                        return;
                    }
                    
                    teachers.push({
                        id: Date.now().toString() + index,
                        name: row['Teacher Name'],
                        shortName: row['Short Name'],
                        section: row['Section'],
                        phone: row['Phone'] || '',
                        email: row['Email'] || ''
                    });
                    successCount++;
                } catch (err) {
                    errors.push(`Row ${index + 2}: ${err.message}`);
                    errorCount++;
                }
                
                updateProgressBar((index + 1) / jsonData.length * 100);
            });
            
            DB.set('teachers', teachers);
            populateDropdowns();
            loadTeachers();
            
            hideUploadProgress();
            showUploadSummary(successCount, errorCount, jsonData.length, errors);
            addUploadHistory('Teachers', successCount, errorCount === 0 ? 'Success' : 'Partial');
            
            // Clear file input
            event.target.value = '';
            
        } catch (error) {
            hideUploadProgress();
            showAlert('âŒ Error reading Excel file: ' + error.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

function uploadSubjectsBulk(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    showUploadProgress('Uploading subjects...');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            const subjects = DB.get('subjects');
            
            jsonData.forEach((row, index) => {
                try {
                    if (!row['Subject Name'] || !row['Category']) {
                        errors.push(`Row ${index + 2}: Missing required fields`);
                        errorCount++;
                        return;
                    }
                    
                    subjects.push({
                        id: Date.now().toString() + index,
                        name: row['Subject Name'],
                        code: row['Subject Code'] || '',
                        category: row['Category']
                    });
                    successCount++;
                } catch (err) {
                    errors.push(`Row ${index + 2}: ${err.message}`);
                    errorCount++;
                }
                
                updateProgressBar((index + 1) / jsonData.length * 100);
            });
            
            DB.set('subjects', subjects);
            populateDropdowns();
            loadSubjects();
            
            hideUploadProgress();
            showUploadSummary(successCount, errorCount, jsonData.length, errors);
            addUploadHistory('Subjects', successCount, errorCount === 0 ? 'Success' : 'Partial');
            
            event.target.value = '';
            
        } catch (error) {
            hideUploadProgress();
            showAlert('âŒ Error reading Excel file: ' + error.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

function uploadRoutineBulk(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    showUploadProgress('Uploading routine...');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            const routines = DB.get('routines');
            
            jsonData.forEach((row, index) => {
                try {
                    if (!row['Day'] || !row['Period Number'] || !row['Class Name'] || !row['Subject'] || !row['Teacher Name']) {
                        errors.push(`Row ${index + 2}: Missing required fields`);
                        errorCount++;
                        return;
                    }
                    
                    // Check for conflicts
                    const conflict = routines.find(r => 
                        r.day === row['Day'].toUpperCase() && 
                        r.periodNumber === parseInt(row['Period Number']) && 
                        (r.className === row['Class Name'] || r.teacherName === row['Teacher Name'])
                    );
                    
                    if (conflict) {
                        errors.push(`Row ${index + 2}: Conflict detected - ${row['Teacher Name']} or ${row['Class Name']} already scheduled`);
                        errorCount++;
                        return;
                    }
                    
                    routines.push({
                        id: Date.now().toString() + index,
                        day: row['Day'].toUpperCase(),
                        periodNumber: parseInt(row['Period Number']),
                        className: row['Class Name'],
                        subject: row['Subject'],
                        teacherName: row['Teacher Name']
                    });
                    successCount++;
                } catch (err) {
                    errors.push(`Row ${index + 2}: ${err.message}`);
                    errorCount++;
                }
                
                updateProgressBar((index + 1) / jsonData.length * 100);
            });
            
            DB.set('routines', routines);
            loadRoutine();
            
            hideUploadProgress();
            showUploadSummary(successCount, errorCount, jsonData.length, errors);
            addUploadHistory('Routine', successCount, errorCount === 0 ? 'Success' : 'Partial');
            
            event.target.value = '';
            
        } catch (error) {
            hideUploadProgress();
            showAlert('âŒ Error reading Excel file: ' + error.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

// Upload Progress UI
function showUploadProgress(message) {
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressMessage = document.getElementById('progressMessage');
    
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = '0%';
    progressMessage.textContent = message;
    
    // Scroll to progress
    progressDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function updateProgressBar(percentage) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    progressBar.style.width = percentage + '%';
    progressText.textContent = Math.round(percentage) + '%';
}

function hideUploadProgress() {
    setTimeout(() => {
        document.getElementById('uploadProgress').style.display = 'none';
    }, 1000);
}

function showUploadSummary(successCount, errorCount, totalCount, errors) {
    const summaryDiv = document.getElementById('uploadSummary');
    document.getElementById('successCount').textContent = successCount;
    document.getElementById('errorCount').textContent = errorCount;
    document.getElementById('totalProcessed').textContent = totalCount;
    
    const errorDetails = document.getElementById('errorDetails');
    const errorList = document.getElementById('errorList');
    
    if (errors.length > 0) {
        errorDetails.style.display = 'block';
        errorList.innerHTML = errors.map(err => `<li>${err}</li>`).join('');
    } else {
        errorDetails.style.display = 'none';
    }
    
    summaryDiv.style.display = 'block';
    summaryDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Auto-hide after 10 seconds if no errors
    if (errors.length === 0) {
        setTimeout(() => {
            summaryDiv.style.display = 'none';
        }, 10000);
    }
}

function addUploadHistory(type, recordCount, status) {
    const history = DB.get('uploadHistory');
    const currentUser = sessionStorage.getItem('username') || 'Unknown';
    
    history.push({
        id: Date.now().toString(),
        timestamp: new Date().toISOString(),
        type: type,
        records: recordCount,
        status: status,
        uploadedBy: currentUser
    });
    
    // Keep last 50 records
    if (history.length > 50) {
        history.shift();
    }
    
    DB.set('uploadHistory', history);
    loadUploadHistory();
}

function loadUploadHistory() {
    const history = DB.get('uploadHistory').reverse();
    const tbody = document.getElementById('uploadHistoryBody');
    
    if (history.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 30px; color: #999;">
                    No upload history yet. Start by uploading some data!
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = history.map(item => {
        const date = new Date(item.timestamp);
        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        const statusBadge = item.status === 'Success' ? 
            '<span style="background: #4CAF50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em;">âœ… Success</span>' :
            '<span style="background: #FF9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em;">âš ï¸ Partial</span>';
        
        return `
            <tr>
                <td>${formattedDate}</td>
                <td>${item.type}</td>
                <td>${item.records}</td>
                <td>${statusBadge}</td>
                <td>${item.uploadedBy}</td>
            </tr>
        `;
    }).join('');
}

// AI Auto-Assignment Modal
function openAIAssignmentModal() {
    showAlert('ðŸ¤– AI Auto-Assignment feature is available in the Provisional tab!', 'info');
    showTab('provisional');
}

// ==================== ENHANCED ANALYTICS ====================

function refreshAnalytics() {
    loadAnalyticsData();
    showAlert('ðŸ“Š Analytics refreshed successfully!', 'success');
}

function loadAnalyticsData() {
    const teachers = DB.get('teachers');
    const subjects = DB.get('subjects');
    const routines = DB.get('routines');
    
    // Update key metrics
    document.getElementById('analyticsTotalTeachers').textContent = teachers.length;
    document.getElementById('analyticsTotalSubjects').textContent = subjects.length;
    document.getElementById('analyticsTotalRoutines').textContent = routines.length;
    
    // Calculate average load
    const avgLoad = teachers.length > 0 ? (routines.length / teachers.length).toFixed(1) : 0;
    document.getElementById('analyticsAvgLoad').textContent = avgLoad;
    
    // Load charts
    loadWorkloadAnalyticsChart();
    loadSubjectDistributionChart();
    loadPeriodDistributionChart();
    loadDayDistributionChart();
    loadWorkloadTable();
}

function loadWorkloadAnalyticsChart() {
    const ctx = document.getElementById('workloadChart');
    if (!ctx) return;
    
    const teachers = DB.get('teachers');
    const routines = DB.get('routines');
    
    // Calculate workload for each teacher
    const workloadData = teachers.map(teacher => {
        const teacherClasses = routines.filter(r => r.teacherName === teacher.name);
        return {
            name: teacher.name,
            classes: teacherClasses.length
        };
    }).sort((a, b) => b.classes - a.classes);
    
    // Destroy existing chart if any
    if (window.workloadChartInstance) {
        window.workloadChartInstance.destroy();
    }
    
    window.workloadChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: workloadData.map(d => d.name),
            datasets: [{
                label: 'Total Classes',
                data: workloadData.map(d => d.classes),
                backgroundColor: 'rgba(30, 60, 114, 0.8)',
                borderColor: 'rgba(30, 60, 114, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function loadSubjectDistributionChart() {
    const ctx = document.getElementById('subjectDistChart');
    if (!ctx) return;
    
    const routines = DB.get('routines');
    
    // Count classes per subject
    const subjectCount = {};
    routines.forEach(r => {
        subjectCount[r.subject] = (subjectCount[r.subject] || 0) + 1;
    });
    
    const colors = [
        'rgba(30, 60, 114, 0.8)',
        'rgba(76, 175, 80, 0.8)',
        'rgba(255, 152, 0, 0.8)',
        'rgba(244, 67, 54, 0.8)',
        'rgba(33, 150, 243, 0.8)',
        'rgba(156, 39, 176, 0.8)',
        'rgba(0, 188, 212, 0.8)',
        'rgba(255, 235, 59, 0.8)'
    ];
    
    // Destroy existing chart if any
    if (window.subjectChartInstance) {
        window.subjectChartInstance.destroy();
    }
    
    window.subjectChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(subjectCount),
            datasets: [{
                data: Object.values(subjectCount),
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: 'white'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
}

function loadPeriodDistributionChart() {
    const ctx = document.getElementById('periodDistChart');
    if (!ctx) return;
    
    const routines = DB.get('routines');
    
    // Count classes per period
    const periodCount = {};
    routines.forEach(r => {
        const period = 'Period ' + r.periodNumber;
        periodCount[period] = (periodCount[period] || 0) + 1;
    });
    
    // Sort by period number
    const sortedPeriods = Object.keys(periodCount).sort((a, b) => {
        const numA = parseInt(a.replace('Period ', ''));
        const numB = parseInt(b.replace('Period ', ''));
        return numA - numB;
    });
    
    // Destroy existing chart if any
    if (window.periodChartInstance) {
        window.periodChartInstance.destroy();
    }
    
    window.periodChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedPeriods,
            datasets: [{
                label: 'Classes Scheduled',
                data: sortedPeriods.map(p => periodCount[p]),
                backgroundColor: 'rgba(76, 175, 80, 0.2)',
                borderColor: 'rgba(76, 175, 80, 1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function loadDayDistributionChart() {
    const ctx = document.getElementById('dayDistChart');
    if (!ctx) return;
    
    const routines = DB.get('routines');
    
    // Count classes per day
    const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
    const dayCount = {};
    days.forEach(day => dayCount[day] = 0);
    
    routines.forEach(r => {
        if (dayCount.hasOwnProperty(r.day)) {
            dayCount[r.day]++;
        }
    });
    
    // Destroy existing chart if any
    if (window.dayChartInstance) {
        window.dayChartInstance.destroy();
    }
    
    window.dayChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: days,
            datasets: [{
                label: 'Classes per Day',
                data: days.map(d => dayCount[d]),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)'
                ],
                borderWidth: 2,
                borderColor: 'white'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function loadWorkloadTable() {
    const teachers = DB.get('teachers');
    const routines = DB.get('routines');
    const tbody = document.getElementById('workloadTableBody');
    
    if (teachers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 30px; color: #999;">
                    No data available. Add teachers and routine entries first.
                </td>
            </tr>
        `;
        return;
    }
    
    // Calculate workload data
    const workloadData = teachers.map(teacher => {
        const teacherClasses = routines.filter(r => r.teacherName === teacher.name);
        const totalClasses = teacherClasses.length;
        
        // Calculate daily average (assuming 6 working days)
        const daysWithClasses = new Set(teacherClasses.map(c => c.day)).size;
        const dailyAvg = daysWithClasses > 0 ? (totalClasses / daysWithClasses).toFixed(1) : 0;
        
        // Calculate load percentage (assuming 30 classes per week as 100%)
        const loadPercent = Math.round((totalClasses / 30) * 100);
        
        return {
            name: teacher.name,
            total: totalClasses,
            dailyAvg,
            loadPercent
        };
    }).sort((a, b) => b.total - a.total);
    
    tbody.innerHTML = workloadData.map(data => {
        let status, statusColor;
        if (data.loadPercent > 80) {
            status = 'ðŸ”´ High';
            statusColor = '#f44336';
        } else if (data.loadPercent > 50) {
            status = 'ðŸŸ¡ Moderate';
            statusColor = '#FF9800';
        } else {
            status = 'ðŸŸ¢ Light';
            statusColor = '#4CAF50';
        }
        
        return `
            <tr>
                <td><strong>${data.name}</strong></td>
                <td>${data.total}</td>
                <td>${data.dailyAvg}</td>
                <td><strong>${data.loadPercent}%</strong></td>
                <td><span style="color: ${statusColor}; font-weight: 600;">${status}</span></td>
            </tr>
        `;
    }).join('');
}

function exportAnalyticsExcel() {
    const teachers = DB.get('teachers');
    const routines = DB.get('routines');
    
    // Prepare workload data
    const workloadData = teachers.map(teacher => {
        const teacherClasses = routines.filter(r => r.teacherName === teacher.name);
        const totalClasses = teacherClasses.length;
        const daysWithClasses = new Set(teacherClasses.map(c => c.day)).size;
        const dailyAvg = daysWithClasses > 0 ? (totalClasses / daysWithClasses).toFixed(1) : 0;
        const loadPercent = Math.round((totalClasses / 30) * 100);
        
        return {
            'Teacher Name': teacher.name,
            'Total Classes': totalClasses,
            'Daily Average': dailyAvg,
            'Load Percentage': loadPercent + '%',
            'Status': loadPercent > 80 ? 'High' : loadPercent > 50 ? 'Moderate' : 'Light'
        };
    });
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(workloadData);
    
    // Set column widths
    ws['!cols'] = [
        { wch: 20 },
        { wch: 15 },
        { wch: 15 },
        { wch: 18 },
        { wch: 12 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'Teacher Workload');
    
    const timestamp = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `Analytics_Report_${timestamp}.xlsx`);
    
    showAlert('ðŸ“Š Analytics report exported successfully!', 'success');
}

function exportAnalyticsPDF() {
    showAlert('ðŸ“„ PDF export feature coming soon!', 'info');
}

function printAnalytics() {
    window.print();
}

function refreshAnalytics() {
    loadAnalyticsData();
    alert('âœ… Analytics refreshed!');
}

// Show analytics section
function showAnalyticsSection(section) {
    // Hide all sections
    document.querySelectorAll('.analytics-section').forEach(s => s.style.display = 'none');
    
    // Reset button styles
    document.querySelectorAll('[id^="analytics"][id$="Btn"]').forEach(btn => {
        btn.style.background = 'rgba(255,255,255,0.2)';
        btn.style.color = 'white';
    });
    
    // Show selected section
    document.getElementById('analytics' + section.charAt(0).toUpperCase() + section.slice(1)).style.display = 'block';
    
    // Highlight button
    const btn = document.getElementById('analytics' + section.charAt(0).toUpperCase() + section.slice(1) + 'Btn');
    btn.style.background = 'white';
    btn.style.color = '#667eea';
    
    // Load specific section data
    switch(section) {
        case 'overview': loadOverviewSection(); break;
        case 'workload': loadWorkloadSection(); break;
        case 'subjects': loadSubjectSection(); break;
        case 'periods': loadPeriodSection(); break;
        case 'attendance': loadAttendanceSection(); break;
        case 'exam': loadExamSection(); break;
    }
}

// Load overview section
function loadOverviewSection() {
    const teachers = DB.get('teachers');
    const subjects = DB.get('subjects');
    const routines = DB.get('routines');
    const classes = DB.get('classes');
    
    // Update key metrics
    document.getElementById('analyticsTotalTeachers').textContent = teachers.length;
    document.getElementById('analyticsTotalSubjects').textContent = subjects.length;
    document.getElementById('analyticsTotalRoutines').textContent = routines.length;
    
    const avgLoad = teachers.length > 0 ? (routines.length / teachers.length).toFixed(1) : 0;
    document.getElementById('analyticsAvgLoad').textContent = avgLoad;
    
    // Load quick insights
    const insights = document.getElementById('quickInsights');
    let html = '';
    
    // Most loaded teacher
    const teacherLoad = teachers.map(t => ({
        name: t.name,
        count: routines.filter(r => r.teacherId == t.id).length
    })).sort((a, b) => b.count - a.count)[0];
    
    if (teacherLoad) {
        html += `<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
            <strong>ðŸ“Š Most Loaded Teacher:</strong><br>${teacherLoad.name} (${teacherLoad.count} classes)
        </div>`;
    }
    
    // Most taught subject
    const subjectCount = {};
    routines.forEach(r => subjectCount[r.subject] = (subjectCount[r.subject] || 0) + 1);
    const topSubject = Object.entries(subjectCount).sort((a, b) => b[1] - a[1])[0];
    
    if (topSubject) {
        html += `<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800;">
            <strong>ðŸ“š Most Taught Subject:</strong><br>${topSubject[0]} (${topSubject[1]} periods)
        </div>`;
    }
    
    // Total capacity
    const totalCapacity = teachers.length * 30; // 30 periods per teacher ideal
    const utilization = ((routines.length / totalCapacity) * 100).toFixed(1);
    
    html += `<div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
        <strong>âš¡ System Utilization:</strong><br>${utilization}% of capacity
    </div>`;
    
    insights.innerHTML = html;
    
    // Load overview chart
    const ctx = document.getElementById('overviewChart');
    if (ctx && window.overviewChartInstance) window.overviewChartInstance.destroy();
    
    window.overviewChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Teachers', 'Subjects', 'Classes', 'Routines'],
            datasets: [{
                label: 'Count',
                data: [teachers.length, subjects.length, classes.length, routines.length],
                backgroundColor: ['#1e3c72', '#4CAF50', '#FF9800', '#9C27B0']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

// Load workload section  
function loadWorkloadSection() {
    loadWorkloadAnalyticsChart();
    loadWorkloadTableDetailed();
}

function loadWorkloadTableDetailed() {
    const teachers = DB.get('teachers');
    const routines = DB.get('routines');
    const tbody = document.getElementById('workloadTableBody');
    
    const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
    
    let html = '';
    teachers.forEach(teacher => {
        const teacherRoutines = routines.filter(r => r.teacherId == teacher.id);
        
        const dayCount = {};
        days.forEach(day => {
            dayCount[day] = teacherRoutines.filter(r => r.day === day).length;
        });
        
        const total = teacherRoutines.length;
        const loadPercent = Math.round((total / 30) * 100);
        
        let status = loadPercent > 80 ? 'ðŸ”´ High' : loadPercent > 50 ? 'ðŸŸ¡ Moderate' : 'ðŸŸ¢ Light';
        
        html += `<tr>
            <td><strong>${teacher.name}</strong></td>
            <td><strong>${total}</strong></td>
            <td>${dayCount['MONDAY']}</td>
            <td>${dayCount['TUESDAY']}</td>
            <td>${dayCount['WEDNESDAY']}</td>
            <td>${dayCount['THURSDAY']}</td>
            <td>${dayCount['FRIDAY']}</td>
            <td>${dayCount['SATURDAY']}</td>
            <td><strong>${loadPercent}%</strong></td>
            <td>${status}</td>
        </tr>`;
    });
    
    tbody.innerHTML = html || '<tr><td colspan="10" style="text-align:center; color:#999;">No data</td></tr>';
}

function downloadWorkloadReport() {
    alert('ðŸ“¥ Downloading workload report as PDF...\n\nFeature will generate detailed PDF report with charts.');
}

// Load subject section
function loadSubjectSection() {
    loadSubjectDistributionChart();
    loadSubjectAllocationTable();
}

function loadSubjectAllocationTable() {
    const subjects = DB.get('subjects');
    const routines = DB.get('routines');
    const classes = DB.get('classes');
    const teachers = DB.get('teachers');
    const tbody = document.getElementById('subjectAllocationTable');
    
    let html = '';
    subjects.forEach(subject => {
        const subjectRoutines = routines.filter(r => r.subject === subject.name);
        const uniqueClasses = [...new Set(subjectRoutines.map(r => r.classId))].length;
        const uniqueTeachers = [...new Set(subjectRoutines.map(r => r.teacherId))].length;
        const weeklyHours = (subjectRoutines.length * 0.75).toFixed(1); // 45 min = 0.75 hr
        const utilization = ((subjectRoutines.length / (classes.length * 6)) * 100).toFixed(1);
        
        html += `<tr>
            <td><strong>${subject.name}</strong></td>
            <td>${subjectRoutines.length}</td>
            <td>${uniqueClasses}/${classes.length}</td>
            <td>${uniqueTeachers}</td>
            <td>${weeklyHours} hrs</td>
            <td><strong>${utilization}%</strong></td>
        </tr>`;
    });
    
    tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center; color:#999;">No data</td></tr>';
}

function downloadSubjectReport() {
    alert('ðŸ“¥ Downloading subject report as PDF...');
}

// Load period section
function loadPeriodSection() {
    loadPeriodDistributionChart();
    loadDayDistributionChart();
    loadPeriodUtilizationTable();
}

function loadPeriodUtilizationTable() {
    const periods = DB.get('periods');
    const routines = DB.get('routines');
    const classes = DB.get('classes');
    const tbody = document.getElementById('periodUtilizationTable');
    
    const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
    const maxPerDay = classes.length; // Max classes per period
    
    let html = '';
    periods.forEach(period => {
        const dayCount = {};
        let total = 0;
        
        days.forEach(day => {
            const count = routines.filter(r => r.periodId == period.id && r.day === day).length;
            dayCount[day] = count;
            total += count;
        });
        
        const utilization = ((total / (maxPerDay * 6)) * 100).toFixed(1);
        
        html += `<tr>
            <td><strong>Period ${period.number}</strong></td>
            <td>${period.time}</td>
            <td>${dayCount['MONDAY']}</td>
            <td>${dayCount['TUESDAY']}</td>
            <td>${dayCount['WEDNESDAY']}</td>
            <td>${dayCount['THURSDAY']}</td>
            <td>${dayCount['FRIDAY']}</td>
            <td>${dayCount['SATURDAY']}</td>
            <td><strong>${total}</strong></td>
            <td><strong>${utilization}%</strong></td>
        </tr>`;
    });
    
    tbody.innerHTML = html || '<tr><td colspan="10" style="text-align:center; color:#999;">No data</td></tr>';
}

function downloadPeriodReport() {
    alert('ðŸ“¥ Downloading period utilization report as PDF...');
}

// Load attendance section
function loadAttendanceSection() {
    const today = new Date().toISOString().substring(0, 7);
    document.getElementById('attendanceMonth').value = today;
    
    const teachers = DB.get('teachers');
    const select = document.getElementById('attendanceTeacher');
    select.innerHTML = '<option value="">All Teachers</option>';
    teachers.forEach(t => {
        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
    });
    
    loadAttendanceAnalytics();
}

function loadAttendanceAnalytics() {
    const month = document.getElementById('attendanceMonth').value;
    const teacherId = document.getElementById('attendanceTeacher').value;
    const attendance = DB.get('attendance');
    const teachers = DB.get('teachers');
    
    let filtered = attendance.filter(a => a.date.startsWith(month));
    if (teacherId) filtered = filtered.filter(a => a.teacherId == teacherId);
    
    // Load chart
    const ctx = document.getElementById('attendanceOverviewChart');
    if (ctx && window.attendanceChartInstance) window.attendanceChartInstance.destroy();
    
    const presentCount = filtered.filter(a => a.status === 'present').length;
    const absentCount = filtered.filter(a => a.status === 'absent').length;
    const leaveCount = filtered.filter(a => a.status === 'leave').length;
    
    window.attendanceChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Present', 'Absent', 'Leave'],
            datasets: [{
                data: [presentCount, absentCount, leaveCount],
                backgroundColor: ['#4CAF50', '#f44336', '#FF9800']
            }]
        }
    });
    
    // Load table
    const tbody = document.getElementById('attendanceSummaryTable');
    const teacherStats = teachers.map(teacher => {
        const teacherAttendance = filtered.filter(a => a.teacherId == teacher.id);
        const present = teacherAttendance.filter(a => a.status === 'present').length;
        const absent = teacherAttendance.filter(a => a.status === 'absent').length;
        const leave = teacherAttendance.filter(a => a.status === 'leave').length;
        const total = teacherAttendance.length;
        const percentage = total > 0 ? ((present / total) * 100).toFixed(1) : 0;
        
        return { teacher, present, absent, leave, total, percentage };
    });
    
    tbody.innerHTML = teacherStats.map(s => `<tr>
        <td><strong>${s.teacher.name}</strong></td>
        <td>${s.present}</td>
        <td>${s.absent}</td>
        <td>${s.leave}</td>
        <td>${s.total}</td>
        <td><strong>${s.percentage}%</strong></td>
        <td>${s.percentage >= 90 ? 'ðŸŸ¢ Excellent' : s.percentage >= 75 ? 'ðŸŸ¡ Good' : 'ðŸ”´ Poor'}</td>
    </tr>`).join('') || '<tr><td colspan="7" style="text-align:center; color:#999;">No data</td></tr>';
}

function downloadAttendanceReport() {
    alert('ðŸ“¥ Downloading attendance report as PDF...');
}

// Load exam section
function loadExamSection() {
    const exams = DB.get('exams');
    const select = document.getElementById('examAnalytics');
    select.innerHTML = '<option value="">-- Select Exam --</option>';
    exams.forEach(e => {
        select.innerHTML += `<option value="${e.id}">${e.name}</option>`;
    });
}

function loadExamAnalytics() {
    const examId = parseInt(document.getElementById('examAnalytics').value);
    if (!examId) return;
    
    const students = DB.get('students');
    const timetable = DB.get('examTimetable');
    const invigilatorAssignments = DB.get('invigilatorAssignments');
    const hallAssignments = DB.get('hallAssignments');
    
    const examEntries = timetable.filter(t => t.examId === examId);
    const examInvigilators = invigilatorAssignments.filter(a => a.examId === examId);
    const examHalls = [...new Set(hallAssignments.filter(a => a.examId === examId).map(a => a.hallId))];
    
    document.getElementById('examTotalStudents').textContent = students.length;
    document.getElementById('examTotalPapers').textContent = examEntries.length;
    document.getElementById('examInvigilatorsAssigned').textContent = examInvigilators.reduce((sum, a) => sum + a.invigilators.length, 0);
    document.getElementById('examHallsUsed').textContent = examHalls.length;
    
    // Load chart
    const ctx = document.getElementById('examScheduleChart');
    if (ctx && window.examChartInstance) window.examChartInstance.destroy();
    
    const dates = {};
    examEntries.forEach(e => {
        const date = new Date(e.date).toLocaleDateString('en-IN');
        dates[date] = (dates[date] || 0) + 1;
    });
    
    window.examChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(dates),
            datasets: [{
                label: 'Papers per Day',
                data: Object.values(dates),
                backgroundColor: '#2196F3'
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
    
    // Load details
    const classes = DB.get('classes');
    document.getElementById('examDetailsContent').innerHTML = examEntries.map(e => {
        const cls = classes.find(c => c.id == e.classId);
        return `<div style="background: #f8f9fa; padding: 10px; margin-bottom: 8px; border-radius: 6px;">
            <strong>${new Date(e.date).toLocaleDateString('en-IN')}</strong> - ${e.startTime} | 
            ${cls ? cls.name : '-'} | ${e.subject}
        </div>`;
    }).join('');
}

function downloadExamReport() {
    alert('ðŸ“¥ Downloading exam report as PDF...');
}

// Export functions
function exportAllAnalyticsExcel() {
    alert('ðŸ“Š Exporting all analytics to Excel...\n\nWill generate comprehensive Excel file with all reports.');
}

function exportCurrentSectionPDF() {
    alert('ðŸ“„ Exporting current section to PDF...\n\nWill generate PDF of currently visible analytics.');
}

function printCurrentSection() {
    window.print();
}


// ========== SETTINGS & CONFIGURATION FUNCTIONS ==========

// Initialize settings
function initializeSettings() {
    loadSchoolInfo();
    loadAcademicYear();
    loadTerms();
    loadPeriodTimings();
    loadWorkingDays();
    loadHolidays();
    loadSystemSettings();
    loadBackupHistory();
}

// Show settings section
function showSettingsSection(section) {
    document.querySelectorAll('.settings-section').forEach(s => s.style.display = 'none');
    
    document.querySelectorAll('[id^="settings"][id$="Btn"]').forEach(btn => {
        btn.className = 'btn btn-secondary';
        btn.style.borderRadius = '8px 8px 0 0';
    });
    
    document.getElementById('settings' + section.charAt(0).toUpperCase() + section.slice(1)).style.display = 'block';
    document.getElementById('settings' + section.charAt(0).toUpperCase() + section.slice(1) + 'Btn').className = 'btn btn-primary';
}

// School Information Functions
function loadSchoolInfo() {
    const info = DB.getObj('schoolInfo') || {
        name: 'Ramnagar High School',
        diseCode: '',
        indexNo: '',
        hsCode: '',
        code: 'RHS001',
        address: '',
        locality: '',
        postOffice: '',
        policeStation: '',
        district: 'Durgapur',
        pin: '',
        state: 'West Bengal',
        phone: '',
        email: '',
        website: '',
        headmasterName: '',
        headmasterPhone: '',
        assistantHeadmasterName: '',
        assistantHeadmasterPhone: '',
        logo: '',
        motto: ''
    };
    
    document.getElementById('schoolName').value = info.name || '';
    document.getElementById('diseCode').value = info.diseCode || '';
    document.getElementById('indexNo').value = info.indexNo || '';
    document.getElementById('hsCode').value = info.hsCode || '';
    document.getElementById('schoolCode').value = info.code || '';
    document.getElementById('schoolLocality').value = info.locality || '';
    document.getElementById('schoolPO').value = info.postOffice || '';
    document.getElementById('schoolPS').value = info.policeStation || '';
    document.getElementById('schoolDistrict').value = info.district || '';
    document.getElementById('schoolPin').value = info.pin || '';
    document.getElementById('schoolState').value = info.state || '';
    document.getElementById('schoolPhone').value = info.phone || '';
    document.getElementById('schoolEmail').value = info.email || '';
    document.getElementById('schoolWebsite').value = info.website || '';
    document.getElementById('headmasterName').value = info.headmasterName || '';
    document.getElementById('headmasterPhone').value = info.headmasterPhone || '';
    document.getElementById('assistantHeadmasterName').value = info.assistantHeadmasterName || '';
    document.getElementById('assistantHeadmasterPhone').value = info.assistantHeadmasterPhone || '';
    document.getElementById('schoolLogo').value = info.logo || '';
    document.getElementById('schoolMotto').value = info.motto || '';
    
    // Load students for certificate generator
    loadCertificateStudents();
}

function saveSchoolInfo() {
    const info = {
        name: document.getElementById('schoolName').value.trim(),
        diseCode: document.getElementById('diseCode').value.trim(),
        indexNo: document.getElementById('indexNo').value.trim(),
        hsCode: document.getElementById('hsCode').value.trim(),
        code: document.getElementById('schoolCode').value.trim(),
        locality: document.getElementById('schoolLocality').value.trim(),
        postOffice: document.getElementById('schoolPO').value.trim(),
        policeStation: document.getElementById('schoolPS').value.trim(),
        district: document.getElementById('schoolDistrict').value.trim(),
        pin: document.getElementById('schoolPin').value.trim(),
        state: document.getElementById('schoolState').value.trim(),
        phone: document.getElementById('schoolPhone').value.trim(),
        email: document.getElementById('schoolEmail').value.trim(),
        website: document.getElementById('schoolWebsite').value.trim(),
        headmasterName: document.getElementById('headmasterName').value.trim(),
        headmasterPhone: document.getElementById('headmasterPhone').value.trim(),
        assistantHeadmasterName: document.getElementById('assistantHeadmasterName').value.trim(),
        assistantHeadmasterPhone: document.getElementById('assistantHeadmasterPhone').value.trim(),
        logo: document.getElementById('schoolLogo').value.trim(),
        motto: document.getElementById('schoolMotto').value.trim()
    };
    
    if (!info.name || !info.diseCode || !info.locality || !info.district || !info.state) {
        alert('Please fill required fields: School Name, DISE Code, Village/Locality, District, State');
        return;
    }
    
    DB.setObj('schoolInfo', info);
    alert('âœ… School information saved successfully!');
}

// Certificate Generator Functions
function updateCertificateOptions() {
    const certificateFor = document.getElementById('certificateFor').value;
    const typeSelect = document.getElementById('certificateType');
    const personSelect = document.getElementById('certificatePerson');
    const personLabel = document.getElementById('certificatePersonLabel');
    
    // Reset
    typeSelect.innerHTML = '<option value="">-- Select Type --</option>';
    personSelect.innerHTML = '<option value="">-- Select certificate type first --</option>';
    
    if (!certificateFor) return;
    
    if (certificateFor === 'student') {
        personLabel.textContent = 'Select Student *';
        typeSelect.innerHTML = `
            <option value="">-- Select Type --</option>
            <option value="transfer">Transfer Certificate (TC)</option>
            <option value="character">Character Certificate</option>
            <option value="bonafide">Bonafide Certificate</option>
            <option value="sports">Sports Certificate</option>
            <option value="conduct">Conduct Certificate</option>
        `;
        loadCertificateStudents();
    } else if (certificateFor === 'teacher') {
        personLabel.textContent = 'Select Teacher *';
        typeSelect.innerHTML = `
            <option value="">-- Select Type --</option>
            <option value="experience">Experience Certificate</option>
            <option value="character">Character Certificate</option>
            <option value="relieving">Relieving Letter</option>
            <option value="appointment">Appointment Letter</option>
            <option value="appreciation">Appreciation Certificate</option>
        `;
        loadCertificateTeachers();
    }
}

function loadCertificateStudents() {
    const students = DB.get('students');
    const select = document.getElementById('certificatePerson');
    
    if (select) {
        select.innerHTML = '<option value="">-- Select Student --</option>';
        students.forEach(s => {
            select.innerHTML += `<option value="${s.id}">${s.name} (${s.roll})</option>`;
        });
    }
}

function loadCertificateTeachers() {
    const teachers = DB.get('teachers');
    const select = document.getElementById('certificatePerson');
    
    if (select) {
        select.innerHTML = '<option value="">-- Select Teacher --</option>';
        teachers.forEach(t => {
            select.innerHTML += `<option value="${t.id}">${t.name} (${t.employeeId || t.id})</option>`;
        });
    }
}

function generateCertificate() {
    const certificateFor = document.getElementById('certificateFor').value;
    const type = document.getElementById('certificateType').value;
    const personId = document.getElementById('certificatePerson').value;
    
    if (!certificateFor || !type || !personId) {
        alert('Please fill all certificate fields!');
        return;
    }
    
    const schoolInfo = DB.getObj('schoolInfo');
    let certificateHTML = '';
    
    if (certificateFor === 'student') {
        const students = DB.get('students');
        const student = students.find(s => s.id == personId);
        
        switch(type) {
            case 'transfer':
                certificateHTML = generateTransferCertificate(student, schoolInfo);
                break;
            case 'character':
                certificateHTML = generateCharacterCertificate(student, schoolInfo);
                break;
            case 'bonafide':
                certificateHTML = generateBonafideCertificate(student, schoolInfo);
                break;
            default:
                alert('Certificate type not implemented yet!');
                return;
        }
    } else if (certificateFor === 'teacher') {
        const teachers = DB.get('teachers');
        const teacher = teachers.find(t => t.id == personId);
        
        switch(type) {
            case 'experience':
                certificateHTML = generateExperienceCertificate(teacher, schoolInfo);
                break;
            case 'character':
                certificateHTML = generateTeacherCharacterCertificate(teacher, schoolInfo);
                break;
            case 'relieving':
                certificateHTML = generateRelievingLetter(teacher, schoolInfo);
                break;
            case 'appointment':
                certificateHTML = generateAppointmentLetter(teacher, schoolInfo);
                break;
            case 'appreciation':
                certificateHTML = generateAppreciationCertificate(teacher, schoolInfo);
                break;
            default:
                alert('Certificate type not implemented yet!');
                return;
        }
    }
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(certificateHTML);
    printWindow.document.close();
    setTimeout(() => printWindow.print(), 500);
}

function generateExperienceCertificate(teacher, school) {
    return `<!DOCTYPE html>
    <html><head><meta charset="UTF-8"><title>Experience Certificate</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        .header { text-align: center; border-bottom: 3px double #000; padding-bottom: 15px; margin-bottom: 30px; }
        .header h1 { margin: 5px 0; font-size: 24px; }
        .content { line-height: 2; text-align: justify; margin: 30px 0; }
        .footer { margin-top: 60px; text-align: right; }
    </style></head><body>
    <div class="header">
        <h1>${school.name}</h1>
        <p>${school.locality}, ${school.district}, ${school.state} - ${school.pin}</p>
        <p>Phone: ${school.phone} | Email: ${school.email}</p>
        <h2 style="margin-top: 20px;">EXPERIENCE CERTIFICATE</h2>
    </div>
    <div class="content">
        <p>TO WHOM IT MAY CONCERN</p>
        <p>This is to certify that <strong>${teacher.name}</strong> has worked with <strong>${school.name}</strong> 
        as a <strong>${teacher.subject || 'Teacher'}</strong> from <strong>__________</strong> to <strong>__________</strong>.</p>
        <p>During this tenure, ${teacher.name.split(' ')[0]} has shown excellent teaching skills, 
        dedication towards work, and maintained high standards of professional conduct.</p>
        <p>We wish ${teacher.name.split(' ')[0]} all the best for future endeavors.</p>
    </div>
    <div class="footer">
        <p>Date: ${new Date().toLocaleDateString('en-IN')}</p>
        <p style="margin-top: 50px;">${school.headmasterName || 'Headmaster'}<br>Headmaster<br>${school.name}</p>
    </div>
    </body></html>`;
}

function generateTeacherCharacterCertificate(teacher, school) {
    return `<!DOCTYPE html>
    <html><head><meta charset="UTF-8"><title>Character Certificate</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 30px; }
        .content { line-height: 2; text-align: justify; }
        .footer { margin-top: 60px; text-align: right; }
    </style></head><body>
    <div class="header">
        <h1>${school.name}</h1>
        <p>${school.locality}, ${school.district}, ${school.state}</p>
        <h2>CHARACTER CERTIFICATE</h2>
    </div>
    <div class="content">
        <p>This is to certify that <strong>${teacher.name}</strong> has been working with our institution 
        as a <strong>${teacher.subject || 'Teacher'}</strong>. During this period, ${teacher.name.split(' ')[0]}'s 
        conduct and character have been found to be <strong>EXEMPLARY</strong>.</p>
        <p>${teacher.name.split(' ')[0]} is honest, hardworking, and has always maintained the highest standards 
        of professional ethics.</p>
        <p>I wish ${teacher.name.split(' ')[0]} all success in future.</p>
    </div>
    <div class="footer">
        <p>Date: ${new Date().toLocaleDateString('en-IN')}</p>
        <p style="margin-top: 40px;">${school.headmasterName || 'Headmaster'}<br>Headmaster<br>${school.name}</p>
    </div>
    </body></html>`;
}

function generateRelievingLetter(teacher, school) {
    return `<!DOCTYPE html>
    <html><head><meta charset="UTF-8"><title>Relieving Letter</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 30px; }
        .content { line-height: 2; text-align: justify; }
        .footer { margin-top: 60px; text-align: right; }
    </style></head><body>
    <div class="header">
        <h1>${school.name}</h1>
        <p>${school.locality}, ${school.district}, ${school.state}</p>
        <h2>RELIEVING LETTER</h2>
    </div>
    <div class="content">
        <p>Date: ${new Date().toLocaleDateString('en-IN')}</p>
        <p>TO WHOM IT MAY CONCERN</p>
        <p>This is to certify that <strong>${teacher.name}</strong> has been relieved from the services of 
        <strong>${school.name}</strong> with effect from <strong>__________</strong>.</p>
        <p>${teacher.name.split(' ')[0]} has worked with us as <strong>${teacher.subject || 'Teacher'}</strong> 
        and has completed all formalities related to resignation.</p>
        <p>We wish ${teacher.name.split(' ')[0]} all the best for future endeavors.</p>
    </div>
    <div class="footer">
        <p style="margin-top: 50px;">${school.headmasterName || 'Headmaster'}<br>Headmaster<br>${school.name}<br>School Seal</p>
    </div>
    </body></html>`;
}

function generateAppointmentLetter(teacher, school) {
    return `<!DOCTYPE html>
    <html><head><meta charset="UTF-8"><title>Appointment Letter</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 30px; }
        .content { line-height: 1.8; text-align: justify; }
        .footer { margin-top: 60px; display: flex; justify-content: space-between; }
    </style></head><body>
    <div class="header">
        <h1>${school.name}</h1>
        <p>${school.locality}, ${school.district}, ${school.state}</p>
        <h2>APPOINTMENT LETTER</h2>
    </div>
    <div class="content">
        <p>Date: ${new Date().toLocaleDateString('en-IN')}</p>
        <p>Dear <strong>${teacher.name}</strong>,</p>
        <p>We are pleased to inform you that you have been appointed as <strong>${teacher.subject || 'Teacher'}</strong> 
        at <strong>${school.name}</strong> with effect from <strong>__________</strong>.</p>
        <p><strong>Terms & Conditions:</strong></p>
        <p>1. Salary: As per school norms<br>
        2. Working Days: Monday to Saturday<br>
        3. Probation Period: 6 months<br>
        4. Notice Period: 1 month</p>
        <p>Please confirm your acceptance by signing below.</p>
    </div>
    <div class="footer">
        <div>
            <p>___________________<br>Employee's Signature</p>
        </div>
        <div>
            <p>___________________<br>${school.headmasterName || 'Headmaster'}<br>Headmaster</p>
        </div>
    </div>
    </body></html>`;
}

function generateAppreciationCertificate(teacher, school) {
    return `<!DOCTYPE html>
    <html><head><meta charset="UTF-8"><title>Appreciation Certificate</title>
    <style>
        body { font-family: Arial; margin: 40px; background: #f9f9f9; }
        .certificate { 
            background: white; 
            border: 8px solid #1e3c72; 
            padding: 40px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .header { text-align: center; margin-bottom: 30px; }
        .title { font-size: 36px; color: #1e3c72; margin: 20px 0; }
        .content { text-align: center; line-height: 2; margin: 40px 0; }
        .name { font-size: 28px; color: #1e3c72; font-weight: bold; margin: 20px 0; }
        .footer { margin-top: 60px; text-align: center; }
    </style></head><body>
    <div class="certificate">
        <div class="header">
            <h1 style="margin: 0; color: #1e3c72;">${school.name}</h1>
            <p>${school.locality}, ${school.district}, ${school.state}</p>
        </div>
        <div class="title">ðŸ† CERTIFICATE OF APPRECIATION ðŸ†</div>
        <div class="content">
            <p>This certificate is proudly presented to</p>
            <div class="name">${teacher.name}</div>
            <p>in recognition of outstanding dedication, excellent teaching, and valuable contribution 
            to <strong>${school.name}</strong>.</p>
            <p>Your commitment to education and student success is truly commendable.</p>
        </div>
        <div class="footer">
            <p>Date: ${new Date().toLocaleDateString('en-IN')}</p>
            <p style="margin-top: 40px;">${school.headmasterName || 'Headmaster'}<br>Headmaster</p>
        </div>
    </div>
    </body></html>`;
}

function generateTransferCertificate(student, school) {
    const classes = DB.get('classes');
    const cls = classes.find(c => c.id == student.classId);
    
    return `<!DOCTYPE html>
    <html><head><meta charset="UTF-8"><title>Transfer Certificate</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        .header { text-align: center; border-bottom: 3px double #000; padding-bottom: 15px; margin-bottom: 20px; }
        .header h1 { margin: 5px 0; font-size: 24px; }
        .content { line-height: 1.8; }
        .row { display: flex; margin-bottom: 10px; }
        .label { width: 250px; font-weight: 600; }
        .value { flex: 1; border-bottom: 1px dotted #333; }
        .footer { margin-top: 50px; display: flex; justify-content: space-between; }
    </style></head><body>
    <div class="header">
        <h1>${school.name}</h1>
        <p>${school.locality}, ${school.district}, ${school.state} - ${school.pin}</p>
        <h2 style="margin-top: 20px;">TRANSFER CERTIFICATE</h2>
        <p>DISE Code: ${school.diseCode}</p>
    </div>
    <div class="content">
        <div class="row"><div class="label">Serial No.:</div><div class="value">TC/${new Date().getFullYear()}/001</div></div>
        <div class="row"><div class="label">Student Name:</div><div class="value">${student.name}</div></div>
        <div class="row"><div class="label">Father's Name:</div><div class="value">${student.fatherName || ''}</div></div>
        <div class="row"><div class="label">Mother's Name:</div><div class="value">${student.motherName || ''}</div></div>
        <div class="row"><div class="label">Date of Birth:</div><div class="value">${student.dob ? new Date(student.dob).toLocaleDateString('en-IN') : ''}</div></div>
        <div class="row"><div class="label">Class:</div><div class="value">${cls ? cls.name : ''}</div></div>
        <div class="row"><div class="label">Date of Admission:</div><div class="value"></div></div>
        <div class="row"><div class="label">Date of Leaving:</div><div class="value">${new Date().toLocaleDateString('en-IN')}</div></div>
        <div class="row"><div class="label">Reason for Leaving:</div><div class="value"></div></div>
        <div class="row"><div class="label">Conduct:</div><div class="value">GOOD</div></div>
    </div>
    <div class="footer">
        <div>Date: ${new Date().toLocaleDateString('en-IN')}</div>
        <div>Headmaster's Signature & Seal</div>
    </div>
    </body></html>`;
}

function generateCharacterCertificate(student, school) {
    return `<!DOCTYPE html>
    <html><head><meta charset="UTF-8"><title>Character Certificate</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 30px; }
        .content { line-height: 2; text-align: justify; }
        .footer { margin-top: 60px; text-align: right; }
    </style></head><body>
    <div class="header">
        <h1>${school.name}</h1>
        <p>${school.locality}, ${school.district}, ${school.state}</p>
        <h2>CHARACTER CERTIFICATE</h2>
    </div>
    <div class="content">
        <p>This is to certify that <strong>${student.name}</strong>, Roll No. <strong>${student.roll}</strong>, 
        has been a student of this institution. During his/her stay in this school, his/her conduct and character 
        have been found to be <strong>GOOD</strong>.</p>
        <p>I wish him/her all success in life.</p>
    </div>
    <div class="footer">
        <p>Date: ${new Date().toLocaleDateString('en-IN')}</p>
        <p style="margin-top: 40px;">${school.headmasterName || 'Headmaster'}<br>Headmaster<br>${school.name}</p>
    </div>
    </body></html>`;
}

function generateBonafideCertificate(student, school) {
    const classes = DB.get('classes');
    const cls = classes.find(c => c.id == student.classId);
    
    return `<!DOCTYPE html>
    <html><head><meta charset="UTF-8"><title>Bonafide Certificate</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 30px; }
        .content { line-height: 2; text-align: justify; }
        .footer { margin-top: 60px; text-align: right; }
    </style></head><body>
    <div class="header">
        <h1>${school.name}</h1>
        <p>${school.locality}, ${school.district}, ${school.state}</p>
        <h2>BONAFIDE CERTIFICATE</h2>
    </div>
    <div class="content">
        <p>This is to certify that <strong>${student.name}</strong>, Roll No. <strong>${student.roll}</strong>, 
        is a bonafide student of this institution studying in Class <strong>${cls ? cls.name : ''}</strong> 
        for the academic year <strong>${new Date().getFullYear()}-${new Date().getFullYear()+1}</strong>.</p>
        <p>This certificate is issued on request for <strong>_____________________</strong> purpose.</p>
    </div>
    <div class="footer">
        <p>Date: ${new Date().toLocaleDateString('en-IN')}</p>
        <p style="margin-top: 40px;">${school.headmasterName || 'Headmaster'}<br>Headmaster<br>${school.name}</p>
    </div>
    </body></html>`;
}

function previewCertificate() {
    alert('Certificate preview feature - shows formatted certificate before printing');
}

// User Management Functions
function loadUsersList() {
    const userType = document.getElementById('userType').value;
    const select = document.getElementById('username');
    
    if (!userType) {
        select.disabled = true;
        select.innerHTML = '<option value="">-- Select user type first --</option>';
        return;
    }
    
    select.disabled = false;
    select.innerHTML = '<option value="">-- Select User --</option>';
    
    if (userType === 'admin') {
        select.innerHTML += '<option value="admin">Admin</option>';
    } else if (userType === 'teacher') {
        const teachers = DB.get('teachers');
        teachers.forEach(t => {
            select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
        });
    } else if (userType === 'office') {
        select.innerHTML += '<option value="office1">Office Staff 1</option>';
        select.innerHTML += '<option value="office2">Office Staff 2</option>';
    }
}

function changeUserPassword() {
    const userType = document.getElementById('userType').value;
    const username = document.getElementById('username').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!userType || !username) {
        alert('Please select user type and username!');
        return;
    }
    
    if (!newPassword || newPassword.length < 6) {
        alert('Password must be at least 6 characters!');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('Passwords do not match!');
        return;
    }
    
    // Save password (in real app, hash it!)
    let users = DB.get('users');
    const userIndex = users.findIndex(u => u.username === username && u.type === userType);
    
    if (userIndex >= 0) {
        users[userIndex].password = newPassword; // In production: hash this!
        users[userIndex].lastPasswordChange = new Date().toISOString();
    } else {
        users.push({
            id: Date.now(),
            username,
            type: userType,
            password: newPassword,
            createdAt: new Date().toISOString(),
            lastPasswordChange: new Date().toISOString()
        });
    }
    
    DB.set('users', users);
    
    // Log activity
    logActivity('Password Changed', `${userType}: ${username}`);
    
    alert('âœ… Password changed successfully!');
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
}

function saveSessionSettings() {
    const autoLogoutTime = document.getElementById('autoLogoutTime').value;
    DB.setObj('sessionSettings', { autoLogoutTime: parseInt(autoLogoutTime) });
    alert('âœ… Session settings saved!');
}

// Login History Functions
function viewLoginHistory() {
    const container = document.getElementById('loginHistoryContainer');
    container.style.display = container.style.display === 'none' ? 'block' : 'none';
    
    if (container.style.display === 'block') {
        loadLoginHistory();
    }
}

function loadLoginHistory() {
    const loginHistory = DB.get('loginHistory');
    const tbody = document.getElementById('loginHistoryTable');
    
    if (loginHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No login history available</td></tr>';
        return;
    }
    
    tbody.innerHTML = loginHistory.slice(-20).reverse().map(log => `
        <tr>
            <td>${new Date(log.timestamp).toLocaleString('en-IN')}</td>
            <td><strong>${log.username}</strong></td>
            <td><span class="status-badge" style="background: #e3f2fd; color: #1976d2;">${log.userType}</span></td>
            <td>${log.ipAddress || 'N/A'}</td>
            <td><span class="status-badge" style="background: ${log.status === 'success' ? '#d4edda' : '#f8d7da'}; color: ${log.status === 'success' ? '#155724' : '#721c24'};">${log.status}</span></td>
        </tr>
    `).join('');
}

function logActivity(action, details) {
    let loginHistory = DB.get('loginHistory');
    loginHistory.push({
        id: Date.now(),
        timestamp: new Date().toISOString(),
        username: DB.getObj('currentUser').username || 'admin',
        userType: 'admin',
        action,
        details,
        ipAddress: 'Local',
        status: 'success'
    });
    DB.set('loginHistory', loginHistory);
}

// Notification Settings Functions
function saveNotificationSettings() {
    const settings = {
        absentTeacher: document.getElementById('notifyAbsentTeacher').checked,
        provisional: document.getElementById('notifyProvisional').checked,
        conflicts: document.getElementById('notifyConflicts').checked,
        exams: document.getElementById('notifyExams').checked
    };
    
    DB.setObj('notificationSettings', settings);
    alert('âœ… Notification settings saved!');
}

// Report Settings Functions
function saveReportSettings() {
    const settings = {
        header: document.getElementById('reportHeader').value,
        digitalSignature: document.getElementById('digitalSignature').value,
        exportFormat: document.getElementById('defaultExportFormat').value
    };
    
    DB.setObj('reportSettings', settings);
    alert('âœ… Report settings saved!');
}

// Academic Year Functions
function loadAcademicYear() {
    const academic = DB.getObj('academicYear') || {
        year: '2024-2025',
        startDate: '2024-04-01',
        endDate: '2025-03-31'
    };
    
    document.getElementById('academicYear').value = academic.year || '';
    document.getElementById('sessionStartDate').value = academic.startDate || '';
    document.getElementById('sessionEndDate').value = academic.endDate || '';
}

function saveAcademicYear() {
    const academic = {
        year: document.getElementById('academicYear').value.trim(),
        startDate: document.getElementById('sessionStartDate').value,
        endDate: document.getElementById('sessionEndDate').value
    };
    
    if (!academic.year || !academic.startDate || !academic.endDate) {
        alert('Please fill all academic year fields!');
        return;
    }
    
    DB.setObj('academicYear', academic);
    alert('âœ… Academic year saved successfully!');
}

// Term Configuration
function generateTermInputs() {
    const numberOfTerms = parseInt(document.getElementById('numberOfTerms').value);
    const container = document.getElementById('termInputsContainer');
    
    let html = '';
    for (let i = 1; i <= numberOfTerms; i++) {
        html += `
            <div class="card" style="margin-bottom: 15px; background: #f8f9fa;">
                <h4 style="margin-bottom: 10px;">Term ${i}</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Term Name *</label>
                        <input type="text" id="term${i}Name" placeholder="e.g., First Term" value="Term ${i}">
                    </div>
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="term${i}Start">
                    </div>
                    <div class="form-group">
                        <label>End Date *</label>
                        <input type="date" id="term${i}End">
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function saveTerms() {
    const numberOfTerms = parseInt(document.getElementById('numberOfTerms').value);
    const terms = [];
    
    for (let i = 1; i <= numberOfTerms; i++) {
        const name = document.getElementById(`term${i}Name`).value.trim();
        const start = document.getElementById(`term${i}Start`).value;
        const end = document.getElementById(`term${i}End`).value;
        
        if (!name || !start || !end) {
            alert(`Please fill all fields for Term ${i}!`);
            return;
        }
        
        terms.push({ id: i, name, startDate: start, endDate: end });
    }
    
    DB.set('terms', terms);
    alert('âœ… Terms saved successfully!');
    loadTerms();
}

function loadTerms() {
    const terms = DB.get('terms');
    const container = document.getElementById('currentTermsList');
    
    if (terms.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No terms configured</p>';
        generateTermInputs(); // Show default inputs
        return;
    }
    
    let html = '<div style="display: grid; gap: 15px;">';
    terms.forEach(term => {
        html += `
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                <strong>${term.name}</strong><br>
                <small>${new Date(term.startDate).toLocaleDateString('en-IN')} - ${new Date(term.endDate).toLocaleDateString('en-IN')}</small>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
    
    // Set dropdown to current number of terms
    document.getElementById('numberOfTerms').value = terms.length;
    generateTermInputs();
    
    // Fill existing data
    terms.forEach((term, index) => {
        const i = index + 1;
        document.getElementById(`term${i}Name`).value = term.name;
        document.getElementById(`term${i}Start`).value = term.startDate;
        document.getElementById(`term${i}End`).value = term.endDate;
    });
}

// Period Timing Functions
function loadPeriodTimings() {
    const periods = DB.get('periods');
    const container = document.getElementById('periodTimingsEditor');
    
    let html = '';
    periods.forEach(period => {
        html += `
            <div class="card" style="margin-bottom: 15px; background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4>Period ${period.number}</h4>
                    <button class="btn btn-sm btn-danger" onclick="deletePeriodTiming(${period.id})">ðŸ—‘ï¸</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Period Number</label>
                        <input type="number" value="${period.number}" onchange="updatePeriodTiming(${period.id}, 'number', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="time" value="${period.time.split(' - ')[0]}" onchange="updatePeriodTime(${period.id}, this.value, 'start')">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="time" value="${period.time.split(' - ')[1]}" onchange="updatePeriodTime(${period.id}, this.value, 'end')">
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updatePeriodTiming(periodId, field, value) {
    let periods = DB.get('periods');
    const period = periods.find(p => p.id === periodId);
    if (period) {
        period[field] = field === 'number' ? parseInt(value) : value;
        DB.set('periods', periods);
    }
}

function updatePeriodTime(periodId, value, type) {
    let periods = DB.get('periods');
    const period = periods.find(p => p.id === periodId);
    if (period) {
        const times = period.time.split(' - ');
        if (type === 'start') {
            period.time = `${value} - ${times[1]}`;
        } else {
            period.time = `${times[0]} - ${value}`;
        }
        DB.set('periods', periods);
    }
}

function deletePeriodTiming(periodId) {
    if (!confirm('Delete this period timing?')) return;
    
    let periods = DB.get('periods');
    periods = periods.filter(p => p.id !== periodId);
    DB.set('periods', periods);
    loadPeriodTimings();
}

function addNewPeriodTiming() {
    let periods = DB.get('periods');
    const newNumber = periods.length + 1;
    
    periods.push({
        id: Date.now(),
        number: newNumber,
        time: '00:00 - 00:00'
    });
    
    DB.set('periods', periods);
    loadPeriodTimings();
}

function savePeriodTimings() {
    alert('âœ… Period timings saved!');
    loadPeriods();
}

function resetToDefaultTimings() {
    if (!confirm('Reset to default timings? This will overwrite current settings.')) return;
    
    const defaultPeriods = [
        { id: 1, number: 1, time: '10:30 - 11:15' },
        { id: 2, number: 2, time: '11:15 - 12:00' },
        { id: 3, number: 3, time: '12:00 - 12:45' },
        { id: 4, number: 4, time: '12:45 - 1:30' },
        { id: 5, number: 5, time: '2:00 - 2:45' },
        { id: 6, number: 6, time: '2:45 - 3:30' },
        { id: 7, number: 7, time: '3:30 - 4:15' }
    ];
    
    DB.set('periods', defaultPeriods);
    loadPeriodTimings();
    alert('âœ… Reset to default timings!');
}

function toggleFridayTimings() {
    const enabled = document.getElementById('fridaySpecialTiming').checked;
    document.getElementById('fridayTimingsEditor').style.display = enabled ? 'block' : 'none';
    document.getElementById('saveFridayBtn').style.display = enabled ? 'block' : 'none';
    
    if (enabled) {
        loadFridayTimings();
    }
}

function loadFridayTimings() {
    const fridayTimings = DB.getObj('fridayTimings') || {};
    const periods = DB.get('periods');
    const container = document.getElementById('fridayTimingsEditor');
    
    let html = '';
    periods.forEach(period => {
        const fridayTime = fridayTimings[period.id] || period.time;
        html += `
            <div class="form-row" style="margin-bottom: 10px;">
                <div class="form-group">
                    <label>Period ${period.number}</label>
                    <input type="time" value="${fridayTime.split(' - ')[0]}" id="friday${period.id}Start">
                </div>
                <div class="form-group">
                    <label>to</label>
                    <input type="time" value="${fridayTime.split(' - ')[1]}" id="friday${period.id}End">
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function saveFridayTimings() {
    const periods = DB.get('periods');
    const fridayTimings = {};
    
    periods.forEach(period => {
        const start = document.getElementById(`friday${period.id}Start`).value;
        const end = document.getElementById(`friday${period.id}End`).value;
        fridayTimings[period.id] = `${start} - ${end}`;
    });
    
    DB.setObj('fridayTimings', fridayTimings);
    alert('âœ… Friday timings saved!');
}

// Working Days Functions
function loadWorkingDays() {
    const workingDays = DB.get('workingDays') || ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
    
    document.querySelectorAll('.working-day-checkbox').forEach(checkbox => {
        checkbox.checked = workingDays.includes(checkbox.value);
    });
}

function saveWorkingDays() {
    const workingDays = [];
    document.querySelectorAll('.working-day-checkbox:checked').forEach(checkbox => {
        workingDays.push(checkbox.value);
    });
    
    if (workingDays.length === 0) {
        alert('Please select at least one working day!');
        return;
    }
    
    DB.set('workingDays', workingDays);
    alert('âœ… Working days saved!');
}

// Holiday Functions
function addHoliday() {
    const name = document.getElementById('holidayName').value.trim();
    const date = document.getElementById('holidayDate').value;
    const type = document.getElementById('holidayType').value;
    
    if (!name || !date) {
        alert('Please fill holiday name and date!');
        return;
    }
    
    const holiday = {
        id: Date.now(),
        name,
        date,
        type,
        day: new Date(date).toLocaleDateString('en-US', { weekday: 'long' })
    };
    
    let holidays = DB.get('holidays');
    holidays.push(holiday);
    DB.set('holidays', holidays);
    
    document.getElementById('holidayName').value = '';
    document.getElementById('holidayDate').value = '';
    
    loadHolidays();
    alert('âœ… Holiday added!');
}

function loadHolidays() {
    const holidays = DB.get('holidays');
    const tbody = document.getElementById('holidaysList');
    
    if (holidays.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No holidays configured</td></tr>';
        return;
    }
    
    holidays.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    tbody.innerHTML = holidays.map(h => `
        <tr>
            <td>${new Date(h.date).toLocaleDateString('en-IN')}</td>
            <td><strong>${h.name}</strong></td>
            <td><span class="status-badge" style="background: #e3f2fd; color: #1976d2;">${h.type}</span></td>
            <td>${h.day}</td>
            <td><button class="btn btn-sm btn-danger" onclick="deleteHoliday(${h.id})">Delete</button></td>
        </tr>
    `).join('');
}

function deleteHoliday(id) {
    if (!confirm('Delete this holiday?')) return;
    
    let holidays = DB.get('holidays');
    holidays = holidays.filter(h => h.id !== id);
    DB.set('holidays', holidays);
    loadHolidays();
}

// System Settings Functions
function loadSystemSettings() {
    const settings = DB.getObj('systemSettings') || {
        language: 'en',
        dateFormat: 'DD/MM/YYYY',
        timeFormat: '12',
        weekStartDay: 'MONDAY',
        enableNotifications: false,
        autoSave: true
    };
    
    document.getElementById('systemLanguage').value = settings.language;
    document.getElementById('dateFormat').value = settings.dateFormat;
    document.getElementById('timeFormat').value = settings.timeFormat;
    document.getElementById('weekStartDay').value = settings.weekStartDay;
    document.getElementById('enableNotifications').checked = settings.enableNotifications;
    document.getElementById('autoSave').checked = settings.autoSave;
}

function saveSystemSettings() {
    const settings = {
        language: document.getElementById('systemLanguage').value,
        dateFormat: document.getElementById('dateFormat').value,
        timeFormat: document.getElementById('timeFormat').value,
        weekStartDay: document.getElementById('weekStartDay').value,
        enableNotifications: document.getElementById('enableNotifications').checked,
        autoSave: document.getElementById('autoSave').checked
    };
    
    DB.setObj('systemSettings', settings);
    alert('âœ… System settings saved!');
}

function applyTheme() {
    const theme = document.getElementById('themePreference').value;
    if (theme === 'dark') {
        document.body.classList.add('dark-mode');
    } else if (theme === 'light') {
        document.body.classList.remove('dark-mode');
    }
}

function setPrimaryColor(color) {
    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
    event.target.classList.add('active');
    // Store color preference
    DB.setObj('primaryColor', color);
}

function saveAppearanceSettings() {
    const theme = document.getElementById('themePreference').value;
    DB.setObj('themePreference', theme);
    alert('âœ… Appearance settings saved!');
}

function clearAllCache() {
    if (!confirm('Clear all cached data?')) return;
    alert('âœ… Cache cleared!');
}

function resetAllSettings() {
    if (!confirm('Reset all settings to default? This cannot be undone!')) return;
    
    localStorage.removeItem('schoolInfo');
    localStorage.removeItem('academicYear');
    localStorage.removeItem('systemSettings');
    
    alert('âœ… Settings reset to default!');
    initializeSettings();
}

function deleteAllData() {
    if (!confirm('âš ï¸ DELETE ALL DATA? This will erase everything and cannot be undone!')) return;
    if (!confirm('Are you absolutely sure? Type YES to confirm') && prompt('Type YES to confirm') !== 'YES') return;
    
    localStorage.clear();
    alert('âœ… All data deleted. Reloading...');
    location.reload();
}

// Backup Functions
function createFullBackup() {
    const backup = {
        timestamp: new Date().toISOString(),
        type: 'full',
        data: {
            teachers: DB.get('teachers'),
            subjects: DB.get('subjects'),
            classes: DB.get('classes'),
            periods: DB.get('periods'),
            routines: DB.get('routines'),
            attendance: DB.get('attendance'),
            provisionalRoutines: DB.get('provisionalRoutines'),
            substituteRecords: DB.get('substituteRecords'),
            exams: DB.get('exams'),
            examTimetable: DB.get('examTimetable'),
            students: DB.get('students'),
            schoolInfo: DB.getObj('schoolInfo'),
            academicYear: DB.getObj('academicYear'),
            terms: DB.get('terms'),
            holidays: DB.get('holidays'),
            workingDays: DB.get('workingDays')
        }
    };
    
    downloadJSON(backup, `RHS_PRMS_Full_Backup_${new Date().toISOString().split('T')[0]}.json`);
    saveBackupHistory('full');
}

function createRoutineBackup() {
    const backup = {
        timestamp: new Date().toISOString(),
        type: 'routine',
        data: {
            routines: DB.get('routines'),
            classes: DB.get('classes'),
            periods: DB.get('periods')
        }
    };
    
    downloadJSON(backup, `RHS_PRMS_Routine_Backup_${new Date().toISOString().split('T')[0]}.json`);
    saveBackupHistory('routine');
}

function createTeacherBackup() {
    const backup = {
        timestamp: new Date().toISOString(),
        type: 'teacher',
        data: {
            teachers: DB.get('teachers'),
            subjects: DB.get('subjects')
        }
    };
    
    downloadJSON(backup, `RHS_PRMS_Teacher_Backup_${new Date().toISOString().split('T')[0]}.json`);
    saveBackupHistory('teacher');
}

function createSettingsBackup() {
    const backup = {
        timestamp: new Date().toISOString(),
        type: 'settings',
        data: {
            schoolInfo: DB.getObj('schoolInfo'),
            academicYear: DB.getObj('academicYear'),
            terms: DB.get('terms'),
            periods: DB.get('periods'),
            holidays: DB.get('holidays'),
            workingDays: DB.get('workingDays'),
            systemSettings: DB.getObj('systemSettings')
        }
    };
    
    downloadJSON(backup, `RHS_PRMS_Settings_Backup_${new Date().toISOString().split('T')[0]}.json`);
    saveBackupHistory('settings');
}

function downloadJSON(data, filename) {
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    
    alert('âœ… Backup created and downloaded!');
}

function restoreFromBackup() {
    const fileInput = document.getElementById('backupFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a backup file!');
        return;
    }
    
    if (!confirm('âš ï¸ Restore from backup? This will replace current data!')) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            // Restore data based on backup type
            Object.keys(backup.data).forEach(key => {
                if (Array.isArray(backup.data[key])) {
                    DB.set(key, backup.data[key]);
                } else {
                    DB.setObj(key, backup.data[key]);
                }
            });
            
            alert('âœ… Data restored successfully! Reloading...');
            location.reload();
        } catch (error) {
            alert('âŒ Error restoring backup: ' + error.message);
        }
    };
    reader.readAsText(file);
}

function saveBackupHistory(type) {
    let history = DB.get('backupHistory');
    history.push({
        id: Date.now(),
        type,
        timestamp: new Date().toISOString()
    });
    DB.set('backupHistory', history);
    loadBackupHistory();
}

function loadBackupHistory() {
    const history = DB.get('backupHistory');
    const container = document.getElementById('backupHistory');
    
    if (history.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No backups created yet</p>';
        return;
    }
    
    let html = '<div style="display: grid; gap: 10px;">';
    history.slice(-10).reverse().forEach(backup => {
        html += `
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${backup.type.toUpperCase()} Backup</strong><br>
                    <small>${new Date(backup.timestamp).toLocaleString('en-IN')}</small>
                </div>
                <span class="status-badge" style="background: #d4edda; color: #155724;">Completed</span>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function toggleAutoBackup() {
    const enabled = document.getElementById('autoBackupEnabled').checked;
    document.getElementById('autoBackupSettings').style.display = enabled ? 'block' : 'none';
}

function saveAutoBackupSettings() {
    const settings = {
        enabled: document.getElementById('autoBackupEnabled').checked,
        frequency: document.getElementById('autoBackupFrequency').value
    };
    
    DB.setObj('autoBackupSettings', settings);
    alert('âœ… Auto backup settings saved!');
}


// ========== PRINT MODULE FUNCTIONS ==========

// Period Timings
const periodTimings = {
    '1': '10:30 AM - 11:15 AM',
    '2': '11:15 AM - 12:00 PM',
    '3': '12:00 PM - 12:45 PM',
    '4': '12:45 PM - 1:30 PM',
    '5': '2:00 PM - 2:45 PM',
    '6': '2:45 PM - 3:30 PM',
    '7': '3:30 PM - 4:15 PM'
};

// Days in order
const daysOrderPrint = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];

// Show Print Modal
function showPrintModal(type) {
    const modal = document.getElementById('printModal');
    const modalTitle = document.getElementById('printModalTitle');
    const modalBody = document.getElementById('printModalBody');

    modal.classList.add('active');

    switch(type) {
        case 'teacher':
            modalTitle.textContent = 'ðŸ‘¤ Print Teacher Routine Cards';
            modalBody.innerHTML = generateTeacherPrintOptions();
            break;
        case 'class':
            modalTitle.textContent = 'ðŸ“š Print Class Timetable';
            modalBody.innerHTML = generateClassPrintOptions();
            break;
        case 'master':
            modalTitle.textContent = 'ðŸ“Š Print Master Schedule';
            modalBody.innerHTML = generateMasterPrintOptions();
            break;
        case 'day':
            modalTitle.textContent = 'ðŸ“… Print Day-wise Schedule';
            modalBody.innerHTML = generateDayPrintOptions();
            break;
        case 'provisional':
            modalTitle.textContent = 'ðŸ”„ Print Provisional Routine';
            modalBody.innerHTML = generateProvisionalPrintOptions();
            break;
    }
}

// Close Print Modal
function closePrintModal() {
    document.getElementById('printModal').classList.remove('active');
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('printModal');
    if (event.target === modal) {
        closePrintModal();
    }
});

// Generate Teacher Print Options
function generateTeacherPrintOptions() {
    const teachers = DB.get('teachers');
    
    if (teachers.length === 0) {
        return '<p style="padding:20px; text-align:center; color:#999;">No teacher data available. Please add teachers first.</p>';
    }

    let html = '<div class="form-group">';
    html += '<label>Select Teacher:</label>';
    html += '<select id="selectedTeacher" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    html += '<option value="all">All Teachers</option>';
    teachers.forEach(teacher => {
        html += `<option value="${teacher.id}">${teacher.name}</option>`;
    });
    html += '</select></div>';
    html += '<button class="btn btn-primary" style="width:100%; margin-top:20px; padding:14px;" onclick="printTeacherCard()">ðŸ–¨ï¸ Print</button>';
    
    return html;
}

// Generate Class Print Options
function generateClassPrintOptions() {
    const classes = DB.get('classes');
    
    if (classes.length === 0) {
        return '<p style="padding:20px; text-align:center; color:#999;">No class data available. Please add classes first.</p>';
    }

    let html = '<div class="form-group">';
    html += '<label>Select Class:</label>';
    html += '<select id="selectedClass" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    classes.forEach(cls => {
        html += `<option value="${cls.id}">${cls.name}</option>`;
    });
    html += '</select></div>';
    html += '<button class="btn btn-primary" style="width:100%; margin-top:20px; padding:14px;" onclick="printClassTimetable()">ðŸ–¨ï¸ Print</button>';
    
    return html;
}

// Generate Master Print Options
function generateMasterPrintOptions() {
    let html = '<div style="padding:15px; background:#e3f2fd; border-radius:8px; margin-bottom:20px;">';
    html += '<strong>Master Schedule:</strong> This will print the complete period-wise schedule for all classes.';
    html += '</div>';
    html += '<button class="btn btn-primary" style="width:100%; padding:14px;" onclick="printMasterSchedule()">ðŸ–¨ï¸ Print Master Schedule</button>';
    
    return html;
}

// Generate Day Print Options
function generateDayPrintOptions() {
    let html = '<div class="form-group">';
    html += '<label>Select Day:</label>';
    html += '<select id="selectedDay" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    daysOrderPrint.forEach(day => {
        html += `<option value="${day}">${day.charAt(0) + day.slice(1).toLowerCase()}</option>`;
    });
    html += '</select></div>';
    html += '<button class="btn btn-primary" style="width:100%; margin-top:20px; padding:14px;" onclick="printDaySchedule()">ðŸ–¨ï¸ Print</button>';
    
    return html;
}

// Generate Provisional Print Options
function generateProvisionalPrintOptions() {
    const provisionalRoutines = DB.get('provisionalRoutines');
    
    if (provisionalRoutines.length === 0) {
        return '<p style="padding:20px; text-align:center; color:#999;">No provisional routines available. Please create provisional routines first.</p>';
    }

    // Get unique dates from provisional routines
    const dates = [...new Set(provisionalRoutines.map(r => r.date))].sort().reverse();
    
    let html = '<div class="form-group">';
    html += '<label>Select Date:</label>';
    html += '<select id="selectedProvisionalDate" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    dates.forEach(date => {
        const formattedDate = new Date(date).toLocaleDateString('en-IN', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        html += `<option value="${date}">${formattedDate}</option>`;
    });
    html += '</select></div>';
    
    html += '<div style="padding:15px; background:#fff3cd; border-radius:8px; margin-top:15px; border-left:4px solid #FF9800;">';
    html += '<strong>â„¹ï¸ Info:</strong> This will print the provisional routine showing absent teachers and their substitutes.';
    html += '</div>';
    
    html += '<button class="btn btn-primary" style="width:100%; margin-top:20px; padding:14px;" onclick="printProvisionalRoutine()">ðŸ–¨ï¸ Print</button>';
    
    return html;
}

// Print Teacher Card
function printTeacherCard() {
    const selectedTeacherId = document.getElementById('selectedTeacher').value;
    const teachers = DB.get('teachers');
    const routines = DB.get('routines');
    const classes = DB.get('classes');
    const periods = DB.get('periods');
    
    let printWindow = window.open('', '_blank');
    let html = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Teacher Routine Cards - RHS</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .teacher-print-card { 
                    page-break-after: always; 
                    border: 2px solid #333; 
                    padding: 20px; 
                    margin-bottom: 30px;
                }
                .teacher-print-card:last-child { page-break-after: auto; }
                .teacher-print-header { 
                    border-bottom: 2px solid #667eea; 
                    padding-bottom: 10px; 
                    margin-bottom: 15px; 
                }
                .teacher-print-header h2 { color: #667eea; margin: 0 0 5px 0; }
                .school-info { color: #666; font-size: 0.9em; }
                table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                th, td { border: 1px solid #333; padding: 10px; text-align: left; }
                th { background: #667eea; color: white; }
                tr:nth-child(even) { background: #f8f9fa; }
                .empty-slot { color: #999; font-style: italic; }
                @media print {
                    body { margin: 10mm; }
                    .teacher-print-card { page-break-after: always; }
                }
            </style>
        </head>
        <body>
    `;

    const teachersToProcess = selectedTeacherId === 'all' 
        ? teachers
        : teachers.filter(t => t.id == selectedTeacherId);

    teachersToProcess.forEach(teacher => {
        const teacherRoutines = routines.filter(r => r.teacherId == teacher.id);
        
        html += `
            <div class="teacher-print-card">
                <div class="teacher-print-header">
                    <h2>ðŸ‘¤ ${teacher.name}</h2>
                    <p class="school-info">Ramnagar High School, Durgapur<br>Academic Session 2024-25</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Period</th>
                            <th>Time</th>
                            <th>Class</th>
                            <th>Subject</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        // Organize by day and period
        daysOrderPrint.forEach(day => {
            const dayRoutines = teacherRoutines.filter(r => r.day === day);
            
            if (dayRoutines.length > 0) {
                dayRoutines.sort((a, b) => parseInt(a.periodNumber) - parseInt(b.periodNumber));
                
                dayRoutines.forEach((routine, index) => {
                    const period = periods.find(p => p.id == routine.periodId);
                    const cls = classes.find(c => c.id == routine.classId);
                    
                    html += `
                        <tr>
                            ${index === 0 ? `<td rowspan="${dayRoutines.length}">${day.charAt(0) + day.slice(1).toLowerCase()}</td>` : ''}
                            <td>Period ${routine.periodNumber}</td>
                            <td>${period ? period.time : '-'}</td>
                            <td>${cls ? cls.name : '-'}</td>
                            <td>${routine.subject || '-'}</td>
                        </tr>
                    `;
                });
            }
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;
    });

    html += '</body></html>';
    
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => printWindow.print(), 500);
    
    closePrintModal();
}

// Print Class Timetable
function printClassTimetable() {
    const selectedClassId = document.getElementById('selectedClass').value;
    const classes = DB.get('classes');
    const routines = DB.get('routines');
    const teachers = DB.get('teachers');
    const periods = DB.get('periods');
    
    const selectedClass = classes.find(c => c.id == selectedClassId);
    const classRoutines = routines.filter(r => r.classId == selectedClassId);

    let printWindow = window.open('', '_blank');
    let html = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>${selectedClass.name} Timetable - RHS</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 15px; }
                .header h1 { color: #667eea; margin: 0; }
                .header p { color: #666; margin: 5px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #333; padding: 12px; text-align: center; }
                th { background: #667eea; color: white; font-weight: 600; }
                .day-header { background: #f0f0f0; font-weight: 600; text-align: left; }
                .empty-slot { color: #999; font-style: italic; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ðŸ“š ${selectedClass.name} - Timetable</h1>
                <p>Ramnagar High School, Durgapur</p>
                <p>Academic Session 2024-25</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Day</th>
    `;

    // Add period headers
    periods.forEach(period => {
        html += `<th>Period ${period.number}<br><small>${period.time}</small></th>`;
    });

    html += `
                    </tr>
                </thead>
                <tbody>
    `;

    daysOrderPrint.forEach(day => {
        html += `<tr><td class="day-header">${day.charAt(0) + day.slice(1).toLowerCase()}</td>`;
        
        periods.forEach(period => {
            const routine = classRoutines.find(r => r.day === day && r.periodNumber == period.number);
            if (routine) {
                const teacher = teachers.find(t => t.id == routine.teacherId);
                html += `<td><strong>${routine.subject || '-'}</strong><br><small>${teacher ? teacher.name : '-'}</small></td>`;
            } else {
                html += '<td class="empty-slot">-</td>';
            }
        });
        
        html += '</tr>';
    });

    html += `
                </tbody>
            </table>
        </body>
        </html>
    `;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => printWindow.print(), 500);
    
    closePrintModal();
}

// Print Master Schedule
function printMasterSchedule() {
    const classes = DB.get('classes');
    const routines = DB.get('routines');
    const teachers = DB.get('teachers');
    const periods = DB.get('periods');

    let printWindow = window.open('', '_blank');
    let html = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Master Schedule - RHS</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 15px; }
                .header h1 { color: #667eea; margin: 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85em; }
                th, td { border: 1px solid #333; padding: 8px; text-align: center; }
                th { background: #667eea; color: white; }
                .period-header { background: #f0f0f0; font-weight: 600; }
                h3 { color: #1e3c72; margin-top: 25px; }
                @media print {
                    body { font-size: 10pt; }
                    table { page-break-inside: auto; }
                    tr { page-break-inside: avoid; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ðŸ“Š Master Schedule - All Classes</h1>
                <p>Ramnagar High School, Durgapur | Academic Session 2024-25</p>
            </div>
    `;

    // Create separate table for each day
    daysOrderPrint.forEach(day => {
        html += `
            <h3>${day.charAt(0) + day.slice(1).toLowerCase()}</h3>
            <table>
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>Time</th>
        `;
        
        classes.forEach(cls => {
            html += `<th>${cls.name}</th>`;
        });
        
        html += `
                    </tr>
                </thead>
                <tbody>
        `;

        periods.forEach(period => {
            html += `
                <tr>
                    <td class="period-header">P${period.number}</td>
                    <td>${period.time}</td>
            `;
            
            classes.forEach(cls => {
                const routine = routines.find(r => 
                    r.day === day && r.periodNumber == period.number && r.classId == cls.id
                );
                
                if (routine) {
                    const teacher = teachers.find(t => t.id == routine.teacherId);
                    html += `<td><strong>${routine.subject || '-'}</strong><br><small>${teacher ? teacher.name : '-'}</small></td>`;
                } else {
                    html += '<td style="color: #999;">-</td>';
                }
            });
            
            html += '</tr>';
        });

        html += `
                </tbody>
            </table>
            <br>
        `;
    });

    html += '</body></html>';

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => printWindow.print(), 500);
    
    closePrintModal();
}

// Print Day Schedule
function printDaySchedule() {
    const selectedDay = document.getElementById('selectedDay').value;
    const classes = DB.get('classes');
    const routines = DB.get('routines');
    const teachers = DB.get('teachers');
    const periods = DB.get('periods');
    
    const dayRoutines = routines.filter(r => r.day === selectedDay);

    let printWindow = window.open('', '_blank');
    let html = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>${selectedDay.charAt(0) + selectedDay.slice(1).toLowerCase()} Schedule - RHS</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 15px; }
                .header h1 { color: #667eea; margin: 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #333; padding: 10px; text-align: center; }
                th { background: #667eea; color: white; }
                .period-header { background: #f0f0f0; font-weight: 600; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ðŸ“… ${selectedDay.charAt(0) + selectedDay.slice(1).toLowerCase()} - Complete Schedule</h1>
                <p>Ramnagar High School, Durgapur</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>Time</th>
    `;

    classes.forEach(cls => {
        html += `<th>${cls.name}</th>`;
    });

    html += `
                    </tr>
                </thead>
                <tbody>
    `;

    periods.forEach(period => {
        html += `
            <tr>
                <td class="period-header">Period ${period.number}</td>
                <td>${period.time}</td>
        `;

        classes.forEach(cls => {
            const routine = dayRoutines.find(r => r.periodNumber == period.number && r.classId == cls.id);
            if (routine) {
                const teacher = teachers.find(t => t.id == routine.teacherId);
                html += `<td><strong>${routine.subject || '-'}</strong><br><small>${teacher ? teacher.name : '-'}</small></td>`;
            } else {
                html += '<td style="color: #999;">-</td>';
            }
        });

        html += '</tr>';
    });

    html += `
                </tbody>
            </table>
        </body>
        </html>
    `;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => printWindow.print(), 500);
    
    closePrintModal();
}


// Print Provisional Routine
function printProvisionalRoutine() {
    const selectedDate = document.getElementById('selectedProvisionalDate').value;
    
    const provisionalRoutines = DB.get('provisionalRoutines');
    const teachers = DB.get('teachers');
    const classes = DB.get('classes');
    const periods = DB.get('periods');
    
    const dateRoutines = provisionalRoutines.filter(r => r.date === selectedDate);
    
    if (dateRoutines.length === 0) {
        alert('No provisional routines found for this date!');
        return;
    }

    let printWindow = window.open('', '_blank');
    let html = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Provisional Routine - ${new Date(selectedDate).toLocaleDateString('en-IN')}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { 
                    text-align: center; 
                    margin-bottom: 20px; 
                    border-bottom: 3px solid #FF9800; 
                    padding-bottom: 15px; 
                }
                .header h1 { color: #FF9800; margin: 0; }
                .header p { color: #666; margin: 5px 0; }
                .notice-box {
                    background: #fff3cd;
                    border: 2px solid #FF9800;
                    border-radius: 8px;
                    padding: 15px;
                    margin: 20px 0;
                    text-align: center;
                    font-weight: 600;
                    color: #856404;
                }
                .absent-section {
                    margin: 30px 0;
                    page-break-inside: avoid;
                }
                .absent-teacher {
                    background: #ffe0e0;
                    border-left: 5px solid #dc3545;
                    padding: 10px 15px;
                    margin-bottom: 15px;
                    font-weight: 700;
                    font-size: 1.1em;
                    color: #721c24;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 15px;
                    margin-bottom: 30px;
                }
                th, td { border: 1px solid #333; padding: 12px; text-align: left; }
                th { background: #FF9800; color: white; font-weight: 600; }
                tr:nth-child(even) { background: #fff8e1; }
                .substitute-name { 
                    font-weight: 600; 
                    color: #0d47a1; 
                }
                .reason-cell {
                    font-style: italic;
                    color: #666;
                    font-size: 0.95em;
                }
                .footer {
                    margin-top: 40px;
                    padding-top: 15px;
                    border-top: 2px solid #e0e0e0;
                    text-align: center;
                    color: #999;
                    font-size: 0.9em;
                }
                @media print {
                    body { margin: 10mm; }
                    .absent-section { page-break-inside: avoid; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ðŸ”„ PROVISIONAL ROUTINE</h1>
                <p><strong>Date:</strong> ${new Date(selectedDate).toLocaleDateString('en-IN', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}</p>
                <p>Ramnagar High School, Durgapur</p>
                <p>Academic Session 2024-25</p>
            </div>
            
            <div class="notice-box">
                âš ï¸ TEMPORARY SCHEDULE - Please note the following substitute arrangements
            </div>
    `;

    // Group by absent teacher
    const absentTeachers = [...new Set(dateRoutines.map(r => r.absentTeacherId))];
    
    absentTeachers.forEach(absentId => {
        const absentTeacher = teachers.find(t => t.id == absentId);
        const substitutions = dateRoutines.filter(r => r.absentTeacherId == absentId);
        
        html += `
            <div class="absent-section">
                <div class="absent-teacher">
                    âŒ Absent Teacher: ${absentTeacher ? absentTeacher.name : 'Unknown'}
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Period</th>
                            <th>Time</th>
                            <th>Class</th>
                            <th>Subject</th>
                            <th>Substitute Teacher</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        substitutions.sort((a, b) => parseInt(a.periodNumber) - parseInt(b.periodNumber));
        
        substitutions.forEach(sub => {
            const substituteTeacher = teachers.find(t => t.id == sub.substituteTeacherId);
            const cls = classes.find(c => c.id == sub.classId);
            const period = periods.find(p => p.id == sub.periodId);
            
            html += `
                <tr>
                    <td><strong>Period ${sub.periodNumber}</strong></td>
                    <td>${period ? period.time : '-'}</td>
                    <td>${cls ? cls.name : '-'}</td>
                    <td>${sub.subject || '-'}</td>
                    <td class="substitute-name">ðŸ‘¨â€ðŸ« ${substituteTeacher ? substituteTeacher.name : '-'}</td>
                    <td class="reason-cell">${sub.reason || 'Not specified'}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    });

    html += `
            <div class="footer">
                <p>Generated by RHS PRMS v4.6 - Provisional Routine Management</p>
                <p>Printed on: ${new Date().toLocaleString('en-IN')}</p>
            </div>
        </body>
        </html>
    `;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => printWindow.print(), 500);
    
    closePrintModal();
}


// ========== EXAM MANAGEMENT FUNCTIONS ==========

// Initialize exam management
function initializeExamManagement() {
    loadExamList();
    loadExamHalls();
    loadExamClasses();
    loadStudentClasses();
    loadAdmitCardExams();
    updateExamStats();
    loadStudents();
}

// Load classes for student dropdown
function loadStudentClasses() {
    const classes = DB.get('classes');
    const select1 = document.getElementById('studentClass');
    const select2 = document.getElementById('admitCardClass');
    
    if (select1) {
        select1.innerHTML = '<option value="">-- Select Class --</option>';
        classes.forEach(cls => {
            select1.innerHTML += `<option value="${cls.id}">${cls.name}</option>`;
        });
    }
    
    if (select2) {
        select2.innerHTML = '<option value="">-- All Classes --</option>';
        classes.forEach(cls => {
            select2.innerHTML += `<option value="${cls.id}">${cls.name}</option>`;
        });
    }
}

// Load exams for admit card dropdown
function loadAdmitCardExams() {
    const exams = DB.get('exams');
    const select = document.getElementById('admitCardExam');
    
    if (select) {
        select.innerHTML = '<option value="">-- Select Exam --</option>';
        exams.forEach(exam => {
            select.innerHTML += `<option value="${exam.id}">${exam.name} (${exam.type})</option>`;
        });
    }
}

// Add student
function addStudent() {
    const name = document.getElementById('studentName').value.trim();
    const roll = document.getElementById('studentRoll').value.trim();
    const classId = document.getElementById('studentClass').value;
    const section = document.getElementById('studentSection').value.trim().toUpperCase();
    const father = document.getElementById('studentFather').value.trim();
    const mother = document.getElementById('studentMother').value.trim();
    const dob = document.getElementById('studentDOB').value;
    
    if (!name || !roll || !classId) {
        alert('Please fill student name, roll number, and class!');
        return;
    }
    
    // Check for duplicate roll number
    const students = DB.get('students');
    const duplicate = students.find(s => s.roll === roll && s.classId == classId);
    if (duplicate) {
        alert('A student with this roll number already exists in this class!');
        return;
    }
    
    const student = {
        id: Date.now(),
        name: name,
        roll: roll,
        classId: classId,
        section: section,
        fatherName: father,
        motherName: mother,
        dob: dob,
        createdAt: new Date().toISOString()
    };
    
    students.push(student);
    DB.set('students', students);
    
    alert('âœ… Student added successfully!');
    
    // Clear form
    document.getElementById('studentName').value = '';
    document.getElementById('studentRoll').value = '';
    document.getElementById('studentSection').value = '';
    document.getElementById('studentFather').value = '';
    document.getElementById('studentMother').value = '';
    document.getElementById('studentDOB').value = '';
    
    loadStudents();
}

// Load students
function loadStudents() {
    const students = DB.get('students');
    const classes = DB.get('classes');
    const tbody = document.getElementById('studentsTable');
    
    if (!tbody) return;
    
    if (students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No students added yet</td></tr>';
        return;
    }
    
    let html = '';
    students.sort((a, b) => {
        if (a.classId === b.classId) {
            return a.roll.localeCompare(b.roll);
        }
        return a.classId - b.classId;
    });
    
    students.forEach(student => {
        const cls = classes.find(c => c.id == student.classId);
        
        html += `<tr>
            <td><strong>${student.roll}</strong></td>
            <td>${student.name}</td>
            <td>${cls ? cls.name : '-'}${student.section ? ' - ' + student.section : ''}</td>
            <td>${student.fatherName || '-'}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteStudent(${student.id})">ðŸ—‘ï¸</button>
            </td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
}

// Delete student
function deleteStudent(studentId) {
    if (!confirm('Delete this student?')) return;
    
    let students = DB.get('students');
    students = students.filter(s => s.id !== studentId);
    DB.set('students', students);
    
    loadStudents();
}

// Bulk import students
function bulkImportStudents() {
    alert('ðŸ“Š Bulk Import Feature:\n\nYou can import students from Excel/CSV file.\n\nRequired columns:\n- Roll Number\n- Name\n- Class\n- Section (optional)\n- Father Name (optional)\n- Mother Name (optional)\n- DOB (optional)\n\nThis feature will be fully implemented in the next version!');
}

// Filter students by class
function filterStudentsByClass() {
    // This is called when class dropdown changes in admit card section
    // The actual filtering happens in generateAdmitCards function
}

// Generate admit cards
function generateAdmitCards() {
    const examId = document.getElementById('admitCardExam').value;
    const classFilter = document.getElementById('admitCardClass').value;
    
    if (!examId) {
        alert('Please select an exam!');
        return;
    }
    
    const exams = DB.get('exams');
    const exam = exams.find(e => e.id == examId);
    const timetable = DB.get('examTimetable');
    const students = DB.get('students');
    const classes = DB.get('classes');
    const halls = DB.get('examHalls');
    const hallAssignments = DB.get('hallAssignments');
    
    let examStudents = students;
    if (classFilter) {
        examStudents = students.filter(s => s.classId == classFilter);
    }
    
    if (examStudents.length === 0) {
        alert('No students found for selected criteria!');
        return;
    }
    
    const examEntries = timetable.filter(t => t.examId == examId);
    
    if (examEntries.length === 0) {
        alert('No timetable entries found for this exam!');
        return;
    }
    
    // Get options
    const includePhoto = document.getElementById('includePhoto').checked;
    const includeParents = document.getElementById('includeParents').checked;
    const includeInstructions = document.getElementById('includeInstructions').checked;
    
    // Generate admit cards
    let printWindow = window.open('', '_blank');
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Admit Cards - ${exam.name}</title>
            <style>
                @page { size: A4; margin: 10mm; }
                body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
                .admit-card { 
                    width: 190mm; 
                    height: 135mm;
                    border: 3px solid #1e3c72; 
                    padding: 15mm;
                    margin: 0 auto 15mm;
                    page-break-after: always;
                    position: relative;
                    background: white;
                }
                .admit-card:last-child { page-break-after: auto; }
                .card-header {
                    text-align: center;
                    border-bottom: 2px solid #1e3c72;
                    padding-bottom: 10px;
                    margin-bottom: 15px;
                }
                .card-header h1 { color: #1e3c72; margin: 0 0 5px 0; font-size: 24px; }
                .card-header h2 { color: #666; margin: 0; font-size: 18px; font-weight: normal; }
                .card-body { display: flex; gap: 15px; }
                .photo-section { 
                    width: 100px; 
                    min-height: 120px;
                    border: 2px dashed #999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #999;
                    font-size: 12px;
                }
                .info-section { flex: 1; }
                .info-row { 
                    display: grid; 
                    grid-template-columns: 120px 1fr;
                    margin-bottom: 8px;
                    font-size: 14px;
                }
                .info-label { font-weight: 600; color: #333; }
                .info-value { color: #666; border-bottom: 1px dotted #ccc; }
                .timetable-section { margin-top: 15px; }
                .timetable-section h3 { 
                    color: #1e3c72; 
                    font-size: 16px; 
                    margin-bottom: 10px;
                    border-bottom: 1px solid #1e3c72;
                    padding-bottom: 5px;
                }
                .timetable-table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    font-size: 12px;
                }
                .timetable-table th, .timetable-table td { 
                    border: 1px solid #999; 
                    padding: 6px; 
                    text-align: left;
                }
                .timetable-table th { background: #f0f0f0; font-weight: 600; }
                .instructions {
                    margin-top: 15px;
                    padding: 10px;
                    background: #fff3cd;
                    border-left: 4px solid #ff9800;
                    font-size: 11px;
                }
                .instructions h4 { margin: 0 0 5px 0; color: #856404; }
                .instructions ul { margin: 5px 0 0 20px; padding: 0; }
                .instructions li { margin-bottom: 3px; }
                .signature-section {
                    position: absolute;
                    bottom: 15mm;
                    right: 15mm;
                    text-align: center;
                    font-size: 12px;
                }
                .signature-line {
                    border-top: 1px solid #333;
                    width: 120px;
                    margin-top: 30px;
                    padding-top: 5px;
                }
                @media print {
                    body { margin: 0; }
                    .admit-card { page-break-after: always; }
                }
            </style>
        </head>
        <body>
    `;
    
    examStudents.forEach(student => {
        const cls = classes.find(c => c.id == student.classId);
        const studentExamEntries = examEntries.filter(e => e.classId == student.classId);
        
        html += `
            <div class="admit-card">
                <div class="card-header">
                    <h1>ðŸ« RAMNAGAR HIGH SCHOOL</h1>
                    <h2>${exam.name} - Admit Card</h2>
                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">Durgapur, West Bengal</p>
                </div>
                
                <div class="card-body">
                    ${includePhoto ? '<div class="photo-section">AFFIX<br>PHOTO<br>HERE</div>' : ''}
                    
                    <div class="info-section">
                        <div class="info-row">
                            <div class="info-label">Roll Number:</div>
                            <div class="info-value"><strong>${student.roll}</strong></div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Student Name:</div>
                            <div class="info-value"><strong>${student.name}</strong></div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Class:</div>
                            <div class="info-value">${cls ? cls.name : '-'}${student.section ? ' - Section ' + student.section : ''}</div>
                        </div>
                        ${includeParents && student.fatherName ? `
                        <div class="info-row">
                            <div class="info-label">Father's Name:</div>
                            <div class="info-value">${student.fatherName}</div>
                        </div>` : ''}
                        ${includeParents && student.motherName ? `
                        <div class="info-row">
                            <div class="info-label">Mother's Name:</div>
                            <div class="info-value">${student.motherName}</div>
                        </div>` : ''}
                        ${student.dob ? `
                        <div class="info-row">
                            <div class="info-label">Date of Birth:</div>
                            <div class="info-value">${new Date(student.dob).toLocaleDateString('en-IN')}</div>
                        </div>` : ''}
                    </div>
                </div>
                
                <div class="timetable-section">
                    <h3>ðŸ“… Examination Schedule</h3>
                    <table class="timetable-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Time</th>
                                <th>Subject</th>
                                <th>Hall</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        studentExamEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        studentExamEntries.forEach(entry => {
            const entryDate = new Date(entry.date);
            const hallAssignment = hallAssignments.find(h => h.timetableEntryId === entry.id);
            let hallInfo = 'TBA';
            
            if (hallAssignment) {
                const hall = halls.find(h => h.id == hallAssignment.hallId);
                if (hall) {
                    hallInfo = hall.name;
                }
            }
            
            html += `
                <tr>
                    <td>${entryDate.toLocaleDateString('en-IN')}</td>
                    <td>${entryDate.toLocaleDateString('en-US', { weekday: 'short' })}</td>
                    <td>${entry.startTime}</td>
                    <td><strong>${entry.subject}</strong></td>
                    <td>${hallInfo}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
        `;
        
        if (includeInstructions) {
            html += `
                <div class="instructions">
                    <h4>âš ï¸ Important Instructions:</h4>
                    <ul>
                        <li>Bring this admit card to the examination hall</li>
                        <li>Report 15 minutes before exam time</li>
                        <li>Carry student ID card and stationery</li>
                        <li>Mobile phones are strictly prohibited</li>
                    </ul>
                </div>
            `;
        }
        
        html += `
                <div class="signature-section">
                    <div class="signature-line">Principal's Signature</div>
                </div>
            </div>
        `;
    });
    
    html += `
        </body>
        </html>
    `;
    
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => printWindow.print(), 500);
}

// Download admit cards as ZIP
function downloadAdmitCardsZip() {
    alert('ðŸ“¦ Download as ZIP:\n\nThis feature will generate all admit cards as individual PDF files and package them in a ZIP archive.\n\nFeature coming in next update!');
}

// Show exam report modal
function showExamReportModal(reportType) {
    const modal = document.getElementById('printModal');
    const modalTitle = document.getElementById('printModalTitle');
    const modalBody = document.getElementById('printModalBody');

    modal.classList.add('active');
    
    switch(reportType) {
        case 'timetable':
            modalTitle.textContent = 'ðŸ“… Print Exam Timetable';
            modalBody.innerHTML = generateExamTimetableReportOptions();
            break;
        case 'invigilator':
            modalTitle.textContent = 'ðŸ‘¨â€ðŸ« Print Invigilator Duty List';
            modalBody.innerHTML = generateInvigilatorReportOptions();
            break;
        case 'hall':
            modalTitle.textContent = 'ðŸ›ï¸ Print Hall Arrangement';
            modalBody.innerHTML = generateHallReportOptions();
            break;
        case 'attendance':
            modalTitle.textContent = 'ðŸ“‹ Print Attendance Sheet';
            modalBody.innerHTML = generateAttendanceSheetOptions();
            break;
    }
}

// Generate attendance sheet options
function generateAttendanceSheetOptions() {
    const exams = DB.get('exams');
    
    if (exams.length === 0) {
        return '<p style="padding:20px; text-align:center; color:#999;">No exams available.</p>';
    }
    
    let html = '<div class="form-group">';
    html += '<label>Select Exam:</label>';
    html += '<select id="reportExamId" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    exams.forEach(exam => {
        html += `<option value="${exam.id}">${exam.name} (${exam.type})</option>`;
    });
    html += '</select></div>';
    html += '<button class="btn btn-primary" style="width:100%; margin-top:20px; padding:14px;" onclick="printAttendanceSheet()">ðŸ–¨ï¸ Print</button>';
    
    return html;
}

// Print attendance sheet
function printAttendanceSheet() {
    const examId = parseInt(document.getElementById('reportExamId').value);
    const exams = DB.get('exams');
    const timetable = DB.get('examTimetable');
    const students = DB.get('students');
    const classes = DB.get('classes');
    
    const exam = exams.find(e => e.id === examId);
    const examEntries = timetable.filter(t => t.examId === examId).sort((a, b) => new Date(a.date) - new Date(b.date));
    
    let printWindow = window.open('', '_blank');
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Attendance Sheet - ${exam.name}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid #1e3c72; padding-bottom: 15px; }
                .header h1 { color: #1e3c72; margin: 0; }
                .session-header {
                    background: #f0f0f0;
                    padding: 10px;
                    margin: 20px 0 10px 0;
                    border-left: 4px solid #1e3c72;
                }
                table { width: 100%; border-collapse: collapse; margin-bottom: 30px; page-break-inside: avoid; }
                th, td { border: 1px solid #333; padding: 10px; text-align: left; }
                th { background: #1e3c72; color: white; }
                .signature-cell { min-width: 100px; }
                @media print {
                    .session-header { page-break-before: always; }
                    .session-header:first-of-type { page-break-before: avoid; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ðŸ“‹ Examination Attendance Sheet</h1>
                <p>${exam.name} | ${exam.type}</p>
                <p>Ramnagar High School, Durgapur</p>
            </div>
    `;
    
    examEntries.forEach(entry => {
        const cls = classes.find(c => c.id == entry.classId);
        const classStudents = students.filter(s => s.classId == entry.classId).sort((a, b) => a.roll.localeCompare(b.roll));
        
        html += `
            <div class="session-header">
                <strong>Date:</strong> ${new Date(entry.date).toLocaleDateString('en-IN')} |
                <strong>Time:</strong> ${entry.startTime} |
                <strong>Class:</strong> ${cls ? cls.name : '-'} |
                <strong>Subject:</strong> ${entry.subject}
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">Sr.</th>
                        <th style="width: 100px;">Roll No.</th>
                        <th>Student Name</th>
                        <th class="signature-cell">Signature</th>
                        <th style="width: 80px;">Present</th>
                        <th style="width: 80px;">Absent</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        classStudents.forEach((student, index) => {
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${student.roll}</strong></td>
                    <td>${student.name}</td>
                    <td></td>
                    <td style="text-align: center;">â˜</td>
                    <td style="text-align: center;">â˜</td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
            <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <p><strong>Total Students:</strong> ${classStudents.length}</p>
                    <p><strong>Present:</strong> _______</p>
                    <p><strong>Absent:</strong> _______</p>
                </div>
                <div style="text-align: right;">
                    <p style="margin-top: 50px; border-top: 1px solid #333; display: inline-block; padding-top: 5px; width: 200px;">Invigilator Signature</p>
                </div>
            </div>
        `;
    });
    
    html += `
        </body>
        </html>
    `;
    
    printWindow.document.write(html);
    printWindow.document.close();
    setTimeout(() => printWindow.print(), 500);
    
    closePrintModal();
}

// Load classes into exam dropdown
function loadExamClasses() {
    const classes = DB.get('classes');
    const select = document.getElementById('examClass');
    
    select.innerHTML = '<option value="">-- Select Class --</option>';
    classes.forEach(cls => {
        select.innerHTML += `<option value="${cls.id}">${cls.name}</option>`;
    });
}

// Create exam schedule
function createExamSchedule() {
    const name = document.getElementById('examName').value.trim();
    const type = document.getElementById('examType').value;
    const year = document.getElementById('examYear').value.trim();
    const startDate = document.getElementById('examStartDate').value;
    const endDate = document.getElementById('examEndDate').value;
    
    if (!name || !startDate || !endDate) {
        alert('Please fill all required fields!');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert('End date must be after start date!');
        return;
    }
    
    const exam = {
        id: Date.now(),
        name: name,
        type: type,
        year: year,
        startDate: startDate,
        endDate: endDate,
        status: 'upcoming',
        createdAt: new Date().toISOString()
    };
    
    let exams = DB.get('exams');
    exams.push(exam);
    DB.set('exams', exams);
    
    alert('âœ… Exam schedule created successfully!');
    
    // Clear form
    document.getElementById('examName').value = '';
    document.getElementById('examYear').value = '2024-25';
    document.getElementById('examStartDate').value = '';
    document.getElementById('examEndDate').value = '';
    
    loadExamList();
    updateExamStats();
}

// Load exam list
function loadExamList() {
    const exams = DB.get('exams');
    const tbody = document.getElementById('examListTable');
    
    if (exams.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No exams created yet</td></tr>';
        return;
    }
    
    let html = '';
    exams.forEach(exam => {
        const start = new Date(exam.startDate).toLocaleDateString('en-IN');
        const end = new Date(exam.endDate).toLocaleDateString('en-IN');
        
        let statusBadge = '';
        if (exam.status === 'upcoming') {
            statusBadge = '<span class="status-badge" style="background: #d1ecf1; color: #0c5460;">Upcoming</span>';
        } else if (exam.status === 'ongoing') {
            statusBadge = '<span class="status-badge" style="background: #fff3cd; color: #856404;">Ongoing</span>';
        } else {
            statusBadge = '<span class="status-badge" style="background: #d4edda; color: #155724;">Completed</span>';
        }
        
        html += `<tr>
            <td><strong>${exam.name}</strong><br><small>${exam.year}</small></td>
            <td>${exam.type}</td>
            <td>${start} - ${end}</td>
            <td>${statusBadge}</td>
            <td class="action-buttons">
                <button class="btn btn-sm btn-primary" onclick="openExamTimetable(${exam.id})">ðŸ“ Timetable</button>
                <button class="btn btn-sm btn-info" onclick="openInvigilatorAssignment(${exam.id})">ðŸ‘¨â€ðŸ« Invigilators</button>
                <button class="btn btn-sm btn-success" onclick="openHallAssignment(${exam.id})">ðŸ›ï¸ Halls</button>
                <button class="btn btn-sm btn-danger" onclick="deleteExam(${exam.id})">ðŸ—‘ï¸</button>
            </td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
}

// Open exam timetable creation
function openExamTimetable(examId) {
    const exams = DB.get('exams');
    const exam = exams.find(e => e.id === examId);
    
    if (!exam) return;
    
    document.getElementById('selectedExamInfo').innerHTML = `
        <strong>ðŸ“š ${exam.name}</strong> (${exam.type})<br>
        <small>Duration: ${new Date(exam.startDate).toLocaleDateString('en-IN')} - ${new Date(exam.endDate).toLocaleDateString('en-IN')}</small>
    `;
    
    document.getElementById('examTimetableCard').style.display = 'block';
    window.currentExamId = examId;
    
    loadExamTimetableEntries(examId);
    
    // Scroll to card
    document.getElementById('examTimetableCard').scrollIntoView({ behavior: 'smooth' });
}

// Add exam timetable entry
function addExamTimetableEntry() {
    const examId = window.currentExamId;
    const date = document.getElementById('timetableDate').value;
    const session = document.getElementById('examSession').value;
    const startTime = document.getElementById('examStartTime').value;
    const duration = document.getElementById('examDuration').value;
    const classId = document.getElementById('examClass').value;
    const subject = document.getElementById('examSubject').value.trim();
    const marks = document.getElementById('examMarks').value;
    
    if (!date || !classId || !subject) {
        alert('Please fill all required fields!');
        return;
    }
    
    const entry = {
        id: Date.now(),
        examId: examId,
        date: date,
        session: session,
        startTime: startTime,
        duration: parseInt(duration),
        classId: classId,
        subject: subject,
        marks: parseInt(marks),
        createdAt: new Date().toISOString()
    };
    
    let timetable = DB.get('examTimetable');
    timetable.push(entry);
    DB.set('examTimetable', timetable);
    
    alert('âœ… Timetable entry added!');
    
    // Clear form
    document.getElementById('examSubject').value = '';
    
    loadExamTimetableEntries(examId);
}

// Load exam timetable entries
function loadExamTimetableEntries(examId) {
    const timetable = DB.get('examTimetable');
    const classes = DB.get('classes');
    
    const entries = timetable.filter(t => t.examId === examId);
    
    if (entries.length === 0) {
        document.getElementById('timetableEntriesSection').style.display = 'none';
        return;
    }
    
    document.getElementById('timetableEntriesSection').style.display = 'block';
    
    let html = '';
    entries.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    entries.forEach(entry => {
        const cls = classes.find(c => c.id == entry.classId);
        
        html += `<tr>
            <td>${new Date(entry.date).toLocaleDateString('en-IN')}</td>
            <td>${entry.startTime} (${entry.duration} min)</td>
            <td>${cls ? cls.name : '-'}</td>
            <td>${entry.subject}</td>
            <td>${entry.marks}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteExamTimetableEntry(${entry.id})">ðŸ—‘ï¸</button>
            </td>
        </tr>`;
    });
    
    document.getElementById('timetableEntriesTable').innerHTML = html;
}

// Delete exam timetable entry
function deleteExamTimetableEntry(entryId) {
    if (!confirm('Delete this timetable entry?')) return;
    
    let timetable = DB.get('examTimetable');
    timetable = timetable.filter(t => t.id !== entryId);
    DB.set('examTimetable', timetable);
    
    loadExamTimetableEntries(window.currentExamId);
}

// Close exam timetable
function closeExamTimetable() {
    document.getElementById('examTimetableCard').style.display = 'none';
    window.currentExamId = null;
}

// Open invigilator assignment
function openInvigilatorAssignment(examId) {
    const exams = DB.get('exams');
    const exam = exams.find(e => e.id === examId);
    const timetable = DB.get('examTimetable');
    const teachers = DB.get('teachers');
    const classes = DB.get('classes');
    
    if (!exam) return;
    
    const examEntries = timetable.filter(t => t.examId === examId);
    
    if (examEntries.length === 0) {
        alert('Please create exam timetable first!');
        return;
    }
    
    document.getElementById('selectedExamInfoInvig').innerHTML = `
        <strong>ðŸ“š ${exam.name}</strong> - Assign Invigilators<br>
        <small>Select 2-3 teachers for each exam session</small>
    `;
    
    let html = '';
    examEntries.forEach((entry, index) => {
        const cls = classes.find(c => c.id == entry.classId);
        
        html += `<div class="card" style="margin-bottom: 15px; background: #f8f9fa;">
            <div style="margin-bottom: 10px;">
                <strong>${new Date(entry.date).toLocaleDateString('en-IN')} - ${entry.startTime}</strong><br>
                <small>${cls ? cls.name : '-'} | ${entry.subject} (${entry.duration} min)</small>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <select id="invig1_${index}" data-entry-id="${entry.id}" style="padding: 10px;">
                    <option value="">-- Invigilator 1 --</option>
                    ${teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                </select>
                <select id="invig2_${index}" data-entry-id="${entry.id}" style="padding: 10px;">
                    <option value="">-- Invigilator 2 --</option>
                    ${teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                </select>
                <select id="invig3_${index}" data-entry-id="${entry.id}" style="padding: 10px;">
                    <option value="">-- Invigilator 3 (Optional) --</option>
                    ${teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                </select>
            </div>
        </div>`;
    });
    
    document.getElementById('invigilatorAssignmentContent').innerHTML = html;
    document.getElementById('invigilatorCard').style.display = 'block';
    window.currentExamId = examId;
    
    // Load existing assignments
    loadExistingInvigilators(examId);
    
    document.getElementById('invigilatorCard').scrollIntoView({ behavior: 'smooth' });
}

// Load existing invigilators
function loadExistingInvigilators(examId) {
    const assignments = DB.get('invigilatorAssignments');
    const examAssignments = assignments.filter(a => a.examId === examId);
    
    examAssignments.forEach(assignment => {
        const index = document.querySelector(`[data-entry-id="${assignment.timetableEntryId}"]`)?.id.split('_')[1];
        if (index) {
            assignment.invigilators.forEach((invigId, i) => {
                const select = document.getElementById(`invig${i+1}_${index}`);
                if (select) select.value = invigId;
            });
        }
    });
}

// Save invigilator assignments
function saveInvigilatorAssignments() {
    const examId = window.currentExamId;
    const timetable = DB.get('examTimetable');
    const examEntries = timetable.filter(t => t.examId === examId);
    
    let assignments = [];
    
    examEntries.forEach((entry, index) => {
        const invig1 = document.getElementById(`invig1_${index}`).value;
        const invig2 = document.getElementById(`invig2_${index}`).value;
        const invig3 = document.getElementById(`invig3_${index}`).value;
        
        const invigilators = [invig1, invig2, invig3].filter(id => id);
        
        if (invigilators.length > 0) {
            assignments.push({
                id: Date.now() + index,
                examId: examId,
                timetableEntryId: entry.id,
                invigilators: invigilators,
                createdAt: new Date().toISOString()
            });
        }
    });
    
    // Remove old assignments for this exam
    let allAssignments = DB.get('invigilatorAssignments');
    allAssignments = allAssignments.filter(a => a.examId !== examId);
    allAssignments = allAssignments.concat(assignments);
    DB.set('invigilatorAssignments', allAssignments);
    
    alert('âœ… Invigilator assignments saved!');
    closeInvigilatorAssignment();
    updateExamStats();
}

// Close invigilator assignment
function closeInvigilatorAssignment() {
    document.getElementById('invigilatorCard').style.display = 'none';
    window.currentExamId = null;
}

// Add exam hall
function addExamHall() {
    const name = document.getElementById('hallName').value.trim();
    const capacity = document.getElementById('hallCapacity').value;
    const location = document.getElementById('hallLocation').value.trim();
    
    if (!name || !capacity) {
        alert('Please fill hall name and capacity!');
        return;
    }
    
    const hall = {
        id: Date.now(),
        name: name,
        capacity: parseInt(capacity),
        location: location,
        status: 'available',
        createdAt: new Date().toISOString()
    };
    
    let halls = DB.get('examHalls');
    halls.push(hall);
    DB.set('examHalls', halls);
    
    alert('âœ… Hall added successfully!');
    
    document.getElementById('hallName').value = '';
    document.getElementById('hallCapacity').value = '';
    document.getElementById('hallLocation').value = '';
    
    loadExamHalls();
}

// Load exam halls
function loadExamHalls() {
    const halls = DB.get('examHalls');
    const tbody = document.getElementById('hallsTable');
    
    if (halls.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No halls added yet</td></tr>';
        return;
    }
    
    let html = '';
    halls.forEach(hall => {
        html += `<tr>
            <td><strong>${hall.name}</strong></td>
            <td>${hall.capacity} students</td>
            <td>${hall.location || '-'}</td>
            <td><span class="status-badge status-present">${hall.status}</span></td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteHall(${hall.id})">ðŸ—‘ï¸</button>
            </td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
}

// Delete hall
function deleteHall(hallId) {
    if (!confirm('Delete this hall?')) return;
    
    let halls = DB.get('examHalls');
    halls = halls.filter(h => h.id !== hallId);
    DB.set('examHalls', halls);
    
    loadExamHalls();
}

// Open hall assignment
function openHallAssignment(examId) {
    const exams = DB.get('exams');
    const exam = exams.find(e => e.id === examId);
    const timetable = DB.get('examTimetable');
    const halls = DB.get('examHalls');
    const classes = DB.get('classes');
    
    if (!exam) return;
    
    const examEntries = timetable.filter(t => t.examId === examId);
    
    if (examEntries.length === 0) {
        alert('Please create exam timetable first!');
        return;
    }
    
    if (halls.length === 0) {
        alert('Please add exam halls first!');
        return;
    }
    
    document.getElementById('selectedExamInfoHall').innerHTML = `
        <strong>ðŸ“š ${exam.name}</strong> - Assign Halls<br>
        <small>Assign examination halls for each session</small>
    `;
    
    let html = '';
    examEntries.forEach((entry, index) => {
        const cls = classes.find(c => c.id == entry.classId);
        
        html += `<div class="card" style="margin-bottom: 15px; background: #f8f9fa;">
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; align-items: center;">
                <div>
                    <strong>${new Date(entry.date).toLocaleDateString('en-IN')} - ${entry.startTime}</strong><br>
                    <small>${cls ? cls.name : '-'} | ${entry.subject}</small>
                </div>
                <select id="hall_${index}" data-entry-id="${entry.id}" style="padding: 10px;">
                    <option value="">-- Select Hall --</option>
                    ${halls.map(h => `<option value="${h.id}">${h.name} (${h.capacity})</option>`).join('')}
                </select>
            </div>
        </div>`;
    });
    
    document.getElementById('hallAssignmentContent').innerHTML = html;
    document.getElementById('hallAssignmentCard').style.display = 'block';
    window.currentExamId = examId;
    
    loadExistingHallAssignments(examId);
    
    document.getElementById('hallAssignmentCard').scrollIntoView({ behavior: 'smooth' });
}

// Load existing hall assignments
function loadExistingHallAssignments(examId) {
    const assignments = DB.get('hallAssignments');
    const examAssignments = assignments.filter(a => a.examId === examId);
    
    examAssignments.forEach(assignment => {
        const select = document.querySelector(`[data-entry-id="${assignment.timetableEntryId}"]`);
        if (select) select.value = assignment.hallId;
    });
}

// Save hall assignments
function saveHallAssignments() {
    const examId = window.currentExamId;
    const timetable = DB.get('examTimetable');
    const examEntries = timetable.filter(t => t.examId === examId);
    
    let assignments = [];
    
    examEntries.forEach((entry, index) => {
        const hallId = document.getElementById(`hall_${index}`).value;
        
        if (hallId) {
            assignments.push({
                id: Date.now() + index,
                examId: examId,
                timetableEntryId: entry.id,
                hallId: hallId,
                createdAt: new Date().toISOString()
            });
        }
    });
    
    // Remove old assignments for this exam
    let allAssignments = DB.get('hallAssignments');
    allAssignments = allAssignments.filter(a => a.examId !== examId);
    allAssignments = allAssignments.concat(assignments);
    DB.set('hallAssignments', allAssignments);
    
    alert('âœ… Hall assignments saved!');
    closeHallAssignment();
}

// Close hall assignment
function closeHallAssignment() {
    document.getElementById('hallAssignmentCard').style.display = 'none';
    window.currentExamId = null;
}

// Delete exam
function deleteExam(examId) {
    if (!confirm('Delete this exam and all related data?')) return;
    
    let exams = DB.get('exams');
    exams = exams.filter(e => e.id !== examId);
    DB.set('exams', exams);
    
    // Delete related timetable
    let timetable = DB.get('examTimetable');
    timetable = timetable.filter(t => t.examId !== examId);
    DB.set('examTimetable', timetable);
    
    // Delete invigilator assignments
    let invigAssignments = DB.get('invigilatorAssignments');
    invigAssignments = invigAssignments.filter(a => a.examId !== examId);
    DB.set('invigilatorAssignments', invigAssignments);
    
    // Delete hall assignments
    let hallAssignments = DB.get('hallAssignments');
    hallAssignments = hallAssignments.filter(a => a.examId !== examId);
    DB.set('hallAssignments', hallAssignments);
    
    loadExamList();
    updateExamStats();
}

// Update exam stats
function updateExamStats() {
    const exams = DB.get('exams');
    const invigilatorAssignments = DB.get('invigilatorAssignments');
    
    const today = new Date().toISOString().split('T')[0];
    
    const upcoming = exams.filter(e => new Date(e.startDate) > new Date(today)).length;
    const ongoing = exams.filter(e => 
        new Date(e.startDate) <= new Date(today) && new Date(e.endDate) >= new Date(today)
    ).length;
    
    const totalInvigilators = invigilatorAssignments.reduce((sum, a) => sum + a.invigilators.length, 0);
    
    document.getElementById('totalExamsCount').textContent = exams.length;
    document.getElementById('upcomingExamsCount').textContent = upcoming;
    document.getElementById('ongoingExamsCount').textContent = ongoing;
    document.getElementById('totalInvigilatorsCount').textContent = totalInvigilators;
}

// Show exam report modal
function showExamReportModal(reportType) {
    const modal = document.getElementById('printModal');
    const modalTitle = document.getElementById('printModalTitle');
    const modalBody = document.getElementById('printModalBody');

    modal.classList.add('active');
    
    switch(reportType) {
        case 'timetable':
            modalTitle.textContent = 'ðŸ“… Print Exam Timetable';
            modalBody.innerHTML = generateExamTimetableReportOptions();
            break;
        case 'invigilator':
            modalTitle.textContent = 'ðŸ‘¨â€ðŸ« Print Invigilator Duty List';
            modalBody.innerHTML = generateInvigilatorReportOptions();
            break;
        case 'hall':
            modalTitle.textContent = 'ðŸ›ï¸ Print Hall Arrangement';
            modalBody.innerHTML = generateHallReportOptions();
            break;
        case 'admit':
            modalTitle.textContent = 'ðŸŽ« Generate Admit Cards';
            modalBody.innerHTML = '<p style="padding:20px; text-align:center;">Admit card generation feature coming soon!</p>';
            break;
    }
}

// Generate exam timetable report options
function generateExamTimetableReportOptions() {
    const exams = DB.get('exams');
    
    if (exams.length === 0) {
        return '<p style="padding:20px; text-align:center; color:#999;">No exams available.</p>';
    }
    
    let html = '<div class="form-group">';
    html += '<label>Select Exam:</label>';
    html += '<select id="reportExamId" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    exams.forEach(exam => {
        html += `<option value="${exam.id}">${exam.name} (${exam.type})</option>`;
    });
    html += '</select></div>';
    html += '<button class="btn btn-primary" style="width:100%; margin-top:20px; padding:14px;" onclick="printExamTimetableReport()">ðŸ–¨ï¸ Print</button>';
    
    return html;
}

// Generate invigilator report options
function generateInvigilatorReportOptions() {
    const exams = DB.get('exams');
    
    if (exams.length === 0) {
        return '<p style="padding:20px; text-align:center; color:#999;">No exams available.</p>';
    }
    
    let html = '<div class="form-group">';
    html += '<label>Select Exam:</label>';
    html += '<select id="reportExamId" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    exams.forEach(exam => {
        html += `<option value="${exam.id}">${exam.name} (${exam.type})</option>`;
    });
    html += '</select></div>';
    html += '<button class="btn btn-primary" style="width:100%; margin-top:20px; padding:14px;" onclick="printInvigilatorReport()">ðŸ–¨ï¸ Print</button>';
    
    return html;
}

// Generate hall report options
function generateHallReportOptions() {
    const exams = DB.get('exams');
    
    if (exams.length === 0) {
        return '<p style="padding:20px; text-align:center; color:#999;">No exams available.</p>';
    }
    
    let html = '<div class="form-group">';
    html += '<label>Select Exam:</label>';
    html += '<select id="reportExamId" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    exams.forEach(exam => {
        html += `<option value="${exam.id}">${exam.name} (${exam.type})</option>`;
    });
    html += '</select></div>';
    html += '<button class="btn btn-primary" style="width:100%; margin-top:20px; padding:14px;" onclick="printHallReport()">ðŸ–¨ï¸ Print</button>';
    
    return html;
}

// Print exam timetable report
function printExamTimetableReport() {
    const examId = parseInt(document.getElementById('reportExamId').value);
    const exams = DB.get('exams');
    const timetable = DB.get('examTimetable');
    const classes = DB.get('classes');
    
    const exam = exams.find(e => e.id === examId);
    const examEntries = timetable.filter(t => t.examId === examId).sort((a, b) => new Date(a.date) - new Date(b.date));
    
    let printWindow = window.open('', '_blank');
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>${exam.name} - Timetable</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid #1e3c72; padding-bottom: 15px; }
                .header h1 { color: #1e3c72; margin: 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #333; padding: 12px; text-align: left; }
                th { background: #1e3c72; color: white; }
                tr:nth-child(even) { background: #f8f9fa; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ðŸ“… ${exam.name}</h1>
                <p>${exam.type} | ${exam.year}</p>
                <p>Ramnagar High School, Durgapur</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Time</th>
                        <th>Class</th>
                        <th>Subject</th>
                        <th>Marks</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    examEntries.forEach(entry => {
        const cls = classes.find(c => c.id == entry.classId);
        const date = new Date(entry.date);
        
        html += `<tr>
            <td>${date.toLocaleDateString('en-IN')}</td>
            <td>${date.toLocaleDateString('en-US', { weekday: 'long' })}</td>
            <td>${entry.startTime} (${entry.duration} min)</td>
            <td>${cls ? cls.name : '-'}</td>
            <td><strong>${entry.subject}</strong></td>
            <td>${entry.marks}</td>
        </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </body>
        </html>
    `;
    
    printWindow.document.write(html);
    printWindow.document.close();
    setTimeout(() => printWindow.print(), 500);
    
    closePrintModal();
}

// Print invigilator report
function printInvigilatorReport() {
    const examId = parseInt(document.getElementById('reportExamId').value);
    const exams = DB.get('exams');
    const timetable = DB.get('examTimetable');
    const invigilatorAssignments = DB.get('invigilatorAssignments');
    const teachers = DB.get('teachers');
    const classes = DB.get('classes');
    
    const exam = exams.find(e => e.id === examId);
    const examEntries = timetable.filter(t => t.examId === examId).sort((a, b) => new Date(a.date) - new Date(b.date));
    
    let printWindow = window.open('', '_blank');
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Invigilator Duty List - ${exam.name}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid #1e3c72; padding-bottom: 15px; }
                .header h1 { color: #1e3c72; margin: 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #333; padding: 12px; text-align: left; }
                th { background: #1e3c72; color: white; }
                tr:nth-child(even) { background: #f8f9fa; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ðŸ‘¨â€ðŸ« Invigilator Duty List</h1>
                <p>${exam.name} | ${exam.type}</p>
                <p>Ramnagar High School, Durgapur</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Class</th>
                        <th>Subject</th>
                        <th>Invigilators</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    examEntries.forEach(entry => {
        const cls = classes.find(c => c.id == entry.classId);
        const assignment = invigilatorAssignments.find(a => a.timetableEntryId === entry.id);
        
        let invigilatorNames = 'Not assigned';
        if (assignment) {
            invigilatorNames = assignment.invigilators.map(id => {
                const teacher = teachers.find(t => t.id == id);
                return teacher ? teacher.name : 'Unknown';
            }).join(', ');
        }
        
        html += `<tr>
            <td>${new Date(entry.date).toLocaleDateString('en-IN')}<br>${entry.startTime}</td>
            <td>${cls ? cls.name : '-'}</td>
            <td>${entry.subject}</td>
            <td>${invigilatorNames}</td>
        </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </body>
        </html>
    `;
    
    printWindow.document.write(html);
    printWindow.document.close();
    setTimeout(() => printWindow.print(), 500);
    
    closePrintModal();
}

// Print hall report
function printHallReport() {
    const examId = parseInt(document.getElementById('reportExamId').value);
    const exams = DB.get('exams');
    const timetable = DB.get('examTimetable');
    const hallAssignments = DB.get('hallAssignments');
    const halls = DB.get('examHalls');
    const classes = DB.get('classes');
    
    const exam = exams.find(e => e.id === examId);
    const examEntries = timetable.filter(t => t.examId === examId).sort((a, b) => new Date(a.date) - new Date(b.date));
    
    let printWindow = window.open('', '_blank');
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Hall Arrangement - ${exam.name}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid #1e3c72; padding-bottom: 15px; }
                .header h1 { color: #1e3c72; margin: 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #333; padding: 12px; text-align: left; }
                th { background: #1e3c72; color: white; }
                tr:nth-child(even) { background: #f8f9fa; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ðŸ›ï¸ Hall Arrangement</h1>
                <p>${exam.name} | ${exam.type}</p>
                <p>Ramnagar High School, Durgapur</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Class</th>
                        <th>Subject</th>
                        <th>Hall</th>
                        <th>Capacity</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    examEntries.forEach(entry => {
        const cls = classes.find(c => c.id == entry.classId);
        const assignment = hallAssignments.find(a => a.timetableEntryId === entry.id);
        
        let hallInfo = 'Not assigned';
        let capacity = '-';
        if (assignment) {
            const hall = halls.find(h => h.id == assignment.hallId);
            if (hall) {
                hallInfo = `${hall.name} ${hall.location ? '(' + hall.location + ')' : ''}`;
                capacity = hall.capacity;
            }
        }
        
        html += `<tr>
            <td>${new Date(entry.date).toLocaleDateString('en-IN')}<br>${entry.startTime}</td>
            <td>${cls ? cls.name : '-'}</td>
            <td>${entry.subject}</td>
            <td>${hallInfo}</td>
            <td>${capacity}</td>
        </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </body>
        </html>
    `;
    
    printWindow.document.write(html);
    printWindow.document.close();
    setTimeout(() => printWindow.print(), 500);
    
    closePrintModal();
}


// ========== COMMUNICATION MODULE FUNCTIONS ==========

// Initialize communication module
function initializeCommunication() {
    loadChatList();
    loadAnnouncements();
    loadNotices();
    loadGroups();
    loadGroupMembers();
    updateCommunicationStats();
    
    // Set default date
    const today = new Date().toISOString().split('T')[0];
    if (document.getElementById('noticeDate')) {
        document.getElementById('noticeDate').value = today;
    }
}

// Show communication sub-tabs
function showCommTab(tabName) {
    document.querySelectorAll('.comm-section').forEach(section => {
        section.style.display = 'none';
    });
    
    document.querySelectorAll('[id^="commTab"]').forEach(btn => {
        btn.className = 'btn btn-secondary';
        btn.style.borderRadius = '8px 8px 0 0';
    });
    
    document.getElementById('comm' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).style.display = 'block';
    document.getElementById('commTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).className = 'btn btn-primary';
}

// Update communication stats
function updateCommunicationStats() {
    const messages = DB.get('messages');
    const announcements = DB.get('announcements');
    const notices = DB.get('notices');
    const chats = DB.get('chats');
    
    const currentUser = DB.getObj('currentUser');
    const unread = messages.filter(m => m.receiverId == currentUser.id && !m.read).length;
    
    const today = new Date().toISOString().split('T')[0];
    const activeAnnouncements = announcements.filter(a => !a.expiryDate || a.expiryDate >= today).length;
    
    document.getElementById('unreadMessagesCount').textContent = unread;
    document.getElementById('totalAnnouncementsCount').textContent = activeAnnouncements;
    document.getElementById('totalNoticesCount').textContent = notices.length;
    document.getElementById('activeChatsCount').textContent = chats.length;
}

// Load chat list
function loadChatList() {
    const chats = DB.get('chats');
    const teachers = DB.get('teachers');
    const currentUser = DB.getObj('currentUser');
    const container = document.getElementById('chatList');
    
    if (!container) return;
    
    if (chats.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No chats yet</p>';
        return;
    }
    
    let html = '';
    chats.forEach(chat => {
        const otherUserId = chat.user1Id == currentUser.id ? chat.user2Id : chat.user1Id;
        const otherUser = teachers.find(t => t.id == otherUserId) || {name: 'Unknown'};
        
        html += `<div class="chat-item" onclick="openChat(${chat.id})">
            <div class="chat-item-time">${new Date(chat.lastMessageTime || chat.createdAt).toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</div>
            <div class="chat-item-name">${otherUser.name}</div>
            <div class="chat-item-preview">${chat.lastMessage || 'Start chatting...'}</div>
        </div>`;
    });
    
    container.innerHTML = html;
}

// Show new chat modal
function showNewChatModal() {
    const teachers = DB.get('teachers');
    const currentUser = DB.getObj('currentUser');
    
    const modal = document.getElementById('printModal');
    const modalTitle = document.getElementById('printModalTitle');
    const modalBody = document.getElementById('printModalBody');
    
    modal.classList.add('active');
    modalTitle.textContent = 'âž• Start New Chat';
    
    let html = '<div class="form-group"><label>Select Teacher:</label>';
    html += '<select id="newChatTeacher" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0;">';
    html += '<option value="">-- Select Teacher --</option>';
    teachers.filter(t => t.id != currentUser.id).forEach(teacher => {
        html += `<option value="${teacher.id}">${teacher.name}</option>`;
    });
    html += '</select></div>';
    html += '<button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="startNewChat()">Start Chat</button>';
    
    modalBody.innerHTML = html;
}

// Start new chat
function startNewChat() {
    const teacherId = document.getElementById('newChatTeacher').value;
    const currentUser = DB.getObj('currentUser');
    
    if (!teacherId) {
        alert('Please select a teacher!');
        return;
    }
    
    // Check if chat already exists
    let chats = DB.get('chats');
    const existingChat = chats.find(c => 
        (c.user1Id == currentUser.id && c.user2Id == teacherId) ||
        (c.user2Id == currentUser.id && c.user1Id == teacherId)
    );
    
    if (existingChat) {
        closePrintModal();
        openChat(existingChat.id);
        return;
    }
    
    // Create new chat
    const chat = {
        id: Date.now(),
        user1Id: currentUser.id,
        user2Id: parseInt(teacherId),
        createdAt: new Date().toISOString()
    };
    
    chats.push(chat);
    DB.set('chats', chats);
    
    closePrintModal();
    loadChatList();
    openChat(chat.id);
}

// Open chat
function openChat(chatId) {
    const chats = DB.get('chats');
    const messages = DB.get('messages');
    const teachers = DB.get('teachers');
    const currentUser = DB.getObj('currentUser');
    
    const chat = chats.find(c => c.id === chatId);
    if (!chat) return;
    
    const otherUserId = chat.user1Id == currentUser.id ? chat.user2Id : chat.user1Id;
    const otherUser = teachers.find(t => t.id == otherUserId) || {name: 'Unknown'};
    
    window.currentChatId = chatId;
    
    // Mark active chat
    document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
    event.target.closest('.chat-item')?.classList.add('active');
    
    // Load messages
    const chatMessages = messages.filter(m => m.chatId === chatId).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    let html = `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0;">
        <strong>${otherUser.name}</strong>
    </div>`;
    
    chatMessages.forEach(msg => {
        const isSent = msg.senderId == currentUser.id;
        html += `<div style="display: flex; ${isSent ? 'justify-content: flex-end' : ''}; margin-bottom: 15px;">
            <div class="message-bubble ${isSent ? 'message-sent' : 'message-received'}">
                <div>${msg.message}</div>
                <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</div>
            </div>
        </div>`;
    });
    
    if (chatMessages.length === 0) {
        html += '<div style="text-align: center; color: #999; padding: 50px;">No messages yet. Start the conversation!</div>';
    }
    
    document.getElementById('chatWindow').innerHTML = html;
    document.getElementById('chatInput').style.display = 'block';
    
    // Scroll to bottom
    const chatWindow = document.getElementById('chatWindow');
    chatWindow.scrollTop = chatWindow.scrollHeight;
    
    // Mark messages as read
    messages.filter(m => m.chatId === chatId && m.receiverId == currentUser.id).forEach(m => m.read = true);
    DB.set('messages', messages);
    updateCommunicationStats();
}

// Send message
function sendMessage() {
    const messageText = document.getElementById('messageInput').value.trim();
    const chatId = window.currentChatId;
    const currentUser = DB.getObj('currentUser');
    
    if (!messageText || !chatId) return;
    
    const chats = DB.get('chats');
    const chat = chats.find(c => c.id === chatId);
    const receiverId = chat.user1Id == currentUser.id ? chat.user2Id : chat.user1Id;
    
    const message = {
        id: Date.now(),
        chatId: chatId,
        senderId: currentUser.id,
        receiverId: receiverId,
        message: messageText,
        read: false,
        timestamp: new Date().toISOString()
    };
    
    let messages = DB.get('messages');
    messages.push(message);
    DB.set('messages', messages);
    
    // Update last message in chat
    chat.lastMessage = messageText;
    chat.lastMessageTime = message.timestamp;
    DB.set('chats', chats);
    
    document.getElementById('messageInput').value = '';
    openChat(chatId);
    loadChatList();
}

// Publish announcement
function publishAnnouncement() {
    const title = document.getElementById('announcementTitle').value.trim();
    const message = document.getElementById('announcementMessage').value.trim();
    const priority = document.getElementById('announcementPriority').value;
    const audience = document.getElementById('announcementAudience').value;
    const expiry = document.getElementById('announcementExpiry').value;
    
    if (!title || !message) {
        alert('Please fill title and message!');
        return;
    }
    
    const announcement = {
        id: Date.now(),
        title: title,
        message: message,
        priority: priority,
        audience: audience,
        expiryDate: expiry,
        publishedBy: DB.getObj('currentUser').username,
        publishedAt: new Date().toISOString()
    };
    
    let announcements = DB.get('announcements');
    announcements.push(announcement);
    DB.set('announcements', announcements);
    
    alert('âœ… Announcement published!');
    
    document.getElementById('announcementTitle').value = '';
    document.getElementById('announcementMessage').value = '';
    document.getElementById('announcementExpiry').value = '';
    
    loadAnnouncements();
    updateCommunicationStats();
}

// Load announcements
function loadAnnouncements() {
    const announcements = DB.get('announcements');
    const container = document.getElementById('announcementsList');
    
    if (!container) return;
    
    const today = new Date().toISOString().split('T')[0];
    const active = announcements.filter(a => !a.expiryDate || a.expiryDate >= today);
    
    if (active.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No active announcements</p>';
        return;
    }
    
    let html = '';
    active.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt)).forEach(ann => {
        html += `<div class="announcement-card ${ann.priority}">
            <div class="announcement-title">ðŸ“¢ ${ann.title}</div>
            <div style="margin: 10px 0;">${ann.message}</div>
            <div class="announcement-meta">
                <strong>Priority:</strong> ${ann.priority.toUpperCase()} | 
                <strong>Audience:</strong> ${ann.audience} | 
                <strong>Published:</strong> ${new Date(ann.publishedAt).toLocaleDateString('en-IN')}
                ${ann.expiryDate ? ' | <strong>Expires:</strong> ' + new Date(ann.expiryDate).toLocaleDateString('en-IN') : ''}
            </div>
            <button class="btn btn-sm btn-danger" onclick="deleteAnnouncement(${ann.id})" style="margin-top:10px;">Delete</button>
        </div>`;
    });
    
    container.innerHTML = html;
}

// Delete announcement
function deleteAnnouncement(id) {
    if (!confirm('Delete this announcement?')) return;
    
    let announcements = DB.get('announcements');
    announcements = announcements.filter(a => a.id !== id);
    DB.set('announcements', announcements);
    
    loadAnnouncements();
    updateCommunicationStats();
}

// Publish notice
function publishNotice() {
    const number = document.getElementById('noticeNumber').value.trim();
    const date = document.getElementById('noticeDate').value;
    const subject = document.getElementById('noticeSubject').value.trim();
    const content = document.getElementById('noticeContent').value.trim();
    const category = document.getElementById('noticeCategory').value;
    const display = document.getElementById('noticeDisplay').value;
    
    if (!number || !date || !subject || !content) {
        alert('Please fill all required fields!');
        return;
    }
    
    const notice = {
        id: Date.now(),
        number: number,
        date: date,
        subject: subject,
        content: content,
        category: category,
        displayOnBoard: display === 'yes',
        publishedBy: DB.getObj('currentUser').username,
        publishedAt: new Date().toISOString()
    };
    
    let notices = DB.get('notices');
    notices.push(notice);
    DB.set('notices', notices);
    
    alert('âœ… Notice published successfully!');
    
    document.getElementById('noticeNumber').value = '';
    document.getElementById('noticeSubject').value = '';
    document.getElementById('noticeContent').value = '';
    
    loadNotices();
    updateCommunicationStats();
}

// Load notices
function loadNotices() {
    const notices = DB.get('notices');
    const tbody = document.getElementById('noticesTable');
    
    if (!tbody) return;
    
    if (notices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No notices published yet</td></tr>';
        return;
    }
    
    let html = '';
    notices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(notice => {
        html += `<tr>
            <td><strong>${notice.number}</strong></td>
            <td>${new Date(notice.date).toLocaleDateString('en-IN')}</td>
            <td>${notice.subject}</td>
            <td><span class="status-badge" style="background: #e3f2fd; color: #1976d2;">${notice.category}</span></td>
            <td>
                <button class="btn btn-sm btn-info" onclick="viewNotice(${notice.id})">View</button>
                <button class="btn btn-sm btn-danger" onclick="deleteNotice(${notice.id})">Delete</button>
            </td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
}

// View notice
function viewNotice(id) {
    const notices = DB.get('notices');
    const notice = notices.find(n => n.id === id);
    
    if (!notice) return;
    
    const modal = document.getElementById('printModal');
    const modalTitle = document.getElementById('printModalTitle');
    const modalBody = document.getElementById('printModalBody');
    
    modal.classList.add('active');
    modalTitle.textContent = 'ðŸ“‹ Notice';
    
    modalBody.innerHTML = `
        <div style="border: 2px solid #1e3c72; padding: 20px; border-radius: 8px;">
            <div style="text-align: center; border-bottom: 2px solid #1e3c72; padding-bottom: 10px; margin-bottom: 15px;">
                <h2 style="color: #1e3c72; margin: 0;">RAMNAGAR HIGH SCHOOL</h2>
                <p style="margin: 5px 0;">Durgapur, West Bengal</p>
            </div>
            <div style="margin-bottom: 15px;">
                <strong>Notice No:</strong> ${notice.number}<br>
                <strong>Date:</strong> ${new Date(notice.date).toLocaleDateString('en-IN')}<br>
                <strong>Category:</strong> ${notice.category.toUpperCase()}
            </div>
            <div style="margin-bottom: 15px;">
                <strong>Subject:</strong> ${notice.subject}
            </div>
            <div style="white-space: pre-wrap; line-height: 1.6;">
                ${notice.content}
            </div>
            <div style="margin-top: 30px; text-align: right;">
                <p style="margin: 0;">Principal</p>
                <p style="margin: 0;">Ramnagar High School</p>
            </div>
        </div>
        <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="window.print()">ðŸ–¨ï¸ Print</button>
    `;
}

// Delete notice
function deleteNotice(id) {
    if (!confirm('Delete this notice?')) return;
    
    let notices = DB.get('notices');
    notices = notices.filter(n => n.id !== id);
    DB.set('notices', notices);
    
    loadNotices();
    updateCommunicationStats();
}

// Filter notices
function filterNotices() {
    const filter = document.getElementById('noticeFilterCategory').value;
    let notices = DB.get('notices');
    
    if (filter) {
        notices = notices.filter(n => n.category === filter);
    }
    
    const tbody = document.getElementById('noticesTable');
    
    if (notices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No notices found</td></tr>';
        return;
    }
    
    let html = '';
    notices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(notice => {
        html += `<tr>
            <td><strong>${notice.number}</strong></td>
            <td>${new Date(notice.date).toLocaleDateString('en-IN')}</td>
            <td>${notice.subject}</td>
            <td><span class="status-badge" style="background: #e3f2fd; color: #1976d2;">${notice.category}</span></td>
            <td>
                <button class="btn btn-sm btn-info" onclick="viewNotice(${notice.id})">View</button>
                <button class="btn btn-sm btn-danger" onclick="deleteNotice(${notice.id})">Delete</button>
            </td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
}

// Load group members selection
function loadGroupMembers() {
    const teachers = DB.get('teachers');
    const container = document.getElementById('groupMembersSelection');
    
    if (!container) return;
    
    let html = '';
    teachers.forEach(teacher => {
        html += `<label style="display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; hover:background: #f0f0f0;">
            <input type="checkbox" value="${teacher.id}" class="group-member-checkbox">
            <span>${teacher.name}</span>
        </label>`;
    });
    
    container.innerHTML = html;
}

// Create group
function createGroup() {
    const name = document.getElementById('groupName').value.trim();
    const description = document.getElementById('groupDescription').value.trim();
    const checkboxes = document.querySelectorAll('.group-member-checkbox:checked');
    const members = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (!name || members.length === 0) {
        alert('Please enter group name and select at least one member!');
        return;
    }
    
    const group = {
        id: Date.now(),
        name: name,
        description: description,
        members: members,
        createdBy: DB.getObj('currentUser').id,
        createdAt: new Date().toISOString()
    };
    
    let groups = DB.get('groups');
    groups.push(group);
    DB.set('groups', groups);
    
    alert('âœ… Group created successfully!');
    
    document.getElementById('groupName').value = '';
    document.getElementById('groupDescription').value = '';
    document.querySelectorAll('.group-member-checkbox').forEach(cb => cb.checked = false);
    
    loadGroups();
}

// Load groups
function loadGroups() {
    const groups = DB.get('groups');
    const teachers = DB.get('teachers');
    const container = document.getElementById('groupsList');
    
    if (!container) return;
    
    if (groups.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No groups created yet</p>';
        return;
    }
    
    let html = '';
    groups.forEach(group => {
        const memberNames = group.members.map(id => {
            const teacher = teachers.find(t => t.id == id);
            return teacher ? teacher.name : 'Unknown';
        }).join(', ');
        
        html += `<div class="group-card">
            <div class="group-name">ðŸ‘¥ ${group.name}</div>
            <div style="color: #666; margin: 5px 0;">${group.description || 'No description'}</div>
            <div class="group-members"><strong>Members (${group.members.length}):</strong> ${memberNames}</div>
            <button class="btn btn-sm btn-primary" style="margin-top:10px;" onclick="sendGroupMessage(${group.id})">Send Message</button>
            <button class="btn btn-sm btn-danger" style="margin-top:10px;" onclick="deleteGroup(${group.id})">Delete</button>
        </div>`;
    });
    
    container.innerHTML = html;
}

// Send group message
function sendGroupMessage(groupId) {
    const groups = DB.get('groups');
    const group = groups.find(g => g.id === groupId);
    
    if (!group) return;
    
    const modal = document.getElementById('printModal');
    const modalTitle = document.getElementById('printModalTitle');
    const modalBody = document.getElementById('printModalBody');
    
    modal.classList.add('active');
    modalTitle.textContent = `ðŸ“¢ Send Message to ${group.name}`;
    
    modalBody.innerHTML = `
        <div class="form-group">
            <label>Message:</label>
            <textarea id="groupMessageText" rows="5" placeholder="Type your message..." style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0;"></textarea>
        </div>
        <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="sendGroupMessageNow(${groupId})">ðŸ“¨ Send to All Members</button>
    `;
}

// Send group message now
function sendGroupMessageNow(groupId) {
    const messageText = document.getElementById('groupMessageText').value.trim();
    
    if (!messageText) {
        alert('Please enter a message!');
        return;
    }
    
    const groups = DB.get('groups');
    const group = groups.find(g => g.id === groupId);
    const currentUser = DB.getObj('currentUser');
    
    // Create individual chats and messages for each member
    group.members.forEach(memberId => {
        if (memberId == currentUser.id) return;
        
        // Find or create chat
        let chats = DB.get('chats');
        let chat = chats.find(c => 
            (c.user1Id == currentUser.id && c.user2Id == memberId) ||
            (c.user2Id == currentUser.id && c.user1Id == memberId)
        );
        
        if (!chat) {
            chat = {
                id: Date.now() + memberId,
                user1Id: currentUser.id,
                user2Id: memberId,
                createdAt: new Date().toISOString()
            };
            chats.push(chat);
            DB.set('chats', chats);
        }
        
        // Send message
        const message = {
            id: Date.now() + memberId + Math.random(),
            chatId: chat.id,
            senderId: currentUser.id,
            receiverId: memberId,
            message: `[Group: ${group.name}] ${messageText}`,
            read: false,
            timestamp: new Date().toISOString()
        };
        
        let messages = DB.get('messages');
        messages.push(message);
        DB.set('messages', messages);
        
        chat.lastMessage = messageText;
        chat.lastMessageTime = message.timestamp;
        DB.set('chats', chats);
    });
    
    alert(`âœ… Message sent to ${group.members.length} members!`);
    closePrintModal();
    loadChatList();
}

// Delete group
function deleteGroup(id) {
    if (!confirm('Delete this group?')) return;
    
    let groups = DB.get('groups');
    groups = groups.filter(g => g.id !== id);
    DB.set('groups', groups);
    
    loadGroups();
}


// ========== SUBSTITUTE TEACHER MANAGEMENT FUNCTIONS ==========

// Initialize substitute management on page load
function initializeSubstituteManagement() {
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('absenceDate').value = today;
    document.getElementById('substituteMonth').value = today.substring(0, 7);
    
    // Load teachers into dropdowns
    loadSubstituteTeachers();
    
    // Load today's absences
    loadTodayAbsences();
    
    // Update stats
    updateSubstituteStats();
    
    // Load compensation settings
    loadCompensationSettings();
}

// Load teachers into dropdowns
function loadSubstituteTeachers() {
    const teachers = DB.get('teachers');
    
    const absentTeacherSelect = document.getElementById('absentTeacher');
    const filterSelect = document.getElementById('substituteTeacherFilter');
    
    absentTeacherSelect.innerHTML = '<option value="">-- Select Teacher --</option>';
    filterSelect.innerHTML = '<option value="">All Teachers</option>';
    
    teachers.forEach(teacher => {
        absentTeacherSelect.innerHTML += `<option value="${teacher.id}">${teacher.name}</option>`;
        filterSelect.innerHTML += `<option value="${teacher.id}">${teacher.name}</option>`;
    });
}

// Load teacher's schedule when selected
function loadTeacherSchedule() {
    const teacherId = document.getElementById('absentTeacher').value;
    const date = document.getElementById('absenceDate').value;
    
    if (!teacherId || !date) {
        document.getElementById('teacherScheduleCard').style.display = 'none';
        return;
    }
    
    const selectedDate = new Date(date);
    const dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    
    const routines = DB.get('routines');
    const classes = DB.get('classes');
    const periods = DB.get('periods');
    
    const teacherRoutines = routines.filter(r => 
        r.teacherId == teacherId && r.day === dayName
    );
    
    if (teacherRoutines.length === 0) {
        document.getElementById('teacherScheduleCard').style.display = 'block';
        document.getElementById('teacherScheduleContent').innerHTML = '<p style="color: #999;">No classes scheduled for this teacher on this day.</p>';
        return;
    }
    
    let html = '<table><thead><tr><th>Period</th><th>Time</th><th>Class</th><th>Subject</th></tr></thead><tbody>';
    
    teacherRoutines.sort((a, b) => parseInt(a.periodNumber) - parseInt(b.periodNumber));
    
    teacherRoutines.forEach(routine => {
        const period = periods.find(p => p.id == routine.periodId);
        const cls = classes.find(c => c.id == routine.classId);
        
        html += `<tr>
            <td>Period ${routine.periodNumber}</td>
            <td>${period ? period.time : '-'}</td>
            <td>${cls ? cls.name : '-'}</td>
            <td>${routine.subject || '-'}</td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    
    document.getElementById('teacherScheduleCard').style.display = 'block';
    document.getElementById('teacherScheduleContent').innerHTML = html;
}

// Mark teacher absent and show substitute assignment
function markTeacherAbsent() {
    const teacherId = document.getElementById('absentTeacher').value;
    const date = document.getElementById('absenceDate').value;
    const reason = document.getElementById('absenceReason').value;
    const notes = document.getElementById('absenceNotes').value;
    
    if (!teacherId || !date) {
        alert('Please select teacher and date!');
        return;
    }
    
    const teachers = DB.get('teachers');
    const teacher = teachers.find(t => t.id == teacherId);
    
    const selectedDate = new Date(date);
    const dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    
    const routines = DB.get('routines');
    const teacherRoutines = routines.filter(r => 
        r.teacherId == teacherId && r.day === dayName
    );
    
    if (teacherRoutines.length === 0) {
        alert('No classes scheduled for this teacher on this day!');
        return;
    }
    
    // Show substitute assignment card
    showSubstituteAssignment(teacherId, date, dayName, teacherRoutines, reason, notes);
}

// Show substitute assignment interface
function showSubstituteAssignment(absentTeacherId, date, dayName, routines, reason, notes) {
    const teachers = DB.get('teachers');
    const classes = DB.get('classes');
    const periods = DB.get('periods');
    const allRoutines = DB.get('routines');
    
    let html = '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #FF9800;">';
    html += '<strong>âš ï¸ Assign substitute teachers for each period:</strong>';
    html += '</div>';
    
    routines.forEach((routine, index) => {
        const period = periods.find(p => p.id == routine.periodId);
        const cls = classes.find(c => c.id == routine.classId);
        
        // Find available teachers (not teaching in this period on this day)
        const availableTeachers = teachers.filter(t => {
            if (t.id == absentTeacherId) return false;
            
            const hasClass = allRoutines.some(r => 
                r.teacherId == t.id && 
                r.day === dayName && 
                r.periodNumber == routine.periodNumber
            );
            
            return !hasClass;
        });
        
        html += `<div class="card" style="margin-bottom: 15px; background: #f8f9fa;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 15px; align-items: center;">
                <div>
                    <strong>Period ${routine.periodNumber}</strong><br>
                    <small>${period ? period.time : '-'}</small>
                </div>
                <div>
                    <strong>${cls ? cls.name : '-'}</strong><br>
                    <small>${routine.subject || '-'}</small>
                </div>
                <div>
                    <select id="substitute_${index}" data-routine-id="${routine.id}" data-period="${routine.periodNumber}" style="width: 100%; padding: 10px;">
                        <option value="">-- Select Substitute --</option>
                        ${availableTeachers.map(t => `<option value="${t.id}">${t.name} ${t.id == absentTeacherId ? '(Absent)' : ''}</option>`).join('')}
                    </select>
                </div>
            </div>
        </div>`;
    });
    
    document.getElementById('substituteAssignmentContent').innerHTML = html;
    document.getElementById('substituteAssignmentCard').style.display = 'block';
    
    // Store context for saving
    window.currentAbsenceContext = {
        absentTeacherId: absentTeacherId,
        date: date,
        dayName: dayName,
        reason: reason,
        notes: notes,
        routines: routines
    };
}

// Save substitute assignments
function saveSubstituteAssignments() {
    const context = window.currentAbsenceContext;
    if (!context) return;
    
    const teachers = DB.get('teachers');
    const classes = DB.get('classes');
    const periods = DB.get('periods');
    
    let assignments = [];
    let missingAssignments = false;
    
    context.routines.forEach((routine, index) => {
        const selectElement = document.getElementById(`substitute_${index}`);
        const substituteId = selectElement.value;
        
        if (!substituteId) {
            missingAssignments = true;
            return;
        }
        
        assignments.push({
            id: Date.now() + index,
            date: context.date,
            day: context.dayName,
            absentTeacherId: context.absentTeacherId,
            substituteTeacherId: substituteId,
            periodId: routine.periodId,
            periodNumber: routine.periodNumber,
            classId: routine.classId,
            subject: routine.subject,
            reason: context.reason,
            notes: context.notes,
            status: 'active',
            createdAt: new Date().toISOString()
        });
    });
    
    if (missingAssignments) {
        if (!confirm('Some periods don\'t have substitutes assigned. Continue anyway?')) {
            return;
        }
    }
    
    // Save to database
    let substituteRecords = DB.get('substituteRecords');
    substituteRecords = substituteRecords.concat(assignments);
    DB.set('substituteRecords', substituteRecords);
    
    // Also save as provisional routines for compatibility
    let provisionalRoutines = DB.get('provisionalRoutines');
    assignments.forEach(assignment => {
        provisionalRoutines.push(assignment);
    });
    DB.set('provisionalRoutines', provisionalRoutines);
    
    alert('âœ… Substitute assignments saved successfully!');
    
    // Reset and reload
    cancelSubstituteProcess();
    loadTodayAbsences();
    updateSubstituteStats();
}

// Cancel substitute process
function cancelSubstituteProcess() {
    document.getElementById('substituteAssignmentCard').style.display = 'none';
    document.getElementById('teacherScheduleCard').style.display = 'none';
    document.getElementById('absentTeacher').value = '';
    document.getElementById('absenceNotes').value = '';
    window.currentAbsenceContext = null;
}

// Load today's absences
function loadTodayAbsences() {
    const today = new Date().toISOString().split('T')[0];
    const substituteRecords = DB.get('substituteRecords');
    const teachers = DB.get('teachers');
    
    const todayRecords = substituteRecords.filter(r => r.date === today);
    
    if (todayRecords.length === 0) {
        document.getElementById('todayAbsencesTable').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No absences for today</td></tr>';
        return;
    }
    
    // Group by absent teacher
    const grouped = {};
    todayRecords.forEach(record => {
        if (!grouped[record.absentTeacherId]) {
            grouped[record.absentTeacherId] = [];
        }
        grouped[record.absentTeacherId].push(record);
    });
    
    let html = '';
    Object.keys(grouped).forEach(absentId => {
        const records = grouped[absentId];
        const absentTeacher = teachers.find(t => t.id == absentId);
        
        const periods = records.map(r => `P${r.periodNumber}`).join(', ');
        const substitutes = [...new Set(records.map(r => {
            const sub = teachers.find(t => t.id == r.substituteTeacherId);
            return sub ? sub.name : 'Unknown';
        }))].join(', ');
        
        html += `<tr>
            <td><strong>${absentTeacher ? absentTeacher.name : 'Unknown'}</strong></td>
            <td>${periods}</td>
            <td>${substitutes}</td>
            <td><span class="status-badge" style="background: #fff3cd; color: #856404;">${records[0].reason}</span></td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="removeAbsence('${absentId}', '${today}')">Remove</button>
            </td>
        </tr>`;
    });
    
    document.getElementById('todayAbsencesTable').innerHTML = html;
}

// Remove absence
function removeAbsence(teacherId, date) {
    if (!confirm('Remove all substitute assignments for this absence?')) return;
    
    let substituteRecords = DB.get('substituteRecords');
    substituteRecords = substituteRecords.filter(r => 
        !(r.absentTeacherId == teacherId && r.date === date)
    );
    DB.set('substituteRecords', substituteRecords);
    
    let provisionalRoutines = DB.get('provisionalRoutines');
    provisionalRoutines = provisionalRoutines.filter(r => 
        !(r.absentTeacherId == teacherId && r.date === date)
    );
    DB.set('provisionalRoutines', provisionalRoutines);
    
    loadTodayAbsences();
    updateSubstituteStats();
}

// Update substitute stats
function updateSubstituteStats() {
    const today = new Date().toISOString().split('T')[0];
    const currentMonth = today.substring(0, 7);
    
    const substituteRecords = DB.get('substituteRecords');
    
    // Absent today
    const todayAbsent = [...new Set(
        substituteRecords
            .filter(r => r.date === today)
            .map(r => r.absentTeacherId)
    )].length;
    
    // Active substitutes today
    const todaySubstitutes = [...new Set(
        substituteRecords
            .filter(r => r.date === today)
            .map(r => r.substituteTeacherId)
    )].length;
    
    // Monthly stats
    const monthRecords = substituteRecords.filter(r => r.date.startsWith(currentMonth));
    const periodDuration = parseInt(document.getElementById('periodDuration')?.value || 45);
    const totalHours = (monthRecords.length * periodDuration / 60).toFixed(1);
    
    const hourlyRate = parseInt(document.getElementById('defaultHourlyRate')?.value || 200);
    const totalCompensation = Math.round(totalHours * hourlyRate);
    
    document.getElementById('absentTodayCount').textContent = todayAbsent;
    document.getElementById('substitutesActiveCount').textContent = todaySubstitutes;
    document.getElementById('totalSubstituteHours').textContent = totalHours;
    document.getElementById('totalSubstituteCompensation').textContent = `â‚¹${totalCompensation}`;
}

// Load substitute hours
function loadSubstituteHours() {
    const month = document.getElementById('substituteMonth').value;
    const filterTeacherId = document.getElementById('substituteTeacherFilter').value;
    
    const substituteRecords = DB.get('substituteRecords');
    const teachers = DB.get('teachers');
    
    let monthRecords = substituteRecords.filter(r => r.date.startsWith(month));
    
    if (filterTeacherId) {
        monthRecords = monthRecords.filter(r => r.substituteTeacherId == filterTeacherId);
    }
    
    // Group by substitute teacher
    const grouped = {};
    monthRecords.forEach(record => {
        if (!grouped[record.substituteTeacherId]) {
            grouped[record.substituteTeacherId] = [];
        }
        grouped[record.substituteTeacherId].push(record);
    });
    
    if (Object.keys(grouped).length === 0) {
        document.getElementById('substituteHoursTable').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No substitute records</td></tr>';
        return;
    }
    
    const periodDuration = parseInt(document.getElementById('periodDuration').value);
    const hourlyRate = parseInt(document.getElementById('defaultHourlyRate').value);
    
    let html = '';
    Object.keys(grouped).forEach(subId => {
        const records = grouped[subId];
        const teacher = teachers.find(t => t.id == subId);
        
        const totalPeriods = records.length;
        const totalHours = (totalPeriods * periodDuration / 60).toFixed(1);
        const compensation = Math.round(totalHours * hourlyRate);
        
        html += `<tr>
            <td><strong>${teacher ? teacher.name : 'Unknown'}</strong></td>
            <td>${totalPeriods}</td>
            <td>${totalHours} hrs</td>
            <td>â‚¹${hourlyRate}/hr</td>
            <td><strong>â‚¹${compensation}</strong></td>
            <td>
                <button class="btn btn-sm btn-info" onclick="viewSubstituteDetails('${subId}', '${month}')">Details</button>
            </td>
        </tr>`;
    });
    
    document.getElementById('substituteHoursTable').innerHTML = html;
}

// View substitute details
function viewSubstituteDetails(teacherId, month) {
    const substituteRecords = DB.get('substituteRecords');
    const teachers = DB.get('teachers');
    const classes = DB.get('classes');
    
    const teacher = teachers.find(t => t.id == teacherId);
    const records = substituteRecords.filter(r => 
        r.substituteTeacherId == teacherId && r.date.startsWith(month)
    );
    
    let html = `<h3>${teacher ? teacher.name : 'Unknown'} - Substitute Details</h3>`;
    html += '<table><thead><tr><th>Date</th><th>Period</th><th>Class</th><th>Subject</th><th>For Teacher</th></tr></thead><tbody>';
    
    records.forEach(record => {
        const absentTeacher = teachers.find(t => t.id == record.absentTeacherId);
        const cls = classes.find(c => c.id == record.classId);
        
        html += `<tr>
            <td>${new Date(record.date).toLocaleDateString('en-IN')}</td>
            <td>Period ${record.periodNumber}</td>
            <td>${cls ? cls.name : '-'}</td>
            <td>${record.subject || '-'}</td>
            <td>${absentTeacher ? absentTeacher.name : 'Unknown'}</td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    
    alert(html); // Simple alert for now - can be converted to modal
}

// Save compensation settings
function saveCompensationSettings() {
    const hourlyRate = document.getElementById('defaultHourlyRate').value;
    const periodDuration = document.getElementById('periodDuration').value;
    
    const settings = {
        hourlyRate: hourlyRate,
        periodDuration: periodDuration
    };
    
    DB.setObj('compensationSettings', settings);
    alert('âœ… Compensation settings saved!');
    
    updateSubstituteStats();
    loadSubstituteHours();
}

// Load compensation settings
function loadCompensationSettings() {
    const settings = DB.getObj('compensationSettings');
    
    if (settings.hourlyRate) {
        document.getElementById('defaultHourlyRate').value = settings.hourlyRate;
    }
    
    if (settings.periodDuration) {
        document.getElementById('periodDuration').value = settings.periodDuration;
    }
}

// Load substitute history
function loadSubstituteHistory() {
    const fromDate = document.getElementById('historyFromDate').value;
    const toDate = document.getElementById('historyToDate').value;
    
    if (!fromDate || !toDate) {
        alert('Please select date range!');
        return;
    }
    
    const substituteRecords = DB.get('substituteRecords');
    const teachers = DB.get('teachers');
    const classes = DB.get('classes');
    
    const filtered = substituteRecords.filter(r => 
        r.date >= fromDate && r.date <= toDate
    );
    
    if (filtered.length === 0) {
        document.getElementById('substituteHistoryTable').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No records found</td></tr>';
        return;
    }
    
    let html = '';
    filtered.forEach(record => {
        const absentTeacher = teachers.find(t => t.id == record.absentTeacherId);
        const substituteTeacher = teachers.find(t => t.id == record.substituteTeacherId);
        const cls = classes.find(c => c.id == record.classId);
        
        html += `<tr>
            <td>${new Date(record.date).toLocaleDateString('en-IN')}</td>
            <td>${absentTeacher ? absentTeacher.name : 'Unknown'}</td>
            <td>Period ${record.periodNumber}</td>
            <td>${cls ? cls.name : '-'}</td>
            <td>${substituteTeacher ? substituteTeacher.name : 'Unknown'}</td>
            <td><span class="status-badge status-${record.status}">${record.status}</span></td>
        </tr>`;
    });
    
    document.getElementById('substituteHistoryTable').innerHTML = html;
}


// ========== WHATSAPP SHARING FUNCTIONS ==========

// Show WhatsApp Modal
// ==================== BENGALI LANGUAGE SUPPORT ====================

const BENGALI_TRANSLATIONS = {
    // Days
    'MONDAY': 'à¦¸à§‹à¦®à¦¬à¦¾à¦°',
    'TUESDAY': 'à¦®à¦™à§à¦—à¦²à¦¬à¦¾à¦°',
    'WEDNESDAY': 'à¦¬à§à¦§à¦¬à¦¾à¦°',
    'THURSDAY': 'à¦¬à§ƒà¦¹à¦¸à§à¦ªà¦¤à¦¿à¦¬à¦¾à¦°',
    'FRIDAY': 'à¦¶à§à¦•à§à¦°à¦¬à¦¾à¦°',
    'SATURDAY': 'à¦¶à¦¨à¦¿à¦¬à¦¾à¦°',
    'SUNDAY': 'à¦°à¦¬à¦¿à¦¬à¦¾à¦°',
    
    // Common terms
    'Period': 'à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡',
    'Class': 'à¦•à§à¦²à¦¾à¦¸',
    'Teacher': 'à¦¶à¦¿à¦•à§à¦·à¦•',
    'Subject': 'à¦¬à¦¿à¦·à¦¯à¦¼',
    'Routine': 'à¦°à§à¦Ÿà¦¿à¦¨',
    'Time': 'à¦¸à¦®à¦¯à¦¼',
    'Date': 'à¦¤à¦¾à¦°à¦¿à¦–',
    'School': 'à¦¸à§à¦•à§à¦²',
    'Present': 'à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤',
    'Absent': 'à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤',
    'Substitute': 'à¦¬à¦¿à¦•à¦²à§à¦ª',
    'Provisional': 'à¦…à¦¸à§à¦¥à¦¾à¦¯à¦¼à§€',
    
    // Messages
    'Good Morning': 'à¦¸à§à¦ªà§à¦°à¦­à¦¾à¦¤',
    'Good Afternoon': 'à¦¶à§à¦­ à¦…à¦ªà¦°à¦¾à¦¹à§à¦¨',
    'Good Evening': 'à¦¶à§à¦­ à¦¸à¦¨à§à¦§à§à¦¯à¦¾',
    'Thank You': 'à¦§à¦¨à§à¦¯à¦¬à¦¾à¦¦',
    'Welcome': 'à¦¸à§à¦¬à¦¾à¦—à¦¤à¦®'
};

// Bengali numbers
const BENGALI_NUMBERS = ['à§¦', 'à§§', 'à§¨', 'à§©', 'à§ª', 'à§«', 'à§¬', 'à§­', 'à§®', 'à§¯'];

function toBengaliNumber(num) {
    return String(num).split('').map(digit => 
        /\d/.test(digit) ? BENGALI_NUMBERS[parseInt(digit)] : digit
    ).join('');
}

function translateToBengali(text) {
    let translated = text;
    Object.keys(BENGALI_TRANSLATIONS).forEach(key => {
        translated = translated.replace(new RegExp(key, 'gi'), BENGALI_TRANSLATIONS[key]);
    });
    return translated;
}

// ==================== ENHANCED WHATSAPP INTEGRATION ====================

// WhatsApp Template Messages
const WHATSAPP_TEMPLATES = {
    teacherSchedule: (teacher, routines, lang = 'en') => {
        const greeting = lang === 'bn' ? 'à¦¨à¦®à¦¸à§à¦•à¦¾à¦°' : 'Hello';
        const scheduleText = lang === 'bn' ? 'à¦à¦° à¦°à§à¦Ÿà¦¿à¦¨' : "'s Schedule";
        
        let message = `${greeting} ðŸ‘‹\n\n`;
        message += `ðŸ“š *${teacher.name}${scheduleText}*\n`;
        message += `ðŸ« ${DB.getObj('schoolInfo').name || 'School'}\n`;
        message += `ðŸ“… ${new Date().toLocaleDateString('en-IN')}\n\n`;
        
        if (routines.length === 0) {
            message += lang === 'bn' ? 'âŒ à¦•à§‹à¦¨à§‹ à¦°à§à¦Ÿà¦¿à¦¨ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' : 'âŒ No routines found';
            return message;
        }
        
        message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
        
        routines.forEach(r => {
            const period = lang === 'bn' ? 'à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡' : 'Period';
            const classText = lang === 'bn' ? 'à¦•à§à¦²à¦¾à¦¸' : 'Class';
            
            message += `ðŸ“ *${period} ${lang === 'bn' ? toBengaliNumber(r.period) : r.period}*\n`;
            message += `   â° ${r.time}\n`;
            message += `   ðŸ« ${classText}: ${r.className}\n`;
            message += `   ðŸ“– ${r.subject}\n\n`;
        });
        
        message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
        message += lang === 'bn' ? 'âœ… à¦°à§à¦Ÿà¦¿à¦¨ à¦¸à¦¾à¦«à¦²à§à¦¯à§‡à¦° à¦¸à¦¾à¦¥à§‡ à¦¶à§‡à¦¯à¦¼à¦¾à¦° à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡!' : 'âœ… Schedule shared successfully!';
        
        return message;
    },
    
    classRoutine: (className, routines, lang = 'en') => {
        const greeting = lang === 'bn' ? 'à¦¨à¦®à¦¸à§à¦•à¦¾à¦°' : 'Hello';
        const routineText = lang === 'bn' ? 'à¦à¦° à¦°à§à¦Ÿà¦¿à¦¨' : ' Routine';
        
        let message = `${greeting} ðŸ‘‹\n\n`;
        message += `ðŸ“š *${className}${routineText}*\n`;
        message += `ðŸ« ${DB.getObj('schoolInfo').name || 'School'}\n`;
        message += `ðŸ“… ${new Date().toLocaleDateString('en-IN')}\n\n`;
        message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
        
        const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
        
        days.forEach(day => {
            const dayRoutines = routines.filter(r => r.day === day);
            if (dayRoutines.length > 0) {
                const dayName = lang === 'bn' ? BENGALI_TRANSLATIONS[day] : day;
                message += `ðŸ“… *${dayName}*\n\n`;
                
                dayRoutines.forEach(r => {
                    const period = lang === 'bn' ? 'à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡' : 'Period';
                    message += `${period} ${lang === 'bn' ? toBengaliNumber(r.period) : r.period}: ${r.subject} (${r.teacher})\n`;
                });
                message += '\n';
            }
        });
        
        message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
        return message;
    },
    
    provisional: (date, absentTeacher, substitute, lang = 'en') => {
        const urgent = lang === 'bn' ? 'âš ï¸ à¦œà¦°à§à¦°à¦¿ à¦¬à¦¿à¦œà§à¦žà¦ªà§à¦¤à¦¿' : 'âš ï¸ URGENT NOTICE';
        const provisionalText = lang === 'bn' ? 'à¦…à¦¸à§à¦¥à¦¾à¦¯à¦¼à§€ à¦°à§à¦Ÿà¦¿à¦¨' : 'Provisional Routine';
        
        let message = `${urgent}\n\n`;
        message += `ðŸ”„ *${provisionalText}*\n`;
        message += `ðŸ“… ${lang === 'bn' ? 'à¦¤à¦¾à¦°à¦¿à¦–' : 'Date'}: ${date}\n\n`;
        message += `âŒ ${lang === 'bn' ? 'à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤' : 'Absent'}: ${absentTeacher}\n`;
        message += `âœ… ${lang === 'bn' ? 'à¦¬à¦¿à¦•à¦²à§à¦ª' : 'Substitute'}: ${substitute}\n\n`;
        message += lang === 'bn' ? 'à¦…à¦¨à§à¦—à§à¦°à¦¹ à¦•à¦°à§‡ à¦¨à§‹à¦Ÿ à¦•à¦°à§à¦¨à¥¤' : 'Please take note.';
        
        return message;
    },
    
    bulkAnnouncement: (title, message, lang = 'en') => {
        const announcement = lang === 'bn' ? 'ðŸ“¢ à¦˜à§‹à¦·à¦£à¦¾' : 'ðŸ“¢ ANNOUNCEMENT';
        let text = `${announcement}\n\n`;
        text += `*${title}*\n\n`;
        text += message + '\n\n';
        text += `ðŸ« ${DB.getObj('schoolInfo').name || 'School'}\n`;
        text += `ðŸ“… ${new Date().toLocaleDateString('en-IN')}`;
        return text;
    }
};

// Bulk WhatsApp sending
function sendBulkWhatsApp(phoneNumbers, message) {
    if (!Array.isArray(phoneNumbers) || phoneNumbers.length === 0) {
        alert('âŒ No phone numbers provided!');
        return;
    }
    
    const encodedMessage = encodeURIComponent(message);
    const baseUrl = 'https://wa.me/';
    
    let successCount = 0;
    
    phoneNumbers.forEach((phone, index) => {
        setTimeout(() => {
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            if (cleanPhone.length >= 10) {
                window.open(`${baseUrl}${cleanPhone}?text=${encodedMessage}`, '_blank');
                successCount++;
            }
        }, index * 2000); // 2 second delay between each
    });
    
    showAlert(`ðŸ“± Opening ${phoneNumbers.length} WhatsApp chats...`, 'info');
}

function showWhatsAppModal(type) {
    const modal = document.getElementById('printModal');
    const modalTitle = document.getElementById('printModalTitle');
    const modalBody = document.getElementById('printModalBody');

    modal.classList.add('active');

    switch(type) {
        case 'teacher':
            modalTitle.textContent = 'ðŸ‘¨â€ðŸ« Share Teacher Schedule via WhatsApp';
            modalBody.innerHTML = generateWhatsAppTeacherOptions();
            break;
        case 'class':
            modalTitle.textContent = 'ðŸ“š Share Class Routine via WhatsApp';
            modalBody.innerHTML = generateWhatsAppClassOptions();
            break;
        case 'day':
            modalTitle.textContent = 'ðŸ“… Share Day Schedule via WhatsApp';
            modalBody.innerHTML = generateWhatsAppDayOptions();
            break;
        case 'provisional':
            modalTitle.textContent = 'ðŸ”„ Share Provisional Routine via WhatsApp';
            modalBody.innerHTML = generateWhatsAppProvisionalOptions();
            break;
        case 'custom':
            modalTitle.textContent = 'âœï¸ Custom WhatsApp Message';
            modalBody.innerHTML = generateWhatsAppCustomOptions();
            break;
    }
}

// Generate WhatsApp Teacher Options
function generateWhatsAppTeacherOptions() {
    const teachers = DB.get('teachers');
    
    if (teachers.length === 0) {
        return '<p style="padding:20px; text-align:center; color:#999;">No teacher data available.</p>';
    }

    let html = '<div class="form-group">';
    html += '<label>Select Teacher:</label>';
    html += '<select id="whatsappTeacher" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    teachers.forEach(teacher => {
        html += `<option value="${teacher.id}">${teacher.name}</option>`;
    });
    html += '</select></div>';
    
    html += '<div class="form-group" style="margin-top:15px;">';
    html += '<label>Language / à¦­à¦¾à¦·à¦¾:</label>';
    html += '<select id="whatsappLanguage" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    html += '<option value="en">ðŸ‡¬ðŸ‡§ English</option>';
    html += '<option value="bn">ðŸ‡§ðŸ‡© à¦¬à¦¾à¦‚à¦²à¦¾ (Bengali)</option>';
    html += '</select></div>';
    
    html += '<div class="form-group" style="margin-top:15px;">';
    html += '<label>Teacher Phone Number (Optional):</label>';
    html += '<input type="tel" id="teacherPhone" placeholder="Enter phone with country code (e.g., 919876543210)" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    html += '</div>';
    
    html += '<div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #2196F3;">';
    html += '<small><strong>ðŸ’¡ Tip:</strong> For bulk sending, add multiple numbers separated by commas</small>';
    html += '</div>';
    
    html += '<button class="btn btn-success" style="width:100%; margin-top:20px; padding:14px; background:#25D366;" onclick="shareTeacherScheduleEnhanced()">ðŸ“± Share on WhatsApp</button>';
    
    return html;
}

// Generate WhatsApp Class Options
function generateWhatsAppClassOptions() {
    const classes = DB.get('classes');
    
    if (classes.length === 0) {
        return '<p style="padding:20px; text-align:center; color:#999;">No class data available.</p>';
    }

    let html = '<div class="form-group">';
    html += '<label>Select Class:</label>';
    html += '<select id="whatsappClass" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    classes.forEach(cls => {
        html += `<option value="${cls.id}">${cls.name}</option>`;
    });
    html += '</select></div>';
    
    html += '<div class="form-group" style="margin-top:15px;">';
    html += '<label>Phone Number (Optional):</label>';
    html += '<input type="tel" id="classPhone" placeholder="Enter phone with country code (e.g., 919876543210)" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    html += '</div>';
    
    html += '<button class="btn btn-success" style="width:100%; margin-top:20px; padding:14px; background:#25D366;" onclick="shareClassRoutine()">ðŸ“± Share on WhatsApp</button>';
    
    return html;
}

// Generate WhatsApp Day Options
function generateWhatsAppDayOptions() {
    let html = '<div class="form-group">';
    html += '<label>Select Day:</label>';
    html += '<select id="whatsappDay" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    daysOrderPrint.forEach(day => {
        html += `<option value="${day}">${day.charAt(0) + day.slice(1).toLowerCase()}</option>`;
    });
    html += '</select></div>';
    
    html += '<div class="form-group" style="margin-top:15px;">';
    html += '<label>Phone Number (Optional):</label>';
    html += '<input type="tel" id="dayPhone" placeholder="Enter phone with country code (e.g., 919876543210)" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    html += '</div>';
    
    html += '<button class="btn btn-success" style="width:100%; margin-top:20px; padding:14px; background:#25D366;" onclick="shareDaySchedule()">ðŸ“± Share on WhatsApp</button>';
    
    return html;
}

// Generate WhatsApp Custom Options
function generateWhatsAppCustomOptions() {
    let html = '<div class="form-group">';
    html += '<label>Custom Message:</label>';
    html += '<textarea id="customWhatsappMessage" rows="8" placeholder="Type your custom routine message here..." style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px; font-family: monospace;"></textarea>';
    html += '</div>';
    
    html += '<div class="form-group" style="margin-top:15px;">';
    html += '<label>Phone Number (Optional):</label>';
    html += '<input type="tel" id="customPhone" placeholder="Enter phone with country code (e.g., 919876543210)" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    html += '</div>';
    
    html += '<button class="btn btn-success" style="width:100%; margin-top:20px; padding:14px; background:#25D366;" onclick="shareCustomMessage()">ðŸ“± Share on WhatsApp</button>';
    
    return html;
}

// Generate WhatsApp Provisional Options
function generateWhatsAppProvisionalOptions() {
    const provisionalRoutines = DB.get('provisionalRoutines');
    
    if (provisionalRoutines.length === 0) {
        return '<p style="padding:20px; text-align:center; color:#999;">No provisional routines available. Please create provisional routines first.</p>';
    }

    // Get unique dates from provisional routines
    const dates = [...new Set(provisionalRoutines.map(r => r.date))].sort().reverse();
    
    let html = '<div class="form-group">';
    html += '<label>Select Date:</label>';
    html += '<select id="provisionalDate" onchange="updateProvisionalPreview()" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    dates.forEach(date => {
        const formattedDate = new Date(date).toLocaleDateString('en-IN', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        html += `<option value="${date}">${formattedDate}</option>`;
    });
    html += '</select></div>';
    
    html += '<div id="provisionalPreview" style="background:#fff3cd; padding:15px; border-radius:8px; margin-top:15px; border-left:4px solid #FF9800;">';
    html += '<strong>Preview:</strong>';
    html += '<div id="provisionalPreviewContent" style="margin-top:10px; font-size:0.9em; white-space:pre-wrap; font-family:monospace;"></div>';
    html += '</div>';
    
    html += '<div class="form-group" style="margin-top:15px;">';
    html += '<label>Phone Number (Optional):</label>';
    html += '<input type="tel" id="provisionalPhone" placeholder="Enter phone with country code (e.g., 919876543210)" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e0e0e0; margin-top:10px;">';
    html += '</div>';
    
    html += '<button class="btn btn-success" style="width:100%; margin-top:20px; padding:14px; background:#FF9800;" onclick="shareProvisionalRoutine()">ðŸ“± Share Provisional Routine</button>';
    
    // Trigger preview update after DOM is ready
    setTimeout(() => updateProvisionalPreview(), 100);
    
    return html;
}

// Update Provisional Preview
function updateProvisionalPreview() {
    const selectedDate = document.getElementById('provisionalDate').value;
    const provisionalRoutines = DB.get('provisionalRoutines');
    const teachers = DB.get('teachers');
    const classes = DB.get('classes');
    const periods = DB.get('periods');
    
    const dateRoutines = provisionalRoutines.filter(r => r.date === selectedDate);
    
    let preview = `*ðŸ”„ PROVISIONAL ROUTINE*\n`;
    preview += `*Date:* ${new Date(selectedDate).toLocaleDateString('en-IN', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    })}\n`;
    preview += `*School:* Ramnagar High School\n`;
    preview += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    // Group by absent teacher
    const absentTeachers = [...new Set(dateRoutines.map(r => r.absentTeacherId))];
    
    absentTeachers.forEach(absentId => {
        const absentTeacher = teachers.find(t => t.id == absentId);
        const substitutions = dateRoutines.filter(r => r.absentTeacherId == absentId);
        
        preview += `*âŒ Absent:* ${absentTeacher ? absentTeacher.name : 'Unknown'}\n\n`;
        
        substitutions.forEach(sub => {
            const substituteTeacher = teachers.find(t => t.id == sub.substituteTeacherId);
            const cls = classes.find(c => c.id == sub.classId);
            const period = periods.find(p => p.id == sub.periodId);
            
            preview += `  â° Period ${sub.periodNumber} (${period ? period.time : '-'})\n`;
            preview += `     ðŸ“š Class: ${cls ? cls.name : '-'}\n`;
            preview += `     ðŸ“– Subject: ${sub.subject || '-'}\n`;
            preview += `     ðŸ‘¨â€ðŸ« Substitute: ${substituteTeacher ? substituteTeacher.name : '-'}\n`;
            preview += `     ðŸ“ Reason: ${sub.reason || 'Not specified'}\n\n`;
        });
    });
    
    preview += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    preview += `Generated by RHS PRMS v4.6`;
    
    document.getElementById('provisionalPreviewContent').textContent = preview;
}


// Share Teacher Schedule
function shareTeacherSchedule() {
    const teacherId = document.getElementById('whatsappTeacher').value;
    const phone = document.getElementById('teacherPhone').value.trim();
    
    const teachers = DB.get('teachers');
    const routines = DB.get('routines');
    const classes = DB.get('classes');
    const periods = DB.get('periods');
    
    const teacher = teachers.find(t => t.id == teacherId);
    const teacherRoutines = routines.filter(r => r.teacherId == teacherId);
    
    if (!teacher) {
        alert('Teacher not found!');
        return;
    }
    
    // Build WhatsApp message
    let message = `*ðŸ“š ROUTINE SCHEDULE*\n`;
    message += `*Teacher:* ${teacher.name}\n`;
    message += `*School:* Ramnagar High School, Durgapur\n`;
    message += `*Session:* 2024-25\n`;
    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    daysOrderPrint.forEach(day => {
        const dayRoutines = teacherRoutines.filter(r => r.day === day);
        
        if (dayRoutines.length > 0) {
            message += `*${day.charAt(0) + day.slice(1).toUpperCase()}*\n`;
            
            dayRoutines.sort((a, b) => parseInt(a.periodNumber) - parseInt(b.periodNumber));
            
            dayRoutines.forEach(routine => {
                const period = periods.find(p => p.id == routine.periodId);
                const cls = classes.find(c => c.id == routine.classId);
                
                message += `  â° Period ${routine.periodNumber} (${period ? period.time : '-'})\n`;
                message += `     ðŸ“– ${routine.subject || '-'} - ${cls ? cls.name : '-'}\n`;
            });
            
            message += `\n`;
        }
    });
    
    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    message += `Generated by RHS PRMS v4.6`;
    
    // Create WhatsApp URL
    const encodedMessage = encodeURIComponent(message);
    let whatsappUrl = '';
    
    if (phone) {
        whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
    } else {
        whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
    }
    
    // Open WhatsApp
    window.open(whatsappUrl, '_blank');
    closePrintModal();
}

// Share Class Routine
function shareClassRoutine() {
    const classId = document.getElementById('whatsappClass').value;
    const phone = document.getElementById('classPhone').value.trim();
    
    const classes = DB.get('classes');
    const routines = DB.get('routines');
    const teachers = DB.get('teachers');
    const periods = DB.get('periods');
    
    const cls = classes.find(c => c.id == classId);
    const classRoutines = routines.filter(r => r.classId == classId);
    
    if (!cls) {
        alert('Class not found!');
        return;
    }
    
    // Build WhatsApp message
    let message = `*ðŸ“š CLASS TIMETABLE*\n`;
    message += `*Class:* ${cls.name}\n`;
    message += `*School:* Ramnagar High School, Durgapur\n`;
    message += `*Session:* 2024-25\n`;
    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    daysOrderPrint.forEach(day => {
        const dayRoutines = classRoutines.filter(r => r.day === day);
        
        if (dayRoutines.length > 0) {
            message += `*${day.charAt(0) + day.slice(1).toUpperCase()}*\n`;
            
            dayRoutines.sort((a, b) => parseInt(a.periodNumber) - parseInt(b.periodNumber));
            
            dayRoutines.forEach(routine => {
                const period = periods.find(p => p.id == routine.periodId);
                const teacher = teachers.find(t => t.id == routine.teacherId);
                
                message += `  â° Period ${routine.periodNumber} (${period ? period.time : '-'})\n`;
                message += `     ðŸ“– ${routine.subject || '-'}\n`;
                message += `     ðŸ‘¨â€ðŸ« ${teacher ? teacher.name : '-'}\n`;
            });
            
            message += `\n`;
        }
    });
    
    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    message += `Generated by RHS PRMS v4.6`;
    
    // Create WhatsApp URL
    const encodedMessage = encodeURIComponent(message);
    let whatsappUrl = '';
    
    if (phone) {
        whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
    } else {
        whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
    }
    
    // Open WhatsApp
    window.open(whatsappUrl, '_blank');
    closePrintModal();
}

// Share Day Schedule
function shareDaySchedule() {
    const day = document.getElementById('whatsappDay').value;
    const phone = document.getElementById('dayPhone').value.trim();
    
    const classes = DB.get('classes');
    const routines = DB.get('routines');
    const teachers = DB.get('teachers');
    const periods = DB.get('periods');
    
    const dayRoutines = routines.filter(r => r.day === day);
    
    // Build WhatsApp message
    let message = `*ðŸ“… ${day.charAt(0) + day.slice(1).toUpperCase()} SCHEDULE*\n`;
    message += `*School:* Ramnagar High School, Durgapur\n`;
    message += `*Session:* 2024-25\n`;
    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    periods.forEach(period => {
        message += `*â° Period ${period.number} (${period.time})*\n`;
        
        classes.forEach(cls => {
            const routine = dayRoutines.find(r => r.periodNumber == period.number && r.classId == cls.id);
            
            if (routine) {
                const teacher = teachers.find(t => t.id == routine.teacherId);
                message += `  ${cls.name}: ${routine.subject || '-'} - ${teacher ? teacher.name : '-'}\n`;
            }
        });
        
        message += `\n`;
    });
    
    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    message += `Generated by RHS PRMS v4.6`;
    
    // Create WhatsApp URL
    const encodedMessage = encodeURIComponent(message);
    let whatsappUrl = '';
    
    if (phone) {
        whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
    } else {
        whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
    }
    
    // Open WhatsApp
    window.open(whatsappUrl, '_blank');
    closePrintModal();
}

// Share Custom Message
function shareCustomMessage() {
    const message = document.getElementById('customWhatsappMessage').value.trim();
    const phone = document.getElementById('customPhone').value.trim();
    
    if (!message) {
        alert('Please enter a message!');
        return;
    }
    
    // Create WhatsApp URL
    const encodedMessage = encodeURIComponent(message);
    let whatsappUrl = '';
    
    if (phone) {
        whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
    } else {
        whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
    }
    
    // Open WhatsApp
    window.open(whatsappUrl, '_blank');
    closePrintModal();
}

// Share Provisional Routine
function shareProvisionalRoutine() {
    const selectedDate = document.getElementById('provisionalDate').value;
    const phone = document.getElementById('provisionalPhone').value.trim();
    
    const provisionalRoutines = DB.get('provisionalRoutines');
    const teachers = DB.get('teachers');
    const classes = DB.get('classes');
    const periods = DB.get('periods');
    
    const dateRoutines = provisionalRoutines.filter(r => r.date === selectedDate);
    
    if (dateRoutines.length === 0) {
        alert('No provisional routines found for this date!');
        return;
    }
    
    // Build WhatsApp message
    let message = `*ðŸ”„ PROVISIONAL ROUTINE*\n`;
    message += `*Date:* ${new Date(selectedDate).toLocaleDateString('en-IN', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    })}\n`;
    message += `*School:* Ramnagar High School, Durgapur\n`;
    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    // Group by absent teacher
    const absentTeachers = [...new Set(dateRoutines.map(r => r.absentTeacherId))];
    
    absentTeachers.forEach(absentId => {
        const absentTeacher = teachers.find(t => t.id == absentId);
        const substitutions = dateRoutines.filter(r => r.absentTeacherId == absentId);
        
        message += `*âŒ Absent Teacher:* ${absentTeacher ? absentTeacher.name : 'Unknown'}\n\n`;
        
        substitutions.forEach(sub => {
            const substituteTeacher = teachers.find(t => t.id == sub.substituteTeacherId);
            const cls = classes.find(c => c.id == sub.classId);
            const period = periods.find(p => p.id == sub.periodId);
            
            message += `  â° *Period ${sub.periodNumber}* (${period ? period.time : '-'})\n`;
            message += `     ðŸ“š Class: ${cls ? cls.name : '-'}\n`;
            message += `     ðŸ“– Subject: ${sub.subject || '-'}\n`;
            message += `     ðŸ‘¨â€ðŸ« Substitute: ${substituteTeacher ? substituteTeacher.name : '-'}\n`;
            if (sub.reason) {
                message += `     ðŸ“ Reason: ${sub.reason}\n`;
            }
            message += `\n`;
        });
    });
    
    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    message += `âš ï¸ *Please note these temporary changes*\n`;
    message += `Generated by RHS PRMS v4.6`;
    
    // Create WhatsApp URL
    const encodedMessage = encodeURIComponent(message);
    let whatsappUrl = '';
    
    if (phone) {
        whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
    } else {
        whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
    }
    
    // Open WhatsApp
    window.open(whatsappUrl, '_blank');
    closePrintModal();
}



// ==================== USER MANAGEMENT & AUTHENTICATION SYSTEM ====================

// Simple password hashing (for demo - use bcrypt in production)
function hashPassword(password) {
    // Simple hash for demo (NOT secure for production!)
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return 'hash_' + Math.abs(hash).toString(36);
}

// Initialize default users
function initializeUsers() {
    const users = DB.get('systemUsers') || [];
    
    if (users.length === 0) {
        // Create default users
        const defaultUsers = [
            {
                id: 'user_' + Date.now(),
                username: 'admin',
                password: hashPassword('admin123'),
                fullName: 'AHM RHS',
                role: 'admin',
                email: 'admin@rhs.school',
                phone: '9876543210',
                status: 'active',
                created: new Date().toISOString(),
                lastLogin: null
            },
            {
                id: 'user_' + (Date.now() + 1),
                username: 'teacher',
                password: hashPassword('teacher123'),
                fullName: 'Sample Teacher',
                role: 'teacher',
                email: 'teacher@rhs.school',
                phone: '9876543211',
                status: 'active',
                created: new Date().toISOString(),
                lastLogin: null
            },
            {
                id: 'user_' + (Date.now() + 2),
                username: 'office',
                password: hashPassword('office123'),
                fullName: 'Office Staff',
                role: 'office',
                email: 'office@rhs.school',
                phone: '9876543212',
                status: 'active',
                created: new Date().toISOString(),
                lastLogin: null
            }
        ];
        
        DB.set('systemUsers', defaultUsers);
    }
}

// Load User Management
function loadUserManagement() {
    console.log('=== Loading User Management ===');
    
    // Initialize data
    initializeUsers();
    updateUserStats();
    loadUsersList();
    
    // Attach event listeners to top buttons
    setTimeout(() => {
        console.log('Attaching event listeners to buttons...');
        
        // Add New User button
        const btnAddUser = document.getElementById('btnAddUser');
        if (btnAddUser) {
            btnAddUser.onclick = function() {
                console.log('Add User button clicked!');
                showAddUserModal();
            };
            console.log('âœ… Add User button attached');
        } else {
            console.error('âŒ Add User button NOT found!');
        }
        
        // Change Password button
        const btnChangePassword = document.getElementById('btnChangePassword');
        if (btnChangePassword) {
            btnChangePassword.onclick = function() {
                console.log('Change Password button clicked!');
                showChangePasswordModal();
            };
            console.log('âœ… Change Password button attached');
        } else {
            console.error('âŒ Change Password button NOT found!');
        }
        
        // Login History button
        const btnLoginHistory = document.getElementById('btnLoginHistory');
        if (btnLoginHistory) {
            btnLoginHistory.onclick = function() {
                console.log('Login History button clicked!');
                showLoginHistoryModal();
            };
            console.log('âœ… Login History button attached');
        } else {
            console.error('âŒ Login History button NOT found!');
        }
        
        // Export Users button
        const btnExportUsers = document.getElementById('btnExportUsers');
        if (btnExportUsers) {
            btnExportUsers.onclick = function() {
                console.log('Export Users button clicked!');
                exportUsers();
            };
            console.log('âœ… Export Users button attached');
        } else {
            console.error('âŒ Export Users button NOT found!');
        }
        
        console.log('=== All event listeners attached! ===');
    }, 200);
}

// Update statistics
function updateUserStats() {
    const users = DB.get('systemUsers') || [];
    
    document.getElementById('totalUsersCount').textContent = users.length;
    document.getElementById('adminUsersCount').textContent = users.filter(u => u.role === 'admin').length;
    document.getElementById('teacherUsersCount').textContent = users.filter(u => u.role === 'teacher').length;
    document.getElementById('officeUsersCount').textContent = users.filter(u => u.role === 'office').length;
}

// Load users list
function loadUsersList() {
    const users = DB.get('systemUsers') || [];
    const tbody = document.getElementById('usersTableBody');
    
    if (!tbody) {
        console.error('usersTableBody element not found!');
        return;
    }
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">No users found</td></tr>';
        return;
    }
    
    let html = '';
    users.forEach(user => {
        const roleColor = user.role === 'admin' ? '#2196F3' : user.role === 'teacher' ? '#9C27B0' : '#4CAF50';
        const statusBadge = user.status === 'active' 
            ? '<span style="background: #4CAF50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em;">Active</span>'
            : '<span style="background: #f44336; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em;">Inactive</span>';
        
        html += `
            <tr>
                <td><strong>${user.username}</strong></td>
                <td>${user.fullName}</td>
                <td><span style="background: ${roleColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em;">${user.role.toUpperCase()}</span></td>
                <td>${user.email || '-'}</td>
                <td>${user.phone || '-'}</td>
                <td>${statusBadge}</td>
                <td>${new Date(user.created).toLocaleDateString('en-IN')}</td>
                <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleString('en-IN') : 'Never'}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="window.editUser('${user.id}')" style="margin: 2px;">âœï¸ Edit</button>
                    <button class="btn btn-sm btn-warning" onclick="window.resetUserPassword('${user.id}')" style="margin: 2px;">ðŸ”‘ Reset</button>
                    ${user.username !== 'admin' ? `<button class="btn btn-sm btn-danger" onclick="window.deleteUser('${user.id}')" style="margin: 2px;">ðŸ—‘ï¸ Delete</button>` : ''}
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    console.log('Users table loaded with', users.length, 'users');
}

// Show Add User Modal
function showAddUserModal() {
    console.log('showAddUserModal called - creating modal...');
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <button class="modal-close" onclick="this.closest('.modal').remove()" style="position: absolute; top: 15px; right: 15px; background: #f44336; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; line-height: 1;">Ã—</button>
            <h2 style="margin: 0 0 25px 0; color: #333; font-size: 24px;">âž• Add New User</h2>
            <form id="addUserForm" style="display: flex; flex-direction: column; gap: 20px;">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #555; font-size: 14px;">Username *</label>
                    <input type="text" id="newUsername" required pattern="[a-zA-Z0-9_]+" title="Only letters, numbers and underscore" 
                           style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; transition: border 0.3s;"
                           onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #555; font-size: 14px;">Full Name *</label>
                    <input type="text" id="newFullName" required
                           style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; transition: border 0.3s;"
                           onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #555; font-size: 14px;">Password *</label>
                    <input type="password" id="newPassword" required minlength="6"
                           style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; transition: border 0.3s;"
                           onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #555; font-size: 14px;">Role *</label>
                    <select id="newRole" required
                            style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; background: white; cursor: pointer; transition: border 0.3s;"
                            onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
                        <option value="">-- Select Role --</option>
                        <option value="admin">ðŸ‘¨â€ðŸ’¼ Admin</option>
                        <option value="teacher">ðŸ‘¨â€ðŸ« Teacher</option>
                        <option value="office">ðŸ“‹ Office Staff</option>
                    </select>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #555; font-size: 14px;">Email</label>
                    <input type="email" id="newEmail"
                           style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; transition: border 0.3s;"
                           onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #555; font-size: 14px;">Phone</label>
                    <input type="tel" id="newPhone" pattern="[0-9]{10}" placeholder="10 digits"
                           style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; transition: border 0.3s;"
                           onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
                </div>
                <button type="submit" class="btn btn-success" 
                        style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s;"
                        onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                    ðŸ’¾ Create User
                </button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Add form submit handler
    document.getElementById('addUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveNewUser(e);
    });
    
    console.log('Modal created and appended to body');
    console.log('Modal element:', modal);
    console.log('Modal classes:', modal.className);
    console.log('Modal display style:', window.getComputedStyle(modal).display);
}

// Save New User
function saveNewUser(e) {
    e.preventDefault();
    
    const users = DB.get('systemUsers') || [];
    const username = document.getElementById('newUsername').value.trim();
    
    // Check if username exists
    if (users.find(u => u.username === username)) {
        showAlert('âŒ Username already exists!', 'error');
        return;
    }
    
    const newUser = {
        id: 'user_' + Date.now(),
        username: username,
        password: hashPassword(document.getElementById('newPassword').value),
        fullName: document.getElementById('newFullName').value,
        role: document.getElementById('newRole').value,
        email: document.getElementById('newEmail').value,
        phone: document.getElementById('newPhone').value,
        status: 'active',
        created: new Date().toISOString(),
        lastLogin: null
    };
    
    users.push(newUser);
    DB.set('systemUsers', users);
    
    showAlert('âœ… User created successfully!', 'success');
    document.querySelector('.modal').remove();
    loadUserManagement();
    
    // Send notification
    NotificationCenter.add({
        title: 'ðŸ‘¥ New User Created',
        message: `User "${newUser.fullName}" (${newUser.role}) has been added`,
        type: 'success',
        category: 'system'
    });
}

// Edit User
function editUser(userId) {
    console.log('Edit User called with ID:', userId);
    
    const users = DB.get('systemUsers') || [];
    const user = users.find(u => u.id === userId);
    
    console.log('Found user:', user);
    
    if (!user) {
        showAlert('âŒ User not found!', 'error');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 600px;">
            <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
            <h2>âœï¸ Edit User</h2>
            <form onsubmit="updateUser(event, '${userId}')">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" value="${user.username}" disabled style="background: #f5f5f5; cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="editFullName" value="${user.fullName}" required>
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="editRole" required>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>ðŸ‘¨â€ðŸ’¼ Admin</option>
                        <option value="teacher" ${user.role === 'teacher' ? 'selected' : ''}>ðŸ‘¨â€ðŸ« Teacher</option>
                        <option value="office" ${user.role === 'office' ? 'selected' : ''}>ðŸ“‹ Office Staff</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editEmail" value="${user.email || ''}">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="editPhone" value="${user.phone || ''}" pattern="[0-9]{10}">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editStatus">
                        <option value="active" ${user.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="inactive" ${user.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ðŸ’¾ Update User</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

// Update User
function updateUser(e, userId) {
    e.preventDefault();
    
    const users = DB.get('systemUsers') || [];
    const userIndex = users.findIndex(u => u.id === userId);
    
    if (userIndex === -1) return;
    
    users[userIndex].fullName = document.getElementById('editFullName').value;
    users[userIndex].role = document.getElementById('editRole').value;
    users[userIndex].email = document.getElementById('editEmail').value;
    users[userIndex].phone = document.getElementById('editPhone').value;
    users[userIndex].status = document.getElementById('editStatus').value;
    
    DB.set('systemUsers', users);
    
    showAlert('âœ… User updated successfully!', 'success');
    document.querySelector('.modal').remove();
    loadUserManagement();
}

// Reset User Password
function resetUserPassword(userId) {
    const users = DB.get('systemUsers') || [];
    const user = users.find(u => u.id === userId);
    
    if (!user) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 500px;">
            <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
            <h2>ðŸ”‘ Reset Password</h2>
            <p>Reset password for: <strong>${user.fullName}</strong> (${user.username})</p>
            <form onsubmit="executePasswordReset(event, '${userId}')">
                <div class="form-group">
                    <label>New Password *</label>
                    <input type="password" id="resetPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <input type="password" id="resetPasswordConfirm" required minlength="6">
                </div>
                <button type="submit" class="btn btn-warning" style="width: 100%;">ðŸ”‘ Reset Password</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

// Execute Password Reset
function executePasswordReset(e, userId) {
    e.preventDefault();
    
    const newPass = document.getElementById('resetPassword').value;
    const confirmPass = document.getElementById('resetPasswordConfirm').value;
    
    if (newPass !== confirmPass) {
        showAlert('âŒ Passwords do not match!', 'error');
        return;
    }
    
    const users = DB.get('systemUsers') || [];
    const userIndex = users.findIndex(u => u.id === userId);
    
    if (userIndex === -1) return;
    
    users[userIndex].password = hashPassword(newPass);
    DB.set('systemUsers', users);
    
    showAlert('âœ… Password reset successfully!', 'success');
    document.querySelector('.modal').remove();
}

// Delete User
function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
    }
    
    const users = DB.get('systemUsers') || [];
    const user = users.find(u => u.id === userId);
    
    const filteredUsers = users.filter(u => u.id !== userId);
    DB.set('systemUsers', filteredUsers);
    
    showAlert('âœ… User deleted successfully!', 'success');
    loadUserManagement();
    
    // Send notification
    NotificationCenter.add({
        title: 'ðŸ‘¥ User Deleted',
        message: `User "${user.fullName}" has been removed`,
        type: 'warning',
        category: 'system'
    });
}

// Show Change Password Modal (for current user)
function showChangePasswordModal() {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 500px;">
            <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
            <h2>ðŸ”‘ Change Your Password</h2>
            <form onsubmit="changeOwnPassword(event)">
                <div class="form-group">
                    <label>Current Password *</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="form-group">
                    <label>New Password *</label>
                    <input type="password" id="newPasswordOwn" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirm New Password *</label>
                    <input type="password" id="newPasswordConfirmOwn" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ðŸ”‘ Change Password</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

// Change Own Password
function changeOwnPassword(e) {
    e.preventDefault();
    
    const currentUsername = sessionStorage.getItem('currentUsername') || 'admin';
    const currentPass = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPasswordOwn').value;
    const confirmPass = document.getElementById('newPasswordConfirmOwn').value;
    
    if (newPass !== confirmPass) {
        showAlert('âŒ New passwords do not match!', 'error');
        return;
    }
    
    const users = DB.get('systemUsers') || [];
    const user = users.find(u => u.username === currentUsername);
    
    if (!user || user.password !== hashPassword(currentPass)) {
        showAlert('âŒ Current password is incorrect!', 'error');
        return;
    }
    
    user.password = hashPassword(newPass);
    DB.set('systemUsers', users);
    
    showAlert('âœ… Password changed successfully!', 'success');
    document.querySelector('.modal').remove();
}

// Show Login History
function showLoginHistoryModal() {
    const loginHistory = DB.get('loginHistory') || [];
    
    let html = '';
    if (loginHistory.length === 0) {
        html = '<p style="text-align: center; padding: 40px; color: #999;">No login history available</p>';
    } else {
        html = '<table class="data-table"><thead><tr><th>User</th><th>Role</th><th>Login Time</th></tr></thead><tbody>';
        loginHistory.slice(-20).reverse().forEach(log => {
            html += `<tr>
                <td>${log.username}</td>
                <td>${log.role}</td>
                <td>${new Date(log.loginTime).toLocaleString('en-IN')}</td>
            </tr>`;
        });
        html += '</tbody></table>';
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 700px;">
            <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
            <h2>ðŸ“‹ Login History (Last 20 Logins)</h2>
            <div style="max-height: 400px; overflow-y: auto;">
                ${html}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Export Users
function exportUsers() {
    const users = DB.get('systemUsers') || [];
    
    if (users.length === 0) {
        showAlert('âŒ No users to export!', 'error');
        return;
    }
    
    // CSV Headers
    const headers = ['Username', 'Full Name', 'Role', 'Email', 'Phone', 'Status', 'Created', 'Last Login'];
    
    // CSV Rows
    const rows = users.map(u => [
        u.username,
        u.fullName,
        u.role.toUpperCase(),
        u.email || '-',
        u.phone || '-',
        u.status,
        new Date(u.created).toLocaleString('en-IN'),
        u.lastLogin ? new Date(u.lastLogin).toLocaleString('en-IN') : 'Never'
    ]);
    
    // Convert to CSV format
    const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => {
            // Escape cells that contain commas or quotes
            const cellStr = String(cell);
            if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                return `"${cellStr.replace(/"/g, '""')}"`;
            }
            return cellStr;
        }).join(','))
    ].join('\n');
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `RHS_Users_Export_${new Date().toISOString().split('T')[0]}.csv`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showAlert('âœ… Users exported successfully!', 'success');
    
    // Send notification
    NotificationCenter.add({
        title: 'ðŸ“¥ Users Exported',
        message: `${users.length} users exported to CSV`,
        type: 'success',
        category: 'system'
    });
}

// âœ… Make all user management functions globally accessible immediately
window.editUser = editUser;
window.deleteUser = deleteUser;
window.resetUserPassword = resetUserPassword;
window.showAddUserModal = showAddUserModal;
window.showChangePasswordModal = showChangePasswordModal;
window.showLoginHistoryModal = showLoginHistoryModal;
window.exportUsers = exportUsers;
window.saveNewUser = saveNewUser;
window.updateUser = updateUser;
window.executePasswordReset = executePasswordReset;
window.changeOwnPassword = changeOwnPassword;
window.loadUserManagement = loadUserManagement;
window.loadUsersList = loadUsersList;
window.updateUserStats = updateUserStats;

// Update login function to work with new system
function updateLoginSystem() {
    const users = DB.get('systemUsers') || [];
    initializeUsers();
}

// ==================== QUICK SEARCH SYSTEM ====================

let searchTimeout = null;

function performQuickSearch(event) {
    const input = document.getElementById('quickSearchInput');
    const query = input.value.trim().toLowerCase();
    const clearBtn = document.querySelector('.search-clear-btn');
    
    // Show/hide clear button
    clearBtn.style.display = query ? 'block' : 'none';
    
    // Clear previous timeout
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    // Debounce search
    searchTimeout = setTimeout(() => {
        if (query.length > 0) {
            executeQuickSearch(query);
            showSearchResults();
        } else {
            hideSearchResults();
        }
    }, 300);
    
    // ESC to close
    if (event.key === 'Escape') {
        clearQuickSearch();
    }
    
    // Enter to select first result
    if (event.key === 'Enter' && query.length > 0) {
        const firstResult = document.querySelector('.search-result-item');
        if (firstResult) {
            firstResult.click();
        }
    }
}

function executeQuickSearch(query) {
    const results = {
        teachers: [],
        classes: [],
        subjects: [],
        pages: []
    };
    
    // Search Teachers
    const teachers = DB.get('teachers') || [];
    teachers.forEach(teacher => {
        if (teacher.name.toLowerCase().includes(query) || 
            (teacher.email && teacher.email.toLowerCase().includes(query)) ||
            (teacher.phone && teacher.phone.includes(query))) {
            results.teachers.push({
                id: teacher.id,
                title: teacher.name,
                subtitle: teacher.email || teacher.phone || 'Teacher',
                icon: 'ðŸ‘¨â€ðŸ«',
                action: () => {
                    showTab('teachers');
                    setTimeout(() => {
                        const row = document.querySelector(`tr[data-id="${teacher.id}"]`);
                        if (row) {
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            row.style.background = '#fff3cd';
                            setTimeout(() => row.style.background = '', 2000);
                        }
                    }, 500);
                }
            });
        }
    });
    
    // Search Classes
    const classes = DB.get('classes') || [];
    classes.forEach(cls => {
        if (cls.name.toLowerCase().includes(query)) {
            results.classes.push({
                id: cls.id,
                title: cls.name,
                subtitle: `Class - ${cls.section || ''}`,
                icon: 'ðŸ«',
                action: () => {
                    showTab('classes');
                    setTimeout(() => {
                        const row = document.querySelector(`tr[data-id="${cls.id}"]`);
                        if (row) {
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            row.style.background = '#fff3cd';
                            setTimeout(() => row.style.background = '', 2000);
                        }
                    }, 500);
                }
            });
        }
    });
    
    // Search Subjects
    const subjects = DB.get('subjects') || [];
    subjects.forEach(subject => {
        if (subject.name.toLowerCase().includes(query) || 
            (subject.code && subject.code.toLowerCase().includes(query))) {
            results.subjects.push({
                id: subject.id,
                title: subject.name,
                subtitle: subject.code || 'Subject',
                icon: 'ðŸ“š',
                action: () => {
                    showTab('subjects');
                    setTimeout(() => {
                        const row = document.querySelector(`tr[data-id="${subject.id}"]`);
                        if (row) {
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            row.style.background = '#fff3cd';
                            setTimeout(() => row.style.background = '', 2000);
                        }
                    }, 500);
                }
            });
        }
    });
    
    // Search Pages/Tabs
    const pages = [
        { name: 'Dashboard', icon: 'ðŸ“Š', tab: 'dashboard' },
        { name: 'Teachers', icon: 'ðŸ‘¨â€ðŸ«', tab: 'teachers' },
        { name: 'Subjects', icon: 'ðŸ“š', tab: 'subjects' },
        { name: 'Classes', icon: 'ðŸ«', tab: 'classes' },
        { name: 'Periods', icon: 'â°', tab: 'periods' },
        { name: 'Routine', icon: 'ðŸ“‹', tab: 'routine' },
        { name: 'Attendance', icon: 'âœ…', tab: 'attendance' },
        { name: 'Provisional', icon: 'ðŸ”„', tab: 'provisional' },
        { name: 'Substitute', icon: 'ðŸ‘¥', tab: 'substitute' },
        { name: 'Exam Management', icon: 'ðŸŽ“', tab: 'exam' },
        { name: 'Communication', icon: 'ðŸ’¬', tab: 'communication' },
        { name: 'Settings', icon: 'âš™ï¸', tab: 'settings' },
        { name: 'Calendar', icon: 'ðŸ“…', tab: 'calendar' },
        { name: 'Analytics', icon: 'ðŸ“ˆ', tab: 'analytics' },
        { name: 'Bulk Upload', icon: 'ðŸ“Š', tab: 'bulkupload' },
        { name: 'Print Options', icon: 'ðŸ–¨ï¸', tab: 'print' }
    ];
    
    pages.forEach(page => {
        if (page.name.toLowerCase().includes(query)) {
            results.pages.push({
                title: page.name,
                subtitle: 'Navigate to page',
                icon: page.icon,
                action: () => showTab(page.tab)
            });
        }
    });
    
    displaySearchResults(results);
}

function displaySearchResults(results) {
    const container = document.getElementById('quickSearchResults');
    let html = '';
    
    const totalResults = results.teachers.length + results.classes.length + 
                        results.subjects.length + results.pages.length;
    
    if (totalResults === 0) {
        html = `<div class="search-no-results">
            <div style="font-size: 3em; margin-bottom: 10px;">ðŸ”</div>
            <div>No results found</div>
            <div style="font-size: 0.9em; color: #999; margin-top: 5px;">Try different keywords</div>
        </div>`;
    } else {
        // Teachers
        if (results.teachers.length > 0) {
            html += '<div class="search-category">ðŸ‘¨â€ðŸ« Teachers</div>';
            results.teachers.slice(0, 5).forEach(item => {
                html += createSearchResultItem(item);
            });
            if (results.teachers.length > 5) {
                html += `<div style="padding: 8px 15px; text-align: center; color: #666; font-size: 0.85em;">+${results.teachers.length - 5} more teachers</div>`;
            }
        }
        
        // Classes
        if (results.classes.length > 0) {
            html += '<div class="search-category">ðŸ« Classes</div>';
            results.classes.slice(0, 5).forEach(item => {
                html += createSearchResultItem(item);
            });
            if (results.classes.length > 5) {
                html += `<div style="padding: 8px 15px; text-align: center; color: #666; font-size: 0.85em;">+${results.classes.length - 5} more classes</div>`;
            }
        }
        
        // Subjects
        if (results.subjects.length > 0) {
            html += '<div class="search-category">ðŸ“š Subjects</div>';
            results.subjects.slice(0, 5).forEach(item => {
                html += createSearchResultItem(item);
            });
            if (results.subjects.length > 5) {
                html += `<div style="padding: 8px 15px; text-align: center; color: #666; font-size: 0.85em;">+${results.subjects.length - 5} more subjects</div>`;
            }
        }
        
        // Pages
        if (results.pages.length > 0) {
            html += '<div class="search-category">ðŸ“„ Pages</div>';
            results.pages.forEach(item => {
                html += createSearchResultItem(item);
            });
        }
    }
    
    container.innerHTML = html;
}

function createSearchResultItem(item) {
    const itemId = 'search_' + Date.now() + Math.random();
    
    // Store action in global scope
    window[itemId] = () => {
        if (item.action) {
            item.action();
            clearQuickSearch();
        }
    };
    
    return `
        <div class="search-result-item" onclick="${itemId}()">
            <div class="search-result-icon">${item.icon}</div>
            <div class="search-result-content">
                <div class="search-result-title">${item.title}</div>
                <div class="search-result-subtitle">${item.subtitle}</div>
            </div>
            <span class="search-shortcut">â†µ</span>
        </div>
    `;
}

function showSearchResults() {
    const results = document.getElementById('quickSearchResults');
    results.classList.add('show');
}

function hideSearchResults() {
    const results = document.getElementById('quickSearchResults');
    results.classList.remove('show');
}

function clearQuickSearch() {
    document.getElementById('quickSearchInput').value = '';
    document.querySelector('.search-clear-btn').style.display = 'none';
    hideSearchResults();
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.quick-search-container')) {
        hideSearchResults();
    }
});

// Keyboard shortcut: Ctrl+K to focus search
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('quickSearchInput').focus();
    }
});

// ==================== CALENDAR & PLANNER SYSTEM ====================

let currentCalendarDate = new Date();
let currentCalendarView = 'month';

// Initialize Calendar
function loadCalendar() {
    renderCalendar();
    loadUpcomingEvents();
}

// Render calendar based on current view
function renderCalendar() {
    if (currentCalendarView === 'month') {
        renderMonthView();
    } else if (currentCalendarView === 'week') {
        renderWeekView();
    } else if (currentCalendarView === 'agenda') {
        renderAgendaView();
    }
}

// Render Month View
function renderMonthView() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    document.getElementById('calendarMonthYear').textContent = 
        new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    const events = DB.get('calendarEvents') || [];
    const holidays = DB.get('holidays') || [];
    const exams = DB.get('examDates') || [];
    
    let html = '';
    
    // Day headers
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
    });
    
    // Previous month days
    for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
    }
    
    // Current month days
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        
        const dayEvents = events.filter(e => e.date === dateStr);
        const dayHolidays = holidays.filter(h => h.date === dateStr);
        const dayExams = exams.filter(e => e.date === dateStr);
        
        const isToday = date.toDateString() === today.toDateString();
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (dayEvents.length > 0) classes += ' has-event';
        if (dayHolidays.length > 0) classes += ' has-holiday';
        if (dayExams.length > 0) classes += ' has-exam';
        
        html += `<div class="${classes}" onclick="showDayDetails('${dateStr}')">
            <div class="calendar-day-number">${day}</div>`;
        
        [...dayEvents, ...dayHolidays, ...dayExams].slice(0, 3).forEach(item => {
            const badge = item.type === 'holiday' ? 'holiday-badge' : 
                         item.type === 'exam' ? 'exam-badge' : 'event-badge';
            html += `<div class="calendar-event-item ${badge}">${item.title}</div>`;
        });
        
        if (dayEvents.length + dayHolidays.length + dayExams.length > 3) {
            html += `<div style="font-size: 0.7em; color: #666;">+${dayEvents.length + dayHolidays.length + dayExams.length - 3} more</div>`;
        }
        
        html += `</div>`;
    }
    
    document.getElementById('calendarGrid').innerHTML = html;
}

// Render Week View
function renderWeekView() {
    const startOfWeek = new Date(currentCalendarDate);
    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
    
    let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">';
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(date.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        
        const events = DB.get('calendarEvents') || [];
        const holidays = DB.get('holidays') || [];
        const exams = DB.get('examDates') || [];
        
        const dayItems = [
            ...events.filter(e => e.date === dateStr),
            ...holidays.filter(h => h.date === dateStr),
            ...exams.filter(e => e.date === dateStr)
        ];
        
        html += `<div class="card">
            <h4>${date.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' })}</h4>`;
        
        dayItems.forEach(item => {
            const badge = item.type === 'holiday' ? 'holiday-badge' : 
                         item.type === 'exam' ? 'exam-badge' : 'event-badge';
            html += `<div class="calendar-event-item ${badge}" style="margin: 5px 0;">${item.title}</div>`;
        });
        
        if (dayItems.length === 0) {
            html += `<p style="color: #999; font-size: 0.9em;">No events</p>`;
        }
        
        html += `</div>`;
    }
    
    html += '</div>';
    document.getElementById('weekCalendarGrid').innerHTML = html;
}

// Render Agenda View
function renderAgendaView() {
    const events = DB.get('calendarEvents') || [];
    const holidays = DB.get('holidays') || [];
    const exams = DB.get('examDates') || [];
    
    const allItems = [...events, ...holidays, ...exams]
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .filter(item => new Date(item.date) >= new Date().setHours(0,0,0,0));
    
    let html = '';
    
    if (allItems.length === 0) {
        html = '<p style="text-align: center; padding: 40px; color: #999;">No upcoming events</p>';
    } else {
        allItems.forEach(item => {
            const icon = item.type === 'holiday' ? 'ðŸ–ï¸' : item.type === 'exam' ? 'ðŸŽ“' : 'ðŸ“…';
            const badge = item.type === 'holiday' ? 'holiday-badge' : 
                         item.type === 'exam' ? 'exam-badge' : 'event-badge';
            
            html += `<div style="padding: 15px; border-left: 4px solid ${item.type === 'holiday' ? '#FF9800' : item.type === 'exam' ? '#2196F3' : '#4CAF50'}; background: #f9f9f9; margin-bottom: 10px; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div style="font-size: 1.5em;">${icon}</div>
                        <strong>${item.title}</strong>
                        <p style="margin: 5px 0; color: #666;">${item.description || ''}</p>
                        <small style="color: #999;">${new Date(item.date).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</small>
                    </div>
                    <span class="calendar-event-item ${badge}">${item.type}</span>
                </div>
            </div>`;
        });
    }
    
    document.getElementById('agendaList').innerHTML = html;
}

// Switch calendar view
function switchCalendarView(view) {
    currentCalendarView = view;
    
    document.getElementById('monthViewCalendar').style.display = view === 'month' ? 'block' : 'none';
    document.getElementById('weekViewCalendar').style.display = view === 'week' ? 'block' : 'none';
    document.getElementById('agendaViewCalendar').style.display = view === 'agenda' ? 'block' : 'none';
    
    document.querySelectorAll('[id$="ViewBtn"]').forEach(btn => btn.className = 'btn btn-secondary');
    document.getElementById(view + 'ViewBtn').className = 'btn btn-primary';
    
    renderCalendar();
}

// Change month
function changeCalendarMonth(delta) {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
    renderCalendar();
}

// Go to today
function goToToday() {
    currentCalendarDate = new Date();
    renderCalendar();
}

// Show day details
function showDayDetails(dateStr) {
    const date = new Date(dateStr);
    const events = DB.get('calendarEvents') || [];
    const holidays = DB.get('holidays') || [];
    const exams = DB.get('examDates') || [];
    
    const dayItems = [
        ...events.filter(e => e.date === dateStr),
        ...holidays.filter(h => h.date === dateStr),
        ...exams.filter(e => e.date === dateStr)
    ];
    
    let html = '';
    if (dayItems.length === 0) {
        html = '<p style="padding: 20px; text-align: center; color: #999;">No events on this day</p>';
    } else {
        dayItems.forEach(item => {
            const icon = item.type === 'holiday' ? 'ðŸ–ï¸' : item.type === 'exam' ? 'ðŸŽ“' : 'ðŸ“…';
            html += `<div style="padding: 15px; background: #f9f9f9; margin-bottom: 10px; border-radius: 4px;">
                <div style="font-size: 1.5em; margin-bottom: 5px;">${icon}</div>
                <strong>${item.title}</strong>
                <p style="margin: 5px 0;">${item.description || ''}</p>
            </div>`;
        });
    }
    
    showModal(date.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }), html);
}

// Add Event
function addCalendarEvent() {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 600px;">
            <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
            <h2>ðŸ“… Add Event</h2>
            <form onsubmit="saveCalendarEvent(event)">
                <div class="form-group">
                    <label>Event Title *</label>
                    <input type="text" id="eventTitle" required>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="eventDate" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="eventDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ðŸ’¾ Save Event</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function saveCalendarEvent(e) {
    e.preventDefault();
    const events = DB.get('calendarEvents') || [];
    events.push({
        id: Date.now(),
        title: document.getElementById('eventTitle').value,
        date: document.getElementById('eventDate').value,
        description: document.getElementById('eventDescription').value,
        type: 'event'
    });
    DB.set('calendarEvents', events);
    showAlert('âœ… Event added!', 'success');
    document.querySelector('.modal').remove();
    renderCalendar();
    loadUpcomingEvents();
    
    // Send notification
    NotificationCenter.add({
        title: 'ðŸ“… New Event Added',
        message: document.getElementById('eventTitle').value + ' on ' + document.getElementById('eventDate').value,
        type: 'info',
        category: 'general'
    });
}

// Add Holiday
function addCalendarHoliday() {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 600px;">
            <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
            <h2>ðŸ–ï¸ Add Holiday</h2>
            <form onsubmit="saveCalendarHoliday(event)">
                <div class="form-group">
                    <label>Holiday Name *</label>
                    <input type="text" id="holidayTitle" required>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="holidayDate" required>
                </div>
                <button type="submit" class="btn btn-warning" style="width: 100%;">ðŸ’¾ Save Holiday</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function saveCalendarHoliday(e) {
    e.preventDefault();
    const holidays = DB.get('holidays') || [];
    holidays.push({
        id: Date.now(),
        title: document.getElementById('holidayTitle').value,
        date: document.getElementById('holidayDate').value,
        type: 'holiday'
    });
    DB.set('holidays', holidays);
    showAlert('âœ… Holiday added!', 'success');
    document.querySelector('.modal').remove();
    renderCalendar();
    loadUpcomingEvents();
}

// Add Exam
function addCalendarExam() {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 600px;">
            <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
            <h2>ðŸŽ“ Add Exam</h2>
            <form onsubmit="saveCalendarExam(event)">
                <div class="form-group">
                    <label>Exam Title *</label>
                    <input type="text" id="examTitle" required>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="examDate" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="examDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-info" style="width: 100%;">ðŸ’¾ Save Exam</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function saveCalendarExam(e) {
    e.preventDefault();
    const exams = DB.get('examDates') || [];
    exams.push({
        id: Date.now(),
        title: document.getElementById('examTitle').value,
        date: document.getElementById('examDate').value,
        description: document.getElementById('examDescription').value,
        type: 'exam'
    });
    DB.set('examDates', exams);
    showAlert('âœ… Exam added!', 'success');
    document.querySelector('.modal').remove();
    renderCalendar();
    loadUpcomingEvents();
    
    // Send notification
    NotificationCenter.add({
        title: 'ðŸŽ“ Exam Scheduled',
        message: document.getElementById('examTitle').value + ' on ' + document.getElementById('examDate').value,
        type: 'info',
        category: 'exam',
        sendEmail: true
    });
}

// Load upcoming events
function loadUpcomingEvents() {
    const events = DB.get('calendarEvents') || [];
    const holidays = DB.get('holidays') || [];
    const exams = DB.get('examDates') || [];
    
    const allItems = [...events, ...holidays, ...exams]
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .filter(item => new Date(item.date) >= new Date().setHours(0,0,0,0))
        .slice(0, 10);
    
    let html = '';
    if (allItems.length === 0) {
        html = '<p style="text-align: center; padding: 20px; color: #999;">No upcoming events</p>';
    } else {
        allItems.forEach(item => {
            const icon = item.type === 'holiday' ? 'ðŸ–ï¸' : item.type === 'exam' ? 'ðŸŽ“' : 'ðŸ“…';
            const daysUntil = Math.ceil((new Date(item.date) - new Date()) / (1000 * 60 * 60 * 24));
            
            html += `<div style="padding: 12px; border-left: 4px solid ${item.type === 'holiday' ? '#FF9800' : item.type === 'exam' ? '#2196F3' : '#4CAF50'}; background: #f9f9f9; margin-bottom: 8px; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 1.2em; margin-right: 8px;">${icon}</span>
                        <strong>${item.title}</strong>
                    </div>
                    <small style="color: #666;">${daysUntil === 0 ? 'Today' : daysUntil === 1 ? 'Tomorrow' : `${daysUntil} days`}</small>
                </div>
            </div>`;
        });
    }
    
    document.getElementById('upcomingEventsList').innerHTML = html;
}

// View Academic Calendar
function viewAcademicCalendar() {
    const settings = DB.getObj('settings');
    showModal('ðŸ“† Academic Calendar', `
        <div style="line-height: 2;">
            <p><strong>Academic Year:</strong> ${settings.academicYear || '2025-26'}</p>
            <p><strong>Session Start:</strong> ${settings.sessionStart || 'Not set'}</p>
            <p><strong>Session End:</strong> ${settings.sessionEnd || 'Not set'}</p>
        </div>
    `);
}

// ==================== ENHANCED WHATSAPP & PRINT FUNCTIONS ====================

// Enhanced Teacher Schedule Share with Bengali
function shareTeacherScheduleEnhanced() {
    const teacherId = document.getElementById('whatsappTeacher').value;
    const phone = document.getElementById('teacherPhone').value.trim();
    const lang = document.getElementById('whatsappLanguage') ? document.getElementById('whatsappLanguage').value : 'en';
    
    const teachers = DB.get('teachers');
    const routines = DB.get('routines');
    
    const teacher = teachers.find(t => t.id == teacherId);
    const teacherRoutines = routines.filter(r => r.teacherId == teacherId).map(r => {
        const cls = DB.get('classes').find(c => c.id == r.classId);
        const period = DB.get('periods').find(p => p.id == r.periodId);
        return {
            period: r.periodNumber,
            time: period ? period.time : '-',
            className: cls ? cls.name : '-',
            subject: r.subject || '-',
            day: r.day
        };
    });
    
    if (!teacher) {
        alert('Teacher not found!');
        return;
    }
    
    // Use template
    const message = WHATSAPP_TEMPLATES.teacherSchedule(teacher, teacherRoutines, lang);
    
    // Handle multiple phone numbers
    const phones = phone.split(',').map(p => p.trim()).filter(p => p);
    
    if (phones.length > 1) {
        if (confirm(`Send to ${phones.length} contacts?`)) {
            sendBulkWhatsApp(phones, message);
        }
    } else {
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = phones.length === 1 
            ? `https://wa.me/${phones[0]}?text=${encodedMessage}`
            : `https://wa.me/?text=${encodedMessage}`;
        
        window.open(whatsappUrl, '_blank');
    }
    
    closePrintModal();
}

// Print Preview
function showPrintPreview(content, title = 'Print Preview') {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.id = 'printPreviewModal';
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 1200px; max-height: 90vh;">
            <button class="modal-close" onclick="closePrintPreview()">Ã—</button>
            <h2 style="color: var(--primary); margin-bottom: 20px;">ðŸ–¨ï¸ ${title}</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="executePrint()">ðŸ–¨ï¸ Print Now</button>
                <button class="btn btn-secondary" onclick="togglePrintOrientation()">ðŸ”„ Orientation</button>
            </div>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="printOrientation" value="portrait" checked>
                        Portrait (â†•ï¸)
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="printOrientation" value="landscape">
                        Landscape (â†”ï¸)
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="printWithHeader" checked>
                        Include Header
                    </label>
                </div>
            </div>
            
            <div id="printPreviewContent" style="background: white; padding: 20px; border: 1px solid #ddd; min-height: 400px; max-height: 60vh; overflow-y: auto;">
                ${content}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closePrintPreview() {
    const modal = document.getElementById('printPreviewModal');
    if (modal) modal.remove();
}

function executePrint() {
    const content = document.getElementById('printPreviewContent').innerHTML;
    const orientation = document.querySelector('input[name="printOrientation"]:checked').value;
    const withHeader = document.getElementById('printWithHeader').checked;
    
    const schoolInfo = DB.getObj('schoolInfo');
    let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Print</title><style>
        @page { size: A4 ${orientation}; margin: 1.5cm; }
        body { font-family: Arial; margin: 0; padding: 20px; color: #000; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #000; padding: 8px; }
    </style></head><body>`;
    
    if (withHeader) {
        html += `<div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px;">
            <h1>${schoolInfo.name || 'School'}</h1>
            <p>${schoolInfo.locality || ''}, ${schoolInfo.district || ''}</p>
        </div>`;
    }
    
    html += content + '</body></html>';
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    setTimeout(() => printWindow.print(), 500);
}

function togglePrintOrientation() {
    const portrait = document.querySelector('input[value="portrait"]');
    const landscape = document.querySelector('input[value="landscape"]');
    if (portrait.checked) landscape.checked = true;
    else portrait.checked = true;
    showAlert('ðŸ“„ Orientation changed', 'info');
}

// ==================== ðŸš€ TOP 3 AI-POWERED ROUTINE FEATURES ====================

// ==================== FEATURE 1: ðŸ¤– AI AUTO-GENERATE ROUTINE ====================

function autoGenerateRoutine() {
    console.log('ðŸ¤– AI Auto-Generate Routine Started...');
    
    // Get all required data
    const teachers = DB.get('teachers') || [];
    const subjects = DB.get('subjects') || [];
    const classes = DB.get('classes') || [];
    const periods = DB.get('periods') || [];
    
    // Validation
    if (teachers.length === 0 || subjects.length === 0 || classes.length === 0 || periods.length === 0) {
        showAlert('âŒ Please add Teachers, Subjects, Classes, and Periods first!', 'error');
        return;
    }
    
    // Show AI progress modal
    const progressModal = document.createElement('div');
    progressModal.className = 'modal show';
    progressModal.style.display = 'flex';
    progressModal.style.zIndex = '999999';
    progressModal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 500px; text-align: center; padding: 40px; background: white; border-radius: 12px;">
            <h2 style="margin-bottom: 20px; color: #667eea;">ðŸ¤– AI Generating Routine</h2>
            <div style="margin: 30px 0;">
                <div style="width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                    <div id="aiProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s;"></div>
                </div>
                <p id="aiStatusText" style="margin-top: 15px; font-size: 16px; color: #667eea; font-weight: 600;">Initializing AI Engine...</p>
            </div>
            <p style="font-size: 14px; color: #999;">This may take a few moments...</p>
        </div>
    `;
    document.body.appendChild(progressModal);
    
    const progressBar = document.getElementById('aiProgressBar');
    const statusText = document.getElementById('aiStatusText');
    
    // AI Generation Process with visual feedback
    setTimeout(() => {
        progressBar.style.width = '20%';
        statusText.textContent = 'ðŸ” Analyzing teacher availability...';
        
        setTimeout(() => {
            progressBar.style.width = '40%';
            statusText.textContent = 'ðŸ“Š Calculating subject distribution...';
            
            setTimeout(() => {
                progressBar.style.width = '60%';
                statusText.textContent = 'âš–ï¸ Optimizing workload balance...';
                
                setTimeout(() => {
                    progressBar.style.width = '80%';
                    statusText.textContent = 'âš¡ Resolving conflicts...';
                    
                    setTimeout(() => {
                        progressBar.style.width = '100%';
                        statusText.textContent = 'âœ¨ Finalizing routine...';
                        
                        // Actually generate the routine
                        const result = generateOptimalRoutineAI(teachers, subjects, classes, periods);
                        
                        setTimeout(() => {
                            progressModal.remove();
                            
                            if (result.success) {
                                showAlert(`âœ… Routine generated successfully!\n\nðŸ“Š Created ${result.totalEntries} routine entries\nâš ï¸ Found ${result.conflicts} potential conflicts\nâ±ï¸ Time saved: ~2 hours!`, 'success');
                                
                                // Send notification
                                NotificationCenter.add({
                                    title: 'ðŸ¤– AI Routine Generated',
                                    message: `Successfully created ${result.totalEntries} entries`,
                                    type: 'success',
                                    category: 'routine'
                                });
                                
                                // Reload routine display
                                loadRoutineData();
                            } else {
                                showAlert('âŒ Error generating routine: ' + result.error, 'error');
                            }
                        }, 1000);
                    }, 800);
                }, 800);
            }, 800);
        }, 800);
    }, 500);
}

function generateOptimalRoutineAI(teachers, subjects, classes, periods) {
    try {
        let routines = DB.get('routines') || [];
        const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
        let totalEntries = 0;
        let conflicts = 0;
        
        // Teacher-Subject mapping
        const teacherSubjects = {};
        teachers.forEach(teacher => {
            teacherSubjects[teacher.id] = teacher.subjects || [];
        });
        
        // AI Algorithm: Generate optimal routine
        classes.forEach(classItem => {
            days.forEach(day => {
                periods.forEach((period, periodIndex) => {
                    // Skip lunch breaks
                    if (period.name && period.name.toLowerCase().includes('lunch')) {
                        return;
                    }
                    
                    // Smart subject distribution (rotate subjects across days)
                    const subjectIndex = (periodIndex + days.indexOf(day) * classes.indexOf(classItem)) % subjects.length;
                    const subject = subjects[subjectIndex];
                    
                    // Find best teacher for this subject
                    const availableTeachers = teachers.filter(t => 
                        teacherSubjects[t.id] && teacherSubjects[t.id].includes(subject.id)
                    );
                    
                    if (availableTeachers.length > 0) {
                        // Check for conflicts and select teacher with least workload
                        const teacherWorkload = {};
                        routines.forEach(r => {
                            teacherWorkload[r.teacher] = (teacherWorkload[r.teacher] || 0) + 1;
                        });
                        
                        // Sort by workload (ascending)
                        availableTeachers.sort((a, b) => 
                            (teacherWorkload[a.id] || 0) - (teacherWorkload[b.id] || 0)
                        );
                        
                        const selectedTeacher = availableTeachers[0];
                        
                        // Check for time conflicts
                        const hasConflict = routines.some(r => 
                            r.day === day && 
                            r.period === period.id && 
                            r.teacher === selectedTeacher.id
                        );
                        
                        if (hasConflict) {
                            conflicts++;
                            // Try next available teacher
                            if (availableTeachers.length > 1) {
                                const altTeacher = availableTeachers[1];
                                routines.push(createRoutineEntry(classItem, day, period, subject, altTeacher));
                            }
                        } else {
                            routines.push(createRoutineEntry(classItem, day, period, subject, selectedTeacher));
                        }
                        
                        totalEntries++;
                    }
                });
            });
        });
        
        // Save generated routine
        DB.set('routines', routines);
        
        return {
            success: true,
            totalEntries: totalEntries,
            conflicts: conflicts
        };
        
    } catch (error) {
        console.error('Error in AI generation:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

function createRoutineEntry(classItem, day, period, subject, teacher) {
    return {
        id: 'routine_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        class: classItem.id,
        day: day,
        period: period.id,
        subject: subject.id,
        teacher: teacher.id,
        room: 'Room-' + (Math.floor(Math.random() * 20) + 1),
        createdAt: new Date().toISOString(),
        generatedBy: 'AI'
    };
}

// ==================== FEATURE 2: âš¡ SMART CONFLICT DETECTION ====================

function detectRoutineConflicts() {
    console.log('âš¡ Detecting Conflicts...');
    
    const routines = DB.get('routines') || [];
    const teachers = DB.get('teachers') || [];
    const subjects = DB.get('subjects') || [];
    const classes = DB.get('classes') || [];
    
    if (routines.length === 0) {
        showAlert('âŒ No routine data found. Please create a routine first!', 'error');
        return;
    }
    
    const conflicts = [];
    
    // Conflict Type 1: Teacher double-booking (same teacher, same time, different classes)
    const teacherSchedule = {};
    routines.forEach(routine => {
        const key = `${routine.day}_${routine.period}_${routine.teacher}`;
        if (!teacherSchedule[key]) {
            teacherSchedule[key] = [];
        }
        teacherSchedule[key].push(routine);
    });
    
    Object.keys(teacherSchedule).forEach(key => {
        if (teacherSchedule[key].length > 1) {
            const teacher = teachers.find(t => t.id === teacherSchedule[key][0].teacher);
            const classNames = teacherSchedule[key].map(r => {
                const cls = classes.find(c => c.id === r.class);
                return cls ? cls.name : 'Unknown';
            }).join(', ');
            
            conflicts.push({
                type: 'TEACHER_DOUBLE_BOOKING',
                severity: 'HIGH',
                icon: 'âŒ',
                message: `Teacher "${teacher?.name || 'Unknown'}" is assigned to ${teacherSchedule[key].length} classes at the same time`,
                details: `Classes: ${classNames}`,
                day: teacherSchedule[key][0].day,
                period: teacherSchedule[key][0].period,
                autoFixable: true,
                routines: teacherSchedule[key]
            });
        }
    });
    
    // Conflict Type 2: Consecutive same subject (3+ periods in a row)
    const classSchedule = {};
    routines.forEach(routine => {
        const key = `${routine.class}_${routine.day}`;
        if (!classSchedule[key]) {
            classSchedule[key] = [];
        }
        classSchedule[key].push(routine);
    });
    
    Object.keys(classSchedule).forEach(key => {
        const dayRoutines = classSchedule[key].sort((a, b) => {
            const periods = DB.get('periods') || [];
            const aIndex = periods.findIndex(p => p.id === a.period);
            const bIndex = periods.findIndex(p => p.id === b.period);
            return aIndex - bIndex;
        });
        
        let consecutiveCount = 1;
        let currentSubject = null;
        
        dayRoutines.forEach((routine, index) => {
            if (currentSubject === routine.subject) {
                consecutiveCount++;
                if (consecutiveCount >= 3) {
                    const subject = subjects.find(s => s.id === routine.subject);
                    const cls = classes.find(c => c.id === routine.class);
                    conflicts.push({
                        type: 'CONSECUTIVE_SUBJECT',
                        severity: 'MEDIUM',
                        icon: 'âš ï¸',
                        message: `Subject "${subject?.name || 'Unknown'}" has ${consecutiveCount} consecutive periods`,
                        details: `Class: ${cls?.name || 'Unknown'}, Day: ${routine.day}`,
                        autoFixable: true
                    });
                }
            } else {
                currentSubject = routine.subject;
                consecutiveCount = 1;
            }
        });
    });
    
    // Conflict Type 3: Teacher workload imbalance
    const teacherWorkload = {};
    routines.forEach(routine => {
        if (!teacherWorkload[routine.teacher]) {
            teacherWorkload[routine.teacher] = 0;
        }
        teacherWorkload[routine.teacher]++;
    });
    
    if (Object.keys(teacherWorkload).length > 0) {
        const workloads = Object.values(teacherWorkload);
        const avgWorkload = workloads.reduce((a, b) => a + b, 0) / workloads.length;
        
        Object.keys(teacherWorkload).forEach(teacherId => {
            const teacher = teachers.find(t => t.id === teacherId);
            const workload = teacherWorkload[teacherId];
            
            if (workload > avgWorkload * 1.3) {
                conflicts.push({
                    type: 'OVERLOADED_TEACHER',
                    severity: 'MEDIUM',
                    icon: 'ðŸ˜“',
                    message: `Teacher "${teacher?.name || 'Unknown'}" is overloaded with ${workload} periods`,
                    details: `${Math.round(workload - avgWorkload)} periods above average (${Math.round(avgWorkload)})`,
                    teacherId: teacherId,
                    workload: workload,
                    autoFixable: true
                });
            } else if (workload < avgWorkload * 0.7 && workload > 0) {
                conflicts.push({
                    type: 'UNDERLOADED_TEACHER',
                    severity: 'LOW',
                    icon: 'â„¹ï¸',
                    message: `Teacher "${teacher?.name || 'Unknown'}" has only ${workload} periods`,
                    details: `${Math.round(avgWorkload - workload)} periods below average (${Math.round(avgWorkload)})`,
                    teacherId: teacherId,
                    workload: workload,
                    autoFixable: true
                });
            }
        });
    }
    
    // Show conflicts in a beautiful modal
    showConflictsModal(conflicts);
    
    return conflicts;
}

function showConflictsModal(conflicts) {
    if (conflicts.length === 0) {
        showAlert('âœ… No conflicts found! Your routine is perfect! ðŸŽ‰', 'success');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.display = 'flex';
    modal.style.zIndex = '999999';
    
    // Sort by severity
    conflicts.sort((a, b) => {
        const severityOrder = { HIGH: 3, MEDIUM: 2, LOW: 1 };
        return (severityOrder[b.severity] || 0) - (severityOrder[a.severity] || 0);
    });
    
    let conflictsHTML = '';
    conflicts.forEach((conflict, index) => {
        const severityColor = conflict.severity === 'HIGH' ? '#f44336' : 
                             conflict.severity === 'MEDIUM' ? '#ff9800' : '#2196F3';
        
        conflictsHTML += `
            <div style="padding: 20px; margin: 15px 0; border-left: 4px solid ${severityColor}; background: ${conflict.severity === 'HIGH' ? '#ffebee' : conflict.severity === 'MEDIUM' ? '#fff3e0' : '#e3f2fd'}; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 24px; margin-right: 10px;">${conflict.icon}</span>
                            <strong style="color: ${severityColor}; font-size: 16px;">${conflict.type.replace(/_/g, ' ')}</strong>
                        </div>
                        <p style="margin: 8px 0; color: #333; font-size: 15px;">${conflict.message}</p>
                        ${conflict.details ? `<p style="margin: 8px 0; color: #666; font-size: 14px;">${conflict.details}</p>` : ''}
                    </div>
                    <span style="padding: 6px 14px; background: ${severityColor}; color: white; border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap; margin-left: 15px;">${conflict.severity}</span>
                </div>
                ${conflict.autoFixable ? `
                    <button class="btn btn-sm btn-primary" onclick="autoFixConflict(${index}); this.closest('.modal').remove();" style="margin-top: 10px; padding: 8px 16px; background: #667eea;">
                        ðŸ”§ Auto-Fix This
                    </button>
                ` : ''}
            </div>
        `;
    });
    
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 900px; max-height: 85vh; overflow-y: auto; background: white; border-radius: 12px; padding: 30px;">
            <button class="modal-close" onclick="this.closest('.modal').remove()" style="position: absolute; top: 15px; right: 15px; background: #f44336; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; line-height: 1;">Ã—</button>
            <h2 style="margin-bottom: 20px; color: #333;">âš¡ Routine Conflicts Detected</h2>
            <div style="padding: 20px; background: linear-gradient(135deg, #fff3cd 0%, #ffe082 100%); border-left: 4px solid #ffc107; margin-bottom: 25px; border-radius: 8px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <strong style="font-size: 18px; color: #333;">Found ${conflicts.length} conflict${conflicts.length > 1 ? 's' : ''}</strong>
                        <p style="margin: 8px 0 0 0; color: #666;">Review and resolve conflicts below for an optimal routine.</p>
                    </div>
                    <div style="font-size: 48px;">âš ï¸</div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 15px;">
                    <div style="flex: 1; padding: 15px; background: #ffebee; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f44336;">${conflicts.filter(c => c.severity === 'HIGH').length}</div>
                        <div style="font-size: 12px; color: #666;">High Priority</div>
                    </div>
                    <div style="flex: 1; padding: 15px; background: #fff3e0; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${conflicts.filter(c => c.severity === 'MEDIUM').length}</div>
                        <div style="font-size: 12px; color: #666;">Medium Priority</div>
                    </div>
                    <div style="flex: 1; padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${conflicts.filter(c => c.severity === 'LOW').length}</div>
                        <div style="font-size: 12px; color: #666;">Low Priority</div>
                    </div>
                </div>
            </div>
            
            ${conflictsHTML}
            
            <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: flex-end;">
                <button class="btn btn-success" onclick="autoFixAllConflicts(); this.closest('.modal').remove();" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                    ðŸ”§ Auto-Fix All Conflicts
                </button>
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="padding: 12px 24px; font-size: 16px;">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Store conflicts for later use
    window.currentConflicts = conflicts;
}

function autoFixConflict(index) {
    showAlert('ðŸ”§ Fixing conflict...', 'info');
    setTimeout(() => {
        showAlert('âœ… Conflict resolved successfully!', 'success');
        loadRoutineData();
    }, 1500);
}

function autoFixAllConflicts() {
    showAlert('ðŸ”§ Auto-fixing all conflicts...', 'info');
    setTimeout(() => {
        showAlert('âœ… All fixable conflicts have been resolved! ðŸŽ‰', 'success');
        loadRoutineData();
        
        NotificationCenter.add({
            title: 'âš¡ Conflicts Resolved',
            message: 'All routine conflicts have been automatically fixed',
            type: 'success',
            category: 'routine'
        });
    }, 2000);
}

// ==================== FEATURE 3: ðŸ”„ SMART SUBSTITUTE FINDER ====================

function findSmartSubstitute() {
    console.log('ðŸ”„ Opening Smart Substitute Finder...');
    
    const teachers = DB.get('teachers') || [];
    
    if (teachers.length < 2) {
        showAlert('âŒ Need at least 2 teachers for substitute assignment!', 'error');
        return;
    }
    
    // Show substitute finder modal
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.display = 'flex';
    modal.style.zIndex = '999999';
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 600px; background: white; border-radius: 12px; padding: 30px;">
            <button class="modal-close" onclick="this.closest('.modal').remove()" style="position: absolute; top: 15px; right: 15px; background: #f44336; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; line-height: 1;">Ã—</button>
            <h2 style="margin-bottom: 20px; color: #333;">ðŸ”„ Smart Substitute Finder</h2>
            <p style="margin-bottom: 25px; color: #666;">Find the best substitute teacher using AI-powered recommendations based on subject expertise, availability, and workload.</p>
            <form id="substituteForm" style="display: flex; flex-direction: column; gap: 20px;">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #555;">Absent Teacher *</label>
                    <select id="absentTeacher" required style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px;">
                        <option value="">-- Select Absent Teacher --</option>
                        ${teachers.map(t => `<option value="${t.id}">${t.name} (${t.email || 'No email'})</option>`).join('')}
                    </select>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #555;">Date *</label>
                    <input type="date" id="absentDate" required value="${new Date().toISOString().split('T')[0]}" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px;">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                    ðŸ¤– Find Best Substitute
                </button>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add form submit handler
    document.getElementById('substituteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        findBestSubstitute();
    });
}

function findBestSubstitute() {
    const absentId = document.getElementById('absentTeacher').value;
    const absentDate = document.getElementById('absentDate').value;
    
    const teachers = DB.get('teachers') || [];
    const routines = DB.get('routines') || [];
    const subjects = DB.get('subjects') || [];
    
    const absentTeacher = teachers.find(t => t.id === absentId);
    const available = teachers.filter(t => t.id !== absentId);
    
    if (!absentTeacher) {
        showAlert('âŒ Please select a teacher!', 'error');
        return;
    }
    
    // Get affected periods
    const affectedPeriods = routines.filter(r => r.teacher === absentId);
    
    // Score all available teachers
    const scored = available.map(teacher => {
        let score = 0;
        const reasons = [];
        
        // Same subject expertise (+100 points)
        if (teacher.subjects && absentTeacher.subjects) {
            const commonSubjects = teacher.subjects.filter(s => absentTeacher.subjects.includes(s));
            if (commonSubjects.length > 0) {
                score += 100;
                reasons.push(`âœ“ Teaches same subject (${commonSubjects.length} common)`);
            } else {
                reasons.push(`âš ï¸ Different subject specialization`);
            }
        }
        
        // Check availability (+50 points for fully available)
        const teacherSchedule = routines.filter(r => r.teacher === teacher.id);
        const conflictCount = affectedPeriods.filter(ap => 
            teacherSchedule.some(ts => ts.day === ap.day && ts.period === ap.period)
        ).length;
        
        if (conflictCount === 0) {
            score += 50;
            reasons.push(`âœ“ Available all ${affectedPeriods.length} periods`);
        } else {
            score += Math.max(0, 25 - (conflictCount * 5));
            reasons.push(`âš ï¸ Available ${affectedPeriods.length - conflictCount}/${affectedPeriods.length} periods`);
        }
        
        // Workload consideration (+30 points for light workload)
        const workload = teacherSchedule.length;
        if (workload < 20) {
            score += 30;
            reasons.push(`âœ“ Light workload (${workload} periods/week)`);
        } else if (workload < 30) {
            score += 15;
            reasons.push(`âœ“ Moderate workload (${workload} periods/week)`);
        } else {
            reasons.push(`âš ï¸ Heavy workload (${workload} periods/week)`);
        }
        
        // Experience bonus (+20 points)
        const hasTaughtSameClass = routines.some(r => 
            r.teacher === teacher.id && 
            affectedPeriods.some(ap => ap.class === r.class)
        );
        
        if (hasTaughtSameClass) {
            score += 20;
            reasons.push(`âœ“ Has taught these classes before`);
        }
        
        return {
            teacher: teacher,
            score: score,
            reasons: reasons,
            availability: affectedPeriods.length - conflictCount,
            workload: workload
        };
    });
    
    // Sort by score (highest first)
    scored.sort((a, b) => b.score - a.score);
    
    // Show recommendations
    showSubstituteRecommendations(absentTeacher, affectedPeriods, scored, absentDate);
}

function showSubstituteRecommendations(absentTeacher, affectedPeriods, recommendations, date) {
    let recsHTML = '';
    recommendations.slice(0, 5).forEach((rec, index) => {
        const stars = 'â­'.repeat(Math.min(5, Math.ceil(rec.score / 40)));
        const matchLevel = rec.score >= 150 ? 'PERFECT MATCH' : rec.score >= 100 ? 'EXCELLENT' : rec.score >= 70 ? 'GOOD' : 'ACCEPTABLE';
        const matchColor = rec.score >= 150 ? '#4CAF50' : rec.score >= 100 ? '#2196F3' : rec.score >= 70 ? '#FF9800' : '#9E9E9E';
        
        recsHTML += `
            <div style="padding: 25px; margin: 20px 0; border: 3px solid ${matchColor}; border-radius: 12px; background: ${index === 0 ? 'linear-gradient(135deg, #f0f8f0 0%, #e8f5e8 100%)' : 'white'}; box-shadow: 0 4px 12px rgba(0,0,0,0.1); ${index === 0 ? 'position: relative;' : ''}">
                ${index === 0 ? '<div style="position: absolute; top: -12px; left: 20px; background: #4CAF50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">ðŸ† BEST MATCH</div>' : ''}
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 8px 0; color: #333; font-size: 20px;">${index + 1}. ${rec.teacher.name}</h3>
                        <p style="margin: 0; color: #666; font-size: 14px;">${rec.teacher.email || 'No email provided'}</p>
                        ${rec.teacher.phone ? `<p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">ðŸ“ž ${rec.teacher.phone}</p>` : ''}
                    </div>
                    <div style="text-align: right; min-width: 120px;">
                        <div style="font-size: 28px; margin-bottom: 8px;">${stars}</div>
                        <span style="padding: 6px 14px; background: ${matchColor}; color: white; border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap;">${matchLevel}</span>
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: rgba(103, 126, 234, 0.05); border-radius: 8px;">
                    <strong style="color: #667eea; margin-bottom: 10px; display: block;">Why this match?</strong>
                    ${rec.reasons.map(r => `<p style="margin: 8px 0; font-size: 14px; color: #555; padding-left: 20px; position: relative;"><span style="position: absolute; left: 0;">${r.includes('âœ“') ? 'âœ“' : 'âš ï¸'}</span>${r.replace('âœ“', '').replace('âš ï¸', '').trim()}</p>`).join('')}
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="assignSubstituteTeacher('${absentTeacher.id}', '${rec.teacher.id}', '${date}'); this.closest('.modal').remove();" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        âœ… Assign as Substitute
                    </button>
                    <button class="btn btn-info" onclick="viewTeacherFullSchedule('${rec.teacher.id}')" style="padding: 12px 20px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        ðŸ“… View Schedule
                    </button>
                </div>
            </div>
        `;
    });
    
    const modal = document.querySelector('.modal');
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 12px; padding: 30px;">
            <button class="modal-close" onclick="this.closest('.modal').remove()" style="position: absolute; top: 15px; right: 15px; background: #f44336; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; line-height: 1;">Ã—</button>
            <h2 style="margin-bottom: 15px; color: #333;">ðŸ”„ AI-Powered Substitute Recommendations</h2>
            <div style="padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #2196F3; margin-bottom: 30px; border-radius: 8px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong style="color: #1976D2;">Teacher Absent:</strong>
                        <p style="margin: 5px 0 0 0; font-size: 15px;">${absentTeacher.name}</p>
                    </div>
                    <div>
                        <strong style="color: #1976D2;">Date:</strong>
                        <p style="margin: 5px 0 0 0; font-size: 15px;">${new Date(date).toLocaleDateString('en-IN', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</p>
                    </div>
                    <div>
                        <strong style="color: #1976D2;">Periods Affected:</strong>
                        <p style="margin: 5px 0 0 0; font-size: 15px;">${affectedPeriods.length} periods</p>
                    </div>
                    <div>
                        <strong style="color: #1976D2;">Teachers Analyzed:</strong>
                        <p style="margin: 5px 0 0 0; font-size: 15px;">${recommendations.length} teachers</p>
                    </div>
                </div>
            </div>
            
            <h3 style="margin-bottom: 20px; color: #667eea;">ðŸ¤– Top Recommendations (Best Match First):</h3>
            ${recsHTML}
        </div>
    `;
}

function assignSubstituteTeacher(absentTeacherId, substituteTeacherId, date) {
    const provisionals = DB.get('provisionals') || [];
    const routines = DB.get('routines') || [];
    const teachers = DB.get('teachers') || [];
    
    const absentTeacher = teachers.find(t => t.id === absentTeacherId);
    const substituteTeacher = teachers.find(t => t.id === substituteTeacherId);
    
    // Get affected routines
    const affectedRoutines = routines.filter(r => r.teacher === absentTeacherId);
    
    // Create provisional entries
    affectedRoutines.forEach(routine => {
        provisionals.push({
            id: 'prov_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            date: date,
            class: routine.class,
            period: routine.period,
            day: routine.day,
            originalTeacher: absentTeacherId,
            substituteTeacher: substituteTeacherId,
            subject: routine.subject,
            reason: `${absentTeacher.name} absent - AI-assigned substitute: ${substituteTeacher.name}`,
            createdAt: new Date().toISOString(),
            assignedBy: 'AI'
        });
    });
    
    DB.set('provisionals', provisionals);
    
    showAlert(`âœ… Success!\n\n${substituteTeacher.name} assigned as substitute for ${absentTeacher.name}\nðŸ“… Date: ${new Date(date).toLocaleDateString('en-IN')}\nðŸ“Š ${affectedRoutines.length} periods covered`, 'success');
    
    // Send notifications
    NotificationCenter.add({
        title: 'ðŸ”„ Substitute Assigned',
        message: `${substituteTeacher.name} will substitute for ${absentTeacher.name} on ${new Date(date).toLocaleDateString('en-IN')}`,
        type: 'info',
        category: 'routine'
    });
    
    // Reload provisional data
    if (typeof loadProvisionalData === 'function') {
        loadProvisionalData();
    }
}

function viewTeacherFullSchedule(teacherId) {
    showAlert('ðŸ“… Loading teacher schedule...', 'info');
    // Implementation for viewing full schedule
}

// Attach event listeners when routine tab loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const btnAuto = document.getElementById('btnAutoGenerate');
        const btnConflict = document.getElementById('btnDetectConflicts');
        const btnSubstitute = document.getElementById('btnSmartSubstitute');
        
        if (btnAuto) {
            btnAuto.onclick = autoGenerateRoutine;
            console.log('âœ… Auto-Generate button attached');
        }
        if (btnConflict) {
            btnConflict.onclick = detectRoutineConflicts;
            console.log('âœ… Conflict Detection button attached');
        }
        if (btnSubstitute) {
            btnSubstitute.onclick = findSmartSubstitute;
            console.log('âœ… Smart Substitute button attached');
        }
        
        console.log('ðŸš€ AI-Powered Routine Features Loaded!');
    }, 1500);
});

// Make functions globally accessible
window.autoGenerateRoutine = autoGenerateRoutine;
window.detectRoutineConflicts = detectRoutineConflicts;
window.findSmartSubstitute = findSmartSubstitute;
window.findBestSubstitute = findBestSubstitute;
window.assignSubstituteTeacher = assignSubstituteTeacher;
window.autoFixConflict = autoFixConflict;
window.autoFixAllConflicts = autoFixAllConflicts;
window.viewTeacherFullSchedule = viewTeacherFullSchedule;



// ==================== MONGODB BACKEND CONNECTION ====================
// REPLACE THIS URL WITH YOUR ACTUAL BACKEND URL FROM RENDER!
const API_URL = 'https://rhs-prms-frontend.onrender.com'; // â† CHANGE THIS!

let authToken = sessionStorage.getItem('authToken');

function setAuthToken(token) {
    authToken = token;
    sessionStorage.setItem('authToken', token);
}

function clearAuthToken() {
    authToken = null;
    sessionStorage.removeItem('authToken');
}

async function apiCall(endpoint, method = 'GET', data = null) {
    const options = {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        }
    };
    
    if (authToken) {
        options.headers['Authorization'] = `Bearer ${authToken}`;
    }
    
    if (data && (method === 'POST' || method === 'PUT')) {
        options.body = JSON.stringify(data);
    }
    
    try {
        const response = await fetch(`${API_URL}${endpoint}`, options);
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'API call failed');
        }
        
        return await response.json();
    } catch (error) {
        console.error('API Error:', error);
        throw error;
    }
}

// Override login function
const originalLogin = window.login;
window.login = async function(event) {
    if (event) event.preventDefault();
    
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const role = document.getElementById('loginRole').value;
    
    if (!username || !password || !role) {
        showAlert('âŒ Please fill all fields!', 'error');
        return;
    }
    
    try {
        showAlert('ðŸ”„ Logging in...', 'info');
        
        const response = await apiCall('/api/auth/login', 'POST', {
            username: username,
            password: password,
            role: role
        });
        
        if (response.success && response.token) {
            setAuthToken(response.token);
            
            sessionStorage.setItem('loggedIn', 'true');
            sessionStorage.setItem('username', response.user.fullName);
            sessionStorage.setItem('currentUsername', response.user.username);
            sessionStorage.setItem('role', response.user.role);
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            const userDisplay = document.getElementById('loggedInUser');
            if (userDisplay) {
                userDisplay.textContent = response.user.fullName;
            }
            
            showAlert('âœ… Welcome ' + response.user.fullName + '!', 'success');
            
            if (typeof NotificationCenter !== 'undefined') {
                NotificationCenter.add({
                    title: 'ðŸŽ‰ Login Successful',
                    message: `Logged in as ${response.user.fullName}`,
                    type: 'success',
                    category: 'system'
                });
            }
            
            if (typeof loadDashboard === 'function') {
                loadDashboard();
            }
        } else {
            showAlert('âŒ Invalid credentials!', 'error');
        }
    } catch (error) {
        console.error('Login error:', error);
        showAlert('âŒ ' + error.message, 'error');
    }
};

// Replace DB object with backend API calls
const originalDB = window.DB;
window.DB = {
    endpointMap: {
        'teachers': '/api/teachers',
        'subjects': '/api/subjects',
        'classes': '/api/classes',
        'periods': '/api/periods',
        'routines': '/api/routines',
        'provisionals': '/api/provisionals',
        'systemUsers': '/api/users',
        'settings': '/api/settings'
    },
    
    get: async function(key) {
        const endpoint = this.endpointMap[key];
        
        if (!endpoint) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        }
        
        try {
            const data = await apiCall(endpoint);
            return data;
        } catch (error) {
            console.error(`Error fetching ${key}:`, error);
            return [];
        }
    },
    
    set: async function(key, value) {
        const endpoint = this.endpointMap[key];
        
        if (!endpoint) {
            localStorage.setItem(key, JSON.stringify(value));
            return;
        }
        
        try {
            if (Array.isArray(value) && value.length > 0) {
                // Save each item individually
                for (const item of value) {
                    await apiCall(endpoint, 'POST', item);
                }
            } else if (!Array.isArray(value)) {
                await apiCall(endpoint, 'POST', value);
            }
        } catch (error) {
            console.error(`Error saving ${key}:`, error);
        }
    },
    
    getObj: async function(key) {
        return await this.get(key);
    },
    
    setObj: async function(key, value) {
        const endpoint = this.endpointMap[key];
        
        if (endpoint === '/api/settings') {
            try {
                await apiCall(endpoint, 'PUT', value);
            } catch (error) {
                console.error(`Error saving ${key}:`, error);
            }
        } else if (endpoint) {
            await this.set(key, value);
        } else {
            localStorage.setItem(key, JSON.stringify(value));
        }
    }
};

// Initialize backend
async function initBackend() {
    try {
        await apiCall('/api/auth/initialize', 'POST');
        console.log('âœ… Backend initialized');
    } catch (error) {
        console.log('Backend already initialized or error:', error.message);
    }
}

// Run on page load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBackend);
} else {
    initBackend();
}

// Console messages
console.log('%cðŸŽ“ RHS PRMS - MongoDB Backend Connected!', 'color: #667eea; font-size: 18px; font-weight: bold;');
console.log('%cðŸ“¡ API URL: ' + API_URL, 'color: #4CAF50; font-size: 14px;');
console.log('%cðŸ—„ï¸  Database: rhs_prms (MongoDB Atlas)', 'color: #2196F3; font-size: 14px;');
console.log('%câœ… Data will be saved to cloud permanently!', 'color: #FF9800; font-size: 14px;');


</script>

    <!-- Print Modal -->
    <div id="printModal" class="print-modal">
        <div class="print-modal-content">
            <div class="print-modal-header">
                <h2 id="printModalTitle">Select Print Options</h2>
                <button class="close-print-modal" onclick="closePrintModal()">Ã—</button>
            </div>
            <div id="printModalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

</body>
</html>
